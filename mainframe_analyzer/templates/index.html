<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mainframe Code Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            overflow-x: hidden;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-metrics {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .metric-label {
            opacity: 0.8;
            font-size: 0.8rem;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 1rem;
            padding: 1rem;
            min-height: calc(100vh - 100px);
        }

        /* Left Panel */
        .left-panel {
            width: 420px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
            height: fit-content;
            transition: all 0.3s ease;
        }

        .left-panel.collapsed {
            width: 60px;
            padding: 1rem;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
        }
        .panel-restore {
            position: fixed;
            top: 50%;
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            transform: translateY(-50%);
            z-index: 1001;
            font-size: 0.8rem;
        }

        .panel-restore.left {
            left: 0;
        }

        .panel-restore.right {
            right: 0;
        }
        .collapse-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        .collapse-btn:hover {
            transform: scale(1.1);
        }

        /* Upload Section */
        .upload-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9ff;
            border-radius: 8px;
            border: 2px dashed #667eea;
        }

        .upload-area {
            text-align: center;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #e8ecff;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f1f3f4;
            color: #667eea;
            border: 1px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* Token Usage */
        .token-usage {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .token-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        /* Main Content */
        .content-area {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-btn:hover:not(.active) {
            background: #e9ecef;
        }

        /* Tab Content */
        .tab-content {
            padding: 2rem;
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Field Mapping Interface */
        .field-mapping-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
        }

        .field-mapping-controls input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .field-mapping-controls input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f3f4;
        }

        .data-table tbody tr:hover {
            background: #f8f9ff;
        }

        /* Field Matrix */
        .field-matrix-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .field-matrix-controls select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .collapsible-row {
            cursor: pointer;
        }

        .collapsible-row:hover {
            background: #f0f2ff !important;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            margin-right: 0.5rem;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .sub-fields {
            display: none;
        }

        .sub-fields.show {
            display: table-row-group;
        }

        .sub-field-row {
            background: #f9f9f9 !important;
        }

        .sub-field-row td:first-child {
            padding-left: 2rem;
        }

        /* Right Panel - Chat */
        .right-panel {
            width: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
            transition: all 0.3s ease;
        }

        .right-panel.collapsed {
            width: 60px;
        }

        .chat-header {
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: white;
            border: 1px solid #e9ecef;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            background: white;
            border-radius: 0 0 10px 10px;
        }

        .chat-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .chat-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }

        .token-counter {
            font-size: 0.8rem;
            color: #666;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            min-width: 400px;
            max-width: 500px;
        }

        .analysis-step {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .analysis-step.completed {
            background: #d4edda;
            color: #155724;
        }

        .analysis-step.current {
            background: #d1ecf1;
            color: #0c5460;
            font-weight: 500;
        }

        .step-icon {
            margin-right: 0.5rem;
            font-size: 1rem;
        }

        .analysis-step.completed .step-icon::before {
            content: '✅';
        }

        .analysis-step.current .step-icon::before {
            content: '🔄';
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                width: 100%;
                max-width: none;
            }

            .right-panel {
                height: 400px;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: #6c757d;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .badge-primary {
            color: #fff;
            background-color: #667eea;
        }

        .badge-success {
            color: #fff;
            background-color: #28a745;
        }

        .badge-warning {
            color: #212529;
            background-color: #ffc107;
        }

        .badge-danger {
            color: #fff;
            background-color: #dc3545;
        }

        /* Component Summaries Styles */
        .component-summaries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .component-summary-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .component-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .component-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .component-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .component-type {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: auto;
        }

        .business-purpose {
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        .component-metrics {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            min-width: 60px;
        }

        .metric-value {
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            font-size: 0.7rem;
            color: #6c757d;
            text-align: center;
        }

        .complexity-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .complexity-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            transition: width 0.3s ease;
        }

        .domain-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 4px;
            margin-top: 0.5rem;
        }

        .domain-financial { background: #d4edda; color: #155724; }
        .domain-insurance { background: #d1ecf1; color: #0c5460; }
        .domain-retail { background: #ffefd5; color: #856404; }
        .domain-manufacturing { background: #e2e3e5; color: #383d41; }
        .domain-general { background: #f8d7da; color: #721c24; }

        .component-section {
            margin-bottom: 2rem;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .expand-btn:hover {
            background: #f8f9ff;
        }

        .derived-count {
            background: #667eea;
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
            min-width: 1.5rem;
            text-align: center;
            display: inline-block;
        }

        .usage-input { background: #e3f2fd; }
        .usage-output { background: #f1f8e9; }
        .usage-derived { background: #fff3e0; }
        .usage-reference { background: #fce4ec; }
        .usage-static { background: #f3e5f5; }
        .usage-unused { background: #ffebee; }
        .usage-input_output { background: #e8f5e8; border-left: 3px solid #4caf50; }

        .cics-operation {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            display: inline-block;
            margin: 0.1rem;
        }

        .io-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.25rem;
        }

        .io-badge {
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .io-input { background: #2196f3; color: white; }
        .io-output { background: #4caf50; color: white; }
        .io-both { background: #ff9800; color: white; }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 600px;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-help {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .connection-status {
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .connection-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status.testing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .server-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .server-info h5 {
            margin: 0 0 0.5rem 0;
            color: #667eea;
        }

        .server-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .btn-test {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .btn-test:hover {
            transform: translateY(-1px);
        }

        .btn-test:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .city-view-container {
            display: grid;
            grid-template-areas: 
                "inputs interfaces"
                "components components"
                "outputs missing";
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            padding: 1rem;
            min-height: 600px;
        }

        .flow-section {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .input-section { 
            grid-area: inputs;
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .interface-section { 
            grid-area: interfaces;
            border-color: #007bff;
            background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%);
        }

        .component-section { 
            grid-area: components;
            border-color: #667eea;
            background: linear-gradient(135deg, #e8ecff 0%, #ffffff 100%);
        }

        .output-section { 
            grid-area: outputs;
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .missing-section { 
            grid-area: missing;
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #ffffff 100%);
        }

        .flow-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .flow-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .flow-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .main-components .flow-item {
            border-left: 4px solid #667eea;
        }

        .missing-items .flow-item {
            border: 2px dashed #dc3545;
            background: #fff5f5;
        }

        .flow-item-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .flow-item-type {
            font-size: 0.8rem;
            color: #6c757d;
            background: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            display: inline-block;
        }

        .connection-line {
            position: absolute;
            height: 2px;
            background: #667eea;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 2% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">🔧 Mainframe Code Analyzer</div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openConfigModal()">⚙️ LLM Config</button>
            </div>
            <div class="header-metrics">
                <div class="metric-item">
                    <span class="metric-value" id="totalComponents">0</span>
                    <span class="metric-label">Components</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalPrograms">0</span>
                    <span class="metric-label">Programs</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalFields">0</span>
                    <span class="metric-label">Fields</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalTokens">0</span>
                    <span class="metric-label">Tokens Used</span>
                </div>
            </div>
        </div>
    </div>

    <!-- LLM Configuration Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🚀 LLM Server Configuration</h3>
                <button class="close" onclick="closeConfigModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="llmConfigForm">
                    <div class="form-group">
                        <label class="form-label" for="llmEndpoint">
                            🔗 VLLM Server Endpoint
                        </label>
                        <input type="url" id="llmEndpoint" class="form-input" 
                               placeholder="http://192.168.1.100:8100/generate"
                               value="http://localhost:8100/generate">
                        <div class="form-help">Enter the full URL to your VLLM server's /generate endpoint</div>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="maxTokens">
                                🎯 Max Tokens per Call
                            </label>
                            <input type="number" id="maxTokens" class="form-input" 
                                   value="6000" min="1000" max="32000" step="500">
                            <div class="form-help">Maximum tokens for each LLM request</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="temperature">
                                🌡️ Temperature
                            </label>
                            <input type="number" id="temperature" class="form-input" 
                                   value="0.1" min="0" max="2" step="0.1">
                            <div class="form-help">Creativity level (0.0 = deterministic, 2.0 = creative)</div>
                        </div>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="timeout">
                                ⏱️ Request Timeout (seconds)
                            </label>
                            <input type="number" id="timeout" class="form-input" 
                                   value="60" min="10" max="300" step="5">
                            <div class="form-help">How long to wait for LLM response</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="retries">
                                🔄 Max Retries
                            </label>
                            <input type="number" id="retries" class="form-input" 
                                   value="3" min="1" max="5" step="1">
                            <div class="form-help">Number of retry attempts on failure</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn-test" onclick="testLLMConnection()">
                            🧪 Test Connection
                        </button>
                    </div>

                    <div id="connectionStatus" class="connection-status" style="display: none;">
                        <span id="statusIcon"></span>
                        <span id="statusMessage"></span>
                    </div>

                    <div id="serverInfo" class="server-info" style="display: none;">
                        <h5>📊 Server Information</h5>
                        <div class="server-info-item">
                            <span>Model:</span>
                            <span id="modelName">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Max Context Length:</span>
                            <span id="contextLength">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Response Time:</span>
                            <span id="responseTime">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Status:</span>
                            <span id="serverStatus">-</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">
                    🔄 Reset to Defaults
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeConfigModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveLLMConfig()">
                    💾 Save & Apply
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel -->
        <div class="left-panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-title">📁 Component Dashboard</div>
                <button class="collapse-btn" onclick="togglePanel('left')">◀</button>
            </div>

            <div class="panel-content">
                <!-- Upload Section -->
                <div class="upload-section">
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">📁</div>
                        <div>Click to upload COBOL files</div>
                        <small class="text-muted">Supports .cbl, .cob, .cpy, .jcl files</small>
                    </div>
                    <input type="file" id="fileInput" class="file-input" multiple 
                           accept=".cbl,.cob,.cpy,.jcl,.txt" onchange="handleFileUpload(event)">
                </div>

                <!-- Session Info -->
                <div class="session-info">
                    <h4>📊 Session Overview</h4>
                    <div id="sessionStats">
                        <p>Project: <span id="projectName">New Project</span></p>
                        <p>Session ID: <span id="sessionId">Not started</span></p>
                    </div>
                </div>

                <!-- Token Usage -->
                <div class="token-usage">
                    <h4>🎯 Token Usage</h4>
                    <div class="token-item">
                        <span>Analysis:</span>
                        <span id="analysisTokens">0</span>
                    </div>
                    <div class="token-item">
                        <span>Chat:</span>
                        <span id="chatTokens">0</span>
                    </div>
                    <div class="token-item">
                        <span><strong>Total:</strong></span>
                        <span id="totalTokensDetailed">0</span>
                    </div>
                </div>

                <!-- Components List -->
                <div class="components-list">
                    <h4>📋 Components</h4>
                    <div id="componentsList">
                        <p class="text-muted">No components uploaded yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="showTab('dashboard')">🏠 Dashboard</button>
                <button class="tab-btn" onclick="showTab('components')">📚 Components Library</button>
                <button class="tab-btn" onclick="showTab('dependencies')">🔗 Dependencies Flow</button>
                <button class="tab-btn" onclick="showTab('fieldMatrix')">📊 Field Matrix</button>
                <button class="tab-btn" onclick="showTab('fieldMapping')">🎯 Field Mapping Analysis</button>
            </div>

            <!-- Tab Contents -->
            <div class="tab-content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-pane active">
                    <h2>📈 Project Dashboard</h2>
                    
                    <!-- Summary Cards -->
                    <div class="dashboard-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 2rem;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Analysis Status</h3>
                            <p id="analysisStatus">Ready for upload</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>✓ Parsed Programs: <span id="parsedPrograms">0</span></div>
                                <div>✓ Record Layouts: <span id="recordLayouts">0</span></div>
                                <div>✓ CICS Files: <span id="cicsFiles">0</span></div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Processing Queue</h3>
                            <p id="processingQueue">0 files in queue</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>⏳ Token Usage: <span id="dashTokenUsage">0</span></div>
                                <div>🔄 LLM Calls: <span id="llmCalls">0</span></div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Success Rate</h3>
                            <p id="successRate">100%</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>📊 Complexity Avg: <span id="avgComplexity">N/A</span></div>
                                <div>🎯 Confidence: <span id="avgConfidence">N/A</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Component Summaries -->
                    <div style="margin-top: 2rem;">
                        <h3>🔍 Component Analysis Summary</h3>
                        <div id="componentSummaries" class="component-summaries">
                            <p class="text-muted">Upload COBOL files to see AI-generated business summaries</p>
                        </div>
                    </div>

                    <!-- Business Domain Analysis -->
                    <div style="margin-top: 2rem;">
                        <h3>🏢 Business Domain Analysis</h3>
                        <div id="domainAnalysis" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Components Library Tab -->
                <div id="components" class="tab-pane">
                    <h2>📚 Components Library</h2>
                    
                    <!-- Filter Controls -->
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                        <select id="componentTypeFilter" onchange="filterComponents()">
                            <option value="">All Component Types</option>
                            <option value="PROGRAM">Programs Only</option>
                            <option value="RECORD_LAYOUT">Record Layouts Only</option>
                            <option value="COPYBOOK_REFERENCE">Copybook References Only</option>
                            <option value="CICS_FILE">CICS Files Only</option>
                        </select>
                        <input type="text" id="componentSearchFilter" placeholder="Search components..." onkeyup="filterComponents()" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <button class="btn btn-secondary" onclick="showComponentHierarchy()">📊 Show Hierarchy</button>
                    </div>

                    <div id="componentsTable">
                        <!-- Main Programs Table -->
                        <div class="component-section">
                            <h4>📁 Main Programs</h4>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Program Name</th>
                                        <th>Business Purpose</th>
                                        <th>Lines</th>
                                        <th>Complexity</th>
                                        <th>Derived Components</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="mainProgramsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">No main programs available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Derived Components (Hidden by default) -->
                        <div id="derivedComponentsSection" class="component-section" style="display: none; margin-top: 2rem;">
                            <h4>🔗 Derived Components</h4>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Component Name</th>
                                        <th>Type</th>
                                        <th>Parent Program</th>
                                        <th>Business Purpose</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="derivedComponentsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Dependencies Flow Tab -->
<div id="dependencies" class="tab-pane">
    <h2>System Architecture Flow</h2>
    <div id="dependenciesVisualization">
        <!-- City View Container -->
        <div class="city-view-container">
            <!-- Input Sources -->
            <div class="flow-section input-section">
                <h4>Input Sources</h4>
                <div id="inputSources" class="flow-items">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- External Interfaces -->
            <div class="flow-section interface-section">
                <h4>External Interfaces</h4>
                <div id="externalInterfaces" class="flow-items">
                    <!-- CICS Files, DB2, MQ, etc. -->
                </div>
            </div>
            
            <!-- Core Components -->
            <div class="flow-section component-section">
                <h4>Core Components</h4>
                <div id="coreComponents" class="flow-items main-components">
                    <!-- Main programs and record layouts -->
                </div>
            </div>
            
            <!-- Output Files -->
            <div class="flow-section output-section">
                <h4>Output Files</h4>
                <div id="outputFiles" class="flow-items">
                    <!-- Output files and reports -->
                </div>
            </div>
            
            <!-- Missing Dependencies -->
            <div class="flow-section missing-section">
                <h4>Missing Dependencies</h4>
                <div id="missingDependencies" class="flow-items missing-items">
                    <!-- Unresolved copybooks, includes, etc. -->
                </div>
            </div>
        </div>
    </div>
</div>
                <!-- Field Matrix Tab -->
                <div id="fieldMatrix" class="tab-pane">
                    <h2>📊 Field Matrix</h2>
                    <div class="field-matrix-controls">
                        <select id="recordLayoutSelect" onchange="loadFieldMatrix()">
                            <option value="">Select Record Layout</option>
                        </select>
                        <select id="programSelect" onchange="loadFieldMatrix()">
                            <option value="">Select Program</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadFieldMatrix()">Refresh Matrix</button>
                    </div>
                    <div id="fieldMatrixTable">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Usage Type</th>
                                    <th>Source Field</th>
                                    <th>Business Purpose</th>
                                    <th>Program</th>
                                    <th>Line #</th>
                                </tr>
                            </thead>
                            <tbody id="fieldMatrixTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No field data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Field Operations Modal -->
                <div id="fieldOperationsModal" class="modal">
                    <div class="modal-content" style="width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title" id="fieldModalTitle">Field Operations</h3>
                            <button class="close" onclick="closeFieldOperationsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="fieldOperationsContent">
                                <!-- Operations will be populated here -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeFieldOperationsModal()">Close</button>
                        </div>
                    </div>
                </div>
                <!-- Field Mapping Analysis Tab -->
                <div id="fieldMapping" class="tab-pane">
                    <h2>🎯 Field Mapping Analysis</h2>
                    <div class="field-mapping-controls">
                        <input type="text" id="targetFileInput" placeholder="Enter target file name (e.g., CUSTOMER-FILE)">
                        <button class="btn btn-primary" onclick="analyzeFieldMapping()">🔍 Analyze Field Mapping</button>
                        <button class="btn btn-secondary" onclick="exportFieldMappings()">📊 Export to CSV</button>
                    </div>
                    <div id="fieldMappingResults">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Mainframe Data Type</th>
                                    <th>Oracle Data Type</th>
                                    <th>MF Length</th>
                                    <th>Oracle Length</th>
                                    <th>Population Source</th>
                                    <th>Business Logic</th>
                                    <th>Programs Involved</th>
                                </tr>
                            </thead>
                            <tbody id="fieldMappingTableBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">Enter a target file name and click Analyze</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Chat -->
        <div class="right-panel" id="rightPanel">
            <div class="chat-header">
                <div>💬 AI Assistant</div>
                <button class="collapse-btn" onclick="togglePanel('right')" style="background: none; border: none; color: white; font-size: 1.2rem;">▶</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message assistant">
                    <p>Hello! I'm your mainframe analysis assistant. I can help you understand:</p>
                    <ul>
                        <li>Field mappings and data relationships</li>
                        <li>Record layout structures</li>
                        <li>Program dependencies and business logic</li>
                        <li>COBOL to Oracle conversion guidance</li>
                    </ul>
                    <p>Ask me about any field, record layout, or program in your analysis!</p>
                </div>
            </div>
            <div class="chat-input-area">
                <textarea id="chatInput" class="chat-input" 
                         placeholder="Ask about fields, record layouts, or programs..."
                         onkeydown="handleChatKeydown(event)"></textarea>
                <div class="chat-controls">
                    <span class="token-counter" id="chatTokenCounter">0 tokens</span>
                    <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading"></div>
            <h3 id="loadingTitle">Processing...</h3>
            <p id="loadingMessage">Analyzing your files...</p>
            <div id="loadingProgress" style="margin-top: 1rem;">
                <div style="background: #e9ecef; border-radius: 10px; height: 6px; margin-bottom: 0.5rem;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="font-size: 0.9rem; color: #6c757d;">Starting analysis...</div>
            </div>
            <div id="analysisSteps" style="margin-top: 1rem; text-align: left; max-width: 400px;">
                <div class="analysis-step" id="step1">
                    <span class="step-icon">⏳</span> Parsing COBOL structure...
                </div>
                <div class="analysis-step" id="step2">
                    <span class="step-icon">⏳</span> Extracting components...
                </div>
                <div class="analysis-step" id="step3">
                    <span class="step-icon">⏳</span> Generating business summary...
                </div>
                <div class="analysis-step" id="step4">
                    <span class="step-icon">⏳</span> Storing results...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentSessionId = null;
        let currentConversationId = null;
        let fieldMatrixData = {};
        let componentsData = [];
        let llmConfig = {
            endpoint: 'http://localhost:8100/generate',
            maxTokens: 6000,
            temperature: 0.1,
            timeout: 60,
            retries: 3
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadLLMConfig();
            initializeSession();
            updateTokenCounters();
        });

        // LLM Configuration Management
        function loadLLMConfig() {
            const saved = localStorage.getItem('llmConfig');
            if (saved) {
                try {
                    llmConfig = { ...llmConfig, ...JSON.parse(saved) };
                    updateConfigForm();
                } catch (e) {
                    console.error('Error loading LLM config:', e);
                }
            }
        }

        function saveLLMConfig() {
            const endpoint = document.getElementById('llmEndpoint').value.trim();
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const timeout = parseInt(document.getElementById('timeout').value);
            const retries = parseInt(document.getElementById('retries').value);

            // Validation
            if (!endpoint) {
                showError('Please enter a valid VLLM endpoint URL');
                return;
            }

            if (maxTokens < 1000 || maxTokens > 32000) {
                showError('Max tokens must be between 1000 and 32000');
                return;
            }

            // Update config
            llmConfig = {
                endpoint,
                maxTokens,
                temperature,
                timeout,
                retries
            };

            // Save to localStorage
            localStorage.setItem('llmConfig', JSON.stringify(llmConfig));

            // Update backend configuration via API
            updateBackendConfig();

            closeConfigModal();
            showSuccess('LLM configuration saved successfully!');
        }

        async function updateBackendConfig() {
            try {
                const response = await fetch('/api/llm-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(llmConfig)
                });

                if (!response.ok) {
                    throw new Error('Failed to update backend configuration');
                }
            } catch (error) {
                console.error('Error updating backend config:', error);
                showError('Failed to update backend configuration');
            }
        }

        async function testLLMConnection() {
            const endpoint = document.getElementById('llmEndpoint').value.trim();
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const timeout = parseInt(document.getElementById('timeout').value);

            if (!endpoint) {
                showError('Please enter a VLLM endpoint URL first');
                return;
            }

            // Show testing status
            showConnectionStatus('testing', '🔄', 'Testing connection to VLLM server...');
            
            const testButton = document.querySelector('.btn-test');
            testButton.disabled = true;
            testButton.textContent = '🔄 Testing...';

            try {
                const startTime = Date.now();
                
                // Test connection with a simple prompt
                const response = await fetch('/api/test-llm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        endpoint,
                        maxTokens,
                        temperature,
                        timeout
                    })
                });

                const responseTime = Date.now() - startTime;

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        // Show success status
                        showConnectionStatus('success', '✅', 
                            `Connection successful! Server is responding normally.`);
                        
                        // Display server information
                        displayServerInfo({
                            model: data.model_name || 'Unknown',
                            contextLength: data.max_context_length || 'Unknown',
                            responseTime: `${responseTime}ms`,
                            status: 'Online'
                        });
                    } else {
                        showConnectionStatus('error', '❌', 
                            `Connection failed: ${data.error || 'Unknown error'}`);
                        hideServerInfo();
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('LLM connection test failed:', error);
                showConnectionStatus('error', '❌', 
                    `Connection failed: ${error.message}`);
                hideServerInfo();
            } finally {
                testButton.disabled = false;
                testButton.textContent = '🧪 Test Connection';
            }
        }

        function showConnectionStatus(type, icon, message) {
            const status = document.getElementById('connectionStatus');
            const statusIcon = document.getElementById('statusIcon');
            const statusMessage = document.getElementById('statusMessage');

            status.className = `connection-status ${type}`;
            status.style.display = 'flex';
            statusIcon.textContent = icon;
            statusMessage.textContent = message;
        }

        function displayServerInfo(info) {
            document.getElementById('modelName').textContent = info.model;
            document.getElementById('contextLength').textContent = info.contextLength;
            document.getElementById('responseTime').textContent = info.responseTime;
            document.getElementById('serverStatus').textContent = info.status;
            document.getElementById('serverInfo').style.display = 'block';
        }

        function hideServerInfo() {
            document.getElementById('serverInfo').style.display = 'none';
        }

        function openConfigModal() {
            updateConfigForm();
            document.getElementById('configModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Hide status messages
            document.getElementById('connectionStatus').style.display = 'none';
            hideServerInfo();
        }

        function updateConfigForm() {
            document.getElementById('llmEndpoint').value = llmConfig.endpoint;
            document.getElementById('maxTokens').value = llmConfig.maxTokens;
            document.getElementById('temperature').value = llmConfig.temperature;
            document.getElementById('timeout').value = llmConfig.timeout;
            document.getElementById('retries').value = llmConfig.retries;
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to default values?')) {
                llmConfig = {
                    endpoint: 'http://localhost:8100/generate',
                    maxTokens: 6000,
                    temperature: 0.1,
                    timeout: 60,
                    retries: 3
                };
                updateConfigForm();
                localStorage.removeItem('llmConfig');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('configModal');
            if (event.target === modal) {
                closeConfigModal();
            }
        }

        function showSuccess(message) {
            // Simple success notification - could be enhanced with a toast library
            alert('✅ ' + message);
        }

        // Session Management
        async function initializeSession() {
    try {
        // First, try to get existing session from localStorage
        const savedSessionId = localStorage.getItem('currentSessionId');
        if (savedSessionId) {
            currentSessionId = savedSessionId;
            currentConversationId = generateUUID();
            
            // Verify session exists on server
            const response = await fetch(`/api/components/${currentSessionId}`);
            if (response.ok) {
                console.log('Using existing session:', currentSessionId);
                document.getElementById('sessionId').textContent = currentSessionId.slice(0, 8) + '...';
                document.getElementById('projectName').textContent = 'Existing Project';
                return;
            }
        }
        
        // Create new session if no existing session or verification failed
        const response = await fetch('/api/session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ project_name: `Project_${new Date().toISOString().slice(0,19)}` })
        });

        if (response.ok) {
            const data = await response.json();
            currentSessionId = data.session_id;
            currentConversationId = generateUUID();
            
            // Save session ID to localStorage
            localStorage.setItem('currentSessionId', currentSessionId);
            
            document.getElementById('sessionId').textContent = currentSessionId.slice(0, 8) + '...';
            document.getElementById('projectName').textContent = data.project_name;
            
            console.log('New session initialized:', currentSessionId);
        } else {
            throw new Error('Failed to create session');
        }
    } catch (error) {
        console.error('Error initializing session:', error);
        showError('Failed to initialize session');
    }
}

        // Enhanced file upload with progress tracking
        async function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            showLoadingWithProgress('Uploading and analyzing files...');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    const content = await readFileContent(file);
                    const fileType = getFileType(file.name);
                    
                    updateLoadingProgress(
                        `Analyzing ${file.name} (${i + 1}/${files.length})...`,
                        (i / files.length) * 100,
                        `Processing ${file.name}`
                    );
                    
                    updateAnalysisStep(1, 'current', `Parsing ${file.name}...`);
                    
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: currentSessionId,
                            content: content,
                            filename: file.name,
                            file_type: fileType
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            console.log(`✅ Successfully analyzed ${file.name}:`, data.components.length, 'components');
                            componentsData = componentsData.concat(data.components);
                            
                            // Update progress steps
                            updateAnalysisStep(1, 'completed', `Parsed ${file.name}`);
                            updateAnalysisStep(2, 'completed', `Extracted ${data.components.length} components`);
                            updateAnalysisStep(3, 'completed', `Generated business summaries`);
                            updateAnalysisStep(4, 'completed', `Stored in database`);
                            console.log('Upload response:', data);
                            console.log('Components received:', data.components);

                            // Check if components have LLM summaries
                            data.components.forEach(component => {
                                console.log('Component:', component.name);
                                console.log('Business purpose:', component.business_purpose);
                                console.log('LLM summary:', component.llm_summary);
                            });
                            setTimeout(() => {
                            hideLoading();
                            refreshUI();  // Make sure this is called
                            loadComponentsList();  // Explicitly call this too
                            loadDashboardSummaries();  // And this
                        }, 1500);
                            

                        } else {
                            console.error(`❌ Error analyzing ${file.name}:`, data.error);
                            showErrorInStep(file.name, data.error);
                        }
                    }
                    
                    // In handleFileUpload, after successful processing:
                    
                } catch (error) {
                    console.error(`💥 Error processing ${file.name}:`, error);
                    showErrorInStep(file.name, error.message);
                }
            }

            updateLoadingProgress('Analysis complete!', 100, 'All files processed successfully');
            setTimeout(() => {
                hideLoading();
                refreshUI();
            }, 1500);
            
            event.target.value = ''; // Reset file input
        }

        function showLoadingWithProgress(title) {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            // Reset progress
            updateLoadingProgress('Starting analysis...', 0, 'Initializing...');
            resetAnalysisSteps();
        }

        function updateLoadingProgress(message, percentage, progressText) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = progressText;
        }

        function resetAnalysisSteps() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                step.className = 'analysis-step';
                step.innerHTML = step.innerHTML.replace(/✅|🔄|❌/g, '⏳');
            });
            
            // Reset text
            document.getElementById('step1').innerHTML = '<span class="step-icon">⏳</span> Parsing COBOL structure...';
            document.getElementById('step2').innerHTML = '<span class="step-icon">⏳</span> Extracting components...';
            document.getElementById('step3').innerHTML = '<span class="step-icon">⏳</span> Generating business summary...';
            document.getElementById('step4').innerHTML = '<span class="step-icon">⏳</span> Storing results...';
        }

        function updateAnalysisStep(stepNumber, status, message) {
            const stepElement = document.getElementById(`step${stepNumber}`);
            stepElement.className = `analysis-step ${status}`;
            
            let icon = '⏳';
            if (status === 'completed') icon = '✅';
            else if (status === 'current') icon = '🔄';
            else if (status === 'error') icon = '❌';
            
            if (message) {
                stepElement.innerHTML = `<span class="step-icon">${icon}</span> ${message}`;
            }
        }

        function showErrorInStep(fileName, error) {
            updateAnalysisStep(1, 'error', `Error parsing ${fileName}`);
            document.getElementById('progressText').textContent = `Error: ${error}`;
            document.getElementById('progressText').style.color = '#dc3545';
        }

        // File reading utility
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }

        // Get file type from extension
        function getFileType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const typeMap = {
                'cbl': 'COBOL',
                'cob': 'COBOL',
                'cpy': 'COPYBOOK',
                'jcl': 'JCL'
            };
            return typeMap[ext] || 'COBOL';
        }

        function exportFieldMappings() {
            const table = document.getElementById('fieldMappingTableBody');
            const rows = table.querySelectorAll('tr');
            
            if (rows.length === 0 || rows[0].textContent.includes('No field mappings')) {
                alert('No field mappings to export');
                return;
            }
            
            let csv = 'Field Name,Mainframe Data Type,Oracle Data Type,MF Length,Oracle Length,Population Source,Business Logic,Programs Involved\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                cells.forEach(cell => {
                    // Clean cell content
                    const text = cell.textContent.trim().replace(/\n/g, ' ').replace(/,/g, ';');
                    rowData.push(`"${text}"`);
                });
                csv += rowData.join(',') + '\n';
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `field_mappings_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        // Field Mapping Analysis
        async function analyzeFieldMapping() {
            const targetFile = document.getElementById('targetFileInput').value.trim();
            if (!targetFile) {
                showError('Please enter a target file name');
                return;
            }

            showLoading('Analyzing field mappings...');

            try {
                const response = await fetch('/api/field-mapping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        target_file: targetFile
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayFieldMappings(data.field_mappings);
                    } else {
                        showError(data.error || 'Failed to analyze field mappings');
                    }
                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error analyzing field mapping:', error);
                showError('Failed to analyze field mappings');
            }

            hideLoading();
        }

        
        
        // Display field mappings in table
        function displayFieldMappings(mappings) {
    const tbody = document.getElementById('fieldMappingTableBody');
    tbody.innerHTML = '';

    if (!mappings || mappings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No field mappings found</td></tr>';
        return;
    }

    mappings.forEach(mapping => {
        const row = document.createElement('tr');
        
        // Extract operations for modal
        const fieldOperations = extractFieldOperations(mapping);
        const operationsJson = JSON.stringify(fieldOperations).replace(/"/g, '&quot;');
        
        // Fix population source display
        let populationSource = mapping.population_source || 'N/A';
        if (populationSource === 'N/A' && mapping.business_logic_description) {
            // Try to extract from business logic description
            if (mapping.business_logic_description.includes('from')) {
                populationSource = mapping.business_logic_description;
            }
        }

        row.innerHTML = `
            <td>
                <strong style="cursor: pointer; color: #667eea; text-decoration: underline;" 
                        onclick="showFieldOperationsWithCode('${mapping.field_name}', '${operationsJson}', '${mapping.source_record_layout || ''}')"
                        title="Click to view operations and source code">
                    ${mapping.field_name}
                </strong><br>
                <small class="text-muted">${mapping.friendly_name || ''}</small>
                ${fieldOperations.length > 0 ? `<br><small class="text-info">${fieldOperations.length} operations</small>` : ''}
            </td>
            <td><code>${mapping.mainframe_data_type}</code></td>
            <td><code>${mapping.oracle_data_type}</code></td>
            <td>${mapping.mainframe_length}</td>
            <td>${mapping.oracle_length}</td>
            <td><strong>${populationSource}</strong></td>
            <td>
                <span class="badge ${getBadgeClass(mapping.business_logic_type)}">${mapping.business_logic_type}</span>
                <br><small>${mapping.business_logic_description || ''}</small>
            </td>
            <td>${Array.isArray(mapping.programs_involved) ? mapping.programs_involved.join(', ') : mapping.programs_involved || 'Unknown'}</td>
        `;
        tbody.appendChild(row);
    });
}

async function showFieldOperationsWithCode(fieldName, operationsJson, layoutName) {
    let operations;
    
    try {
        operations = JSON.parse(operationsJson.replace(/&quot;/g, '"'));
    } catch (error) {
        operations = [];
    }
    
    // Get source code from current session
    let sourceCode = '';
    try {
        const response = await fetch(`/api/field-source-code/${currentSessionId}/${fieldName}`);
        if (response.ok) {
            const data = await response.json();
            sourceCode = data.source_code || 'Source code not available';
        }
    } catch (error) {
        sourceCode = 'Error loading source code';
    }
    
    document.getElementById('fieldModalTitle').textContent = `${fieldName} - Operations & Source Code`;
    
    const content = document.getElementById('fieldOperationsContent');
    content.innerHTML = `
        <div style="margin-bottom: 1rem;">
            <h5>Field: <code>${fieldName}</code> from <code>${layoutName}</code></h5>
        </div>
        
        <div style="margin-bottom: 2rem;">
            <h6>Operations (${operations.length}):</h6>
            <div style="max-height: 200px; overflow-y: auto;">
    `;
    
    operations.forEach((op, index) => {
        const badgeClass = getBadgeClass(op.type);
        content.innerHTML += `
            <div style="border: 1px solid #dee2e6; border-radius: 6px; padding: 1rem; margin-bottom: 0.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>Operation ${index + 1}: ${op.type.replace('_', ' ')}</strong>
                    <span class="badge ${badgeClass}">${op.type}</span>
                </div>
                <div><strong>Description:</strong> ${op.description}</div>
                <div><strong>Code:</strong> <code>${op.code}</code></div>
            </div>
        `;
    });
    
    content.innerHTML += `
            </div>
        </div>
        
        <div>
            <h6>Complete Source Code Context:</h6>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; max-height: 300px; overflow-y: auto;">
                <pre style="margin: 0; white-space: pre-wrap; font-size: 0.8rem;">${sourceCode}</pre>
            </div>
        </div>
    `;
    
    document.getElementById('fieldOperationsModal').style.display = 'block';
}
        // Function to extract field operations from mapping data
        function extractFieldOperations(mapping) {
            const operations = [];
            
            try {
                // Extract from derivation_logic if available
                if (mapping.derivation_logic) {
                    operations.push({
                        type: 'DERIVATION',
                        line_number: 'Multiple',
                        code: mapping.derivation_logic,
                        description: 'Field derivation logic'
                    });
                }
                
                // Extract from business_logic_description
                if (mapping.business_logic_description) {
                    operations.push({
                        type: mapping.business_logic_type || 'PROCESSING',
                        line_number: 'Multiple',
                        code: mapping.business_logic_description,
                        description: 'Business logic implementation'
                    });
                }
                
                // Extract from population_source
                if (mapping.population_source && mapping.population_source !== 'N/A') {
                    let operationType = 'MOVE';
                    if (mapping.population_source.includes('CICS READ')) {
                        operationType = 'CICS_READ';
                    } else if (mapping.population_source.includes('CICS WRITE')) {
                        operationType = 'CICS_WRITE';
                    } else if (mapping.population_source.includes('CICS REWRITE')) {
                        operationType = 'CICS_REWRITE';
                    } else if (mapping.population_source.includes('Computed')) {
                        operationType = 'COMPUTE';
                    }
                    
                    operations.push({
                        type: operationType,
                        line_number: 'Runtime',
                        code: mapping.population_source,
                        description: 'Data population source'
                    });
                }
                
                // If we have source_record_layout, add layout reference
                if (mapping.source_record_layout) {
                    operations.push({
                        type: 'LAYOUT_REFERENCE',
                        line_number: 'Definition',
                        code: `Defined in ${mapping.source_record_layout}`,
                        description: 'Field definition location'
                    });
                }
                
                // Add confidence and program information
                if (mapping.programs_involved && mapping.programs_involved.length > 0) {
                    const programs = Array.isArray(mapping.programs_involved) 
                        ? mapping.programs_involved 
                        : [mapping.programs_involved];
                        
                    operations.push({
                        type: 'PROGRAM_USAGE',
                        line_number: 'Multiple',
                        code: `Used in: ${programs.join(', ')}`,
                        description: `Field is processed by ${programs.length} program(s)`
                    });
                }
                
            } catch (error) {
                console.error('Error extracting field operations:', error);
            }
            
            return operations;
        }

        // Updated showFieldOperations to handle string parameter
        function showFieldOperations(fieldName, operationsJson) {
            let operations;
            
            try {
                // Parse the operations JSON string
                operations = JSON.parse(operationsJson.replace(/&quot;/g, '"'));
            } catch (error) {
                console.error('Error parsing operations:', error);
                operations = [{
                    type: 'ERROR',
                    line_number: 'N/A',
                    code: 'Failed to load operations',
                    description: 'Error loading field operation details'
                }];
            }
            
            document.getElementById('fieldModalTitle').textContent = `${fieldName} - Field Operations`;
            
            const content = document.getElementById('fieldOperationsContent');
            content.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <h5>Field: <code>${fieldName}</code></h5>
                    <p>Found ${operations.length} operation(s) for this field:</p>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            operations.forEach((op, index) => {
                const badgeClass = getBadgeClass(op.type);
                
                content.innerHTML += `
                    <div class="operation-item" style="border: 1px solid #dee2e6; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background: #f8f9fa;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong>Operation ${index + 1}</strong>
                            <span class="badge ${badgeClass}">${op.type.replace('_', ' ')}</span>
                        </div>
                        
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Location:</strong> ${op.line_number}
                        </div>
                        
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Code/Logic:</strong>
                            <div style="background: white; padding: 0.5rem; border-radius: 4px; font-family: monospace; border: 1px solid #dee2e6; margin-top: 0.25rem;">
                                ${op.code}
                            </div>
                        </div>
                        
                        <div style="color: #6c757d; font-style: italic;">
                            <strong>Description:</strong> ${op.description}
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML += '</div>';
            document.getElementById('fieldOperationsModal').style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeFieldOperationsModal() {
            document.getElementById('fieldOperationsModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('fieldOperationsModal');
            if (event.target === modal) {
                closeFieldOperationsModal();
            }
        }
        // Add this function to load and display dependencies
        async function loadDependenciesVisualization() {
    try {
        console.log('Loading dependencies for session:', currentSessionId);
        
        const response = await fetch(`/api/dependencies/${currentSessionId}`);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Dependencies response:', data);
            
            if (data.success && data.dependencies && data.dependencies.length > 0) {
                displayCityView(data.dependencies, data.dependency_groups || {});
            } else {
                console.log('No dependencies found or response not successful');
                displayEmptyDependencies();
            }
        } else {
            console.error('Dependencies API response not ok:', response.status);
            displayEmptyDependencies();
        }
    } catch (error) {
        console.error('Error loading dependencies:', error);
        displayEmptyDependencies();
    }
}

function displayEmptyDependencies() {
    document.getElementById('coreComponents').innerHTML = 
        '<p class="text-muted">Upload and analyze COBOL programs to see system architecture</p>';
    ['inputSources', 'externalInterfaces', 'outputFiles', 'missingDependencies']
        .forEach(id => document.getElementById(id).innerHTML = '<p class="text-muted">No data available</p>');
}


function displayCityView(dependencies, dependencyGroups) {
    console.log('Displaying city view with', dependencies.length, 'dependencies');
    
    // Clear all sections
    ['inputSources', 'externalInterfaces', 'coreComponents', 'outputFiles', 'missingDependencies']
        .forEach(id => document.getElementById(id).innerHTML = '');
    
    const categorizedDeps = categorizeDependencies(dependencies);
    console.log('Categorized dependencies:', categorizedDeps);
    
    // Populate each section
    populateFlowSection('inputSources', categorizedDeps.inputs, 'input');
    populateFlowSection('externalInterfaces', categorizedDeps.interfaces, 'interface');
    populateFlowSection('coreComponents', categorizedDeps.components, 'component');
    populateFlowSection('outputFiles', categorizedDeps.outputs, 'output');
    populateFlowSection('missingDependencies', categorizedDeps.missing, 'missing');
}

function categorizeDependencies(dependencies) {
    const categorized = {
        inputs: new Set(),
        interfaces: new Set(), 
        components: new Set(),
        outputs: new Set(),
        missing: new Set()
    };
    
    dependencies.forEach(dep => {
        const source = dep.source_component;
        const target = dep.target_component; 
        const type = dep.relationship_type;
        
        console.log('Processing dependency:', source, '->', target, '(', type, ')');
        
        // Add source as core component
        categorized.components.add({
            name: source,
            friendly_name: generateFriendlyName(source),
            type: 'Program',
            confidence: dep.confidence_score || 0.8
        });
        
        // Categorize target based on relationship type
        if (type === 'INPUT_FILE' || type === 'FILE_ACCESS') {
            categorized.inputs.add({
                name: target,
                friendly_name: generateFriendlyName(target),
                type: 'Input File',
                confidence: dep.confidence_score || 0.8
            });
        } else if (type === 'OUTPUT_FILE') {
            categorized.outputs.add({
                name: target,
                friendly_name: generateFriendlyName(target),
                type: 'Output File', 
                confidence: dep.confidence_score || 0.8
            });
        } else if (type === 'CICS_FILE') {
            categorized.interfaces.add({
                name: target,
                friendly_name: generateFriendlyName(target),
                type: 'CICS Interface',
                confidence: dep.confidence_score || 0.8
            });
        } else if (type === 'PROGRAM_CALL') {
            categorized.components.add({
                name: target,
                friendly_name: generateFriendlyName(target),
                type: 'Called Program',
                confidence: dep.confidence_score || 0.8
            });
        } else {
            // Default to missing/unknown
            categorized.missing.add({
                name: target,
                friendly_name: generateFriendlyName(target),
                type: type.replace('_', ' '),
                confidence: dep.confidence_score || 0.5,
                reason: 'Unknown relationship type'
            });
        }
    });
    
    // Convert Sets to Arrays
    Object.keys(categorized).forEach(key => {
        categorized[key] = Array.from(categorized[key]);
    });
    
    console.log('Final categorized dependencies:', categorized);
    return categorized;
}

function generateFriendlyName(technicalName) {
    if (!technicalName) return 'Unknown';
    
    return technicalName
        .replace(/[-_]/g, ' ')
        .toLowerCase()
        .replace(/\b\w/g, l => l.toUpperCase())
        .replace(/\bWs\b/g, 'Working Storage')
        .replace(/\bFd\b/g, 'File Description')
        .replace(/\bMq\b/g, 'Message Queue')
        .replace(/\bDb2\b/g, 'DB2')
        .replace(/\bCics\b/g, 'CICS')
        .replace(/\bXml\b/g, 'XML')
        .replace(/\bJson\b/g, 'JSON')
        .replace(/\bSql\b/g, 'SQL')
        .replace(/\bAcc\b/g, 'Account')
        .replace(/\bCust\b/g, 'Customer')
        .replace(/\bTxn\b/g, 'Transaction')
        .replace(/\bRec\b/g, 'Record')
        .replace(/\bTbl\b/g, 'Table');
}

        function populateFlowSection(sectionId, items, sectionType) {
    const container = document.getElementById(sectionId);
    
    if (!items || items.length === 0) {
        container.innerHTML = `<p class="text-muted">No ${sectionType} dependencies found</p>`;
        return;
    }
    
    items.forEach(item => {
        const flowItem = document.createElement('div');
        flowItem.className = 'flow-item';
        flowItem.onclick = () => showItemDetails(item);
        
        const confidence = item.confidence ? `${(item.confidence * 100).toFixed(0)}%` : 'N/A';
        
        flowItem.innerHTML = `
            <div class="flow-item-title">${item.friendly_name || item.name}</div>
            <div class="flow-item-type">${item.type}</div>
            <div style="font-size: 0.65rem; color: #888; margin-top: 0.25rem;">
                ${item.name !== (item.friendly_name || item.name) ? `Technical: ${item.name}<br>` : ''}
                Confidence: ${confidence}
            </div>
            ${item.reason ? `<div style="font-size: 0.7rem; color: #dc3545; margin-top: 0.25rem;">${item.reason}</div>` : ''}
        `;
        
        container.appendChild(flowItem);
    });
}

        function showItemDetails(item) {
            alert(`Details for ${item.name}:\nType: ${item.type}\nConfidence: ${item.confidence || 'N/A'}`);
        }

        // Add this function to display dependencies
        function displayDependenciesTable(dependencies, dependencyGroups) {
            const container = document.getElementById('dependenciesVisualization');
            
            if (!dependencies || dependencies.length === 0) {
                container.innerHTML = '<p class="text-muted">No dependencies found. Upload and analyze COBOL programs to see component relationships.</p>';
                return;
            }
            
            let html = `
                <div style="margin-bottom: 1rem;">
                    <h4>Found ${dependencies.length} dependencies in ${Object.keys(dependencyGroups).length} categories</h4>
                </div>
            `;
            
            // Display by groups
            Object.entries(dependencyGroups).forEach(([groupType, deps]) => {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h5 style="color: #667eea; margin-bottom: 1rem;">
                            ${groupType.replace('_', ' ')} (${deps.length})
                        </h5>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Source Component</th>
                                    <th>Target Component</th>
                                    <th>Interface Type</th>
                                    <th>Confidence</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                deps.forEach(dep => {
                    const confidence = (dep.confidence_score * 100).toFixed(0);
                    const details = dep.details.operation || dep.details.line_number || 'N/A';
                    
                    html += `
                        <tr>
                            <td><strong>${dep.source_component}</strong></td>
                            <td><strong>${dep.target_component}</strong></td>
                            <td><span class="badge badge-primary">${dep.interface_type}</span></td>
                            <td>${confidence}%</td>
                            <td>${details}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }


        // Load field matrix data
        // Load field matrix data
async function loadFieldMatrix() {
    const recordLayout = document.getElementById('recordLayoutSelect').value;
    const program = document.getElementById('programSelect').value;

    if (!recordLayout && !program) {
        return;
    }

    showLoading('Loading field matrix...');

    try {
        const params = new URLSearchParams({
            session_id: currentSessionId
        });
        
        if (recordLayout) params.append('record_layout', recordLayout);
        if (program) params.append('program_name', program);

        const response = await fetch(`/api/field-matrix?${params}`);
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                displayFieldMatrix(data.matrix_data);
            } else {
                showError(data.error || 'Failed to load field matrix');
            }
        } else {
            throw new Error('Network error');
        }
    } catch (error) {
        console.error('Error loading field matrix:', error);
        showError('Failed to load field matrix');
    }

    hideLoading();
}
        // Fixed loadFieldMatrixSelectors function
async function loadFieldMatrixSelectors() {
    try {
        // Load record layouts from dedicated API endpoint
        const [componentsResponse, layoutsResponse] = await Promise.all([
            fetch(`/api/components/${currentSessionId}`),
            fetch(`/api/record-layouts/${currentSessionId}`)
        ]);
        
        if (componentsResponse.ok) {
            const componentsData = await componentsResponse.json();
            if (componentsData.success) {
                populateProgramSelectors(componentsData.components);
            }
        }
        
        if (layoutsResponse.ok) {
            const layoutsData = await layoutsResponse.json();
            if (layoutsData.success) {
                populateLayoutSelectors(layoutsData.layouts);
            }
        } else {
            console.log('No dedicated record layouts endpoint, extracting from components');
            // Fallback to extracting layouts from components
            if (componentsResponse.ok) {
                const componentsData = await componentsResponse.json();
                if (componentsData.success) {
                    extractLayoutsFromComponents(componentsData.components);
                }
            }
        }
    } catch (error) {
        console.error('Error loading selectors:', error);
    }
}

// Populate program selectors
function populateProgramSelectors(components) {
    const programSelect = document.getElementById('programSelect');
    programSelect.innerHTML = '<option value="">Select Program</option>';

    const programs = components.filter(c => c.component_type === 'PROGRAM');
    
    programs.forEach(program => {
        const option = document.createElement('option');
        option.value = program.component_name;
        option.textContent = `${program.component_name} (${program.total_lines || 0} lines)`;
        programSelect.appendChild(option);
    });
}

// Populate layout selectors from dedicated API
function populateLayoutSelectors(layouts) {
    const recordLayoutSelect = document.getElementById('recordLayoutSelect');
    recordLayoutSelect.innerHTML = '<option value="">Select Record Layout</option>';

    layouts.forEach(layout => {
        const option = document.createElement('option');
        option.value = layout.layout_name;
        option.textContent = `${layout.layout_name} (${layout.fields_count || 0} fields) - ${layout.program_name}`;
        recordLayoutSelect.appendChild(option);
    });
}

// Fallback: Extract layouts from components
function extractLayoutsFromComponents(components) {
    const recordLayoutSelect = document.getElementById('recordLayoutSelect');
    recordLayoutSelect.innerHTML = '<option value="">Select Record Layout</option>';

    const layouts = new Set();
    
    components.forEach(component => {
        if (component.component_type === 'PROGRAM' && component.analysis_result_json) {
            try {
                const analysisResult = JSON.parse(component.analysis_result_json);
                if (analysisResult.record_layouts) {
                    analysisResult.record_layouts.forEach(layout => {
                        if (layout.name) {
                            layouts.add({
                                name: layout.name,
                                program: component.component_name,
                                fields: layout.fields ? layout.fields.length : 0
                            });
                        }
                    });
                }
            } catch (e) {
                console.warn('Could not parse analysis result for', component.component_name);
            }
        }
    });

    Array.from(layouts).forEach(layout => {
        const option = document.createElement('option');
        option.value = layout.name;
        option.textContent = `${layout.name} (${layout.fields} fields) - ${layout.program}`;
        recordLayoutSelect.appendChild(option);
    });
}

        // Display field matrix
        function displayFieldMatrix(matrixData) {
            const tbody = document.getElementById('fieldMatrixTableBody');
            tbody.innerHTML = '';

            if (matrixData.program_layouts) {
                // Program view with collapsible layouts
                matrixData.program_layouts.forEach((layout, layoutIndex) => {
                    // Layout header row
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'collapsible-row';
                    headerRow.onclick = () => toggleLayoutFields(layoutIndex);
                    
                    headerRow.innerHTML = `
                        <td>
                            <span class="expand-icon" id="expand-${layoutIndex}">▶</span>
                            <strong>${layout.layout_name}</strong>
                            <br><small class="text-muted">${layout.friendly_name}</small>
                        </td>
                        <td colspan="5">
                            <span class="badge badge-primary">Level ${layout.level}</span>
                            ${layout.fields.length} fields
                        </td>
                    `;
                    tbody.appendChild(headerRow);

                    // Fields rows (initially hidden)
                    const fieldsContainer = document.createElement('tbody');
                    fieldsContainer.id = `fields-${layoutIndex}`;
                    fieldsContainer.className = 'sub-fields';
                    
                    layout.fields.forEach(field => {
                        const fieldRow = document.createElement('tr');
                        fieldRow.className = 'sub-field-row';
                        
                        const usageClass = `usage-${field.usage_type.toLowerCase()}`;
                        
                        fieldRow.innerHTML = `
                            <td>
                                ${field.field_name}
                                <br><small class="text-muted">${field.friendly_name || ''}</small>
                            </td>
                            <td>
                                <span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type}</span>
                                <br><small>${field.usage_description || ''}</small>
                            </td>
                            <td>${field.source_field || 'N/A'}</td>
                            <td>${field.business_purpose || 'N/A'}</td>
                            <td>${field.program_name || 'N/A'}</td>
                            <td>${field.line_number || 'N/A'}</td>
                        `;
                        fieldRow.className += ` ${usageClass}`;
                        fieldsContainer.appendChild(fieldRow);
                    });
                    
                    tbody.appendChild(fieldsContainer);
                });
            } else if (matrixData.fields) {
                // Simple field list view
                matrixData.fields.forEach(field => {
                    const row = document.createElement('tr');
                    const usageClass = `usage-${field.usage_type.toLowerCase()}`;
                    
                    row.innerHTML = `
                        <td>
                            ${field.field_name}
                            <br><small class="text-muted">${field.friendly_name || ''}</small>
                        </td>
                        <td>
                            <span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type}</span>
                            <br><small>${field.usage_description || ''}</small>
                        </td>
                        <td>${field.source_field || 'N/A'}</td>
                        <td>${field.business_purpose || 'N/A'}</td>
                        <td>${field.program_name || 'N/A'}</td>
                        <td>${field.line_number || 'N/A'}</td>
                    `;
                    row.className = usageClass;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No field data available</td></tr>';
            }
        }

        // Toggle layout fields visibility
        function toggleLayoutFields(layoutIndex) {
            const fieldsContainer = document.getElementById(`fields-${layoutIndex}`);
            const expandIcon = document.getElementById(`expand-${layoutIndex}`);
            
            if (fieldsContainer.classList.contains('show')) {
                fieldsContainer.classList.remove('show');
                expandIcon.textContent = '▶';
                expandIcon.classList.remove('expanded');
            } else {
                fieldsContainer.classList.add('show');
                expandIcon.textContent = '▼';
                expandIcon.classList.add('expanded');
            }
        }

        // Chat functionality
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message to chat
            addChatMessage('user', message);
            input.value = '';
            updateChatTokenCounter();

            // Show typing indicator
            const typingId = addChatMessage('assistant', '💭 Thinking...');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message: message,
                        conversation_id: currentConversationId
                    })
                });

               if (response.ok) {
                    const data = await response.json();
                    
                    // Remove typing indicator
                    document.getElementById(typingId).remove();
                    
                    if (data.success) {
                        // Fix: Extract the actual response content
                        const responseContent = data.response || data.content || data.message || 'No response';
                        addChatMessage('assistant', responseContent);  // Pass string, not object
                        
                        // Update token usage if provided
                        if (data.tokens_used) {
                            updateTokenCounters();
                        }
                    } else {
                        addChatMessage('assistant', data.error || 'Sorry, I encountered an error.');
                    }

                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error sending chat message:', error);
                document.getElementById(typingId).remove();
                addChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            }
        }

        // Add message to chat
        function addChatMessage(type, message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${type}`;
            
            // Fix the [object][object] issue
            let displayMessage = '';
            if (typeof message === 'string') {
                displayMessage = message;
            } else if (typeof message === 'object') {
                // Handle object responses from API
                if (message.response) {
                    displayMessage = message.response;
                } else if (message.content) {
                    displayMessage = message.content;
                } else {
                    displayMessage = JSON.stringify(message, null, 2);
                }
            } else {
                displayMessage = String(message);
            }
            
            // Handle markdown-like formatting
            const formattedMessage = displayMessage
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `<p>${formattedMessage}</p>`;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageId;
        }

        // Handle chat input keydown
        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
            updateChatTokenCounter();
        }

        // Update chat token counter
        function updateChatTokenCounter() {
            const input = document.getElementById('chatInput');
            const counter = document.getElementById('chatTokenCounter');
            const tokenCount = Math.ceil(input.value.length / 4); // Rough estimation
            counter.textContent = `${tokenCount} tokens`;
        }

        // Tab Management
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load data if needed
            if (tabName === 'components') {
                loadComponentsTable();
            } else if (tabName === 'fieldMatrix') {
                loadFieldMatrixSelectors();
            } else if (tabName === 'dashboard') {
                loadDashboardSummaries();
            } else if (tabName === 'dependencies') {
                loadDependenciesVisualization();  // Add this line
          }

        }

        // Panel Management
        function togglePanel(side) {
            const panel = document.getElementById(side + 'Panel');
            const isCollapsed = panel.classList.contains('collapsed');
            
            if (isCollapsed) {
                // Restore panel
                panel.classList.remove('collapsed');
                removeRestoreButton(side);
            } else {
                // Collapse panel
                panel.classList.add('collapsed');
                addRestoreButton(side);
            }
        }

        function addRestoreButton(side) {
            const existing = document.getElementById(`restore-${side}`);
            if (existing) existing.remove();
            
            const button = document.createElement('button');
            button.id = `restore-${side}`;
            button.className = `panel-restore ${side}`;
            button.textContent = side === 'left' ? '📁' : '💬';
            button.title = `Restore ${side} panel`;
            button.onclick = () => togglePanel(side);
            
            document.body.appendChild(button);
        }

        function removeRestoreButton(side) {
            const button = document.getElementById(`restore-${side}`);
            if (button) button.remove();
        }

        // Load components table with hierarchy support
        async function loadComponentsTable() {
            try {
                const response = await fetch(`/api/components/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayComponentsHierarchy(data.components);
                    }
                }
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        // Display components in hierarchical structure
              
        // Fixed displayComponentsHierarchy function
function displayComponentsHierarchy(components) {
    const mainProgramsBody = document.getElementById('mainProgramsTableBody');
    const derivedComponentsBody = document.getElementById('derivedComponentsTableBody');
    
    mainProgramsBody.innerHTML = '';
    derivedComponentsBody.innerHTML = '';

    const mainPrograms = components.filter(c => c.component_type === 'PROGRAM');
    const derivedComponents = components.filter(c => c.component_type !== 'PROGRAM');

    console.log('Main programs:', mainPrograms.length);
    console.log('Derived components:', derivedComponents.length);
    console.log('All components:', components);

    if (mainPrograms.length === 0) {
        mainProgramsBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No programs available</td></tr>';
        return;
    }

    // Store derived components globally for the toggle function
    window.derivedComponentsData = {};
    
    // Group derived components by parent program
    derivedComponents.forEach(component => {
        // Try multiple ways to find parent program
        let parent = component.parent_program || 
                    component.program_name || 
                    (component.analysis_result_json ? 
                        JSON.parse(component.analysis_result_json).parent_program : null) ||
                    'Unknown';
        
        if (!window.derivedComponentsData[parent]) {
            window.derivedComponentsData[parent] = [];
        }
        window.derivedComponentsData[parent].push(component);
    });

    mainPrograms.forEach(program => {
        const row = document.createElement('tr');
        
        let businessPurpose = program.business_purpose || 'Analysis complete';
        let complexity = program.complexity_score || 0;
        let derivedCount = 0;
        
        try {
            if (program.analysis_result_json) {
                const analysisResult = JSON.parse(program.analysis_result_json);
                
                // Check for derived components in multiple places
                if (analysisResult.derived_components) {
                    derivedCount = analysisResult.derived_components.length;
                } else if (analysisResult.record_layouts) {
                    derivedCount = analysisResult.record_layouts.length;
                }
                
                if (!businessPurpose && analysisResult.business_purpose) {
                    businessPurpose = analysisResult.business_purpose;
                }
                
                if (analysisResult.llm_summary) {
                    businessPurpose = analysisResult.llm_summary.business_purpose || businessPurpose;
                    complexity = analysisResult.llm_summary.complexity_score || complexity;
                }
            }
        } catch (e) {
            console.warn('Analysis result parsing failed for', program.component_name, e);
        }
        
        // Also count from our grouped derived components
        const programDerivedCount = window.derivedComponentsData[program.component_name] ? 
            window.derivedComponentsData[program.component_name].length : 0;
        derivedCount = Math.max(derivedCount, programDerivedCount);
        
        row.innerHTML = `
            <td>
                <strong>${program.component_name}</strong>
                <br><small class="text-muted">${program.friendly_name || ''}</small>
                <div class="complexity-bar">
                    <div class="complexity-fill" style="width: ${complexity * 100}%"></div>
                </div>
            </td>
            <td style="max-width: 250px;">${businessPurpose}</td>
            <td>
                <div><strong>${program.total_lines || 0}</strong> total</div>
                <div><small>${program.executable_lines || 0} executable</small></div>
            </td>
            <td>${(complexity * 100).toFixed(0)}%</td>
            <td>
                <span class="derived-count">${derivedCount}</span>
                ${derivedCount > 0 ? `<button class="expand-btn" onclick="toggleDerivedComponents('${program.component_name}')">View Derived</button>` : ''}
            </td>
            <td>
                <button class="btn btn-secondary btn-sm" onclick="viewComponentDetails('${program.component_name}')">View Details</button>
            </td>
        `;
        mainProgramsBody.appendChild(row);
    });
}
        // Toggle derived components display
        function toggleDerivedComponents(programName) {
            const section = document.getElementById('derivedComponentsSection');
            const tbody = document.getElementById('derivedComponentsTableBody');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                displayDerivedComponents(programName);
            } else {
                section.style.display = 'none';
            }
        }

        // Display derived components for a specific program
        function displayDerivedComponents(programName) {
            const tbody = document.getElementById('derivedComponentsTableBody');
            tbody.innerHTML = '';

            const derivedComponents = window.derivedComponentsData[programName] || [];
            
            if (derivedComponents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No derived components found</td></tr>';
                return;
            }

            derivedComponents.forEach(component => {
                const row = document.createElement('tr');
                
                let details = '';
                if (component.component_type === 'RECORD_LAYOUT') {
                    details = `${component.fields ? component.fields.length : 0} fields, Level ${component.level}`;
                } else if (component.component_type === 'CICS_FILE') {
                    details = `${component.access_pattern || 'Unknown'} access, ${component.operations ? component.operations.length : 0} operations`;
                } else if (component.component_type === 'COPYBOOK_REFERENCE') {
                    details = `Line ${component.line_number}`;
                }
                
                row.innerHTML = `
                    <td>
                        <strong>${component.component_name || component.name}</strong>
                        <br><small class="text-muted">${component.friendly_name || ''}</small>
                    </td>
                    <td><span class="badge badge-primary">${component.component_type}</span></td>
                    <td>${component.parent_program || 'N/A'}</td>
                    <td style="max-width: 200px;">${component.business_purpose || 'N/A'}</td>
                    <td>${details}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter components
        function filterComponents() {
            const typeFilter = document.getElementById('componentTypeFilter').value;
            const searchFilter = document.getElementById('componentSearchFilter').value.toLowerCase();
            
            // This would filter the displayed components
            // Implementation depends on current display structure
        }

        // Show component hierarchy view
        function showComponentHierarchy() {
            // Toggle between flat and hierarchical view
            const derivedSection = document.getElementById('derivedComponentsSection');
            if (derivedSection.style.display === 'none') {
                derivedSection.style.display = 'block';
                // Show all derived components
                const allDerived = [];
                Object.values(window.derivedComponentsData || {}).forEach(components => {
                    allDerived.push(...components);
                });
                
                const tbody = document.getElementById('derivedComponentsTableBody');
                tbody.innerHTML = '';
                
                allDerived.forEach(component => {
                    const row = document.createElement('tr');
                    
                    let details = '';
                    if (component.component_type === 'RECORD_LAYOUT') {
                        details = `${component.fields ? component.fields.length : 0} fields, Level ${component.level}`;
                    } else if (component.component_type === 'CICS_FILE') {
                        details = `${component.access_pattern || 'Unknown'} access`;
                    } else if (component.component_type === 'COPYBOOK_REFERENCE') {
                        details = `Line ${component.line_number}`;
                    }
                    
                    row.innerHTML = `
                        <td>
                            <strong>${component.component_name || component.name}</strong>
                            <br><small class="text-muted">${component.friendly_name || ''}</small>
                        </td>
                        <td><span class="badge badge-primary">${component.component_type}</span></td>
                        <td>${component.parent_program || 'N/A'}</td>
                        <td style="max-width: 200px;">${component.business_purpose || 'N/A'}</td>
                        <td>${details}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                derivedSection.style.display = 'none';
            }
        }

        // View component details
        function viewComponentDetails(componentName) {
            // Replace the alert with actual implementation
            showComponentModal(componentName);
        }

        function showComponentModal(componentName) {
            // Find the component data
            const component = componentsData.find(c => c.component_name === componentName);
            if (!component) return;
            
            // Create modal content showing detailed component information
            const modalContent = `
                <div class="modal">
                    <div class="modal-content">
                        <h3>${componentName} Details</h3>
                        <pre>${JSON.stringify(component, null, 2)}</pre>
                        <button onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        // Enhanced dashboard with component summaries
        async function loadDashboardSummaries() {
            try {
                const response = await fetch(`/api/components/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayComponentSummaries(data.components);
                        displayDomainAnalysis(data.components);
                        updateDashboardMetrics(data.components);
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard summaries:', error);
            }
        }

        // Display component summaries on dashboard
        function displayComponentSummaries(components) {
            const container = document.getElementById('componentSummaries');
            container.innerHTML = '';

            const programs = components.filter(c => c.component_type === 'PROGRAM');
            
            if (programs.length === 0) {
                container.innerHTML = '<p class="text-muted">Upload COBOL files to see AI-generated business summaries</p>';
                return;
            }

            programs.forEach(program => {
                console.log('🔍 Processing program:', program.component_name);
                console.log('📊 Direct business_purpose:', program.business_purpose);
                console.log('📋 Analysis JSON length:', program.analysis_result_json ? program.analysis_result_json.length : 'null');
                
                let businessPurpose = 'Analysis in progress...';
                let complexityScore = 0;
                let derivedCount = 0;
                
                // First try direct fields
                if (program.business_purpose && program.business_purpose !== '' && program.business_purpose !== 'Analysis in progress...') {
                    businessPurpose = program.business_purpose;
                }
                
                // Then try parsing JSON
                try {
                    if (program.analysis_result_json && program.analysis_result_json !== '{}' && program.analysis_result_json.length > 10) {
                        const analysisResult = JSON.parse(program.analysis_result_json);
                        console.log('📈 Parsed analysis keys:', Object.keys(analysisResult));
                        
                        // Extract business purpose
                        if (!businessPurpose || businessPurpose === 'Analysis in progress...') {
                            businessPurpose = analysisResult.business_purpose || businessPurpose;
                        }
                        
                        // Extract from LLM summary
                        if (analysisResult.llm_summary) {
                            console.log('🤖 Found LLM summary:', analysisResult.llm_summary);
                            businessPurpose = analysisResult.llm_summary.business_purpose || businessPurpose;
                            complexityScore = analysisResult.llm_summary.complexity_score || 0;
                        }
                        
                        // Extract derived components count
                        if (analysisResult.derived_components) {
                            derivedCount = analysisResult.derived_components.length;
                            console.log('🔗 Found', derivedCount, 'derived components');
                        } else if (analysisResult.record_layouts) {
                            derivedCount = analysisResult.record_layouts.length;
                            console.log('📋 Found', derivedCount, 'record layouts');
                        }
                    } else {
                        console.log('⚠️ Empty or invalid analysis_result_json');
                    }
                } catch (e) {
                    console.error('❌ JSON parsing failed for', program.component_name, ':', e);
                }
                
                console.log(`📊 Final values: purpose="${businessPurpose.substring(0,50)}...", complexity=${complexityScore}, derived=${derivedCount}`);
                
                // Rest of the card creation code...
                const card = document.createElement('div');
                card.className = 'component-summary-card';
                
                card.innerHTML = `
                    <div class="component-header">
                        <div>
                            <div class="component-title">${program.component_name}</div>
                            <div class="text-muted" style="font-size: 0.8rem;">${program.friendly_name || ''}</div>
                        </div>
                        <span class="component-type badge badge-primary">PROGRAM</span>
                    </div>
                    
                    <div class="business-purpose">${businessPurpose}</div>
                    
                    <div class="component-metrics">
                        <div class="metric">
                            <span class="metric-value">${program.total_lines || 0}</span>
                            <span class="metric-label">Lines</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${(complexityScore * 100).toFixed(0)}%</span>
                            <span class="metric-label">Complexity</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${derivedCount}</span>
                            <span class="metric-label">Derived</span>
                        </div>
                    </div>
                    
                    <div class="complexity-bar">
                        <div class="complexity-fill" style="width: ${complexityScore * 100}%"></div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Display domain analysis
        function displayDomainAnalysis(components) {
            const container = document.getElementById('domainAnalysis');
            container.innerHTML = '';

            const programs = components.filter(c => c.component_type === 'PROGRAM' && c.llm_summary);
            const domains = {};
            
            programs.forEach(program => {
                const domain = program.llm_summary.business_domain || 'GENERAL';
                domains[domain] = (domains[domain] || 0) + 1;
            });

            Object.entries(domains).forEach(([domain, count]) => {
                const card = document.createElement('div');
                card.style = `
                    background: white;
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    padding: 1rem;
                    text-align: center;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                
                card.innerHTML = `
                    <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${count}</div>
                    <div style="font-size: 0.9rem; color: #6c757d;">${domain}</div>
                    <div style="font-size: 0.8rem; margin-top: 0.5rem;">
                        <span class="domain-badge domain-${domain.toLowerCase()}">${domain.replace('_', ' ')}</span>
                    </div>
                `;
                
                container.appendChild(card);
            });

            if (Object.keys(domains).length === 0) {
                container.innerHTML = '<p class="text-muted" style="text-align: center; grid-column: 1 / -1;">No domain analysis available yet</p>';
            }
        }

        // Update dashboard metrics with analysis data
        function updateDashboardMetrics(components) {
            const programs = components.filter(c => c.component_type === 'PROGRAM');
            const recordLayouts = components.filter(c => c.component_type === 'RECORD_LAYOUT');
            const cicsFiles = components.filter(c => c.component_type === 'CICS_FILE');
            
            document.getElementById('parsedPrograms').textContent = programs.length;
            document.getElementById('recordLayouts').textContent = recordLayouts.length;
            document.getElementById('cicsFiles').textContent = cicsFiles.length;
            
            // Calculate average complexity
            const programsWithComplexity = programs.filter(p => p.llm_summary && p.llm_summary.complexity_score);
            if (programsWithComplexity.length > 0) {
                const avgComplexity = programsWithComplexity.reduce((sum, p) => sum + p.llm_summary.complexity_score, 0) / programsWithComplexity.length;
                document.getElementById('avgComplexity').textContent = (avgComplexity * 100).toFixed(0) + '%';
            }
        }

        // Load field matrix selectors
        async function loadFieldMatrixSelectors() {
            try {
                // Load record layouts
                const components = await fetch(`/api/components/${currentSessionId}`);
                if (components.ok) {
                    const data = await components.json();
                    if (data.success) {
                        populateSelectors(data.components);
                    }
                }
            } catch (error) {
                console.error('Error loading selectors:', error);
            }
        }

        // Populate selector dropdowns
        function populateSelectors(components) {
            const recordLayoutSelect = document.getElementById('recordLayoutSelect');
            const programSelect = document.getElementById('programSelect');

            // Clear existing options
            recordLayoutSelect.innerHTML = '<option value="">Select Record Layout</option>';
            programSelect.innerHTML = '<option value="">Select Program</option>';

            const layouts = new Set();
            const programs = new Set();

            components.forEach(component => {
                if (component.component_type === 'RECORD_LAYOUT') {
                    layouts.add(component.component_name);
                } else if (component.component_type === 'PROGRAM') {
                    programs.add(component.component_name);
                }
            });

            // Populate dropdowns
            layouts.forEach(layout => {
                const option = document.createElement('option');
                option.value = layout;
                option.textContent = layout;
                recordLayoutSelect.appendChild(option);
            });

            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program;
                option.textContent = program;
                programSelect.appendChild(option);
            });
        }

        // UI Refresh
        async function refreshUI() {
            await loadMetrics();
            await loadComponentsList();
        }

        // Load session metrics
        async function loadMetrics() {
            try {
                const response = await fetch(`/api/session-metrics/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateMetricsDisplay(data.metrics);
                    }
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        // Update metrics display
        function updateMetricsDisplay(metrics) {
            document.getElementById('totalComponents').textContent = metrics.total_components || 0;
            document.getElementById('totalPrograms').textContent = metrics.component_counts?.PROGRAM || 0;
            document.getElementById('totalFields').textContent = metrics.total_fields || 0;
            document.getElementById('totalTokens').textContent = 
                (metrics.token_usage?.total_prompt_tokens || 0) + (metrics.token_usage?.total_response_tokens || 0);

            // Update detailed token display
            document.getElementById('analysisTokens').textContent = 
                (metrics.token_usage?.total_prompt_tokens || 0) + (metrics.token_usage?.total_response_tokens || 0);
            document.getElementById('totalTokensDetailed').textContent = 
                (metrics.token_usage?.total_prompt_tokens || 0) + (metrics.token_usage?.total_response_tokens || 0);
        }

        // Load components list for left panel
        async function loadComponentsList() {
            try {
                const response = await fetch(`/api/components/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateComponentsList(data.components);
                    }
                }
            } catch (error) {
                console.error('Error loading components list:', error);
            }
        }

        // Update components list display
        function updateComponentsList(components) {
    const container = document.getElementById('componentsList');
    container.innerHTML = '';

    console.log('Updating components list with:', components);

    if (!components || components.length === 0) {
        container.innerHTML = '<p class="text-muted">No components uploaded yet</p>';
        return;
    }

    const list = document.createElement('div');
    const typeGroups = {};

    // Group by type
    components.forEach(component => {
        const type = component.component_type;
        if (!typeGroups[type]) {
            typeGroups[type] = [];
        }
        typeGroups[type].push(component);
    });

    console.log('Grouped components:', typeGroups);

    // Display grouped components
    Object.keys(typeGroups).forEach(type => {
        const typeHeader = document.createElement('h5');
        typeHeader.textContent = `${type}s (${typeGroups[type].length})`;
        typeHeader.style.color = '#667eea';
        typeHeader.style.marginTop = '1rem';
        typeHeader.style.fontSize = '0.9rem';
        list.appendChild(typeHeader);

        typeGroups[type].forEach(component => {
            const item = document.createElement('div');
            item.style.padding = '0.5rem';
            item.style.borderLeft = '3px solid #667eea';
            item.style.paddingLeft = '0.5rem';
            item.style.marginBottom = '0.5rem';
            item.style.backgroundColor = '#f8f9ff';
            item.style.borderRadius = '4px';
            item.style.cursor = 'pointer';
            
            let businessPurpose = component.business_purpose || 'Analysis pending';
            
            // Try to extract from analysis_result_json if available
            try {
                if (component.analysis_result_json) {
                    const analysis = JSON.parse(component.analysis_result_json);
                    if (analysis.llm_summary && analysis.llm_summary.business_purpose) {
                        businessPurpose = analysis.llm_summary.business_purpose;
                    }
                }
            } catch (e) {
                console.warn('Could not parse analysis for', component.component_name);
            }
            
            item.innerHTML = `
                <div style="font-weight: bold; font-size: 0.8rem;">${component.component_name}</div>
                <div style="font-size: 0.7rem; color: #666; margin-top: 0.2rem;">
                    ${component.total_lines || 0} lines
                </div>
                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem; 
                           max-height: 2.4em; overflow: hidden; line-height: 1.2em;">
                    ${businessPurpose}
                </div>
            `;
            
            // Add click handler to show more details
            item.onclick = () => {
                alert(`${component.component_name}\n\nLines: ${component.total_lines || 0}\n\nPurpose: ${businessPurpose}`);
            };
            
            list.appendChild(item);
        });
    });

    container.appendChild(list);
}

        // Utility functions
        function updateTokenCounters() {
            // This would normally fetch real token usage from the server
            // For now, we'll update based on components loaded
            const totalComponents = componentsData.length;
            const estimatedTokens = totalComponents * 1500; // Rough estimate
            
            document.getElementById('totalTokens').textContent = estimatedTokens;
            document.getElementById('analysisTokens').textContent = estimatedTokens;
            document.getElementById('totalTokensDetailed').textContent = estimatedTokens;
        }

        function getBadgeClass(type) {
            const badgeMap = {
                'INPUT': 'badge-primary',
                'OUTPUT': 'badge-success', 
                'INPUT_OUTPUT': 'badge-warning',
                'DERIVED': 'badge-warning',
                'REFERENCE': 'badge-info',
                'STATIC': 'badge-secondary',
                'UNUSED': 'badge-danger',
                'MOVE': 'badge-primary',
                'CONDITIONAL': 'badge-warning',
                'CALCULATED': 'badge-success',
                'STRING_MANIPULATION': 'badge-info',
                'CICS_INPUT': 'badge-primary',
                'CICS_OUTPUT': 'badge-success',
                'CICS_REWRITE': 'badge-warning'
            };
            return badgeMap[type] || 'badge-secondary';
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function showLoading(message = 'Processing...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function updateLoadingMessage(message) {
            document.getElementById('loadingMessage').textContent = message;
        }

        function showError(message) {
            // Simple error display - could be enhanced with a toast notification
            alert('Error: ' + message);
        }
    </script>
</body>
</html>