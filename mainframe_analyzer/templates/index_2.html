<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Code Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            overflow-x: hidden;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-metrics {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .metric-label {
            opacity: 0.8;
            font-size: 0.8rem;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 1rem;
            padding: 1rem;
            min-height: calc(100vh - 100px);
        }

        /* Left Panel */
        .left-panel {
            width: 420px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
            height: fit-content;
            transition: all 0.3s ease;
        }

        .left-panel.collapsed {
            display: none;
        }

        .panel-restore {
            position: fixed;
            top: 50%;
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            transform: translateY(-50%);
            z-index: 1001;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .panel-restore:hover {
            background: #5a6fd8;
            transform: translateY(-50%) scale(1.1);
        }

        .panel-restore.left {
            left: 0;
        }

        .panel-restore.right {
            right: 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
        }

        .collapse-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        .collapse-btn:hover {
            transform: scale(1.1);
        }

        /* Upload Section */
        .upload-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9ff;
            border-radius: 8px;
            border: 2px dashed #667eea;
        }

        .upload-area {
            text-align: center;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #e8ecff;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f1f3f4;
            color: #667eea;
            border: 1px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* Main Content */
        .content-area {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-btn:hover:not(.active) {
            background: #e9ecef;
        }

        /* Tab Content */
        .tab-content {
            padding: 2rem;
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Enhanced Component Summaries */
        .component-summaries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .component-summary-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .component-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .component-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }

        .component-type {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: auto;
        }

        .business-purpose {
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 1rem;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .raw-analysis {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .component-metrics {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            min-width: 60px;
        }

        .metric-value {
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            font-size: 0.7rem;
            color: #6c757d;
            text-align: center;
        }

        .complexity-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .complexity-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            transition: width 0.3s ease;
        }

        .derived-components {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .derived-toggle {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .derived-toggle:hover {
            background: #5a6fd8;
        }

        .derived-list {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9ff;
            border-radius: 6px;
            border: 1px solid #e8ecff;
        }

        .derived-list.show {
            display: block;
        }

        .derived-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }

        .derived-item-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .derived-item-type {
            font-size: 0.75rem;
            background: #e8ecff;
            color: #667eea;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        /* Enhanced Dependency Flow */
        .dependency-flow-container {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 2rem;
            min-height: 600px;
        }

        .dependency-controls {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dependency-flow {
            display: flex;
            flex-direction: column;
            gap: 4rem;
            position: relative;
        }
        
        .dependency-status-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .status-card {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .status-present {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .status-missing {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .status-file {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .status-unknown {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .status-count {
            font-size: 2rem;
            font-weight: bold;
        }

        .status-label {
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .dependency-section {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dependency-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .dependency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .dependency-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
            transition: all 0.3s ease;
            position: relative;
        }

        .dependency-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dependency-card.status-present {
            border-left: 4px solid #28a745;
            background: #f8fff9;
        }

        .dependency-card.status-missing {
            border-left: 4px solid #dc3545;
            background: #fff8f8;
        }

        .dependency-card.status-file {
            border-left: 4px solid #007bff;
            background: #f8f9ff;
        }

        .dependency-card.status-unknown {
            border-left: 4px solid #6c757d;
            background: #f8f9fa;
        }

        .dependency-header {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .dependency-details {
            font-size: 0.9rem;
        }

        .dependency-details p {
            margin: 6px 0;
            display: flex;
            justify-content: space-between;
        }

        .confidence-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        .confidence-low { background: #f8d7da; color: #721c24; }

        .alert {
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 8px;
            position: relative;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .flow-level {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            position: relative;
            min-height: 140px;
        }

        .flow-level-title {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .flow-component {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 200px;
            max-width: 280px;
            text-align: center;
            position: relative;
        }

        .flow-component:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .flow-component.input-source {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .flow-component.core-program {
            border-color: #667eea;
            background: linear-gradient(135deg, #e8ecff 0%, #ffffff 100%);
        }

        .flow-component.called-program {
            border-color: #fd7e14;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .flow-component.input-output-file {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%);
        }

        .flow-component.output-file {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%);
        }

        .flow-component.missing-dependency {
            border-color: #dc3545;
            border-style: dashed;
            background: linear-gradient(135deg, #f8d7da 0%, #ffffff 100%);
            opacity: 0.8;
        }

        .flow-component.present-program {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .flow-component.file-with-layout {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .flow-component.file-only {
            border-left: 4px solid #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .component-name {
            font-weight: bold;
            font-size: 1rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .component-type-badge {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .component-description {
            font-size: 0.8rem;
            color: #6c757d;
            line-height: 1.3;
        }

        .flow-arrow {
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            margin: 1rem auto;
        }

        .program-call-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem;
        }

        .call-arrow {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #667eea;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .program-call-arrows {
            animation: pulse 2s infinite;
        }

        .call-arrow-indicator {
            color: #667eea;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f3f4;
        }

        .data-table tbody tr:hover {
            background: #f8f9ff;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .badge-primary {
            color: #fff;
            background-color: #667eea;
        }

        .badge-success {
            color: #fff;
            background-color: #28a745;
        }

        .badge-warning {
            color: #212529;
            background-color: #ffc107;
        }

        .badge-danger {
            color: #fff;
            background-color: #dc3545;
        }

        .badge-info {
            color: #fff;
            background-color: #17a2b8;
        }

        .badge-secondary {
            color: #fff;
            background-color: #6c757d;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            min-width: 400px;
            max-width: 500px;
        }

        .analysis-step {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .analysis-step.completed {
            background: #d4edda;
            color: #155724;
        }

        .analysis-step.current {
            background: #d1ecf1;
            color: #0c5460;
            font-weight: 500;
        }

        .step-icon {
            margin-right: 0.5rem;
            font-size: 1rem;
        }

        .analysis-step.completed .step-icon::before {
            content: '‚úÖ';
        }

        .analysis-step.current .step-icon::before {
            content: 'üîÑ';
        }

        /* Chat Panel */
        .right-panel {
            width: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
            transition: all 0.3s ease;
        }

        .right-panel.collapsed {
            display: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 700px;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-help {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .connection-status {
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .connection-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status.testing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .server-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .server-info h5 {
            margin: 0 0 0.5rem 0;
            color: #667eea;
        }

        .server-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .btn-test {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .btn-test:hover {
            transform: translateY(-1px);
        }

        .btn-test:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .test-results {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
        }

        .test-results h6 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }

        .test-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-testing { background-color: #ffc107; }

        .chat-header {
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: white;
            border: 1px solid #e9ecef;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            background: white;
            border-radius: 0 0 10px 10px;
        }

        .chat-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .chat-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }

        .token-counter {
            font-size: 0.8rem;
            color: #666;
        }

        /* Field Matrix and Mapping styles */
        .field-mapping-controls, .field-matrix-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .field-mapping-controls input, .field-matrix-controls select {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .field-mapping-table, .field-matrix-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: #6c757d;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                width: 100%;
                max-width: none;
            }

            .right-panel {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 2% auto;
                width: 95%;
            }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">Enhanced Code Analyzer</div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openConfigModal()">LLM Config</button>
            </div>
            <div class="header-metrics">
                <div class="metric-item">
                    <span class="metric-value" id="totalComponents">0</span>
                    <span class="metric-label">Components</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalPrograms">0</span>
                    <span class="metric-label">Programs</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalFields">0</span>
                    <span class="metric-label">Fields</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalTokens">0</span>
                    <span class="metric-label">Tokens Used</span>
                </div>
            </div>
        </div>
    </div>

    <!-- LLM Configuration Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">VLLM Server Configuration</h3>
                <button class="close" onclick="closeConfigModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="llmConfigForm">
                    <div class="form-group">
                        <label class="form-label" for="llmEndpoint">VLLM Server Endpoint</label>
                        <input type="url" id="llmEndpoint" class="form-input" 
                               placeholder="http://192.168.1.100:8100/generate"
                               value="http://localhost:8100/generate">
                        <div class="form-help">Enter the full URL to your VLLM server's /generate endpoint</div>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="maxTokens">Max Tokens per Call</label>
                            <input type="number" id="maxTokens" class="form-input" 
                                   value="6000" min="1000" max="32000" step="500">
                            <div class="form-help">Maximum tokens for each LLM request</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="temperature">Temperature</label>
                            <input type="number" id="temperature" class="form-input" 
                                   value="0.1" min="0" max="2" step="0.1">
                            <div class="form-help">Creativity level (0.0 = deterministic, 2.0 = creative)</div>
                        </div>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="timeout">Request Timeout (seconds)</label>
                            <input type="number" id="timeout" class="form-input" 
                                   value="60" min="10" max="300" step="5">
                            <div class="form-help">How long to wait for LLM response</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="retries">Max Retries</label>
                            <input type="number" id="retries" class="form-input" 
                                   value="3" min="1" max="5" step="1">
                            <div class="form-help">Number of retry attempts on failure</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn-test" onclick="testLLMConnection()" id="testButton">
                            Test Connection
                        </button>
                    </div>

                    <div id="connectionStatus" class="connection-status" style="display: none;">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="statusMessage"></span>
                    </div>

                    <div id="serverInfo" class="server-info" style="display: none;">
                        <h5>Server Information</h5>
                        <div class="server-info-item">
                            <span>Model:</span>
                            <span id="modelName">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Max Context Length:</span>
                            <span id="contextLength">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Response Time:</span>
                            <span id="responseTime">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Status:</span>
                            <span id="serverStatus">-</span>
                        </div>
                    </div>

                    <div id="testResults" class="test-results" style="display: none;">
                        <h6>Test Results</h6>
                        <div class="test-detail">
                            <span>Endpoint Reachable:</span>
                            <span id="endpointStatus">-</span>
                        </div>
                        <div class="test-detail">
                            <span>Response Format:</span>
                            <span id="responseFormat">-</span>
                        </div>
                        <div class="test-detail">
                            <span>Token Generation:</span>
                            <span id="tokenGeneration">-</span>
                        </div>
                        <div class="test-detail">
                            <span>Model Compatibility:</span>
                            <span id="modelCompatibility">-</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">Reset to Defaults</button>
                <button type="button" class="btn btn-secondary" onclick="closeConfigModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveLLMConfig()">Save & Apply</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel -->
        <div class="left-panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-title">Component Dashboard</div>
                <button class="collapse-btn" onclick="togglePanel('left')">‚óÄ</button>
            </div>

            <div class="panel-content">
                <!-- Upload Section -->
                <div class="upload-section">
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;">üìÅ</div>
                        <div>Click to upload COBOL files</div>
                        <small class="text-muted">Supports .cbl, .cob, .cpy, .jcl files</small>
                    </div>
                    <input type="file" id="fileInput" class="file-input" multiple 
                           accept=".cbl,.cob,.cpy,.jcl,.txt" onchange="handleFileUpload(event)">
                </div>

                <!-- Session Info -->
                <div class="session-info" style="margin-bottom: 2rem;">
                    <h4>Session Overview</h4>
                    <div id="sessionStats">
                        <p>Project: <span id="projectName">New Project</span></p>
                        <p>Session ID: <span id="sessionId">Not started</span></p>
                    </div>
                </div>

                <!-- Components List -->
                <div class="components-list">
                    <h4>Components</h4>
                    <div id="componentsList">
                        <p class="text-muted">No components uploaded yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard Overview</button>
                <button class="tab-btn" onclick="showTab('components')">Components Library</button>
                <button class="tab-btn" onclick="showTab('dependencies')">Dependencies Flow</button>
                <button class="tab-btn" onclick="showTab('fieldMatrix')">Field Matrix</button>
                <button class="tab-btn" onclick="showTab('fieldMapping')">Field Mapping Analysis</button>
            </div>

            <!-- Tab Contents -->
            <div class="tab-content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-pane active">
                    <h2>Project Dashboard</h2>
                    
                    <!-- Summary Cards -->
                    <div class="dashboard-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 2rem;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Analysis Status</h3>
                            <p id="analysisStatus">Ready for upload</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>Parsed Programs: <span id="parsedPrograms">0</span></div>
                                <div>Record Layouts: <span id="recordLayouts">0</span></div>
                                <div>CICS Files: <span id="cicsFiles">0</span></div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Processing Queue</h3>
                            <p id="processingQueue">0 files in queue</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>Token Usage: <span id="dashTokenUsage">0</span></div>
                                <div>LLM Calls: <span id="llmCalls">0</span></div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Success Rate</h3>
                            <p id="successRate">100%</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>Complexity Avg: <span id="avgComplexity">N/A</span></div>
                                <div>Confidence: <span id="avgConfidence">N/A</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Component Summaries -->
                    <div style="margin-top: 2rem;">
                        <h3>Component Analysis Summary</h3>
                        <div id="componentSummaries" class="component-summaries">
                            <p class="text-muted">Upload COBOL files to see AI-generated business summaries</p>
                        </div>
                    </div>
                </div>

                <!-- Components Library Tab -->
                <div id="components" class="tab-pane">
                    <h2>Components Library</h2>
                    
                    <!-- Filter Controls -->
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                        <select id="componentTypeFilter" onchange="filterComponents()">
                            <option value="">All File Types</option>
                            <option value="PROGRAM">Programs Only</option>
                            <option value="COPYBOOK">Copybooks Only</option>
                            <option value="JCL">JCL Only</option>
                        </select>
                        <input type="text" id="componentSearchFilter" placeholder="Search components..." onkeyup="filterComponents()" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <select id="componentViewFilter" onchange="filterComponents()">
                            <option value="">All Components</option>
                            <option value="analyzed">Analyzed Components</option>
                            <option value="extracted">Extracted Components</option>
                        </select>
                    </div>

                    <div id="componentsTable">
                        <div class="component-section">
                            <h4>Uploaded Files & Discovered Components</h4>
                            <p class="text-muted">Click on any file to expand and view its discovered components</p>
                            
                            <div id="mainComponentsView" style="margin-top: 1rem;">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dependencies Flow Tab -->
                <div id="dependencies" class="tab-pane">
                    <h2>Dependencies Flow</h2>
                    
                    <!-- Dependency Controls -->
                    <div class="dependency-controls">
                        <label for="dependencyComponentSelect" style="font-weight: 600;">View Dependencies For:</label>
                        <select id="dependencyComponentSelect" onchange="loadDependencyFlow()" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
                            <option value="">Overall System View</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshDependencyFlow()">Refresh</button>
                        <button class="btn btn-secondary" onclick="loadEnhancedDependencies()" id="enhancedViewBtn">Load Enhanced View</button>
                        <button class="btn btn-secondary" onclick="restoreNormalView()" id="normalViewBtn" style="display: none;">Restore Normal View</button>
                    </div>

                    <!-- Dependency Status Summary -->
                    <div id="dependencyStatusSummary" class="dependency-status-summary" style="display: none;">
                        <div class="status-card status-present">
                            <div class="status-count" id="present-count">0</div>
                            <div class="status-label">Present Programs</div>
                        </div>
                        <div class="status-card status-missing">
                            <div class="status-count" id="missing-count">0</div>
                            <div class="status-label">Missing Programs</div>
                        </div>
                        <div class="status-card status-file">
                            <div class="status-count" id="file-count">0</div>
                            <div class="status-label">Files & CICS</div>
                        </div>
                        <div class="status-card status-unknown">
                            <div class="status-count" id="unknown-count">0</div>
                            <div class="status-label">Unknown</div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Dependencies Container -->
                    <div id="enhancedDependenciesContainer" style="display: none;"></div>
                    
                    <!-- Original Dependency Flow Container -->
                    <div id="dependenciesVisualization">
                        <div class="dependency-flow-container">
                            <div id="dependencyFlowContent">
                                <p class="text-muted">Upload and analyze COBOL programs to see system architecture flow</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Field Matrix Tab -->
                <div id="fieldMatrix" class="tab-pane">
                    <h2>Field Matrix</h2>
                    <div class="field-matrix-controls">
                        <select id="recordLayoutSelect" onchange="loadFieldMatrix()">
                            <option value="">Select Record Layout</option>
                        </select>
                        <select id="programSelect" onchange="loadFieldMatrix()">
                            <option value="">Select Program</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadFieldMatrix()">Refresh Matrix</button>
                    </div>
                    <div id="fieldMatrixTable">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Usage Type</th>
                                    <th>Source Field</th>
                                    <th>Business Purpose</th>
                                    <th>Program</th>
                                    <th>Line #</th>
                                </tr>
                            </thead>
                            <tbody id="fieldMatrixTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No field data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Field Mapping Analysis Tab -->
                <div id="fieldMapping" class="tab-pane">
                    <h2>Field Mapping Analysis</h2>
                    <div class="field-mapping-controls">
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="targetFileInput" placeholder="Enter target file name (e.g., CUSTOMER-FILE)" style="flex: 1; min-width: 200px;">
                            <select id="recordLayoutSelector" onchange="updateTargetFileFromLayout()" style="min-width: 200px;">
                                <option value="">Or select a record layout</option>
                            </select>
                            <button class="btn btn-primary" onclick="analyzeFieldMapping()">Analyze Field Mapping</button>
                            <button class="btn btn-secondary" onclick="exportFieldMappings()">Export to CSV</button>
                        </div>
                    </div>

                    <!-- Layout Summary Section -->
                    <div id="layoutSummarySection" style="display: none; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <h4>Layout Summary</h4>
                        <div id="layoutSummaryContent"></div>
                    </div>
                    
                    <div id="fieldMappingResults">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Mainframe Type & Length</th>
                                    <th>Oracle Type & Length</th>
                                    <th>Population Source</th>
                                    <th>Business Logic</th>
                                    <th>Programs Involved</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fieldMappingTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Enter a target file name or select a layout and click Analyze</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Field Details Modal -->
                <div id="fieldDetailsModal" class="modal">
                    <div class="modal-content" style="width: 80%; max-width: 900px;">
                        <div class="modal-header">
                            <h3 class="modal-title" id="fieldModalTitle">Field Details</h3>
                            <button class="close" onclick="closeFieldDetailsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="fieldDetailsContent">
                                <!-- Will be populated with field details -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeFieldDetailsModal()">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Chat -->
        <div class="right-panel" id="rightPanel">
            <div class="chat-header">
                <div>AI Assistant</div>
                <button class="collapse-btn" onclick="togglePanel('right')" style="background: none; border: none; color: white; font-size: 1.2rem;">‚ñ∂</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message assistant">
                    <p>Hello! I'm your mainframe analysis assistant. I can help you understand:</p>
                    <ul>
                        <li>Field mappings and data relationships</li>
                        <li>Record layout structures</li>
                        <li>Program dependencies and business logic</li>
                        <li>COBOL to Oracle conversion guidance</li>
                    </ul>
                    <p>Ask me about any field, record layout, or program in your analysis!</p>
                </div>
            </div>
            <div class="chat-input-area">
                <textarea id="chatInput" class="chat-input" 
                         placeholder="Ask about fields, record layouts, or programs..."
                         onkeydown="handleChatKeydown(event)"></textarea>
                <div class="chat-controls">
                    <span class="token-counter" id="chatTokenCounter">0 tokens</span>
                    <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading"></div>
            <h3 id="loadingTitle">Processing...</h3>
            <p id="loadingMessage">Analyzing your files...</p>
            <div id="loadingProgress" style="margin-top: 1rem;">
                <div style="background: #e9ecef; border-radius: 10px; height: 6px; margin-bottom: 0.5rem;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="font-size: 0.9rem; color: #6c757d;">Starting analysis...</div>
            </div>
            <div id="analysisSteps" style="margin-top: 1rem; text-align: left; max-width: 400px;">
                <div class="analysis-step" id="step1">
                    <span class="step-icon"></span> Parsing COBOL structure...
                </div>
                <div class="analysis-step" id="step2">
                    <span class="step-icon"></span> Extracting components...
                </div>
                <div class="analysis-step" id="step3">
                    <span class="step-icon"></span> Generating business summary...
                </div>
                <div class="analysis-step" id="step4">
                    <span class="step-icon"></span> Storing results...
                </div>
            </div>
            <div id="processingStatus" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <script>
        // Global variables
        let currentSessionId = null;
        let currentConversationId = null;
        let fieldMatrixData = {};
        let componentsData = [];
        let dependenciesData = [];
        let llmConfig = {
            endpoint: 'http://localhost:8100/generate',
            maxTokens: 6000,
            temperature: 0.1,
            timeout: 60,
            retries: 3
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadLLMConfig();
            initializeSession();
            updateTokenCounters();
        });

        // LLM Configuration Management
        function loadLLMConfig() {
            const saved = localStorage.getItem('llmConfig');
            if (saved) {
                try {
                    llmConfig = { ...llmConfig, ...JSON.parse(saved) };
                    updateConfigForm();
                } catch (e) {
                    console.error('Error loading LLM config:', e);
                }
            }
        }

        function openConfigModal() {
            updateConfigForm();
            document.getElementById('configModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Hide status messages
            document.getElementById('connectionStatus').style.display = 'none';
            document.getElementById('serverInfo').style.display = 'none';
            document.getElementById('testResults').style.display = 'none';
        }

        function updateConfigForm() {
            document.getElementById('llmEndpoint').value = llmConfig.endpoint;
            document.getElementById('maxTokens').value = llmConfig.maxTokens;
            document.getElementById('temperature').value = llmConfig.temperature;
            document.getElementById('timeout').value = llmConfig.timeout;
            document.getElementById('retries').value = llmConfig.retries;
        }

        async function testLLMConnection() {
            const endpoint = document.getElementById('llmEndpoint').value.trim();
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const timeout = parseInt(document.getElementById('timeout').value);

            if (!endpoint) {
                showConnectionStatus('error', 'Please enter a VLLM endpoint URL first');
                return;
            }

            showConnectionStatus('testing', 'Testing connection to VLLM server...');
            
            const testButton = document.getElementById('testButton');
            testButton.disabled = true;
            testButton.textContent = 'Testing...';

            document.getElementById('testResults').style.display = 'block';
            resetTestResults();

            try {
                const startTime = Date.now();
                
                const response = await fetch('/api/test-llm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        endpoint,
                        maxTokens,
                        temperature,
                        timeout
                    })
                });

                const responseTime = Date.now() - startTime;

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        showConnectionStatus('success', 'Connection successful! VLLM server is responding normally.');
                        
                        updateTestResults({
                            endpointReachable: true,
                            responseFormat: 'Valid JSON',
                            tokenGeneration: data.response_tokens > 0 ? 'Working' : 'Limited',
                            modelCompatibility: data.model_name ? 'Compatible' : 'Unknown'
                        });
                        
                        displayServerInfo({
                            model: data.model_name || 'Unknown',
                            contextLength: data.max_context_length || 'Unknown',
                            responseTime: `${responseTime}ms`,
                            status: 'Online',
                            promptTokens: data.prompt_tokens || 0,
                            responseTokens: data.response_tokens || 0
                        });
                    } else {
                        showConnectionStatus('error', `Connection failed: ${data.error || 'Unknown error'}`);
                        updateTestResults({
                            endpointReachable: false,
                            responseFormat: 'Error',
                            tokenGeneration: 'Failed',
                            modelCompatibility: 'Incompatible'
                        });
                        hideServerInfo();
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('LLM connection test failed:', error);
                showConnectionStatus('error', `Connection failed: ${error.message}`);
                updateTestResults({
                    endpointReachable: false,
                    responseFormat: 'Network Error',
                    tokenGeneration: 'Failed',
                    modelCompatibility: 'Cannot Determine'
                });
                hideServerInfo();
            } finally {
                testButton.disabled = false;
                testButton.textContent = 'Test Connection';
            }
        }

        function showConnectionStatus(type, message) {
            const status = document.getElementById('connectionStatus');
            const indicator = document.getElementById('statusIndicator');
            const statusMessage = document.getElementById('statusMessage');

            status.className = `connection-status ${type}`;
            status.style.display = 'flex';
            
            indicator.className = `status-indicator status-${type === 'testing' ? 'testing' : type === 'success' ? 'online' : 'offline'}`;
            
            statusMessage.textContent = message;
        }

        function resetTestResults() {
            document.getElementById('endpointStatus').textContent = 'Testing...';
            document.getElementById('responseFormat').textContent = 'Testing...';
            document.getElementById('tokenGeneration').textContent = 'Testing...';
            document.getElementById('modelCompatibility').textContent = 'Testing...';
        }

        function updateTestResults(results) {
            document.getElementById('endpointStatus').textContent = results.endpointReachable ? '‚úÖ Reachable' : '‚ùå Failed';
            document.getElementById('responseFormat').textContent = results.responseFormat;
            document.getElementById('tokenGeneration').textContent = results.tokenGeneration;
            document.getElementById('modelCompatibility').textContent = results.modelCompatibility;
        }

        function displayServerInfo(info) {
            document.getElementById('modelName').textContent = info.model;
            document.getElementById('contextLength').textContent = info.contextLength;
            document.getElementById('responseTime').textContent = info.responseTime;
            document.getElementById('serverStatus').textContent = info.status;
            document.getElementById('serverInfo').style.display = 'block';
        }

        function hideServerInfo() {
            document.getElementById('serverInfo').style.display = 'none';
        }

        async function saveLLMConfig() {
            const endpoint = document.getElementById('llmEndpoint').value.trim();
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const timeout = parseInt(document.getElementById('timeout').value);
            const retries = parseInt(document.getElementById('retries').value);

            if (!endpoint) {
                showError('Please enter a valid VLLM endpoint URL');
                return;
            }

            if (maxTokens < 1000 || maxTokens > 32000) {
                showError('Max tokens must be between 1000 and 32000');
                return;
            }

            if (temperature < 0 || temperature > 2) {
                showError('Temperature must be between 0.0 and 2.0');
                return;
            }

            llmConfig = {
                endpoint,
                maxTokens,
                temperature,
                timeout,
                retries
            };

            localStorage.setItem('llmConfig', JSON.stringify(llmConfig));

            try {
                await updateBackendConfig();
                closeConfigModal();
                showSuccess('LLM configuration saved successfully!');
            } catch (error) {
                showError('Failed to update backend configuration');
            }
        }

        async function updateBackendConfig() {
            try {
                const response = await fetch('/api/llm-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(llmConfig)
                });

                if (!response.ok) {
                    throw new Error('Failed to update backend configuration');
                }
            } catch (error) {
                console.error('Error updating backend config:', error);
                throw error;
            }
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to default values?')) {
                llmConfig = {
                    endpoint: 'http://localhost:8100/generate',
                    maxTokens: 6000,
                    temperature: 0.1,
                    timeout: 60,
                    retries: 3
                };
                updateConfigForm();
                localStorage.removeItem('llmConfig');
                
                document.getElementById('connectionStatus').style.display = 'none';
                document.getElementById('serverInfo').style.display = 'none';
                document.getElementById('testResults').style.display = 'none';
            }
        }

        // Session Management
        async function initializeSession() {
            try {
                const savedSessionId = localStorage.getItem('currentSessionId');
                if (savedSessionId) {
                    currentSessionId = savedSessionId;
                    currentConversationId = generateUUID();
                    
                    const response = await fetch(`/api/components/${currentSessionId}`);
                    if (response.ok) {
                        console.log('Using existing session:', currentSessionId);
                        document.getElementById('sessionId').textContent = currentSessionId.slice(0, 8) + '...';
                        document.getElementById('projectName').textContent = 'Existing Project';
                        return;
                    }
                }
                
                const response = await fetch('/api/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_name: `Project_${new Date().toISOString().slice(0,19)}` })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentSessionId = data.session_id;
                    currentConversationId = generateUUID();
                    
                    localStorage.setItem('currentSessionId', currentSessionId);
                    
                    document.getElementById('sessionId').textContent = currentSessionId.slice(0, 8) + '...';
                    document.getElementById('projectName').textContent = data.project_name;
                    
                    console.log('New session initialized:', currentSessionId);
                } else {
                    throw new Error('Failed to create session');
                }
            } catch (error) {
                console.error('Error initializing session:', error);
                showError('Failed to initialize session');
            }
        }

        // File Upload with Progress Tracking
        async function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            showLoadingWithProgress(`Processing ${files.length} files...`);
            
            let processedCount = 0;
            let successCount = 0;
            let errorCount = 0;
            const results = [];

            const loadingContent = document.querySelector('.loading-content');
            const statusContainer = document.createElement('div');
            statusContainer.id = 'processingStatus';
            statusContainer.style.marginTop = '2rem';
            loadingContent.appendChild(statusContainer);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileNumber = i + 1;
                
                try {
                    updateLoadingProgress(
                        `Processing ${file.name} (${fileNumber}/${files.length})...`,
                        (i / files.length) * 90,
                        `Analyzing ${file.name}`
                    );
                    
                    updateProcessingStatus(fileNumber, files.length, file.name, 'processing');
                    
                    updateAnalysisStep(1, 'current', `Parsing ${file.name}...`);
                    updateAnalysisStep(2, 'current', 'Extracting components...');
                    updateAnalysisStep(3, 'current', 'Generating AI analysis...');
                    updateAnalysisStep(4, 'current', 'Storing results...');

                    const content = await readFileContent(file);
                    const fileType = getFileType(file.name);
                    
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: currentSessionId,
                            content: content,
                            filename: file.name,
                            file_type: fileType
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            successCount++;
                            results.push({ file: file.name, success: true, data: data });
                            
                            updateAnalysisStep(1, 'completed', `Parsed ${file.name}`);
                            updateAnalysisStep(2, 'completed', `Found ${data.components.length} components`);
                            updateAnalysisStep(3, 'completed', `Generated business summaries`);
                            updateAnalysisStep(4, 'completed', `Stored in database`);
                            
                            updateProcessingStatus(fileNumber, files.length, file.name, 'success', data.components.length);
                            
                            componentsData = componentsData.concat(data.components);
                            
                            console.log(`Successfully processed ${file.name}:`, data.components.length, 'components');
                        } else {
                            errorCount++;
                            results.push({ file: file.name, success: false, error: data.error });
                            updateProcessingStatus(fileNumber, files.length, file.name, 'error', 0, data.error);
                            showErrorInStep(file.name, data.error);
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    errorCount++;
                    results.push({ file: file.name, success: false, error: error.message });
                    console.error(`Error processing ${file.name}:`, error);
                    updateProcessingStatus(fileNumber, files.length, file.name, 'error', 0, error.message);
                    showErrorInStep(file.name, error.message);
                }
                
                processedCount++;
                
                const overallProgress = (processedCount / files.length) * 90;
                updateLoadingProgress(
                    `Processed ${processedCount}/${files.length} files (${successCount} successful, ${errorCount} failed)`,
                    overallProgress,
                    `${processedCount} of ${files.length} complete`
                );
            }

            updateLoadingProgress(
                `Analysis complete! Processed ${processedCount} files`,
                95,
                'Updating interface...'
            );

            const finalSummaryHtml = `
                <div style="background: #d4edda; padding: 1rem; border-radius: 8px; border: 1px solid #c3e6cb; margin-top: 1rem;">
                    <h4 style="color: #155724; margin: 0 0 0.5rem 0;">Processing Complete!</h4>
                    <div style="color: #155724;">
                        <strong>Total Files:</strong> ${files.length}<br>
                        <strong>Successful:</strong> ${successCount}<br>
                        <strong>Failed:</strong> ${errorCount}<br>
                        <strong>Total Components:</strong> ${results.reduce((sum, r) => sum + (r.data?.components?.length || 0), 0)}
                    </div>
                </div>
            `;
            statusContainer.insertAdjacentHTML('beforeend', finalSummaryHtml);

            updateLoadingProgress('All files processed successfully!', 100, 'Ready!');
            
            setTimeout(async () => {
                hideLoading();
                
                await refreshUI();
                await loadDashboardSummaries();
                
                showCompletionNotification(successCount, errorCount, files.length);
                
            }, 2000);
            
            event.target.value = '';
        }

        function updateProcessingStatus(currentFile, totalFiles, fileName, status, componentsFound = 0, error = null) {
            const container = document.getElementById('processingStatus');
            if (!container) return;

            let statusItem = document.getElementById(`status-${currentFile}`);
            if (!statusItem) {
                statusItem = document.createElement('div');
                statusItem.id = `status-${currentFile}`;
                statusItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 0.5rem;
                    margin-bottom: 0.5rem;
                    border-radius: 6px;
                    font-size: 0.9rem;
                `;
                container.appendChild(statusItem);
            }

            let statusIcon, statusColor, statusText, backgroundColor;
            
            switch (status) {
                case 'processing':
                    statusIcon = 'üîÑ';
                    statusColor = '#0c5460';
                    backgroundColor = '#d1ecf1';
                    statusText = `Processing ${fileName}...`;
                    break;
                case 'success':
                    statusIcon = '‚úÖ';
                    statusColor = '#155724';
                    backgroundColor = '#d4edda';
                    statusText = `${fileName} - ${componentsFound} components found`;
                    break;
                case 'error':
                    statusIcon = '‚ùå';
                    statusColor = '#721c24';
                    backgroundColor = '#f8d7da';
                    statusText = `${fileName} - Error: ${error?.substring(0, 50) || 'Unknown error'}`;
                    break;
            }

            statusItem.style.color = statusColor;
            statusItem.style.backgroundColor = backgroundColor;
            statusItem.innerHTML = `
                <span style="margin-right: 0.5rem; font-size: 1rem;">${statusIcon}</span>
                <span><strong>File ${currentFile}/${totalFiles}:</strong> ${statusText}</span>
            `;
        }

        function showCompletionNotification(successCount, errorCount, totalFiles) {
            const notificationHtml = `
                <div id="completionNotification" style="
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    background: ${errorCount > 0 ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)' : 'linear-gradient(135deg, #28a745 0%, #20c997 100%)'};
                    color: white;
                    padding: 1.5rem;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    z-index: 10000;
                    min-width: 300px;
                    animation: slideIn 0.3s ease;
                ">
                    <h4 style="margin: 0 0 0.5rem 0;">${errorCount > 0 ? '‚ö†Ô∏è' : 'üéâ'} Processing Complete!</h4>
                    <div>
                        <strong>Files Processed:</strong> ${successCount}/${totalFiles}<br>
                        ${errorCount > 0 ? `<strong>Errors:</strong> ${errorCount}<br>` : ''}
                        <strong>Total Components:</strong> ${componentsData.length}
                    </div>
                    <button onclick="closeCompletionNotification()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        padding: 0.25rem 0.5rem;
                        border-radius: 4px;
                        margin-top: 0.5rem;
                        cursor: pointer;
                    ">Close</button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', notificationHtml);
            
            setTimeout(() => {
                closeCompletionNotification();
            }, 10000);
        }

        function closeCompletionNotification() {
            const notification = document.getElementById('completionNotification');
            if (notification) {
                notification.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => notification.remove(), 300);
            }
        }

        // Dashboard Summaries
        async function loadDashboardSummaries() {
            try {
                const response = await fetch(`/api/llm-summaries/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayComponentSummariesFromLLMTable(data.summaries);
                        updateDashboardMetrics(data.summaries);
                    }
                }
            } catch (error) {
                console.error('Error loading LLM summaries:', error);
            }
        }

        function displayComponentSummariesFromLLMTable(summaries) {
            const container = document.getElementById('componentSummaries');
            container.innerHTML = '';

            if (summaries.length === 0) {
                container.innerHTML = '<p class="text-muted">No component summaries available</p>';
                return;
            }

            summaries.forEach(summary => {
                const card = document.createElement('div');
                card.className = 'component-summary-card';
                
                const businessPurpose = summary.business_purpose || 'No business purpose available';
                const complexityScore = summary.complexity_score || 0.5;
                const keyFeatures = summary.key_features || [];
                
                if (summary.is_raw_response) {
                    card.innerHTML = `
                        <div class="component-header">
                            <div>
                                <div class="component-title">${summary.component_name}</div>
                                <div class="text-muted">${summary.friendly_name || ''}</div>
                            </div>
                            <span class="component-type badge badge-warning">RAW AI ANALYSIS</span>
                        </div>
                        
                        <div class="business-purpose raw-analysis">
                            <strong>AI Analysis (Raw Response):</strong><br>
                            <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; max-height: 150px; overflow-y: auto;">
                                ${businessPurpose}
                            </div>
                        </div>
                        
                        <div class="component-metrics">
                            <div class="metric">
                                <span class="metric-value">RAW</span>
                                <span class="metric-label">Analysis</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${Math.round(complexityScore * 100)}%</span>
                                <span class="metric-label">Complexity</span>
                            </div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="component-header">
                            <div>
                                <div class="component-title">${summary.component_name}</div>
                                <div class="text-muted">${summary.friendly_name || ''}</div>
                            </div>
                            <span class="component-type badge badge-primary">${summary.component_type}</span>
                        </div>
                        
                        <div class="business-purpose">${businessPurpose}</div>
                        
                        <div class="component-metrics">
                            <div class="metric">
                                <span class="metric-value">${summary.primary_function || 'GENERAL'}</span>
                                <span class="metric-label">Function</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${Math.round(complexityScore * 100)}%</span>
                                <span class="metric-label">Complexity</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${keyFeatures.length}</span>
                                <span class="metric-label">Features</span>
                            </div>
                        </div>
                        
                        <div class="complexity-bar">
                            <div class="complexity-fill" style="width: ${complexityScore * 100}%"></div>
                        </div>
                    `;
                }
                
                container.appendChild(card);
            });
        }

        // Enhanced Dependencies Flow with Fixed Core Component Display
        async function createEnhancedDependencyFlowHTML(categorized, focusComponent) {
    let html = '<div class="dependency-flow">';
    
    // Input Files Level
    if (categorized.inputFiles && categorized.inputFiles.length > 0) {
        html += createFileLayerWithLayouts('Input Sources', categorized.inputFiles, 'input-source');
        html += '<div class="flow-arrow">‚Üì</div>';
    }
    
    // Core Programs Level - ALWAYS show this layer with actual program names
    let coreItems;
    if (focusComponent) {
        coreItems = [{name: focusComponent, type: 'Focus Program', confidence: 1.0}];
    } else if (categorized.corePrograms && categorized.corePrograms.length > 0) {
        coreItems = categorized.corePrograms;
    } else {
        // Get ALL uploaded programs instead of just first one
        coreItems = await getAllUploadedPrograms() || [{name: 'MAIN-PROGRAM', type: 'Core Program', confidence: 0.9}];
    }
    
    html += createProgramLayer('Core Programs', coreItems, 'core-program');
    
    // Add arrows to called programs if any exist
    if (categorized.calledPrograms && categorized.calledPrograms.length > 0) {
        html += '<div style="position: relative; height: 80px; display: flex; justify-content: center; align-items: center;">';
        html += createProgramCallArrows(categorized.calledPrograms);
        html += '</div>';
    } else {
        html += '<div class="flow-arrow">‚Üì</div>';
    }
    
    // Called Programs Level
    if (categorized.calledPrograms && categorized.calledPrograms.length > 0) {
        html += createProgramLayerWithArrows('Called Programs', categorized.calledPrograms, 'called-program');
        html += '<div class="flow-arrow">‚Üì</div>';
    }
    
    // Input/Output Files Level
    if (categorized.inputOutputFiles && categorized.inputOutputFiles.length > 0) {
        html += createFileLayerWithLayouts('Input/Output Files', categorized.inputOutputFiles, 'input-output-file');
        html += '<div class="flow-arrow">‚Üì</div>';
    }
    
    // Output Files Level
    if (categorized.outputFiles && categorized.outputFiles.length > 0) {
        html += createFileLayerWithLayouts('Output Files', categorized.outputFiles, 'output-file');
    }
    
    // Missing Dependencies Level
    if (categorized.missingPrograms && categorized.missingPrograms.length > 0) {
        html += '<div style="margin-top: 3rem; padding-top: 2rem; border-top: 3px dashed #dc3545;">';
        html += '<h4 style="color: #dc3545; text-align: center; margin-bottom: 2rem;">‚ö†Ô∏è Missing Dependencies</h4>';
        html += createProgramLayer('Missing Programs', categorized.missingPrograms, 'missing-dependency');
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

    async function getAllUploadedPrograms() {
    try {
        // Get actual components from the API instead of relying on local data
        const response = await fetch(`/api/components/${currentSessionId}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.components) {
                const programs = data.components.filter(c => c.component_type === 'PROGRAM');
                if (programs.length > 0) {
                    console.log('Found uploaded programs:', programs.map(p => p.component_name));
                    return programs.map(program => ({
                        name: program.component_name,
                        friendly_name: program.friendly_name || program.component_name,
                        type: 'Core Program',
                        confidence: 0.9
                    }));
                }
            }
        }
    } catch (error) {
        console.error('Error fetching uploaded programs:', error);
    }
    
    // Fallback - try componentsData if API fails
    if (componentsData && componentsData.length > 0) {
        const programs = componentsData.filter(c => c.component_type === 'PROGRAM');
        if (programs.length > 0) {
            return programs.map(program => ({
                name: program.component_name,
                friendly_name: program.friendly_name || program.component_name,
                type: 'Core Program',
                confidence: 0.9
            }));
        }
    }
    
    return null;
}
        function createProgramCallArrows(calledPrograms) {
            let html = '<div class="program-call-arrows" style="display: flex; justify-content: center; align-items: center; gap: 1rem; height: 60px; margin: 1rem 0;">';
            
            calledPrograms.slice(0, 5).forEach((program, index) => {
                const arrowIcon = getCallArrowIcon(program.callType);
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; margin: 0 1rem;">
                        <div style="font-size: 1.8rem; color: #667eea; text-shadow: 0 2px 4px rgba(0,0,0,0.3); margin-bottom: 0.2rem;">${arrowIcon}</div>
                        <div style="font-size: 0.7rem; color: #666; text-align: center; max-width: 60px;">${program.name.substring(0, 8)}</div>
                    </div>
                `;
            });
            
            if (calledPrograms.length > 5) {
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; margin: 0 1rem;">
                        <div style="font-size: 1.5rem; color: #999;">...</div>
                        <div style="font-size: 0.7rem; color: #666;">+${calledPrograms.length - 5} more</div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        function createProgramLayer(title, items, className) {
            let html = `
                <div class="flow-level">
                    <div class="flow-level-title">${title}</div>
                    <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">
            `;
            
            items.forEach(item => {
                const displayName = item.name || item.friendly_name || 'UNKNOWN';
                const confidenceClass = item.confidence > 0.8 ? 'confidence-high' : 
                                       item.confidence > 0.5 ? 'confidence-medium' : 'confidence-low';
                
                html += `
                    <div class="flow-component ${className}" onclick="showProgramDetails('${item.name}')">
                        <div class="confidence-indicator ${confidenceClass}"></div>
                        <div class="component-name">${displayName}</div>
                        <div class="component-type-badge">${item.type}</div>
                        <div class="component-description">
                            Confidence: ${(item.confidence * 100).toFixed(0)}%
                            ${item.reason ? `<br><small>${item.reason}</small>` : ''}
                            ${item.calledFrom ? `<br><small>Called from: ${item.calledFrom}</small>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }




function displayFieldMatrix(matrixData) {
            const tbody = document.getElementById('fieldMatrixTableBody');
            tbody.innerHTML = '';

            if (matrixData.program_layouts) {
                matrixData.program_layouts.forEach((layout, layoutIndex) => {
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'collapsible-row';
                    headerRow.onclick = () => toggleLayoutFields(layoutIndex);
                    
                    headerRow.innerHTML = `
                        <td>
                            <span class="expand-icon" id="expand-${layoutIndex}">‚ñ∂</span>
                            <strong>${layout.layout_name}</strong>
                            <br><small class="text-muted">${layout.friendly_name}</small>
                        </td>
                        <td colspan="5">
                            <span class="badge badge-primary">Level ${layout.level}</span>
                            ${layout.fields.length} fields
                        </td>
                    `;
                    tbody.appendChild(headerRow);

                    const fieldsContainer = document.createElement('tbody');
                    fieldsContainer.id = `fields-${layoutIndex}`;
                    fieldsContainer.className = 'sub-fields';
                    fieldsContainer.style.display = 'none';
                    
                    layout.fields.forEach(field => {
                        const fieldRow = document.createElement('tr');
                        fieldRow.className = 'sub-field-row';
                        
                        const usageClass = `usage-${field.usage_type.toLowerCase()}`;
                        
                        fieldRow.innerHTML = `
                            <td style="padding-left: 2rem;">
                                ${field.field_name}
                                <br><small class="text-muted">${field.friendly_name || ''}</small>
                            </td>
                            <td>
                                <span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type}</span>
                                <br><small>${field.usage_description || ''}</small>
                            </td>
                            <td>${field.source_field || 'N/A'}</td>
                            <td>${field.business_purpose || 'N/A'}</td>
                            <td>${field.program_name || 'N/A'}</td>
                            <td>${field.line_number || 'N/A'}</td>
                        `;
                        fieldRow.className += ` ${usageClass}`;
                        fieldsContainer.appendChild(fieldRow);
                    });
                    
                    tbody.appendChild(fieldsContainer);
                });
            } else if (matrixData.fields) {
                matrixData.fields.forEach(field => {
                    const row = document.createElement('tr');
                    const usageClass = `usage-${field.usage_type.toLowerCase()}`;
                    
                    row.innerHTML = `
                        <td>
                            ${field.field_name}
                            <br><small class="text-muted">${field.friendly_name || ''}</small>
                        </td>
                        <td>
                            <span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type}</span>
                            <br><small>${field.usage_description || ''}</small>
                        </td>
                        <td>${field.source_field || 'N/A'}</td>
                        <td>${field.business_purpose || 'N/A'}</td>
                        <td>${field.program_name || 'N/A'}</td>
                        <td>${field.line_number || 'N/A'}</td>
                    `;
                    row.className = usageClass;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No field data available</td></tr>';
            }
        }

        function toggleLayoutFields(layoutIndex) {
            const fieldsContainer = document.getElementById(`fields-${layoutIndex}`);
            const expandIcon = document.getElementById(`expand-${layoutIndex}`);
            
            if (fieldsContainer.style.display === 'none') {
                fieldsContainer.style.display = 'table-row-group';
                expandIcon.textContent = '‚ñº';
            } else {
                fieldsContainer.style.display = 'none';
                expandIcon.textContent = '‚ñ∂';
            }
        }

        // Field Mapping Functions
        function initializeFieldMapping() {
            loadRecordLayoutSelector();
        }

        function loadRecordLayoutSelector() {
            const selector = document.getElementById('recordLayoutSelector');
            if (!selector) return;
            
            if (!currentSessionId) return;
            
            try {
                fetch(`/api/record-layouts/${currentSessionId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            selector.innerHTML = '<option value="">Or select a record layout</option>';
                            
                            if (data.layouts && data.layouts.length > 0) {
                                data.layouts.forEach(layout => {
                                    const option = document.createElement('option');
                                    option.value = layout.layout_name;
                                    option.textContent = `${layout.layout_name} (${layout.fields_count || 0} fields) - ${layout.program_name}`;
                                    selector.appendChild(option);
                                });
                            } else {
                                const option = document.createElement('option');
                                option.value = '';
                                option.textContent = 'No record layouts found';
                                option.disabled = true;
                                selector.appendChild(option);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading record layouts:', error);
                        selector.innerHTML = '<option value="">Error loading layouts</option>';
                    });
            } catch (error) {
                console.error('Error in loadRecordLayoutSelector:', error);
            }
        }

        function updateTargetFileFromLayout() {
            const selector = document.getElementById('recordLayoutSelector');
            const targetInput = document.getElementById('targetFileInput');
            
            if (selector && selector.value && targetInput) {
                targetInput.value = selector.value;
            }
        }

        async function analyzeFieldMapping() {
            const targetFile = document.getElementById('targetFileInput').value.trim();
            if (!targetFile) {
                showError('Please enter a target file name or select a record layout');
                return;
            }

            showLoading('Analyzing field mappings...');

            try {
                const response = await fetch('/api/field-mapping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        target_file: targetFile
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayFieldMappingsWithSummary(data.field_mappings, data.summary);
                        await displayLayoutSummary(targetFile);
                    } else {
                        showError(data.error || 'Failed to analyze field mappings');
                    }
                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error analyzing field mapping:', error);
                showError('Failed to analyze field mappings');
            }

            hideLoading();
        }

        function normalizeUsageType(usageType) {
            if (!usageType) return 'STATIC';
            
            const normalizedMappings = {
                'MOVE_TARGET': 'INPUT',
                'MOVE_SOURCE': 'OUTPUT', 
                'MOVE': 'INPUT_OUTPUT',
                'COMPUTED': 'DERIVED',
                'DEFINITION': 'STATIC',
                'CONDITION': 'REFERENCE',
                'CONDITIONAL': 'REFERENCE',
                'CICS_INPUT': 'INPUT',
                'CICS_OUTPUT': 'OUTPUT',
                'CICS_REWRITE': 'INPUT_OUTPUT',
                'STRING_MANIPULATION': 'DERIVED',
                'CALCULATED': 'DERIVED',
                'UNUSED': 'UNUSED'
            };
            
            return normalizedMappings[usageType.toUpperCase()] || usageType.toUpperCase();
        }

        function displayFieldMappingsWithSummary(mappings, summary) {
            const tbody = document.getElementById('fieldMappingTableBody');
            tbody.innerHTML = '';

            if (!mappings || mappings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No field mappings found</td></tr>';
                return;
            }

            mappings.forEach(mapping => {
                const row = document.createElement('tr');
                
                let normalizedUsageType = normalizeUsageType(mapping.usage_type || 'STATIC');
                
                row.innerHTML = `
                    <td>
                        <div style="min-width: 150px;">
                            <strong>${mapping.field_name || 'N/A'}</strong>
                            ${mapping.friendly_name && mapping.friendly_name !== mapping.field_name ? 
                                `<br><small class="text-muted">${mapping.friendly_name}</small>` : ''}
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 120px;">
                            <code style="font-size: 0.8rem;">${mapping.mainframe_data_type || 'UNKNOWN'}</code>
                            <br><small><strong>Length:</strong> ${mapping.mainframe_length || 0}</small>
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 120px;">
                            <code style="font-size: 0.8rem;">${mapping.oracle_data_type || 'VARCHAR2(50)'}</code>
                            <br><small><strong>Length:</strong> ${mapping.oracle_length || 50}</small>
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 150px;">
                            <strong>${mapping.population_source || 'Program logic'}</strong>
                            ${mapping.source_record_layout ? `<br><small>From: ${mapping.source_record_layout}</small>` : ''}
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 120px;">
                            <span class="badge ${getBadgeClass(normalizedUsageType)}">${normalizedUsageType}</span>
                            <br><small style="font-size: 0.75rem;">${mapping.business_logic_description || ''}</small>
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 100px;">
                            ${Array.isArray(mapping.programs_involved) ? 
                                mapping.programs_involved.join(', ') : 
                                mapping.programs_involved || 'Unknown'}
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 80px;">
                            <button class="btn btn-secondary" onclick="showFieldDetails('${mapping.field_name}')" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap;">
                                View Details
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function displayLayoutSummary(layoutName) {
            try {
                const response = await fetch(`/api/layout-summary/${currentSessionId}/${layoutName}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const summary = data.summary;
                        const summarySection = document.getElementById('layoutSummarySection');
                        const summaryContent = document.getElementById('layoutSummaryContent');
                        
                        if (!summarySection || !summaryContent) {
                            return;
                        }
                        
                        summaryContent.innerHTML = `
                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                                <div>
                                    <h5>${summary.layout_name}</h5>
                                    <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #666;">${summary.friendly_name}</p>
                                    <p style="font-size: 0.85rem; line-height: 1.4;">${summary.business_purpose}</p>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #667eea;">${summary.total_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Total</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">${summary.input_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Input</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #17a2b8;">${summary.output_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Output</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #6c757d;">${summary.static_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Static</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #dc3545;">${summary.unused_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Unused</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #ffc107;">${summary.derived_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Derived</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        summarySection.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading layout summary:', error);
            }
        }

        async function showFieldDetails(fieldName) {
            try {
                const response = await fetch(`/api/field-details/${currentSessionId}/${fieldName}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayFieldDetailsModal(data.field_details);
                    } else {
                        showError(`Could not load details for field ${fieldName}`);
                    }
                }
            } catch (error) {
                console.error('Error loading field details:', error);
                showError('Error loading field details');
            }
        }

        function displayFieldDetailsModal(fieldDetails) {
            const modalTitle = document.getElementById('fieldModalTitle');
            const fieldDetailsContent = document.getElementById('fieldDetailsContent');
            
            if (!modalTitle || !fieldDetailsContent) {
                console.error('Modal elements not found');
                return;
            }
            
            try {
                modalTitle.textContent = `${fieldDetails.field_name} - Field Details`;
                
                const normalizedUsageType = normalizeUsageType(fieldDetails.usage_type || 'STATIC');
                const content = createFieldDetailsContent({...fieldDetails, usage_type: normalizedUsageType});
                fieldDetailsContent.innerHTML = content;
                
                const modal = document.getElementById('fieldDetailsModal');
                if (modal) {
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                }
            } catch (error) {
                console.error('Error displaying field details modal:', error);
                showError('Error displaying field details');
            }
        }

        function createFieldDetailsContent(fieldDetails) {
            const operationsSummary = fieldDetails.operations ? 
                fieldDetails.operations.map(op => 
                    `${op.program_name}: ${normalizeUsageType(op.usage_type)} (${op.move_source_count + op.move_target_count + op.arithmetic_count + op.conditional_count} operations)`
                ).join('<br>') : 'No operations found';

            const referencesHtml = fieldDetails.references ? 
                fieldDetails.references.map(ref => `
                    <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 4px;">
                        <strong>Line ${ref.line_number}:</strong> ${normalizeUsageType(ref.operation_type)}<br>
                        <code style="font-size: 0.8rem;">${ref.line_content}</code>
                    </div>
                `).join('') : 'No references found';

            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <h5>Field Information</h5>
                        <table style="width: 100%; font-size: 0.9rem;">
                            <tr><td><strong>Name:</strong></td><td>${fieldDetails.field_name || 'N/A'}</td></tr>
                            <tr><td><strong>Friendly Name:</strong></td><td>${fieldDetails.friendly_name || 'N/A'}</td></tr>
                            <tr><td><strong>Usage Type:</strong></td><td><span class="badge ${getBadgeClass(fieldDetails.usage_type || 'UNKNOWN')}">${fieldDetails.usage_type || 'UNKNOWN'}</span></td></tr>
                            <tr><td><strong>Source Field:</strong></td><td>${fieldDetails.source_field || 'N/A'}</td></tr>
                            <tr><td><strong>Target Field:</strong></td><td>${fieldDetails.target_field || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div>
                        <h5>Data Types & Lengths</h5>
                        <table style="width: 100%; font-size: 0.9rem;">
                            <tr><td><strong>Mainframe Type:</strong></td><td><code>${fieldDetails.mainframe_data_type || 'UNKNOWN'}</code></td></tr>
                            <tr><td><strong>Mainframe Length:</strong></td><td>${fieldDetails.mainframe_length || 0}</td></tr>
                            <tr><td><strong>Oracle Type:</strong></td><td><code>${fieldDetails.oracle_data_type || 'VARCHAR2(50)'}</code></td></tr>
                            <tr><td><strong>Oracle Length:</strong></td><td>${fieldDetails.oracle_length || 50}</td></tr>
                            <tr><td><strong>Total References:</strong></td><td>${fieldDetails.total_references || 0}</td></tr>
                        </table>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h5>Business Purpose</h5>
                    <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                        ${fieldDetails.business_purpose || 'No description available'}
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h5>Field Definition</h5>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.9rem;">
                        ${fieldDetails.definition_code || 'Definition not available'}
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h5>Program Operations</h5>
                    <div style="font-size: 0.9rem;">
                        ${operationsSummary}
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h5>Field References (First 10)</h5>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${referencesHtml}
                    </div>
                </div>

                <div>
                    <h5>Source Code Context</h5>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                        <pre style="margin: 0; font-size: 0.8rem; white-space: pre-wrap;">${fieldDetails.source_code_snippet || 'Source code not available'}</pre>
                    </div>
                </div>
            `;
        }

        function closeFieldDetailsModal() {
            document.getElementById('fieldDetailsModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function exportFieldMappings() {
            const table = document.getElementById('fieldMappingTableBody');
            const rows = table.querySelectorAll('tr');
            
            if (rows.length === 0 || rows[0].textContent.includes('No field mappings')) {
                alert('No field mappings to export');
                return;
            }
            
            let csv = 'Field Name,Mainframe Data Type,Oracle Data Type,MF Length,Oracle Length,Population Source,Business Logic,Programs Involved\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                cells.forEach(cell => {
                    const text = cell.textContent.trim().replace(/\n/g, ' ').replace(/,/g, ';');
                    rowData.push(`"${text}"`);
                });
                csv += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `field_mappings_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function getBadgeClass(type) {
            const badgeMap = {
                'INPUT': 'badge-primary',
                'OUTPUT': 'badge-success', 
                'INPUT_OUTPUT': 'badge-warning',
                'DERIVED': 'badge-warning',
                'REFERENCE': 'badge-info',
                'STATIC': 'badge-secondary',
                'UNUSED': 'badge-danger',
                'MOVE': 'badge-primary',
                'CONDITIONAL': 'badge-warning',
                'CALCULATED': 'badge-success',
                'STRING_MANIPULATION': 'badge-info',
                'CICS_INPUT': 'badge-primary',
                'CICS_OUTPUT': 'badge-success',
                'CICS_REWRITE': 'badge-warning'
            };
            return badgeMap[type] || 'badge-secondary';
        }

        // Chat Functions
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addChatMessage('user', message);
            input.value = '';
            updateChatTokenCounter();

            const typingId = addChatMessage('assistant', 'Thinking...');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message: message,
                        conversation_id: currentConversationId
                    })
                });

               if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById(typingId).remove();
                    
                    if (data.success) {
                        const responseContent = data.response || data.content || data.message || 'No response';
                        addChatMessage('assistant', responseContent);
                        
                        if (data.tokens_used) {
                            updateTokenCounters();
                        }
                    } else {
                        addChatMessage('assistant', data.error || 'Sorry, I encountered an error.');
                    }

                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error sending chat message:', error);
                document.getElementById(typingId).remove();
                addChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            }
        }

        function addChatMessage(type, message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${type}`;
            
            let displayMessage = '';
            if (typeof message === 'string') {
                displayMessage = message;
            } else if (typeof message === 'object') {
                if (message.response) {
                    displayMessage = message.response;
                } else if (message.content) {
                    displayMessage = message.content;
                } else {
                    displayMessage = JSON.stringify(message, null, 2);
                }
            } else {
                displayMessage = String(message);
            }
            
            const formattedMessage = displayMessage
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `<p>${formattedMessage}</p>`;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageId;
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
            updateChatTokenCounter();
        }

        function updateChatTokenCounter() {
            const input = document.getElementById('chatInput');
            const counter = document.getElementById('chatTokenCounter');
            const tokenCount = Math.ceil(input.value.length / 4);
            counter.textContent = `${tokenCount} tokens`;
        }

        // Utility Functions
        function updateTokenCounters() {
            const totalComponents = componentsData.length;
            const estimatedTokens = totalComponents * 1500;
            
            document.getElementById('totalTokens').textContent = estimatedTokens;
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function showLoading(message = 'Processing...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showLoadingWithProgress(title) {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            updateLoadingProgress('Starting analysis...', 0, 'Initializing...');
            resetAnalysisSteps();
        }

        function updateLoadingProgress(message, percentage, progressText) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = progressText;
        }

        function resetAnalysisSteps() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                step.className = 'analysis-step';
            });
        }

        function updateAnalysisStep(stepNumber, status, message) {
            const stepElement = document.getElementById(`step${stepNumber}`);
            stepElement.className = `analysis-step ${status}`;
            
            if (message) {
                stepElement.innerHTML = `<span class="step-icon"></span> ${message}`;
            }
        }

        function showErrorInStep(fileName, error) {
            updateAnalysisStep(1, 'error', `Error parsing ${fileName}`);
            document.getElementById('progressText').textContent = `Error: ${error}`;
            document.getElementById('progressText').style.color = '#dc3545';
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }

        function getFileType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const typeMap = {
                'cbl': 'COBOL',
                'cob': 'COBOL',
                'cpy': 'COPYBOOK',
                'jcl': 'JCL'
            };
            return typeMap[ext] || 'COBOL';
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10001;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Panel Management
        function togglePanel(side) {
            const panel = document.getElementById(side + 'Panel');
            const isCollapsed = panel.classList.contains('collapsed');
            
            if (isCollapsed) {
                panel.classList.remove('collapsed');
                removeRestoreButton(side);
            } else {
                panel.classList.add('collapsed');
                addRestoreButton(side);
            }
        }

        function addRestoreButton(side) {
            const existing = document.getElementById(`restore-${side}`);
            if (existing) existing.remove();
            
            const button = document.createElement('button');
            button.id = `restore-${side}`;
            button.className = `panel-restore ${side}`;
            button.innerHTML = side === 'left' ? 'üìÅ<br><small>Dashboard</small>' : 'üí¨<br><small>Chat</small>';
            button.title = `Restore ${side} panel`;
            button.onclick = () => togglePanel(side);
            
            document.body.appendChild(button);
        }

        function removeRestoreButton(side) {
            const button = document.getElementById(`restore-${side}`);
            if (button) button.remove();
        }

        async function refreshUI() {
            await loadMetrics();
            await loadComponentsList();
            await populateDependencyDropdown();
        }

        async function loadMetrics() {
            try {
                const response = await fetch(`/api/session-metrics/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateMetricsDisplay(data.metrics);
                    }
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        function updateMetricsDisplay(metrics) {
            document.getElementById('totalComponents').textContent = metrics.total_components || 0;
            document.getElementById('totalPrograms').textContent = metrics.component_counts?.PROGRAM || 0;
            document.getElementById('totalFields').textContent = metrics.total_fields || 0;
            document.getElementById('totalTokens').textContent = 
                (metrics.token_usage?.total_prompt_tokens || 0) + (metrics.token_usage?.total_response_tokens || 0);
        }

        async function loadComponentsList() {
            try {
                const response = await fetch(`/api/components/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateComponentsList(data.components);
                    }
                }
            } catch (error) {
                console.error('Error loading components list:', error);
            }
        }

        function updateComponentsList(components) {
            const container = document.getElementById('componentsList');
            container.innerHTML = '';

            if (!components || components.length === 0) {
                container.innerHTML = '<p class="text-muted">No components uploaded yet</p>';
                return;
            }

            const list = document.createElement('div');
            const typeGroups = {};

            components.forEach(component => {
                const type = component.component_type;
                if (!typeGroups[type]) {
                    typeGroups[type] = [];
                }
                typeGroups[type].push(component);
            });

            Object.keys(typeGroups).forEach(type => {
                const typeHeader = document.createElement('h5');
                typeHeader.textContent = `${type}s (${typeGroups[type].length})`;
                typeHeader.style.color = '#667eea';
                typeHeader.style.marginTop = '1rem';
                typeHeader.style.fontSize = '0.9rem';
                list.appendChild(typeHeader);

                typeGroups[type].forEach(component => {
                    const item = document.createElement('div');
                    item.style.padding = '0.5rem';
                    item.style.borderLeft = '3px solid #667eea';
                    item.style.paddingLeft = '0.5rem';
                    item.style.marginBottom = '0.5rem';
                    item.style.backgroundColor = '#f8f9ff';
                    item.style.borderRadius = '4px';
                    item.style.cursor = 'pointer';
                    
                    let businessPurpose = (component.llm_summary && component.llm_summary.business_purpose) || component.business_purpose || 'Analysis pending';
                    
                    if ((!component.llm_summary || !component.llm_summary.business_purpose) && component.analysis_result_json) {
                        try {
                            const analysis = JSON.parse(component.analysis_result_json);
                            if (analysis.llm_summary && analysis.llm_summary.business_purpose) {
                                businessPurpose = analysis.llm_summary.business_purpose;
                            } else if (analysis.business_purpose) {
                                businessPurpose = analysis.business_purpose;
                            }
                        } catch (e) {
                            console.warn('Could not parse analysis for', component.component_name);
                        }
                    }
                    
                    item.innerHTML = `
                        <div style="font-weight: bold; font-size: 0.8rem;">${component.component_name}</div>
                        <div style="font-size: 0.7rem; color: #666; margin-top: 0.2rem;">
                            ${component.total_lines || 0} lines
                        </div>
                        <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem; 
                                   max-height: 2.4em; overflow: hidden; line-height: 1.2em;">
                            ${businessPurpose}
                        </div>
                    `;
                    
                    item.onclick = () => {
                        alert(`${component.component_name}\n\nLines: ${component.total_lines || 0}\n\nPurpose: ${businessPurpose}`);
                    };
                    
                    list.appendChild(item);
                });
            });

            container.appendChild(list);
        }

        function updateDashboardMetrics(components) {
            const programs = components.filter(c => c.component_type === 'PROGRAM');
            const recordLayouts = components.filter(c => c.component_type === 'RECORD_LAYOUT');
            const cicsFiles = components.filter(c => c.component_type === 'CICS_FILE');
            
            document.getElementById('parsedPrograms').textContent = programs.length;
            document.getElementById('recordLayouts').textContent = recordLayouts.length;
            document.getElementById('cicsFiles').textContent = cicsFiles.length;
        }

        // Additional component actions
        function reAnalyzeComponent(componentName) {
            alert(`Re-analysis functionality for ${componentName} coming soon!`);
        }

        function askAboutThis(componentName) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value = `Tell me about the ${componentName} component. What does it do and how does it work?`;
            chatInput.focus();
        }

        function filterComponents() {
            console.log('Filtering components...');
        }

        // Component Details Functions
        async function showProgramDetails(programName) {
        try {
            // Get detailed program information from API
            const response = await fetch(`/api/component-source/${currentSessionId}/${programName}`);
            const data = await response.json();
            
            if (data.success) {
                displayProgramDetailsModal(data.components[0], programName);
            } else {
                // Fallback to basic component data
                showBasicProgramDetails(programName);
            }
        } catch (error) {
            console.error('Error loading program details:', error);
            showBasicProgramDetails(programName);
        }
    }

        async function showFileDetails(fileName) {
    try {
        // Get file and layout information
        const [dependencyResponse, layoutResponse] = await Promise.all([
            fetch(`/api/dependencies/${currentSessionId}`),
            fetch(`/api/record-layouts/${currentSessionId}`)
        ]);
        
        const dependencyData = await dependencyResponse.json();
        const layoutData = await layoutResponse.json();
        
        displayFileDetailsModal(fileName, dependencyData, layoutData);
    } catch (error) {
        console.error('Error loading file details:', error);
        showBasicFileDetails(fileName);
    }
}

function displayProgramDetailsModal(programData, programName) {
    // Safety check and defaults
    if (!programData) {
        programData = {
            component_name: programName,
            friendly_name: programName.replace('-', ' '),
            component_type: 'COBOL Program',
            total_lines: 'Unknown',
            total_fields: 'Unknown',
            business_purpose: 'Program analysis information not available',
            source_for_chat: 'Source code not available'
        };
    }

    const modalHtml = `
        <div class="modal" style="display: block; z-index: 10001;">
            <div class="modal-content" style="width: 80%; max-width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title">${programName} - Program Details</h3>
                    <button class="close" onclick="closeProgramModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h5>Program Information</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>Program Name:</strong></td><td>${programData.component_name || programName}</td></tr>
                                <tr><td><strong>Friendly Name:</strong></td><td>${programData.friendly_name || programName.replace('-', ' ')}</td></tr>
                                <tr><td><strong>Type:</strong></td><td>${programData.component_type || 'COBOL Program'}</td></tr>
                                <tr><td><strong>Lines of Code:</strong></td><td>${programData.total_lines || 'Unknown'}</td></tr>
                                <tr><td><strong>Total Fields:</strong></td><td>${programData.total_fields || 'Unknown'}</td></tr>
                            </table>
                        </div>
                        <div>
                            <h5>Analysis Metrics</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>Complexity Score:</strong></td><td>${programData.complexity_score ? Math.round(programData.complexity_score * 100) + '%' : 'N/A'}</td></tr>
                                <tr><td><strong>Analysis Status:</strong></td><td><span class="badge badge-success">Complete</span></td></tr>
                                <tr><td><strong>Dependencies:</strong></td><td id="programDependencyCount">Loading...</td></tr>
                                <tr><td><strong>Called By:</strong></td><td id="programCallerCount">Loading...</td></tr>
                            </table>
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <h5>Business Purpose</h5>
                        <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                            ${programData.business_purpose || 'This program handles mainframe business logic and data processing operations.'}
                        </div>
                    </div>

                    <div class="program-details-tabs">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; border-bottom: 1px solid #e9ecef;">
                            <button class="tab-button active" onclick="showProgramTab('dependencies', this)">Dependencies</button>
                            <button class="tab-button" onclick="showProgramTab('fields', this)">Field Usage</button>
                            <button class="tab-button" onclick="showProgramTab('source', this)">Source Code</button>
                        </div>

                        <div id="dependencies-tab" class="program-tab active">
                            <div id="programDependencies">Loading dependency information...</div>
                        </div>

                        <div id="fields-tab" class="program-tab" style="display: none;">
                            <div id="programFields">Loading field usage...</div>
                        </div>

                        <div id="source-tab" class="program-tab" style="display: none;">
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; max-height: 400px; overflow-y: auto;">
                                <pre style="margin: 0; font-size: 0.8rem; white-space: pre-wrap;">${programData.source_for_chat || 'Source code not available'}</pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="askAboutProgram('${programName}')">Ask AI About This</button>
                    <button class="btn btn-secondary" onclick="closeProgramModal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Load additional data
    loadProgramDependencies(programName);
    loadProgramFields(programName);
}

async function loadProgramDependencies(programName) {
    try {
        const response = await fetch(`/api/dependencies/${currentSessionId}`);
        const data = await response.json();
        
        if (data.success) {
            const outgoing = data.dependencies.filter(dep => dep.source_component === programName);
            const incoming = data.dependencies.filter(dep => dep.target_component === programName);
            
            document.getElementById('programDependencyCount').textContent = outgoing.length;
            document.getElementById('programCallerCount').textContent = incoming.length;
            
            const dependenciesHtml = createDependencyTables(outgoing, incoming);
            document.getElementById('programDependencies').innerHTML = dependenciesHtml;
        }
    } catch (error) {
        console.error('Error loading program dependencies:', error);
        document.getElementById('programDependencies').innerHTML = 'Error loading dependency information.';
    }
}

function createDependencyTables(outgoing, incoming) {
    let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">';
    
    html += '<div><h6>This Program Calls:</h6>';
    if (outgoing.length > 0) {
        html += '<div style="max-height: 200px; overflow-y: auto;">';
        outgoing.forEach(dep => {
            const icon = dep.interface_type === 'CICS' ? 'üè¶' : dep.relationship_type.includes('FILE') ? 'üìÅ' : 'üìû';
            html += `<div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 4px; font-size: 0.8rem;">${icon} <strong>${dep.target_component}</strong><br><small>${dep.relationship_type} via ${dep.interface_type}</small></div>`;
        });
        html += '</div>';
    } else {
        html += '<p class="text-muted">No outgoing dependencies found.</p>';
    }
    html += '</div>';
    
    html += '<div><h6>Called By:</h6>';
    if (incoming.length > 0) {
        html += '<div style="max-height: 200px; overflow-y: auto;">';
        incoming.forEach(dep => {
            html += `<div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #28a745; border-radius: 4px; font-size: 0.8rem;">üìû <strong>${dep.source_component}</strong><br><small>${dep.relationship_type}</small></div>`;
        });
        html += '</div>';
    } else {
        html += '<p class="text-muted">No incoming dependencies found.</p>';
    }
    html += '</div></div>';
    
    return html;
}

async function loadProgramFields(programName) {
    try {
        const response = await fetch(`/api/field-matrix?session_id=${currentSessionId}&program_name=${programName}`);
        const data = await response.json();
        
        if (data.success && data.matrix_data) {
            const fieldsHtml = createProgramFieldsDisplay(data.matrix_data);
            document.getElementById('programFields').innerHTML = fieldsHtml;
        } else {
            document.getElementById('programFields').innerHTML = '<p class="text-muted">No field usage information available.</p>';
        }
    } catch (error) {
        console.error('Error loading program fields:', error);
        document.getElementById('programFields').innerHTML = 'Error loading field information.';
    }
}

function createProgramFieldsDisplay(matrixData) {
    const fields = matrixData.fields || [];
    
    if (fields.length === 0) {
        return '<p class="text-muted">No field usage data found.</p>';
    }

    let html = `<div style="max-height: 300px; overflow-y: auto;"><table class="data-table" style="font-size: 0.8rem;"><thead><tr><th>Field Name</th><th>Usage</th><th>Source/Target</th><th>Purpose</th></tr></thead><tbody>`;

    fields.forEach(field => {
        html += `<tr><td><strong>${field.field_name}</strong>${field.friendly_name ? `<br><small class="text-muted">${field.friendly_name}</small>` : ''}</td><td><span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type || 'STATIC'}</span></td><td>${field.source_field || 'N/A'}</td><td>${field.business_purpose || 'Field processing'}</td></tr>`;
    });

    html += '</tbody></table></div>';
    return html;
}

function displayFileDetailsModal(fileName, dependencyData, layoutData) {
    // Find related layouts
    const relatedLayouts = layoutData.success ? 
        layoutData.layouts.filter(layout => 
            layout.layout_name.toUpperCase().includes(fileName.toUpperCase()) ||
            fileName.toUpperCase().includes(layout.layout_name.toUpperCase())
        ) : [];

    // Find file dependencies
    const fileDependencies = dependencyData.success ?
        dependencyData.dependencies.filter(dep => 
            dep.target_component.toUpperCase() === fileName.toUpperCase()
        ) : [];

    const modalHtml = `
        <div class="modal" style="display: block; z-index: 10001;">
            <div class="modal-content" style="width: 80%; max-width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title">${fileName} - File Details</h3>
                    <button class="close" onclick="closeFileModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h5>File Information</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>File Name:</strong></td><td>${fileName}</td></tr>
                                <tr><td><strong>Interface Type:</strong></td><td>${fileDependencies[0]?.interface_type || 'FILE_SYSTEM'}</td></tr>
                                <tr><td><strong>I/O Operations:</strong></td><td>${getFileOperations(fileDependencies)}</td></tr>
                                <tr><td><strong>Access Programs:</strong></td><td>${fileDependencies.length}</td></tr>
                            </table>
                        </div>
                        <div>
                            <h5>Layout Information</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>Associated Layouts:</strong></td><td>${relatedLayouts.length}</td></tr>
                                <tr><td><strong>Total Fields:</strong></td><td>${getTotalFields(relatedLayouts)}</td></tr>
                                <tr><td><strong>Layout Status:</strong></td><td>${relatedLayouts.length > 0 ? '<span class="badge badge-success">Available</span>' : '<span class="badge badge-warning">No Layouts</span>'}</td></tr>
                            </table>
                        </div>
                    </div>

                    <div class="file-details-tabs">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; border-bottom: 1px solid #e9ecef;">
                            <button class="tab-button active" onclick="showFileTab('access', this)">File Access</button>
                            <button class="tab-button" onclick="showFileTab('layouts', this)">Record Layouts</button>
                            <button class="tab-button" onclick="showFileTab('fields', this)">Field Structure</button>
                        </div>

                        <div id="access-tab" class="file-tab active">
                            <h6>Programs Accessing This File</h6>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${createFileAccessTable(fileDependencies)}
                            </div>
                        </div>

                        <div id="layouts-tab" class="file-tab" style="display: none;">
                            <h6>Associated Record Layouts</h6>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${createLayoutTable(relatedLayouts)}
                            </div>
                        </div>

                        <div id="fields-tab" class="file-tab" style="display: none;">
                            <h6>Field Structure Analysis</h6>
                            <div id="fileFieldStructure">
                                ${relatedLayouts.length > 0 ? 'Loading field structure...' : 'No layout information available for field analysis.'}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="analyzeFileMapping('${fileName}')">Analyze Field Mapping</button>
                    <button class="btn btn-secondary" onclick="askAboutFile('${fileName}')">Ask AI About This</button>
                    <button class="btn btn-secondary" onclick="closeFileModal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Load field structure if layouts are available
    if (relatedLayouts.length > 0) {
        loadFileFieldStructure(fileName, relatedLayouts[0].layout_name);
    }
}

// Helper functions for file details
function getFileOperations(dependencies) {
    const operations = new Set();
    dependencies.forEach(dep => {
        if (dep.analysis_details && dep.analysis_details.operations) {
            dep.analysis_details.operations.forEach(op => operations.add(op));
        }
    });
    return Array.from(operations).join(', ') || 'READ/WRITE';
}

function getTotalFields(layouts) {
    return layouts.reduce((total, layout) => total + (layout.fields_count || 0), 0);
}

function createFileAccessTable(dependencies) {
    if (dependencies.length === 0) {
        return '<p class="text-muted">No program access information available.</p>';
    }

    let html = `<table class="data-table" style="font-size: 0.9rem;"><thead><tr><th>Program</th><th>Operation</th><th>Interface</th><th>Confidence</th></tr></thead><tbody>`;

    dependencies.forEach(dep => {
        const operations = dep.analysis_details?.operations?.join(', ') || 'Unknown';
        const confidence = Math.round((dep.confidence_score || 0) * 100);
        html += `<tr><td>${dep.source_component}</td><td>${operations}</td><td>${dep.interface_type || 'FILE'}</td><td>${confidence}%</td></tr>`;
    });

    html += '</tbody></table>';
    return html;
}

function createLayoutTable(layouts) {
    if (layouts.length === 0) {
        return '<p class="text-muted">No record layouts found for this file.</p>';
    }

    let html = `<table class="data-table" style="font-size: 0.9rem;"><thead><tr><th>Layout Name</th><th>Program</th><th>Fields</th><th>Actions</th></tr></thead><tbody>`;

    layouts.forEach(layout => {
        html += `<tr><td><strong>${layout.layout_name}</strong>${layout.friendly_name ? `<br><small class="text-muted">${layout.friendly_name}</small>` : ''}</td><td>${layout.program_name || 'Unknown'}</td><td>${layout.fields_count || 0}</td><td><button class="btn btn-secondary" onclick="viewLayoutFields('${layout.layout_name}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Fields</button></td></tr>`;
    });

    html += '</tbody></table>';
    return html;
}

// Tab switching functions
function showProgramTab(tabName, button) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    document.querySelectorAll('.program-tab').forEach(tab => tab.style.display = 'none');
    document.getElementById(tabName + '-tab').style.display = 'block';
}

function showFileTab(tabName, button) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    document.querySelectorAll('.file-tab').forEach(tab => tab.style.display = 'none');
    document.getElementById(tabName + '-tab').style.display = 'block';
}

// Modal close functions
function closeProgramModal() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (modal.style.zIndex === '10001') {
            modal.remove();
        }
    });
}

function closeFileModal() {
    closeProgramModal();
}

// Action functions
function askAboutProgram(programName) {
    closeProgramModal();
    const chatInput = document.getElementById('chatInput');
    chatInput.value = `Tell me about the ${programName} program. What does it do, what are its key functions, and how does it interact with other components?`;
    chatInput.focus();
}

function askAboutFile(fileName) {
    closeFileModal();
    const chatInput = document.getElementById('chatInput');
    chatInput.value = `Explain the ${fileName} file. What data does it contain, which programs access it, and what is its business purpose?`;
    chatInput.focus();
}

function analyzeFileMapping(fileName) {
    closeFileModal();
    showTab({target: document.querySelector('.tab-btn:nth-child(5)')}, 'fieldMapping');
    document.getElementById('targetFileInput').value = fileName;
}

function viewLayoutFields(layoutName) {
    closeFileModal();
    showTab({target: document.querySelector('.tab-btn:nth-child(4)')}, 'fieldMatrix');
    document.getElementById('recordLayoutSelect').value = layoutName;
    loadFieldMatrix();
}

// Fallback functions
function showBasicProgramDetails(programName) {
    alert(`Program Details: ${programName}\n\nDetailed information could not be loaded.\nPlease check the connection and try again.`);
}

function showBasicFileDetails(fileName) {
    alert(`File Details: ${fileName}\n\nDetailed information could not be loaded.\nPlease check the connection and try again.`);
}



        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('configModal');
            const fieldModal = document.getElementById('fieldDetailsModal');
            
            if (event.target === modal) {
                closeConfigModal();
            }
            if (event.target === fieldModal) {
                closeFieldDetailsModal();
            }
        }

  


function createFileLayerWithLayouts(title, items, className) {
            let html = `
                <div class="flow-level">
                    <div class="flow-level-title">${title}</div>
                    <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">
 `;
            
            items.forEach(item => {
                const layoutInfo = item.hasLayoutAssociation && item.associatedLayouts.length > 0 ?
                    `<div style="font-size: 0.7rem; color: #666; margin-top: 0.5rem;">
                        üìã Layouts: ${item.associatedLayouts.slice(0, 2).join(', ')}
                        ${item.associatedLayouts.length > 2 ? ` (+${item.associatedLayouts.length - 2} more)` : ''}
                    </div>` : '';
                    
                const interfaceIcon = item.interface === 'CICS' ? 'üè¶' : 'üìÅ';
                const statusClass = item.hasLayoutAssociation ? 'file-with-layout' : 'file-only';
                
                html += `
                    <div class="flow-component ${className} ${statusClass}" onclick="showFileDetails('${item.name}')">
                        <div class="component-name">${interfaceIcon} ${item.name}</div>
                        <div class="component-type-badge">${item.type}</div>
                        <div class="component-description">
                            Operations: ${item.operations.join(', ') || 'Unknown'}
                            <br>Interface: ${item.interface}
                            ${layoutInfo}
                        </div>
                        <div class="confidence-indicator ${getConfidenceClass(item.confidence)}">
                            ${(item.confidence * 100).toFixed(0)}%
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

        function createProgramLayerWithArrows(title, items, className) {
            let html = `
                <div class="flow-level">
                    <div class="flow-level-title">${title}</div>
                    <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">
            `;
            
            items.forEach(item => {
                const arrowIcon = getCallArrowIcon(item.callType);
                const statusClass = item.status === 'missing' ? 'missing-dependency' : 'present-program';
                
                html += `
                    <div class="program-call-container">
                        <div class="call-arrow">${arrowIcon}</div>
                        <div class="flow-component ${className} ${statusClass}" onclick="showProgramDetails('${item.name}')">
                            <div class="component-name">${item.name}</div>
                            <div class="component-type-badge">${item.type}</div>
                            <div class="component-description">
                                Call Type: ${item.callType}
                                <br>Status: ${item.status || 'Present'}
                            </div>
                            <div class="confidence-indicator ${getConfidenceClass(item.confidence)}">
                                ${(item.confidence * 100).toFixed(0)}%
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

        function getCallArrowIcon(callType) {
            const arrowMap = {
                'CALL': '‚ÜîÔ∏è',
                'XCTL': '‚Üí',
                'LINK': '‚ÜîÔ∏è',
                'DYNAMIC': '‚§¥Ô∏è',
                'CICS_LINK': '‚ÜîÔ∏è',
                'CICS_XCTL': '‚Üí'
            };
            
            return arrowMap[callType] || '‚Üí';
        }

        function getConfidenceClass(confidence) {
            if (confidence > 0.8) return 'confidence-high';
            if (confidence > 0.5) return 'confidence-medium';
            return 'confidence-low';
        }

        function categorizeDependenciesWithLayouts(dependencies, focusComponent = null) {
            const categorized = {
                inputFiles: [],
                outputFiles: [],
                inputOutputFiles: [],
                corePrograms: [],
                calledPrograms: [],
                missingPrograms: []
            };
            
            dependencies.forEach(dep => {
                const source = dep.source_component;
                const target = dep.target_component;
                const type = dep.relationship_type;
                const analysis = dep.analysis_details || {};
                
                if (type === 'PROGRAM_CALL' || type === 'DYNAMIC_PROGRAM_CALL') {
                    const callType = analysis.call_type || 'CALL';
                    const isTarget = target === focusComponent;
                    
                    if (focusComponent && isTarget) {
                        categorized.corePrograms.push({
                            name: source,
                            type: 'Calling Program',
                            confidence: dep.confidence_score || 0.8,
                            callDirection: 'incoming',
                            callType: callType
                        });
                    } else {
                        categorized.calledPrograms.push({
                            name: target,
                            type: 'Called Program',
                            confidence: dep.confidence_score || 0.8,
                            callDirection: getArrowDirection(callType),
                            callType: callType,
                            status: dep.dependency_status || 'unknown'
                        });
                    }
                }
                else if (type.includes('FILE')) {
                    const ioDirection = analysis.io_direction || 'UNKNOWN';
                    const associatedLayouts = analysis.associated_layouts || [];
                    const hasLayout = analysis.has_layout_association || false;
                    
                    const fileInfo = {
                        name: target,
                        type: getFileTypeLabel(type),
                        confidence: dep.confidence_score || 0.8,
                        ioDirection: ioDirection,
                        associatedLayouts: associatedLayouts,
                        hasLayoutAssociation: hasLayout,
                        interface: dep.interface_type || 'FILE',
                        operations: analysis.operations || []
                    };
                    
                    if (ioDirection === 'INPUT') {
                        categorized.inputFiles.push(fileInfo);
                    } else if (ioDirection === 'OUTPUT') {
                        categorized.outputFiles.push(fileInfo);
                    } else if (ioDirection === 'INPUT_OUTPUT') {
                        categorized.inputOutputFiles.push(fileInfo);
                    }
                }
                
                if (dep.dependency_status === 'missing') {
                    categorized.missingPrograms.push({
                        name: target,
                        type: 'Missing Program',
                        confidence: dep.confidence_score || 0.3,
                        reason: 'Program not uploaded',
                        calledFrom: source
                    });
                }
            });
            
            return categorized;
        }

        function getArrowDirection(callType) {
            const directionMap = {
                'CALL': 'bidirectional',
                'XCTL': 'outgoing',
                'LINK': 'bidirectional',
                'DYNAMIC': 'outgoing',
                'CICS_LINK': 'bidirectional',
                'CICS_XCTL': 'outgoing'
            };
            
            return directionMap[callType] || 'outgoing';
        }

        function getFileTypeLabel(relationshipType) {
            if (relationshipType.includes('CICS')) {
                return 'CICS File';
            } else if (relationshipType.includes('INPUT_OUTPUT')) {
                return 'I/O File';
            } else if (relationshipType.includes('INPUT')) {
                return 'Input File';
            } else if (relationshipType.includes('OUTPUT')) {
                return 'Output File';
            }
            return 'File';
        }

        // Dependencies Flow Functions
        async function loadDependencyFlow() {
            const selectedComponent = document.getElementById('dependencyComponentSelect').value;
            
            try {
                console.log('Loading dependency flow for:', selectedComponent || 'Overall System');
                
                await populateDependencyDropdown();
                
                const response = await fetch(`/api/dependencies/${currentSessionId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Dependencies response:', data);
                    
                    if (data.success && data.dependencies && data.dependencies.length > 0) {
                        displayEnhancedDependencyFlowWithLayouts(data.dependencies, selectedComponent);
                        
                        if (document.getElementById('dependencyStatusSummary')) {
                            updateDependencyStatusDisplay(data.dependencies);
                        }
                    } else {
                        displayEmptyDependencyFlow();
                    }
                } else {
                    console.error('Dependencies API response not ok:', response.status);
                    displayEmptyDependencyFlow();
                }
            } catch (error) {
                console.error('Error loading dependency flow:', error);
                displayEmptyDependencyFlow();
            }
        }

        async function displayEnhancedDependencyFlowWithLayouts(dependencies, selectedComponent) {
    console.log('Displaying enhanced flow with layout associations');
    
    const flowContainer = document.getElementById('dependencyFlowContent');
    flowContainer.innerHTML = '';
    
    let filteredDeps = dependencies;
    if (selectedComponent) {
        filteredDeps = dependencies.filter(dep => 
            dep.source_component === selectedComponent || dep.target_component === selectedComponent
        );
    }
    
    if (filteredDeps.length === 0) {
        flowContainer.innerHTML = `<p class="text-muted">No dependencies found for ${selectedComponent || 'the system'}</p>`;
        return;
    }
    
    const categorizedDeps = categorizeDependenciesWithLayouts(filteredDeps, selectedComponent);
    
    const flowHtml = await createEnhancedDependencyFlowHTML(categorizedDeps, selectedComponent);
    flowContainer.innerHTML = flowHtml;
}

        function displayEmptyDependencyFlow() {
            document.getElementById('dependencyFlowContent').innerHTML = 
                '<p class="text-muted">Upload and analyze COBOL programs to see system architecture flow</p>';
        }

        function updateDependencyStatusDisplay(dependencies) {
            const statusCounts = {
                present: 0,
                missing: 0,
                file: 0,
                file_with_layout: 0,
                unknown: 0
            };
            
            dependencies.forEach(dep => {
                const status = dep.dependency_status || 'unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            document.getElementById('present-count').textContent = statusCounts.present || 0;
            document.getElementById('missing-count').textContent = statusCounts.missing || 0;
            document.getElementById('file-count').textContent = (statusCounts.file || 0) + (statusCounts.file_with_layout || 0);
            document.getElementById('unknown-count').textContent = statusCounts.unknown || 0;
            
            const fileCountElement = document.getElementById('file-count');
            if (statusCounts.file_with_layout > 0) {
                fileCountElement.title = `${statusCounts.file_with_layout} files have associated record layouts`;
                fileCountElement.style.borderLeft = '4px solid #28a745';
            }
            
            document.getElementById('dependencyStatusSummary').style.display = 'grid';
        }

        async function populateDependencyDropdown() {
            const select = document.getElementById('dependencyComponentSelect');
            if (!select) return;
            
            try {
                const response = await fetch(`/api/components/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.components) {
                        const programs = data.components.filter(c => c.component_type === 'PROGRAM');
                        
                        select.innerHTML = '<option value="">Overall System View</option>';
                        
                        programs.forEach(program => {
                            const option = document.createElement('option');
                            option.value = program.component_name;
                            option.textContent = `${program.component_name} (${program.friendly_name || program.component_name})`;
                            select.appendChild(option);
                        });
                        
                        console.log(`Populated dependency dropdown with ${programs.length} programs`);
                    }
                }
            } catch (error) {
                console.error('Error populating dependency dropdown:', error);
            }
        }

        function refreshDependencyFlow() {
            loadDependencyFlow();
        }

        function restoreNormalView() {
    // Hide enhanced view
    document.getElementById('enhancedDependenciesContainer').style.display = 'none';
    
    // Show normal view
    document.getElementById('dependenciesVisualization').style.display = 'block';
    
    // Reload normal dependency flow
    loadDependencyFlow();
    
    // Toggle buttons
    document.getElementById('enhancedViewBtn').style.display = 'inline-block';
    document.getElementById('normalViewBtn').style.display = 'none';
}
        async function loadEnhancedDependencies() {
    if (!currentSessionId) {
        showError('No active session');
        return;
    }

    try {
        showLoading('Loading enhanced dependencies...');
        
        const response = await fetch(`/api/dependencies-enhanced/${currentSessionId}`);
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                displayEnhancedDependencies(data);
                showDependencyStatusSummary(data.status_counts);
                
                // Toggle buttons
                document.getElementById('enhancedViewBtn').style.display = 'none';
                document.getElementById('normalViewBtn').style.display = 'inline-block';
            } else {
                showError(data.error || 'Failed to load enhanced dependencies');
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error loading enhanced dependencies:', error);
        showError('Failed to load enhanced dependencies');
    }
    
    hideLoading();
}

        function showDependencyStatusSummary(statusCounts) {
            document.getElementById('present-count').textContent = statusCounts.present || 0;
            document.getElementById('missing-count').textContent = statusCounts.missing || 0;
            document.getElementById('file-count').textContent = statusCounts.file || 0;
            document.getElementById('unknown-count').textContent = statusCounts.unknown || 0;
            
            document.getElementById('dependencyStatusSummary').style.display = 'grid';
        }

        function displayEnhancedDependencies(data) {
            const container = document.getElementById('enhancedDependenciesContainer');
            const categorizedDeps = data.categorized_dependencies;
            const missingSummary = data.missing_summary;
            
            let html = '';
            
            if (missingSummary && missingSummary.total_missing > 0) {
                html += `
                <div class="alert alert-warning">
                    <h4>‚ö†Ô∏è Missing Dependencies (${missingSummary.total_missing})</h4>
                    <p>The following programs are called but not uploaded:</p>
                    <ul>
                        ${missingSummary.missing_programs.map(prog => 
                            `<li><strong>${prog}</strong> - Upload this program for complete analysis</li>`
                        ).join('')}
                    </ul>
                </div>`;
            }
            
            if (categorizedDeps.dynamic_calls && categorizedDeps.dynamic_calls.length > 0) {
                html += createDependencySection('üîÑ Dynamic Program Calls', categorizedDeps.dynamic_calls, 'dynamic');
            }
            
            if (categorizedDeps.program_calls && categorizedDeps.program_calls.length > 0) {
                html += createDependencySection('üìû Static Program Calls', categorizedDeps.program_calls, 'static');
            }
            
            if (categorizedDeps.cics_operations && categorizedDeps.cics_operations.length > 0) {
                html += createDependencySection('üè¶ CICS File Operations', categorizedDeps.cics_operations, 'cics');
            }
            
            if (categorizedDeps.file_operations && categorizedDeps.file_operations.length > 0) {
                html += createDependencySection('üìÅ File Operations', categorizedDeps.file_operations, 'file');
            }
            
            container.innerHTML = html;
            container.style.display = 'block';
            
            document.getElementById('dependenciesVisualization').style.display = 'none';
        }

        function createDependencySection(title, dependencies, type) {
            let html = `
            <div class="dependency-section">
                <h3>${title}</h3>
                <div class="dependency-grid">
            `;
            
            dependencies.forEach(dep => {
                const statusIcon = getStatusIcon(dep.display_status);
                const statusClass = getStatusClass(dep.display_status);
                const confidenceClass = getConfidenceClass(dep.confidence_score);
                
                html += `
                <div class="dependency-card ${statusClass}">
                    <div class="confidence-indicator ${confidenceClass}">
                        ${Math.round((dep.confidence_score || 0) * 100)}%
                    </div>
                    <div class="dependency-header">
                        ${statusIcon} <strong>${dep.target_component}</strong>
                    </div>
                    <div class="dependency-details">
                        <p><strong>Called from:</strong> <span>${dep.source_component}</span></p>
                        ${type === 'dynamic' ? 
                            `<p><strong>Variable:</strong> <span>${dep.analysis_details?.variable_name || 'Unknown'}</span></p>
                            <p><strong>Resolution:</strong> <span>${dep.analysis_details?.resolution_method || 'Unknown'}</span></p>` : ''}
                        ${type === 'cics' || type === 'file' ? 
                            `<p><strong>I/O Type:</strong> <span>${dep.analysis_details?.io_direction || 'Unknown'}</span></p>
                            <p><strong>Operations:</strong> <span>${(dep.analysis_details?.operations || []).join(', ')}</span></p>` : ''}
                        <p><strong>Type:</strong> <span>${dep.relationship_type}</span></p>
                    </div>
                </div>`;
            });
            
            html += '</div></div>';
            return html;
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'present': return '‚úÖ';
                case 'missing': return '‚ùå';
                case 'file': return 'üìÅ';
                default: return '‚ùì';
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'present': return 'status-present';
                case 'missing': return 'status-missing';
                case 'file': return 'status-file';
                default: return 'status-unknown';
            }
        }

        function getConfidenceClass(confidence) {
            if (confidence > 0.8) return 'confidence-high';
            if (confidence > 0.5) return 'confidence-medium';
            return 'confidence-low';
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'components') {
                loadComponentsLibrary();
            } else if (tabName === 'fieldMatrix') {
                loadFieldMatrixSelectors();
            } else if (tabName === 'dashboard') {
                loadDashboardSummaries();
            } else if (tabName === 'dependencies') {
                loadDependencyFlow();
                if (currentSessionId) {
                    setTimeout(() => {
                        const enhancedButton = document.querySelector('button[onclick="loadEnhancedDependencies()"]');
                        if (enhancedButton) {
                            enhancedButton.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                            enhancedButton.style.color = 'white';
                        }
                    }, 100);
                }
            } else if (tabName === 'fieldMapping') {
                initializeFieldMapping();
            }
        }

        // Components Library Functions
        async function loadComponentsLibrary() {
            try {
                const response = await fetch(`/api/components-with-derived/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayComponentsLibrary(data.components);
                    }
                }
            } catch (error) {
                console.error('Error loading components library:', error);
            }
        }

        function displayComponentsLibrary(components) {
            const container = document.getElementById('mainComponentsView');
            container.innerHTML = '';

            const programs = components.filter(c => c.component_type === 'PROGRAM');
            
            if (programs.length === 0) {
                container.innerHTML = '<p class="text-muted">No programs uploaded yet</p>';
                return;
            }

            programs.forEach(program => {
                const card = document.createElement('div');
                card.className = 'component-summary-card';
                
                let businessPurpose = (program.llm_summary && program.llm_summary.business_purpose) || program.business_purpose || 'Analysis pending';
                let derivedCount = program.derived_count || 0;
                
                card.innerHTML = `
                    <div class="component-header">
                        <div>
                            <div class="component-title">${program.component_name}</div>
                            <div class="text-muted" style="font-size: 0.8rem;">${program.friendly_name || ''}</div>
                        </div>
                        <span class="component-type badge badge-primary">COBOL Program</span>
                    </div>
                    
                    <div class="business-purpose">${businessPurpose}</div>
                    
                    <div class="component-metrics">
                        <div class="metric">
                            <span class="metric-value">${program.total_lines || 0}</span>
                            <span class="metric-label">Lines of Code</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${derivedCount}</span>
                            <span class="metric-label">Analyzed Components</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${program.total_fields || 0}</span>
                            <span class="metric-label">Total Fields</span>
                        </div>
                    </div>
                    
                    <div class="derived-components">
                        <button class="derived-toggle" onclick="toggleDerivedComponents('${program.component_name}', this)">
                            View ${derivedCount} Analyzed Components
                        </button>
                        <div class="derived-list" id="derived-${program.component_name}">
                            <!-- Will be populated when expanded -->
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="reAnalyzeComponent('${program.component_name}')">Re-analyze Component</button>
                        <button class="btn btn-secondary" onclick="askAboutThis('${program.component_name}')">Ask AI About This</button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        async function toggleDerivedComponents(programName, button) {
            const derivedList = document.getElementById(`derived-${programName}`);
            
            if (derivedList.classList.contains('show')) {
                derivedList.classList.remove('show');
                button.textContent = button.textContent.replace('Hide', 'View');
            } else {
                if (derivedList.children.length === 0) {
                    try {
                        const response = await fetch(`/api/derived-components/${currentSessionId}?parent_component=${programName}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                displayDerivedComponentsList(derivedList, data.derived_components);
                            }
                        }
                    } catch (error) {
                        console.error('Error loading derived components:', error);
                        derivedList.innerHTML = '<p class="text-muted">Error loading components</p>';
                    }
                }
                
                derivedList.classList.add('show');
                button.textContent = button.textContent.replace('View', 'Hide');
            }
        }

        function displayDerivedComponentsList(container, derivedComponents) {
            container.innerHTML = '';
            
            derivedComponents.forEach(component => {
                const item = document.createElement('div');
                item.className = 'derived-item';
                
                item.innerHTML = `
                    <div>
                        <div class="derived-item-name">${component.component_name}</div>
                        <div class="text-muted" style="font-size: 0.8rem;">${component.friendly_name || ''}</div>
                    </div>
                    <div class="derived-item-type">${component.component_type}</div>
                `;
                
                container.appendChild(item);
            });
        }

        // Field Matrix Functions
        async function loadFieldMatrixSelectors() {
            try {
                const [componentsResponse, layoutsResponse] = await Promise.all([
                    fetch(`/api/components/${currentSessionId}`),
                    fetch(`/api/record-layouts/${currentSessionId}`)
                ]);
                
                if (componentsResponse.ok) {
                    const componentsData = await componentsResponse.json();
                    if (componentsData.success) {
                        populateProgramSelectors(componentsData.components);
                    }
                }
                
                if (layoutsResponse.ok) {
                    const layoutsData = await layoutsResponse.json();
                    if (layoutsData.success) {
                        populateLayoutSelectors(layoutsData.layouts);
                    }
                }
            } catch (error) {
                console.error('Error loading selectors:', error);
            }
        }

        function populateProgramSelectors(components) {
            const programSelect = document.getElementById('programSelect');
            programSelect.innerHTML = '<option value="">Select Program</option>';

            const programs = components.filter(c => c.component_type === 'PROGRAM');
            
            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.component_name;
                option.textContent = `${program.component_name} (${program.total_lines || 0} lines)`;
                programSelect.appendChild(option);
            });
        }

        function populateLayoutSelectors(layouts) {
            const recordLayoutSelect = document.getElementById('recordLayoutSelect');
            recordLayoutSelect.innerHTML = '<option value="">Select Record Layout</option>';

            layouts.forEach(layout => {
                const option = document.createElement('option');
                option.value = layout.layout_name;
                option.textContent = `${layout.layout_name} (${layout.fields_count || 0} fields) - ${layout.program_name}`;
                recordLayoutSelect.appendChild(option);
            });
        }

        async function loadFieldMatrix() {
            const recordLayout = document.getElementById('recordLayoutSelect').value;
            const program = document.getElementById('programSelect').value;

            if (!recordLayout && !program) {
                return;
            }

            showLoading('Loading field matrix...');

            try {
                const params = new URLSearchParams({
                    session_id: currentSessionId
                });
                
                if (recordLayout) params.append('record_layout', recordLayout);
                if (program) params.append('program_name', program);

                const response = await fetch(`/api/field-matrix?${params}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayFieldMatrix(data.matrix_data);
                    } else {
                        showError(data.error || 'Failed to load field matrix');
                    }
                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error loading field matrix:', error);
                showError('Failed to load field matrix');
            }

            hideLoading();
        }

      // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced Code Analyzer initialized');
        });
    </script>
</body>
</html>   