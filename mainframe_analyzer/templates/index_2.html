<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Code Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            overflow-x: hidden;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-metrics {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .metric-label {
            opacity: 0.8;
            font-size: 0.8rem;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 1rem;
            padding: 1rem;
            min-height: calc(100vh - 100px);
        }

        /* Left Panel */
        .left-panel {
            width: 420px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
            height: fit-content;
            transition: all 0.3s ease;
        }

        .left-panel.collapsed {
            display: none;
        }

        .panel-restore {
            position: fixed;
            top: 50%;
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            transform: translateY(-50%);
            z-index: 1001;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .panel-restore:hover {
            background: #5a6fd8;
            transform: translateY(-50%) scale(1.1);
        }

        .panel-restore.left {
            left: 0;
        }

        .panel-restore.right {
            right: 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
        }

        .collapse-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        .collapse-btn:hover {
            transform: scale(1.1);
        }

        /* Upload Section */
        .upload-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9ff;
            border-radius: 8px;
            border: 2px dashed #667eea;
        }

        .upload-area {
            text-align: center;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #e8ecff;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f1f3f4;
            color: #667eea;
            border: 1px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* Main Content */
        .content-area {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-btn:hover:not(.active) {
            background: #e9ecef;
        }

        /* Tab Content */
        .tab-content {
            padding: 2rem;
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Enhanced Component Summaries */
        .component-summaries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .component-summary-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .component-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .component-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }

        .component-type {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: auto;
        }

        .business-purpose {
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 1rem;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .raw-analysis {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .component-metrics {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            min-width: 60px;
        }

        .metric-value {
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            font-size: 0.7rem;
            color: #6c757d;
            text-align: center;
        }

        .complexity-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .complexity-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            transition: width 0.3s ease;
        }

        .derived-components {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .derived-toggle {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .derived-toggle:hover {
            background: #5a6fd8;
        }

        .derived-list {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9ff;
            border-radius: 6px;
            border: 1px solid #e8ecff;
        }

        .derived-list.show {
            display: block;
        }

        .derived-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }

        .derived-item-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .derived-item-type {
            font-size: 0.75rem;
            background: #e8ecff;
            color: #667eea;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        /* Enhanced Dependency Flow */
        .dependency-flow-container {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 2rem;
            min-height: 600px;
        }

        .dependency-controls {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dependency-flow {
            display: flex;
            flex-direction: column;
            gap: 4rem;
            position: relative;
        }
        
        .dependency-status-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .status-card {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .status-present {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .status-missing {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .status-file {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .status-unknown {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .status-count {
            font-size: 2rem;
            font-weight: bold;
        }

        .status-label {
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .dependency-section {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dependency-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .dependency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .dependency-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
            transition: all 0.3s ease;
            position: relative;
        }

        .dependency-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dependency-card.status-present {
            border-left: 4px solid #28a745;
            background: #f8fff9;
        }

        .dependency-card.status-missing {
            border-left: 4px solid #dc3545;
            background: #fff8f8;
        }

        .dependency-card.status-file {
            border-left: 4px solid #007bff;
            background: #f8f9ff;
        }

        .dependency-card.status-unknown {
            border-left: 4px solid #6c757d;
            background: #f8f9fa;
        }

        .dependency-header {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .dependency-details {
            font-size: 0.9rem;
        }

        .dependency-details p {
            margin: 6px 0;
            display: flex;
            justify-content: space-between;
        }

        .confidence-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        .confidence-low { background: #f8d7da; color: #721c24; }

        .alert {
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 8px;
            position: relative;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        /* Enhanced Flow Visualization Styles */
        .flow-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .flow-node:hover {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .flow-edge {
            transition: all 0.3s ease;
        }

        .flow-edge:hover {
            stroke-width: 3;
        }

        .node-program { fill: #4a90e2; stroke: #2c5aa0; }
        .node-program-main { fill: #1a73e8; stroke: #0d47a1; }
        .node-program-called { fill: #64b5f6; stroke: #1976d2; }
        .node-program-missing { fill: #ffcdd2; stroke: #d32f2f; stroke-dasharray: 5,5; }
        .node-file { fill: #4caf50; stroke: #2e7d32; }
        .node-db2 { fill: #ff9800; stroke: #f57c00; }

        
        .node-cics { fill: #9c27b0; stroke: #6a1b9a; }

        .edge-call { stroke: #2196f3; }
        .edge-xctl { stroke: #ff5722; }
        .edge-link { stroke: #4caf50; }
        .edge-dynamic { stroke: #9c27b0; stroke-dasharray: 8,4; }
        .edge-file-read { stroke: #4caf50; }
        .edge-file-write { stroke: #ff9800; }
        .edge-file-update { stroke: #2196f3; }

         .flow-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            max-width: 200px;
            z-index: 100;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-symbol {
            width: 20px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
        }

        .sequence-label {
            font-size: 10px;
            fill: white;
            text-anchor: middle;
            font-weight: bold;
        }
        .flow-level {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            position: relative;
            min-height: 140px;
        }

        .flow-level-title {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .flow-component {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 200px;
            max-width: 280px;
            text-align: center;
            position: relative;
        }

        .flow-component:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .flow-component.input-source {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .flow-component.core-program {
            border-color: #667eea;
            background: linear-gradient(135deg, #e8ecff 0%, #ffffff 100%);
        }

        .flow-component.called-program {
            border-color: #fd7e14;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .flow-component.input-output-file {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%);
        }

        .flow-component.output-file {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%);
        }

        .flow-component.missing-dependency {
            border-color: #dc3545;
            border-style: dashed;
            background: linear-gradient(135deg, #f8d7da 0%, #ffffff 100%);
            opacity: 0.8;
        }

        .flow-component.present-program {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .flow-component.file-with-layout {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .flow-component.file-only {
            border-left: 4px solid #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .component-name {
            font-weight: bold;
            font-size: 1rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .component-type-badge {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .component-description {
            font-size: 0.8rem;
            color: #6c757d;
            line-height: 1.3;
        }

        .flow-arrow {
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            margin: 1rem auto;
        }

        .program-call-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem;
        }

        .call-arrow {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #667eea;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .program-call-arrows {
            animation: pulse 2s infinite;
        }

        .call-arrow-indicator {
            color: #667eea;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .program-chain-section {
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .program-chain-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }
    
    .program-chain-item.missing-program {
        background: #fff3cd;
        border-color: #ffeaa7;
    }
    
    .program-chain-item.available-program {
        background: #d4edda;
        border-color: #c3e6cb;
    }
    
    .chain-sequence {
        background: #667eea;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
    }
    
    .chain-flow {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .source-program, .target-program {
        background: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .call-arrow {
        color: #667eea;
        font-weight: bold;
    }
    
    .missing-indicator {
        background: #dc3545;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
    }
    
    .dynamic-info {
        font-size: 0.85rem;
        color: #9c27b0;
        font-style: italic;
        margin-top: 4px;
    }
    
    .business-context {
        font-size: 0.85rem;
        color: #666;
        margin-top: 4px;
    }
    
    .file-operation-item .connected-program {
        background: #e8ecff;
        color: #667eea;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
        margin-left: 10px;
    }
    
    .layout-info {
        font-size: 0.75rem;
        color: #28a745;
        margin-left: 4px;
    }
    
    .flow-business-summary {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #667eea;
        margin-bottom: 15px;
    }
    
    .flow-statistics {
        display: flex;
        gap: 20px;
        margin-top: 15px;
    }
    
    .stat-item {
        text-align: center;
        padding: 10px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-value {
        display: block;
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 4px;
    }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f3f4;
        }

        .data-table tbody tr:hover {
            background: #f8f9ff;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .badge-primary {
            color: #fff;
            background-color: #667eea;
        }

        .badge-success {
            color: #fff;
            background-color: #28a745;
        }

        .badge-warning {
            color: #212529;
            background-color: #ffc107;
        }

        .badge-danger {
            color: #fff;
            background-color: #dc3545;
        }

        .badge-info {
            color: #fff;
            background-color: #17a2b8;
        }

        .badge-secondary {
            color: #fff;
            background-color: #6c757d;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            min-width: 400px;
            max-width: 500px;
        }

        .analysis-step {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .analysis-step.completed {
            background: #d4edda;
            color: #155724;
        }

        .analysis-step.current {
            background: #d1ecf1;
            color: #0c5460;
            font-weight: 500;
        }

        .step-icon {
            margin-right: 0.5rem;
            font-size: 1rem;
        }

        .analysis-step.completed .step-icon::before {
            content: 'âœ…';
        }

        .analysis-step.current .step-icon::before {
            content: 'ðŸ”„';
        }

        /* Chat Panel */
        .right-panel {
            width: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
            transition: all 0.3s ease;
        }

        .right-panel.collapsed {
            display: none;
        }

        /* Modal Styles */
        /* Modal Styles */
        .modal {
            display: none !important; /* Force hidden by default */
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: block !important;
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 700px;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-help {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .connection-status {
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .connection-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status.testing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .server-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .server-info h5 {
            margin: 0 0 0.5rem 0;
            color: #667eea;
        }

        .server-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .btn-test {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .btn-test:hover {
            transform: translateY(-1px);
        }

        .btn-test:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .test-results {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
        }

        .test-results h6 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }

        .test-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-testing { background-color: #ffc107; }

        .chat-header {
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: white;
            border: 1px solid #e9ecef;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            background: white;
            border-radius: 0 0 10px 10px;
        }

        .chat-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .chat-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }

        .token-counter {
            font-size: 0.8rem;
            color: #666;
        }

        /* Field Matrix and Mapping styles */
        .field-mapping-controls, .field-matrix-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .field-mapping-controls input, .field-matrix-controls select {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .field-mapping-table, .field-matrix-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

                /* DB2 Table Styles */
        .flow-component.db2-input-table {
            border-color: #007bff;
            background: linear-gradient(135deg, #cce5ff 0%, #ffffff 100%);
        }

        .flow-component.db2-output-table {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .flow-component.db2-io-table {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .db2-operations {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .sql-operation {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            margin: 0.1rem;
        }


        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: #6c757d;
        }

        .program-flow-container {
        padding: 20px;
    }
    
    .flow-controls {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .flow-controls input, .flow-controls button {
            padding: 8px 16px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .flow-controls button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }
    
    
    
    .flow-visualization {
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 20px;
    height: 800px;
    overflow-x: auto;
    overflow-y: auto;
    width: 100%;
    max-width: 100%;
    background: #f9f9f9;
}

.flow-visualization svg {
    width: 1400px;
    height: 1200px;  /* Increased from 1000px */
    display: block;
}
/* Enhanced Program Flow Styles */

/* Program Chain Section */
.program-chain-section {
    margin: 20px 0;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.program-chain-item {
    display: flex;
    align-items: flex-start;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: white;
    transition: all 0.3s ease;
}

.program-chain-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.program-chain-item.missing-program {
    background: #fff8f0;
    border-left: 4px solid #ff6b35;
}

.program-chain-item.available-program {
    background: #f8fff9;
    border-left: 4px solid #28a745;
}

.chain-sequence {
    background: #667eea;
    color: white;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 20px;
    flex-shrink: 0;
}

.chain-flow-details {
    flex: 1;
}

.program-call-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 10px;
    font-weight: 500;
}

.source-program, .target-program {
    background: #f8f9fa;
    padding: 6px 12px;
    border-radius: 6px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
}

.call-arrow {
    color: #667eea;
    font-weight: bold;
    font-size: 1.1em;
}

.missing-indicator {
    background: #dc3545;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
}

.available-indicator {
    background: #28a745;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
}

.dynamic-call-info {
    background: #e8f4fd;
    border-left: 3px solid #007bff;
    padding: 10px;
    margin: 8px 0;
    border-radius: 4px;
}

.dynamic-call-info strong {
    color: #0056b3;
}

.dynamic-call-info code {
    background: #fff;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
}

.resolution-details {
    font-size: 0.9em;
    color: #6c757d;
    margin-top: 5px;
}

.business-context {
    background: #f8f9fa;
    padding: 8px 12px;
    border-radius: 4px;
    margin: 8px 0;
    font-size: 0.9em;
    line-height: 1.4;
}

.call-metadata {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}

.confidence-badge, .data-passed-count {
    background: #e9ecef;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    color: #495057;
}

/* Layout Associations Section */
.layout-associations-section {
    margin: 25px 0;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.layout-flow-grid {
    display: grid;
    gap: 20px;
}

.program-layout-group {
    background: #f8f9ff;
    border-radius: 8px;
    padding: 20px;
    border-left: 4px solid #667eea;
}

.program-header {
    color: #667eea;
    margin-bottom: 15px;
    font-size: 1.1em;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.layouts-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 15px;
}

.layout-item {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.layout-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.layout-item.layout-complete {
    border-left: 4px solid #28a745;
}

.layout-item.layout-partial {
    border-left: 4px solid #ffc107;
}

.layout-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.layout-name {
    font-weight: bold;
    font-family: 'Courier New', monospace;
    color: #333;
}

.layout-type-badge {
    background: #667eea;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
}

.field-count {
    background: #e9ecef;
    color: #495057;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
}

.layout-details {
    margin: 10px 0;
}

.layout-purpose {
    color: #666;
    font-size: 0.9em;
    line-height: 1.4;
    margin-bottom: 8px;
}

.usage-context, .connected-programs {
    font-size: 0.85rem;
    margin: 5px 0;
}

.connected-programs strong {
    color: #667eea;
}

.layout-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}

.btn-sm {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-sm:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

/* Field Flow Section */
.field-flows-section {
    margin: 25px 0;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.field-flows-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
}

.field-flow-card {
    background: #f8fff9;
    border: 1px solid #d4edda;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #28a745;
}

.field-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.field-name {
    color: #155724;
    margin: 0;
    font-size: 1.1em;
}

.flow-steps-count {
    background: #d4edda;
    color: #155724;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
}

.field-flow-path {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 15px 0;
}

.flow-step {
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 6px;
    padding: 10px;
    border-left: 3px solid #28a745;
}

.step-program {
    font-weight: bold;
    color: #333;
    font-family: 'Courier New', monospace;
}

.step-layout {
    color: #667eea;
    font-size: 0.85rem;
    margin: 3px 0;
}

.step-transformation {
    color: #666;
    font-size: 0.9em;
    font-style: italic;
}

.flow-connector {
    text-align: center;
    color: #28a745;
    font-size: 1.2em;
    font-weight: bold;
    margin: 5px 0;
}

.field-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.trace-btn, .analyze-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: background 0.2s ease;
}

.trace-btn:hover, .analyze-btn:hover {
    background: #218838;
}

.analyze-btn {
    background: #007bff;
}

.analyze-btn:hover {
    background: #0056b3;
}

/* File Operations Section */
.file-operations-section {
    margin: 25px 0;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.file-operations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 15px;
}

.file-operation-card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    background: white;
    transition: all 0.3s ease;
}

.file-operation-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.file-operation-card.has-layout {
    border-left: 4px solid #28a745;
    background: #f8fff9;
}

.file-operation-card.no-layout {
    border-left: 4px solid #ffc107;
    background: #fffbf0;
}

.file-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 8px;
}

.file-icon {
    font-size: 1.2em;
}

.file-name {
    font-weight: bold;
    font-family: 'Courier New', monospace;
}

.io-direction-badge {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
}

.io-direction-badge.input {
    background: #d4edda;
    color: #155724;
}

.io-direction-badge.output {
    background: #cce5ff;
    color: #004085;
}

.io-direction-badge.input_output {
    background: #fff3cd;
    color: #856404;
}

.layout-indicator {
    background: #28a745;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
}

.no-layout-indicator {
    background: #ffc107;
    color: #212529;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
}

.file-details {
    margin: 12px 0;
    font-size: 0.9em;
}

.file-details > div {
    margin: 6px 0;
}

.file-details strong {
    color: #333;
}

.connected-program {
    font-family: 'Courier New', monospace;
    background: #f8f9fa;
    padding: 2px 6px;
    border-radius: 3px;
}

.associated-layouts {
    margin-top: 10px;
}

.layout-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 5px;
}

.layout-tag {
    background: #e8ecff;
    color: #667eea;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s ease;
}

.layout-tag:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.file-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

/* Missing Programs Section */
.missing-programs-section {
    margin: 25px 0;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid #dc3545;
}

.missing-programs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.missing-program-card {
    background: #fff5f5;
    border: 1px solid #feb2b2;
    border-radius: 8px;
    padding: 15px;
    transition: all 0.3s ease;
}

.missing-program-card:hover {
    box-shadow: 0 4px 12px rgba(220,53,69,0.2);
    transform: translateY(-2px);
}

.missing-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.missing-icon {
    font-size: 1.2em;
}

.program-name {
    font-weight: bold;
    font-family: 'Courier New', monospace;
    color: #721c24;
}

.call-type-badge {
    background: #dc3545;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
}

.missing-details {
    margin: 12px 0;
    font-size: 0.9em;
}

.missing-details > div {
    margin: 6px 0;
}

.missing-details strong {
    color: #721c24;
}

.impact-description {
    background: #f8d7da;
    padding: 8px;
    border-radius: 4px;
    margin: 8px 0;
    color: #721c24;
    font-size: 0.85em;
    line-height: 1.4;
}

.missing-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.impact-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: background 0.2s ease;
}

.impact-btn:hover {
    background: #c82333;
}

.upload-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: background 0.2s ease;
}

.upload-btn:hover {
    background: #218838;
}

.missing-summary {
    border-top: 1px solid #dee2e6;
    padding-top: 20px;
}

.recommendation-box {
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    padding: 15px;
    border-radius: 4px;
}

.recommendation-box h4 {
    color: #667eea;
    margin: 0 0 10px 0;
}

.recommendation-box ul {
    margin: 10px 0 0 20px;
    line-height: 1.6;
}

.recommendation-box li {
    margin: 5px 0;
    color: #495057;
}

/* Field Flow Modal Styles */
.field-journey-visualization {
    padding: 20px 0;
}

.journey-summary {
    background: #e8f4fd;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #007bff;
}

.flow-steps-detailed {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.detailed-flow-step {
    display: flex;
    align-items: center;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    position: relative;
}

.step-number {
    background: #007bff;
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 15px;
    flex-shrink: 0;
}

.step-content {
    flex: 1;
}

.step-content .programs {
    font-weight: bold;
    color: #333;
    font-family: 'Courier New', monospace;
    margin-bottom: 5px;
}

.step-content .transformation {
    color: #666;
    font-size: 0.9em;
    margin-bottom: 3px;
}

.step-content .mechanism {
    color: #007bff;
    font-size: 0.8em;
    font-weight: 500;
}

.step-arrow {
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    color: #007bff;
    font-size: 1.5em;
    font-weight: bold;
    z-index: 2;
    padding: 0 10px;
}

.modal-flow-details {
    height: 100%;
    overflow-y: auto;
}

.flow-summary-header {
    padding-bottom: 15px;
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 20px;
}

.flow-overview-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 15px;
}

.overview-stat {
    text-align: center;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
}

.stat-value {
    display: block;
    font-size: 1.2em;
    font-weight: bold;
    color: #667eea;
}

.stat-label {
    font-size: 0.8em;
    color: #6c757d;
}

.modal-section {
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f1f1f1;
}

.modal-section h4 {
    color: #667eea;
    margin-bottom: 10px;
    font-size: 1.1em;
}

.call-chain-item, .file-operation-item, .db2-operation-item, .missing-program-item {
    display: flex;
    align-items: center;
    padding: 8px;
    margin: 5px 0;
    border-radius: 4px;
    border: 1px solid #e9ecef;
}

.missing-call {
    background: #fff3cd;
    border-color: #ffeaa7;
}

.available-call {
    background: #d4edda;
    border-color: #c3e6cb;
}

.chain-step {
    background: #667eea;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8em;
    font-weight: bold;
    margin-right: 10px;
}

.call-flow {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.caller, .target {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 3px;
    background: #f8f9fa;
}

.target.missing {
    background: #f8d7da;
    color: #721c24;
}

.dynamic-info, .missing-warning {
    font-size: 0.8em;
    margin-top: 4px;
}

.dynamic-info {
    color: #9c27b0;
    font-style: italic;
}

.missing-warning {
    color: #856404;
    font-weight: bold;
}

.flow-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.action-btn {
    padding: 8px 16px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}

.action-btn:hover {
    background: #5a6fd8;
}

.missing-section {
    background: #fff8f0;
    padding: 15px;
    border-radius: 6px;
    border-left: 4px solid #ff6b35;
}

.alert.alert-warning {
    background: #fff3cd;
    color: #856404;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .layouts-list, .field-flows-grid, .file-operations-grid, .missing-programs-grid {
        grid-template-columns: 1fr;
    }
    
    .program-call-header {
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .chain-flow-details {
        margin-left: 0;
        margin-top: 10px;
    }
    
    .field-flow-path {
        font-size: 0.9em;
    }
    
    .call-metadata {
        flex-wrap: wrap;
        gap: 8px;
    }
}

/* Animation for enhanced interactivity */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.program-chain-item, .layout-item, .field-flow-card, .file-operation-card, .missing-program-card {
    animation: slideInUp 0.3s ease-out;
}

/* Enhanced hover effects */
.layout-item:hover .layout-name {
    color: #667eea;
}

.field-flow-card:hover .field-name {
    color: #0f5132;
}

.missing-program-card:hover .program-name {
    color: #a91e2c;
}

    .flow-details {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 5px;
    }
    
    .flow-summary-section h3,
    .missing-programs-section h3,
    .field-flows-section h3,
    .file-operations-section h3 {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
        margin-bottom: 15px;
    }
    
    .missing-program-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 3px;
    }
    
    .missing-program-item .program-name {
        font-weight: bold;
        margin-right: 10px;
    }
    
    .missing-program-item .impact-btn {
        margin: 0 10px;
        padding: 5px 10px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    
    .missing-program-item .upload-hint {
        color: #856404;
        font-style: italic;
    }
    
    .field-flow-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 3px;
    }
    
    .field-flow-item .field-name {
        font-weight: bold;
        margin-right: 15px;
        min-width: 120px;
    }
    
    .field-flow-item .field-flow-path {
        flex: 1;
        margin-right: 10px;
    }
    
    .field-flow-item .trace-btn {
        padding: 5px 10px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    
    .file-operation-item {
        padding: 10px;
        margin: 5px 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 3px;
    }
    
    .file-operation-item.has-layout {
        border-left: 4px solid #28a745;
    }
    
    .file-operation-item.no-layout {
        border-left: 4px solid #ffc107;
    }
    
    .file-info {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .file-name {
        font-weight: bold;
        margin-right: 10px;
    }
    
    .io-direction {
        color: #6c757d;
        margin-right: 10px;
    }
    
    .layout-indicator {
        background: #28a745;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .enhanced-node-details {
        padding: 15px;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 10px;
    }

    .detail-grid div {
        padding: 5px;
        background: #f5f5f5;
        border-radius: 4px;
    }
    /* Additional CSS for the new layout elements */

.enhanced-flow-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 25px;
}

.enhanced-flow-header h2 {
    margin: 0 0 15px 0;
    font-size: 1.3em;
}

.flow-overview-stats {
    display: flex;
    gap: 30px;
    justify-content: center;
}

.overview-stat {
    text-align: center;
}

.overview-stat .stat-value {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    line-height: 1;
}

.overview-stat .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-top: 5px;
}

/* Field tags and indicators */
.field-tags, .field-tags-small {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}

.field-tag, .field-tag-small {
    background: #e8ecff;
    color: #667eea;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s ease;
}

.field-tag-small {
    font-size: 0.7rem;
    padding: 2px 6px;
}

.field-tag:hover, .field-tag-small:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.more-fields, .more-fields-small {
    background: #f8f9fa;
    color: #6c757d;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-style: italic;
}

.key-fields {
    margin-top: 10px;
}

.key-fields strong {
    color: #667eea;
}

/* Transformation indicators */
.step-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.step-header .step-arrow {
    color: #28a745;
    font-weight: bold;
    font-size: 1.1em;
}

.transformation-type {
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: bold;
    margin-right: 8px;
}

.transformation-type.direct_pass {
    background: #e8f5e8;
    color: #2d5a2d;
}

.transformation-type.data_type_conversion {
    background: #fff3cd;
    color: #856404;
}

.transformation-type.usage_type_change {
    background: #cce5ff;
    color: #004085;
}

.transformation-indicators {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.indicator {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.7rem;
}

.indicator.business-logic {
    background: #e8f4fd;
    color: #0056b3;
    border-color: #bee5eb;
}

.indicator.validation {
    background: #d4edda;
    color: #155724;
    border-color: #c3e6cb;
}

/* Layout connections */
.layout-connections {
    margin: 12px 0;
}

.layout-connection-list {
    margin-top: 8px;
}

.layout-connection-item {
    background: #f8f9ff;
    border-left: 3px solid #667eea;
    padding: 8px;
    margin-bottom: 6px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.layout-connection-item:hover {
    background: #e8ecff;
}

.layout-connection-item .layout-name {
    font-weight: bold;
    color: #667eea;
    margin-right: 8px;
}

.layout-connection-item .layout-fields {
    color: #6c757d;
    font-size: 0.85rem;
}

.layout-purpose-small {
    font-size: 0.8rem;
    color: #666;
    margin-top: 4px;
    font-style: italic;
}

/* Program link styling */
.program-link {
    color: #667eea;
    cursor: pointer;
    font-weight: bold;
    text-decoration: underline;
    transition: color 0.2s ease;
}

.program-link:hover {
    color: #5a6fd8;
}

/* Fields involved section */
.fields-involved {
    margin: 12px 0;
}

.fields-involved strong {
    color: #28a745;
}

/* Enhanced step styling */
.step-program {
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

/* Upload area highlight animation */
@keyframes highlight-upload {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
    50% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0.2); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}

.upload-section.highlight {
    animation: highlight-upload 1.5s ease-in-out 3;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .flow-overview-stats {
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .layout-connection-item {
        padding: 6px;
    }
    
    .step-header {
        flex-wrap: wrap;
        gap: 6px;
    }
    
    .transformation-indicators {
        flex-wrap: wrap;
        gap: 4px;
    }
    
    .field-tags, .field-tags-small {
        gap: 4px;
    }
}
    .status-present { color: #4caf50; font-weight: bold; }
    .status-missing { color: #f44336; font-weight: bold; }
    .status-file { color: #2196f3; font-weight: bold; }
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: white;
        border-radius: 5px;
        max-width: 80%;
        max-height: 80%;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #ddd;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
    }
    
    .close-btn:hover {
        color: #333;
    }
    
    .highlight {
        background: #fff3cd;
        padding: 10px;
        border-radius: 3px;
        font-weight: bold;
    }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                width: 100%;
                max-width: none;
            }

            .right-panel {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 2% auto;
                width: 95%;
            }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">Enhanced Code Analyzer</div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openConfigModal()">LLM Config</button>
            </div>
            <div class="header-metrics">
                <div class="metric-item">
                    <span class="metric-value" id="totalComponents">0</span>
                    <span class="metric-label">Components</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalPrograms">0</span>
                    <span class="metric-label">Programs</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalFields">0</span>
                    <span class="metric-label">Fields</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalTokens">0</span>
                    <span class="metric-label">Tokens Used</span>
                </div>
            </div>
        </div>
    </div>

    <!-- LLM Configuration Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">VLLM Server Configuration</h3>
                <button class="close" onclick="closeConfigModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="llmConfigForm">
                    <div class="form-group">
                        <label class="form-label" for="llmEndpoint">VLLM Server Endpoint</label>
                        <input type="url" id="llmEndpoint" class="form-input" 
                               placeholder="http://192.168.1.100:8100/generate"
                               value="http://localhost:8100/generate">
                        <div class="form-help">Enter the full URL to your VLLM server's /generate endpoint</div>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="maxTokens">Max Tokens per Call</label>
                            <input type="number" id="maxTokens" class="form-input" 
                                   value="6000" min="1000" max="32000" step="500">
                            <div class="form-help">Maximum tokens for each LLM request</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="temperature">Temperature</label>
                            <input type="number" id="temperature" class="form-input" 
                                   value="0.1" min="0" max="2" step="0.1">
                            <div class="form-help">Creativity level (0.0 = deterministic, 2.0 = creative)</div>
                        </div>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="timeout">Request Timeout (seconds)</label>
                            <input type="number" id="timeout" class="form-input" 
                                   value="60" min="10" max="300" step="5">
                            <div class="form-help">How long to wait for LLM response</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="retries">Max Retries</label>
                            <input type="number" id="retries" class="form-input" 
                                   value="3" min="1" max="5" step="1">
                            <div class="form-help">Number of retry attempts on failure</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn-test" onclick="testLLMConnection()" id="testButton">
                            Test Connection
                        </button>
                    </div>

                    <div id="connectionStatus" class="connection-status" style="display: none;">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="statusMessage"></span>
                    </div>

                    <div id="serverInfo" class="server-info" style="display: none;">
                        <h5>Server Information</h5>
                        <div class="server-info-item">
                            <span>Model:</span>
                            <span id="modelName">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Max Context Length:</span>
                            <span id="contextLength">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Response Time:</span>
                            <span id="responseTime">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Status:</span>
                            <span id="serverStatus">-</span>
                        </div>
                    </div>

                    <div id="testResults" class="test-results" style="display: none;">
                        <h6>Test Results</h6>
                        <div class="test-detail">
                            <span>Endpoint Reachable:</span>
                            <span id="endpointStatus">-</span>
                        </div>
                        <div class="test-detail">
                            <span>Response Format:</span>
                            <span id="responseFormat">-</span>
                        </div>
                        <div class="test-detail">
                            <span>Token Generation:</span>
                            <span id="tokenGeneration">-</span>
                        </div>
                        <div class="test-detail">
                            <span>Model Compatibility:</span>
                            <span id="modelCompatibility">-</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">Reset to Defaults</button>
                <button type="button" class="btn btn-secondary" onclick="closeConfigModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveLLMConfig()">Save & Apply</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel -->
        <div class="left-panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-title">Component Dashboard</div>
                <button class="collapse-btn" onclick="togglePanel('left')">â—€</button>
            </div>

            <div class="panel-content">
                <!-- Upload Section -->
                <div class="upload-section">
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;">ðŸ“</div>
                        <div>Click to upload COBOL files</div>
                        <small class="text-muted">Supports .cbl, .cob, .cpy, .jcl files</small>
                    </div>
                    <input type="file" id="fileInput" class="file-input" multiple 
                           accept=".cbl,.cob,.cpy,.jcl,.txt" onchange="handleFileUpload(event)">
                </div>

                <!-- Session Info -->
                <div class="session-info" style="margin-bottom: 2rem;">
                    <h4>Session Overview</h4>
                    <div id="sessionStats">
                        <p>Project: <span id="projectName">New Project</span></p>
                        <p>Session ID: <span id="sessionId">Not started</span></p>
                    </div>
                </div>

                <!-- Components List -->
                <div class="components-list">
                    <h4>Components</h4>
                    <div id="componentsList">
                        <p class="text-muted">No components uploaded yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard Overview</button>
                <button class="tab-btn" onclick="showTab('components')">Components Library</button>
                <button class="tab-btn" onclick="showTab('dependencies')">Dependencies Flow</button>
                <button class="tab-btn" onclick="showTab('fieldMatrix')">Field Matrix</button>
                <button class="tab-btn" onclick="showTab('fieldMapping')">Field Mapping Analysis</button>
                <button class="tab-btn" onclick="showTab('program-flow')">Program Flow</button>
            </div>

            <!-- Tab Contents -->
            <div class="tab-content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-pane active">
                    <h2>Project Dashboard</h2>
                    
                    <!-- Summary Cards -->
                    <div class="dashboard-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 2rem;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Analysis Status</h3>
                            <p id="analysisStatus">Ready for upload</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>Parsed Programs: <span id="parsedPrograms">0</span></div>
                                <div>Record Layouts: <span id="recordLayouts">0</span></div>
                                <div>CICS Files: <span id="cicsFiles">0</span></div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Processing Queue</h3>
                            <p id="processingQueue">0 files in queue</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>Token Usage: <span id="dashTokenUsage">0</span></div>
                                <div>LLM Calls: <span id="llmCalls">0</span></div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Success Rate</h3>
                            <p id="successRate">100%</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>Complexity Avg: <span id="avgComplexity">N/A</span></div>
                                <div>Confidence: <span id="avgConfidence">N/A</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Component Summaries -->
                    <div style="margin-top: 2rem;">
                        <h3>Component Analysis Summary</h3>
                        <div id="componentSummaries" class="component-summaries">
                            <p class="text-muted">Upload COBOL files to see AI-generated business summaries</p>
                        </div>
                    </div>
                </div>

                <!-- Components Library Tab -->
                <div id="components" class="tab-pane">
                    <h2>Components Library</h2>
                    
                    <!-- Filter Controls -->
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                        <select id="componentTypeFilter" onchange="filterComponents()">
                            <option value="">All File Types</option>
                            <option value="PROGRAM">Programs Only</option>
                            <option value="COPYBOOK">Copybooks Only</option>
                            <option value="JCL">JCL Only</option>
                        </select>
                        <input type="text" id="componentSearchFilter" placeholder="Search components..." onkeyup="filterComponents()" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <select id="componentViewFilter" onchange="filterComponents()">
                            <option value="">All Components</option>
                            <option value="analyzed">Analyzed Components</option>
                            <option value="extracted">Extracted Components</option>
                        </select>
                    </div>

                    <div id="componentsTable">
                        <div class="component-section">
                            <h4>Uploaded Files & Discovered Components</h4>
                            <p class="text-muted">Click on any file to expand and view its discovered components</p>
                            
                            <div id="mainComponentsView" style="margin-top: 1rem;">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dependencies Flow Tab -->
                <div id="dependencies" class="tab-pane">
                    <h2>Dependencies Flow</h2>
                    
                    <!-- Dependency Controls -->
                    <div class="dependency-controls">
                        <label for="dependencyComponentSelect" style="font-weight: 600;">View Dependencies For:</label>
                        <select id="dependencyComponentSelect" onchange="loadDependencyFlow()" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
                            <option value="">Overall System View</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshDependencyFlow()">Refresh</button>
                        <button class="btn btn-secondary" onclick="loadEnhancedDependencies()" id="enhancedViewBtn">Load Enhanced View</button>
                        <button class="btn btn-secondary" onclick="restoreNormalView()" id="normalViewBtn" style="display: none;">Restore Normal View</button>
                    </div>

                    <!-- Dependency Status Summary -->
                    <div id="dependencyStatusSummary" class="dependency-status-summary" style="display: none;">
                        <div class="status-card status-present">
                            <div class="status-count" id="present-count">0</div>
                            <div class="status-label">Present Programs</div>
                        </div>
                        <div class="status-card status-missing">
                            <div class="status-count" id="missing-count">0</div>
                            <div class="status-label">Missing Programs</div>
                        </div>
                        <div class="status-card status-file">
                            <div class="status-count" id="file-count">0</div>
                            <div class="status-label">Files & CICS</div>
                        </div>
                        <div class="status-card status-unknown">
                            <div class="status-count" id="unknown-count">0</div>
                            <div class="status-label">Unknown</div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Dependencies Container -->
                    <div id="enhancedDependenciesContainer" style="display: none;"></div>
                    
                    <!-- Original Dependency Flow Container -->
                    <div id="dependenciesVisualization">
                        <div class="dependency-flow-container">
                            <div id="dependencyFlowContent">
                                <p class="text-muted">Upload and analyze COBOL programs to see system architecture flow</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Field Matrix Tab -->
                <div id="fieldMatrix" class="tab-pane">
                    <h2>Field Matrix</h2>
                    <div class="field-matrix-controls">
                        <select id="recordLayoutSelect" onchange="loadFieldMatrix()">
                            <option value="">Select Record Layout</option>
                        </select>
                        <select id="programSelect" onchange="loadFieldMatrix()">
                            <option value="">Select Program</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadFieldMatrix()">Refresh Matrix</button>
                    </div>
                    <div id="fieldMatrixTable">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Usage Type</th>
                                    <th>Source Field</th>
                                    <th>Business Purpose</th>
                                    <th>Program</th>
                                    <th>Line #</th>
                                </tr>
                            </thead>
                            <tbody id="fieldMatrixTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No field data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Field Mapping Analysis Tab -->
                <div id="fieldMapping" class="tab-pane">
                    <h2>Field Mapping Analysis</h2>
                    <div class="field-mapping-controls">
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="targetFileInput" placeholder="Enter target file name (e.g., CUSTOMER-FILE)" style="flex: 1; min-width: 200px;">
                            <select id="recordLayoutSelector" onchange="updateTargetFileFromLayout()" style="min-width: 200px;">
                                <option value="">Or select a record layout</option>
                            </select>
                            <button class="btn btn-primary" onclick="analyzeFieldMapping()">Analyze Field Mapping</button>
                            <button class="btn btn-secondary" onclick="exportFieldMappings()">Export to CSV</button>
                        </div>
                    </div>

                    <!-- Layout Summary Section -->
                    <div id="layoutSummarySection" style="display: none; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <h4>Layout Summary</h4>
                        <div id="layoutSummaryContent"></div>
                    </div>
                    
                    <div id="fieldMappingResults">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Mainframe Type & Length</th>
                                    <th>Oracle Type & Length</th>
                                    <th>Population Source</th>
                                    <th>Business Logic</th>
                                    <th>Programs Involved</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fieldMappingTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Enter a target file name or select a layout and click Analyze</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Field Details Modal -->
                <div id="fieldDetailsModal" class="modal">
                    <div class="modal-content" style="width: 80%; max-width: 900px;">
                        <div class="modal-header">
                            <h3 class="modal-title" id="fieldModalTitle">Field Details</h3>
                            <button class="close" onclick="closeFieldDetailsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="fieldDetailsContent">
                                <!-- Will be populated with field details -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeFieldDetailsModal()">Close</button>
                        </div>
                    </div>
                </div>
            
                <!-- Program Flow -->
                <div id="program-flow" class="tab-pane" >
                    <div class="program-flow-container">
                        <div class="flow-controls">
                            <input type="text" id="startingProgram" placeholder="Enter program name (e.g., TMSTMPM4)" value="TMSTMPM4">
                            <button onclick="analyzeEnhancedFlow()">Analyze Program Flow</button>
                        </div>
                        
                        <div id="flowVisualization" class="flow-visualization">
                            <!-- Flow diagram will be rendered here -->
                        </div>
                        
                        <div id="flowDetails" class="flow-details">
                            <div class="flow-summary"></div>
                            <div class="missing-programs"></div>
                            <div class="field-flows"></div>
                            <div class="file-operations"></div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Right Panel - Chat -->
        <div class="right-panel" id="rightPanel">
            <div class="chat-header">
                <div>AI Assistant</div>
                <button class="collapse-btn" onclick="togglePanel('right')" style="background: none; border: none; color: white; font-size: 1.2rem;">â–¶</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message assistant">
                    <p>Hello! I'm your mainframe analysis assistant. I can help you understand:</p>
                    <ul>
                        <li>Field mappings and data relationships</li>
                        <li>Record layout structures</li>
                        <li>Program dependencies and business logic</li>
                        <li>COBOL to Oracle conversion guidance</li>
                    </ul>
                    <p>Ask me about any field, record layout, or program in your analysis!</p>
                </div>
            </div>
            <div class="chat-input-area">
                <textarea id="chatInput" class="chat-input" 
                         placeholder="Ask about fields, record layouts, or programs..."
                         onkeydown="handleChatKeydown(event)"></textarea>
                <div class="chat-controls">
                    <span class="token-counter" id="chatTokenCounter">0 tokens</span>
                    <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading"></div>
            <h3 id="loadingTitle">Processing...</h3>
            <p id="loadingMessage">Analyzing your files...</p>
            <div id="loadingProgress" style="margin-top: 1rem;">
                <div style="background: #e9ecef; border-radius: 10px; height: 6px; margin-bottom: 0.5rem;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="font-size: 0.9rem; color: #6c757d;">Starting analysis...</div>
            </div>
            <div id="analysisSteps" style="margin-top: 1rem; text-align: left; max-width: 400px;">
                <div class="analysis-step" id="step1">
                    <span class="step-icon"></span> Parsing COBOL structure...
                </div>
                <div class="analysis-step" id="step2">
                    <span class="step-icon"></span> Extracting components...
                </div>
                <div class="analysis-step" id="step3">
                    <span class="step-icon"></span> Generating business summary...
                </div>
                <div class="analysis-step" id="step4">
                    <span class="step-icon"></span> Storing results...
                </div>
            </div>
            <div id="processingStatus" style="margin-top: 1rem;"></div>
        </div>
    </div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Global variables
        let currentSessionId = null;
        let currentConversationId = null;
        let fieldMatrixData = {};
        let componentsData = [];
        let dependenciesData = [];
        let llmConfig = {
            endpoint: 'http://localhost:8100/generate',
            maxTokens: 6000,
            temperature: 0.1,
            timeout: 60,
            retries: 3
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadLLMConfig();
            initializeSession();
            updateTokenCounters();
        });

        // LLM Configuration Management
        function loadLLMConfig() {
            const saved = localStorage.getItem('llmConfig');
            if (saved) {
                try {
                    llmConfig = { ...llmConfig, ...JSON.parse(saved) };
                    updateConfigForm();
                } catch (e) {
                    console.error('Error loading LLM config:', e);
                }
            }
        }

        function openConfigModal() {
            updateConfigForm();
            const modal = document.getElementById('configModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeConfigModal() {
            const modal = document.getElementById('configModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
            
            // Hide status messages
            document.getElementById('connectionStatus').style.display = 'none';
            document.getElementById('serverInfo').style.display = 'none';
            document.getElementById('testResults').style.display = 'none';
        }

        function updateConfigForm() {
            document.getElementById('llmEndpoint').value = llmConfig.endpoint;
            document.getElementById('maxTokens').value = llmConfig.maxTokens;
            document.getElementById('temperature').value = llmConfig.temperature;
            document.getElementById('timeout').value = llmConfig.timeout;
            document.getElementById('retries').value = llmConfig.retries;
        }

        async function testLLMConnection() {
            const endpoint = document.getElementById('llmEndpoint').value.trim();
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const timeout = parseInt(document.getElementById('timeout').value);

            if (!endpoint) {
                showConnectionStatus('error', 'Please enter a VLLM endpoint URL first');
                return;
            }

            showConnectionStatus('testing', 'Testing connection to VLLM server...');
            
            const testButton = document.getElementById('testButton');
            testButton.disabled = true;
            testButton.textContent = 'Testing...';

            document.getElementById('testResults').style.display = 'block';
            resetTestResults();

            try {
                const startTime = Date.now();
                
                const response = await fetch('/api/test-llm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        endpoint,
                        maxTokens,
                        temperature,
                        timeout
                    })
                });

                const responseTime = Date.now() - startTime;

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        showConnectionStatus('success', 'Connection successful! VLLM server is responding normally.');
                        
                        updateTestResults({
                            endpointReachable: true,
                            responseFormat: 'Valid JSON',
                            tokenGeneration: data.response_tokens > 0 ? 'Working' : 'Limited',
                            modelCompatibility: data.model_name ? 'Compatible' : 'Unknown'
                        });
                        
                        displayServerInfo({
                            model: data.model_name || 'Unknown',
                            contextLength: data.max_context_length || 'Unknown',
                            responseTime: `${responseTime}ms`,
                            status: 'Online',
                            promptTokens: data.prompt_tokens || 0,
                            responseTokens: data.response_tokens || 0
                        });
                    } else {
                        showConnectionStatus('error', `Connection failed: ${data.error || 'Unknown error'}`);
                        updateTestResults({
                            endpointReachable: false,
                            responseFormat: 'Error',
                            tokenGeneration: 'Failed',
                            modelCompatibility: 'Incompatible'
                        });
                        hideServerInfo();
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('LLM connection test failed:', error);
                showConnectionStatus('error', `Connection failed: ${error.message}`);
                updateTestResults({
                    endpointReachable: false,
                    responseFormat: 'Network Error',
                    tokenGeneration: 'Failed',
                    modelCompatibility: 'Cannot Determine'
                });
                hideServerInfo();
            } finally {
                testButton.disabled = false;
                testButton.textContent = 'Test Connection';
            }
        }

        function showConnectionStatus(type, message) {
            const status = document.getElementById('connectionStatus');
            const indicator = document.getElementById('statusIndicator');
            const statusMessage = document.getElementById('statusMessage');

            status.className = `connection-status ${type}`;
            status.style.display = 'flex';
            
            indicator.className = `status-indicator status-${type === 'testing' ? 'testing' : type === 'success' ? 'online' : 'offline'}`;
            
            statusMessage.textContent = message;
        }

        function resetTestResults() {
            document.getElementById('endpointStatus').textContent = 'Testing...';
            document.getElementById('responseFormat').textContent = 'Testing...';
            document.getElementById('tokenGeneration').textContent = 'Testing...';
            document.getElementById('modelCompatibility').textContent = 'Testing...';
        }

        function updateTestResults(results) {
            document.getElementById('endpointStatus').textContent = results.endpointReachable ? 'âœ… Reachable' : 'âŒ Failed';
            document.getElementById('responseFormat').textContent = results.responseFormat;
            document.getElementById('tokenGeneration').textContent = results.tokenGeneration;
            document.getElementById('modelCompatibility').textContent = results.modelCompatibility;
        }

        function displayServerInfo(info) {
            document.getElementById('modelName').textContent = info.model;
            document.getElementById('contextLength').textContent = info.contextLength;
            document.getElementById('responseTime').textContent = info.responseTime;
            document.getElementById('serverStatus').textContent = info.status;
            document.getElementById('serverInfo').style.display = 'block';
        }

        function hideServerInfo() {
            document.getElementById('serverInfo').style.display = 'none';
        }

        async function saveLLMConfig() {
            const endpoint = document.getElementById('llmEndpoint').value.trim();
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const timeout = parseInt(document.getElementById('timeout').value);
            const retries = parseInt(document.getElementById('retries').value);

            if (!endpoint) {
                showError('Please enter a valid VLLM endpoint URL');
                return;
            }

            if (maxTokens < 1000 || maxTokens > 32000) {
                showError('Max tokens must be between 1000 and 32000');
                return;
            }

            if (temperature < 0 || temperature > 2) {
                showError('Temperature must be between 0.0 and 2.0');
                return;
            }

            llmConfig = {
                endpoint,
                maxTokens,
                temperature,
                timeout,
                retries
            };

            localStorage.setItem('llmConfig', JSON.stringify(llmConfig));

            try {
                await updateBackendConfig();
                closeConfigModal();
                showSuccess('LLM configuration saved successfully!');
            } catch (error) {
                showError('Failed to update backend configuration');
            }
        }

        async function updateBackendConfig() {
            try {
                const response = await fetch('/api/llm-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(llmConfig)
                });

                if (!response.ok) {
                    throw new Error('Failed to update backend configuration');
                }
            } catch (error) {
                console.error('Error updating backend config:', error);
                throw error;
            }
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to default values?')) {
                llmConfig = {
                    endpoint: 'http://localhost:8100/generate',
                    maxTokens: 6000,
                    temperature: 0.1,
                    timeout: 60,
                    retries: 3
                };
                updateConfigForm();
                localStorage.removeItem('llmConfig');
                
                document.getElementById('connectionStatus').style.display = 'none';
                document.getElementById('serverInfo').style.display = 'none';
                document.getElementById('testResults').style.display = 'none';
            }
        }

        // Session Management
        async function initializeSession() {
            try {
                const savedSessionId = localStorage.getItem('currentSessionId');
                if (savedSessionId) {
                    currentSessionId = savedSessionId;
                    currentConversationId = generateUUID();
                    
                    const response = await fetch(`/api/components/${currentSessionId}`);
                    if (response.ok) {
                        console.log('Using existing session:', currentSessionId);
                        document.getElementById('sessionId').textContent = currentSessionId.slice(0, 8) + '...';
                        document.getElementById('projectName').textContent = 'Existing Project';
                        return;
                    }
                }
                
                const response = await fetch('/api/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_name: `Project_${new Date().toISOString().slice(0,19)}` })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentSessionId = data.session_id;
                    currentConversationId = generateUUID();
                    
                    localStorage.setItem('currentSessionId', currentSessionId);
                    
                    document.getElementById('sessionId').textContent = currentSessionId.slice(0, 8) + '...';
                    document.getElementById('projectName').textContent = data.project_name;
                    
                    console.log('New session initialized:', currentSessionId);
                } else {
                    throw new Error('Failed to create session');
                }
            } catch (error) {
                console.error('Error initializing session:', error);
                showError('Failed to initialize session');
            }
        }

        // File Upload with Progress Tracking
        async function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            showLoadingWithProgress(`Processing ${files.length} files...`);
            
            let processedCount = 0;
            let successCount = 0;
            let errorCount = 0;
            const results = [];

            const loadingContent = document.querySelector('.loading-content');
            const statusContainer = document.createElement('div');
            statusContainer.id = 'processingStatus';
            statusContainer.style.marginTop = '2rem';
            loadingContent.appendChild(statusContainer);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileNumber = i + 1;
                
                try {
                    updateLoadingProgress(
                        `Processing ${file.name} (${fileNumber}/${files.length})...`,
                        (i / files.length) * 90,
                        `Analyzing ${file.name}`
                    );
                    
                    updateProcessingStatus(fileNumber, files.length, file.name, 'processing');
                    
                    updateAnalysisStep(1, 'current', `Parsing ${file.name}...`);
                    updateAnalysisStep(2, 'current', 'Extracting components...');
                    updateAnalysisStep(3, 'current', 'Generating AI analysis...');
                    updateAnalysisStep(4, 'current', 'Storing results...');

                    const content = await readFileContent(file);
                    const fileType = getFileType(file.name);
                    
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: currentSessionId,
                            content: content,
                            filename: file.name,
                            file_type: fileType
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            successCount++;
                            results.push({ file: file.name, success: true, data: data });
                            
                            updateAnalysisStep(1, 'completed', `Parsed ${file.name}`);
                            updateAnalysisStep(2, 'completed', `Found ${data.components.length} components`);
                            updateAnalysisStep(3, 'completed', `Generated business summaries`);
                            updateAnalysisStep(4, 'completed', `Stored in database`);
                            
                            updateProcessingStatus(fileNumber, files.length, file.name, 'success', data.components.length);
                            
                            componentsData = componentsData.concat(data.components);
                            
                            console.log(`Successfully processed ${file.name}:`, data.components.length, 'components');
                        } else {
                            errorCount++;
                            results.push({ file: file.name, success: false, error: data.error });
                            updateProcessingStatus(fileNumber, files.length, file.name, 'error', 0, data.error);
                            showErrorInStep(file.name, data.error);
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    errorCount++;
                    results.push({ file: file.name, success: false, error: error.message });
                    console.error(`Error processing ${file.name}:`, error);
                    updateProcessingStatus(fileNumber, files.length, file.name, 'error', 0, error.message);
                    showErrorInStep(file.name, error.message);
                }
                
                processedCount++;
                
                const overallProgress = (processedCount / files.length) * 90;
                updateLoadingProgress(
                    `Processed ${processedCount}/${files.length} files (${successCount} successful, ${errorCount} failed)`,
                    overallProgress,
                    `${processedCount} of ${files.length} complete`
                );
            }

            updateLoadingProgress(
                `Analysis complete! Processed ${processedCount} files`,
                95,
                'Updating interface...'
            );

            const finalSummaryHtml = `
                <div style="background: #d4edda; padding: 1rem; border-radius: 8px; border: 1px solid #c3e6cb; margin-top: 1rem;">
                    <h4 style="color: #155724; margin: 0 0 0.5rem 0;">Processing Complete!</h4>
                    <div style="color: #155724;">
                        <strong>Total Files:</strong> ${files.length}<br>
                        <strong>Successful:</strong> ${successCount}<br>
                        <strong>Failed:</strong> ${errorCount}<br>
                        <strong>Total Components:</strong> ${results.reduce((sum, r) => sum + (r.data?.components?.length || 0), 0)}
                    </div>
                </div>
            `;
            statusContainer.insertAdjacentHTML('beforeend', finalSummaryHtml);

            updateLoadingProgress('All files processed successfully!', 100, 'Ready!');
            
            setTimeout(async () => {
                hideLoading();
                
                await refreshUI();
                await loadDashboardSummaries();
                
                showCompletionNotification(successCount, errorCount, files.length);
                
            }, 2000);
            
            event.target.value = '';
        }

        function updateProcessingStatus(currentFile, totalFiles, fileName, status, componentsFound = 0, error = null) {
            const container = document.getElementById('processingStatus');
            if (!container) return;

            let statusItem = document.getElementById(`status-${currentFile}`);
            if (!statusItem) {
                statusItem = document.createElement('div');
                statusItem.id = `status-${currentFile}`;
                statusItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 0.5rem;
                    margin-bottom: 0.5rem;
                    border-radius: 6px;
                    font-size: 0.9rem;
                `;
                container.appendChild(statusItem);
            }

            let statusIcon, statusColor, statusText, backgroundColor;
            
            switch (status) {
                case 'processing':
                    statusIcon = 'ðŸ”„';
                    statusColor = '#0c5460';
                    backgroundColor = '#d1ecf1';
                    statusText = `Processing ${fileName}...`;
                    break;
                case 'success':
                    statusIcon = 'âœ…';
                    statusColor = '#155724';
                    backgroundColor = '#d4edda';
                    statusText = `${fileName} - ${componentsFound} components found`;
                    break;
                case 'error':
                    statusIcon = 'âŒ';
                    statusColor = '#721c24';
                    backgroundColor = '#f8d7da';
                    statusText = `${fileName} - Error: ${error?.substring(0, 50) || 'Unknown error'}`;
                    break;
            }

            statusItem.style.color = statusColor;
            statusItem.style.backgroundColor = backgroundColor;
            statusItem.innerHTML = `
                <span style="margin-right: 0.5rem; font-size: 1rem;">${statusIcon}</span>
                <span><strong>File ${currentFile}/${totalFiles}:</strong> ${statusText}</span>
            `;
        }

        function showCompletionNotification(successCount, errorCount, totalFiles) {
            const notificationHtml = `
                <div id="completionNotification" style="
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    background: ${errorCount > 0 ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)' : 'linear-gradient(135deg, #28a745 0%, #20c997 100%)'};
                    color: white;
                    padding: 1.5rem;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    z-index: 10000;
                    min-width: 300px;
                    animation: slideIn 0.3s ease;
                ">
                    <h4 style="margin: 0 0 0.5rem 0;">${errorCount > 0 ? 'âš ï¸' : 'ðŸŽ‰'} Processing Complete!</h4>
                    <div>
                        <strong>Files Processed:</strong> ${successCount}/${totalFiles}<br>
                        ${errorCount > 0 ? `<strong>Errors:</strong> ${errorCount}<br>` : ''}
                        <strong>Total Components:</strong> ${componentsData.length}
                    </div>
                    <button onclick="closeCompletionNotification()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        padding: 0.25rem 0.5rem;
                        border-radius: 4px;
                        margin-top: 0.5rem;
                        cursor: pointer;
                    ">Close</button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', notificationHtml);
            
            setTimeout(() => {
                closeCompletionNotification();
            }, 10000);
        }

        function closeCompletionNotification() {
            const notification = document.getElementById('completionNotification');
            if (notification) {
                notification.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => notification.remove(), 300);
            }
        }

        // Dashboard Summaries
        async function loadDashboardSummaries() {
            try {
                const response = await fetch(`/api/llm-summaries/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayComponentSummariesFromLLMTable(data.summaries);
                        updateDashboardMetrics(data.summaries);
                    }
                }
            } catch (error) {
                console.error('Error loading LLM summaries:', error);
            }
        }

        function displayComponentSummariesFromLLMTable(summaries) {
            const container = document.getElementById('componentSummaries');
            container.innerHTML = '';

            if (summaries.length === 0) {
                container.innerHTML = '<p class="text-muted">No component summaries available</p>';
                return;
            }

            summaries.forEach(summary => {
                const card = document.createElement('div');
                card.className = 'component-summary-card';
                
                const businessPurpose = summary.business_purpose || 'No business purpose available';
                const complexityScore = summary.complexity_score || 0.5;
                const keyFeatures = summary.key_features || [];
                
                if (summary.is_raw_response) {
                    card.innerHTML = `
                        <div class="component-header">
                            <div>
                                <div class="component-title">${summary.component_name}</div>
                                <div class="text-muted">${summary.friendly_name || ''}</div>
                            </div>
                            <span class="component-type badge badge-warning">RAW AI ANALYSIS</span>
                        </div>
                        
                        <div class="business-purpose raw-analysis">
                            <strong>AI Analysis (Raw Response):</strong><br>
                            <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; max-height: 150px; overflow-y: auto;">
                                ${businessPurpose}
                            </div>
                        </div>
                        
                        <div class="component-metrics">
                            <div class="metric">
                                <span class="metric-value">RAW</span>
                                <span class="metric-label">Analysis</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${Math.round(complexityScore * 100)}%</span>
                                <span class="metric-label">Complexity</span>
                            </div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="component-header">
                            <div>
                                <div class="component-title">${summary.component_name}</div>
                                <div class="text-muted">${summary.friendly_name || ''}</div>
                            </div>
                            <span class="component-type badge badge-primary">${summary.component_type}</span>
                        </div>
                        
                        <div class="business-purpose">${businessPurpose}</div>
                        
                        <div class="component-metrics">
                            <div class="metric">
                                <span class="metric-value">${summary.primary_function || 'GENERAL'}</span>
                                <span class="metric-label">Function</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${Math.round(complexityScore * 100)}%</span>
                                <span class="metric-label">Complexity</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${keyFeatures.length}</span>
                                <span class="metric-label">Features</span>
                            </div>
                        </div>
                        
                        <div class="complexity-bar">
                            <div class="complexity-fill" style="width: ${complexityScore * 100}%"></div>
                        </div>
                    `;
                }
                
                container.appendChild(card);
            });
        }

        // Enhanced Dependencies Flow with Fixed Core Component Display
        async function createEnhancedDependencyFlowHTML(categorized, focusComponent) {
    let html = '<div class="dependency-flow">';
    
    // Input Sources Level (Files + DB2 Input Tables)
    if ((categorized.inputFiles && categorized.inputFiles.length > 0) || 
        (categorized.db2InputTables && categorized.db2InputTables.length > 0)) {
        
        html += '<div class="flow-level">';
        html += '<div class="flow-level-title">Input Sources</div>';
        html += '<div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">';
        
        // Regular input files
        if (categorized.inputFiles) {
            categorized.inputFiles.forEach(file => {
                html += createFileComponent(file, 'input-source');
            });
        }
        
        // DB2 input tables
        if (categorized.db2InputTables) {
            categorized.db2InputTables.forEach(table => {
                html += createDB2Component(table, 'db2-input-table');
            });
        }
        
        html += '</div></div>';
        html += '<div class="flow-arrow">â†“</div>';
    }
    
    // Core Programs Level
    let coreItems;
    if (focusComponent) {
        coreItems = [{name: focusComponent, type: 'Focus Program', confidence: 1.0}];
    } else if (categorized.corePrograms && categorized.corePrograms.length > 0) {
        coreItems = categorized.corePrograms;
    } else {
        coreItems = await getAllUploadedPrograms() || [{name: 'MAIN-PROGRAM', type: 'Core Program', confidence: 0.9}];
    }
    
    html += createProgramLayer('Core Programs', coreItems, 'core-program');
    
    // Add arrows to called programs if any exist
    if (categorized.calledPrograms && categorized.calledPrograms.length > 0) {
        html += '<div style="position: relative; height: 80px; display: flex; justify-content: center; align-items: center;">';
        html += createProgramCallArrows(categorized.calledPrograms);
        html += '</div>';
    } else {
        html += '<div class="flow-arrow">â†“</div>';
    }
    
    // Called Programs Level
    if (categorized.calledPrograms && categorized.calledPrograms.length > 0) {
        html += createProgramLayerWithArrows('Called Programs', categorized.calledPrograms, 'called-program');
        html += '<div class="flow-arrow">â†“</div>';
    }
    
    // Output Destinations Level (Files + DB2 Output Tables)
    if ((categorized.outputFiles && categorized.outputFiles.length > 0) || 
        (categorized.inputOutputFiles && categorized.inputOutputFiles.length > 0) ||
        (categorized.db2OutputTables && categorized.db2OutputTables.length > 0) ||
        (categorized.db2IOTables && categorized.db2IOTables.length > 0)) {
        
        html += '<div class="flow-level">';
        html += '<div class="flow-level-title">Output Destinations</div>';
        html += '<div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">';
        
        // Regular output files
        if (categorized.outputFiles) {
            categorized.outputFiles.forEach(file => {
                html += createFileComponent(file, 'output-file');
            });
        }
        
        // Input/Output files
        if (categorized.inputOutputFiles) {
            categorized.inputOutputFiles.forEach(file => {
                html += createFileComponent(file, 'input-output-file');
            });
        }
        
        // DB2 output tables
        if (categorized.db2OutputTables) {
            categorized.db2OutputTables.forEach(table => {
                html += createDB2Component(table, 'db2-output-table');
            });
        }
        
        // DB2 I/O tables
        if (categorized.db2IOTables) {
            categorized.db2IOTables.forEach(table => {
                html += createDB2Component(table, 'db2-io-table');
            });
        }
        
        html += '</div></div>';
    }
    
    // Missing Dependencies Level
    if (categorized.missingPrograms && categorized.missingPrograms.length > 0) {
        html += '<div style="margin-top: 3rem; padding-top: 2rem; border-top: 3px dashed #dc3545;">';
        html += '<h4 style="color: #dc3545; text-align: center; margin-bottom: 2rem;">âš ï¸ Missing Dependencies</h4>';
        html += createProgramLayer('Missing Programs', categorized.missingPrograms, 'missing-dependency');
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

function createDB2Component(table, className) {
    const tableIcon = 'ðŸ—ƒï¸';
    const operationIcon = getDB2OperationIcon(table.sqlOperation);
    
    return `
        <div class="flow-component ${className}" onclick="showDB2TableDetails('${table.name}', '${table.sourceProgram}')">
            <div class="component-name">${tableIcon} ${table.name}</div>
            <div class="component-type-badge">${table.tableType}</div>
            <div class="component-description">
                ${operationIcon} ${table.sqlOperation}
                <br>Source: ${table.sourceProgram}
                <br>Interface: DB2
            </div>
            <div class="confidence-indicator ${getConfidenceClass(table.confidence)}">
                ${(table.confidence * 100).toFixed(0)}%
            </div>
        </div>
    `;
}

// Helper function to get DB2 operation icons
function getDB2OperationIcon(sqlOperation) {
    if (sqlOperation.includes('SELECT')) return 'ðŸ“¥';
    if (sqlOperation.includes('INSERT')) return 'ðŸ“¤';
    if (sqlOperation.includes('UPDATE')) return 'ðŸ”„';
    if (sqlOperation.includes('DELETE')) return 'ðŸ—‘ï¸';
    return 'ðŸ’¾';
}

// Helper function to create file components (updated to work with existing code)
function createFileComponent(file, className) {
    const layoutInfo = file.hasLayoutAssociation && file.associatedLayouts.length > 0 ?
        `<div style="font-size: 0.7rem; color: #666; margin-top: 0.5rem;">
            ðŸ“‹ Layouts: ${file.associatedLayouts.slice(0, 2).join(', ')}
            ${file.associatedLayouts.length > 2 ? ` (+${file.associatedLayouts.length - 2} more)` : ''}
        </div>` : '';
        
    const interfaceIcon = file.interface === 'CICS' ? 'ðŸ¦' : 'ðŸ“';
    const statusClass = file.hasLayoutAssociation ? 'file-with-layout' : 'file-only';
    
    return `
        <div class="flow-component ${className} ${statusClass}" 
             data-component-name="${file.name}" 
             data-component-type="file"
             style="cursor: pointer;">
            <div class="component-name">${interfaceIcon} ${file.name}</div>
            <div class="component-type-badge">${file.type}</div>
            <div class="component-description">
                Operations: ${file.operations.join(', ') || 'Unknown'}
                <br>Interface: ${file.interface}
                ${layoutInfo}
            </div>
            <div class="confidence-indicator ${getConfidenceClass(file.confidence)}">
                ${(file.confidence * 100).toFixed(0)}%
            </div>
        </div>
    `;
}


// Function to show DB2 table details (modal)
function showDB2TableDetails(tableName, sourceProgram) {
    const modalHtml = `
        <div class="modal" style="display: block; z-index: 10001;">
            <div class="modal-content" style="width: 70%; max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title">ðŸ—ƒï¸ ${tableName} - DB2 Table Details</h3>
                    <button class="close" onclick="closeDB2Modal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h5>Table Information</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>Table Name:</strong></td><td>${tableName}</td></tr>
                                <tr><td><strong>Interface:</strong></td><td>DB2 Database</td></tr>
                                <tr><td><strong>Source Program:</strong></td><td>${sourceProgram}</td></tr>
                                <tr><td><strong>Access Type:</strong></td><td>SQL Operations</td></tr>
                            </table>
                        </div>
                        <div>
                            <h5>SQL Operations</h5>
                            <div id="db2SqlOperations">Loading SQL operations...</div>
                        </div>
                    </div>
                    <div>
                        <h5>Field Mappings</h5>
                        <div id="db2FieldMappings">Loading field mapping information...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="analyzeDB2Table('${tableName}')">Analyze Table Fields</button>
                    <button class="btn btn-secondary" onclick="askAboutDB2Table('${tableName}')">Ask AI About This</button>
                    <button class="btn btn-secondary" onclick="closeDB2Modal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    loadDB2TableDetails(tableName, sourceProgram);
}

// Function to load DB2 table details
async function loadDB2TableDetails(tableName, sourceProgram) {
    try {
        const response = await fetch(`/api/dependencies/${currentSessionId}`);
        const data = await response.json();
        
        if (data.success) {
            const db2Deps = data.dependencies.filter(dep => 
                dep.target_component === tableName && 
                (dep.interface_type === 'DB2' || dep.relationship_type.includes('DB2'))
            );
            
            displayDB2Operations(db2Deps);
        }
    } catch (error) {
        console.error('Error loading DB2 table details:', error);
        document.getElementById('db2SqlOperations').innerHTML = 'Error loading SQL operations';
        document.getElementById('db2FieldMappings').innerHTML = 'Error loading field mappings';
    }
}

function displayDB2Operations(db2Dependencies) {
    const operationsContainer = document.getElementById('db2SqlOperations');
    const fieldMappingsContainer = document.getElementById('db2FieldMappings');
    
    if (db2Dependencies.length === 0) {
        operationsContainer.innerHTML = '<p class="text-muted">No SQL operations found</p>';
        fieldMappingsContainer.innerHTML = '<p class="text-muted">No field mappings available</p>';
        return;
    }
    
    // Display SQL operations
    let operationsHtml = '<div style="max-height: 200px; overflow-y: auto;">';
    db2Dependencies.forEach(dep => {
        const analysis = dep.analysis_details || {};
        const sqlOp = analysis.sql_operation || 'Unknown SQL';
        const icon = getDB2OperationIcon(sqlOp);
        
        operationsHtml += `
            <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #007bff; border-radius: 4px;">
                <strong>${icon} ${sqlOp}</strong>
                <br><small>Program: ${dep.source_component}</small>
                ${analysis.sql_context ? `<br><small>Context: ${analysis.sql_context.substring(0, 100)}...</small>` : ''}
            </div>
        `;
    });
    operationsHtml += '</div>';
    operationsContainer.innerHTML = operationsHtml;
    
    // Display field mappings info
    fieldMappingsContainer.innerHTML = `
        <p>To see detailed field mappings for this DB2 table, use the Field Mapping Analysis tab.</p>
        <button class="btn btn-primary" onclick="analyzeDB2TableFields('${db2Dependencies[0].target_component}')">
            Analyze DB2 Field Mappings
        </button>
    `;
}

function closeDB2Modal() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (modal.style.zIndex === '10001') {
            modal.remove();
        }
    });
}

function analyzeDB2Table(tableName) {
    closeDB2Modal();
    showTab('fieldMapping');
    document.getElementById('targetFileInput').value = tableName;
}

function askAboutDB2Table(tableName) {
    closeDB2Modal();
    const chatInput = document.getElementById('chatInput');
    chatInput.value = `Tell me about the ${tableName} DB2 table. What data does it contain, which programs access it, and what SQL operations are performed on it?`;
    chatInput.focus();
}

function analyzeDB2TableFields(tableName) {
    closeDB2Modal();
    showTab('fieldMapping');
    document.getElementById('targetFileInput').value = tableName;
    analyzeFieldMapping();
}

    async function getAllUploadedPrograms() {
    try {
        // Get actual components from the API instead of relying on local data
        const response = await fetch(`/api/components/${currentSessionId}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.components) {
                const programs = data.components.filter(c => c.component_type === 'PROGRAM');
                if (programs.length > 0) {
                    console.log('Found uploaded programs:', programs.map(p => p.component_name));
                    return programs.map(program => ({
                        name: program.component_name,
                        friendly_name: program.friendly_name || program.component_name,
                        type: 'Core Program',
                        confidence: 0.9
                    }));
                }
            }
        }
    } catch (error) {
        console.error('Error fetching uploaded programs:', error);
    }
    
    // Fallback - try componentsData if API fails
    if (componentsData && componentsData.length > 0) {
        const programs = componentsData.filter(c => c.component_type === 'PROGRAM');
        if (programs.length > 0) {
            return programs.map(program => ({
                name: program.component_name,
                friendly_name: program.friendly_name || program.component_name,
                type: 'Core Program',
                confidence: 0.9
            }));
        }
    }
    
    return null;
}
        function createProgramCallArrows(calledPrograms) {
            let html = '<div class="program-call-arrows" style="display: flex; justify-content: center; align-items: center; gap: 1rem; height: 60px; margin: 1rem 0;">';
            
            calledPrograms.slice(0, 5).forEach((program, index) => {
                const arrowIcon = getCallArrowIcon(program.callType);
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; margin: 0 1rem;">
                        <div style="font-size: 1.8rem; color: #667eea; text-shadow: 0 2px 4px rgba(0,0,0,0.3); margin-bottom: 0.2rem;">${arrowIcon}</div>
                        <div style="font-size: 0.7rem; color: #666; text-align: center; max-width: 60px;">${program.name.substring(0, 8)}</div>
                    </div>
                `;
            });
            
            if (calledPrograms.length > 5) {
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; margin: 0 1rem;">
                        <div style="font-size: 1.5rem; color: #999;">...</div>
                        <div style="font-size: 0.7rem; color: #666;">+${calledPrograms.length - 5} more</div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        function createProgramLayer(title, items, className) {
            let html = `
                <div class="flow-level">
                    <div class="flow-level-title">${title}</div>
                    <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">
            `;
            
            items.forEach(item => {
                const displayName = item.name || item.friendly_name || 'UNKNOWN';
                const confidenceClass = item.confidence > 0.8 ? 'confidence-high' : 
                                    item.confidence > 0.5 ? 'confidence-medium' : 'confidence-low';
                
                html += `
                    <div class="flow-component ${className}" 
                        data-component-name="${item.name}" 
                        data-component-type="program"
                        style="cursor: pointer;">
                        <div class="confidence-indicator ${confidenceClass}"></div>
                        <div class="component-name">${displayName}</div>
                        <div class="component-type-badge">${item.type}</div>
                        <div class="component-description">
                            Confidence: ${(item.confidence * 100).toFixed(0)}%
                            ${item.reason ? `<br><small>${item.reason}</small>` : ''}
                            ${item.calledFrom ? `<br><small>Called from: ${item.calledFrom}</small>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

function initializeDependencyFlowInteractivity() {
    // Remove any existing event listeners
    document.removeEventListener('click', handleDependencyFlowClick);
    
    // Add event delegation for dependency flow clicks
    document.addEventListener('click', handleDependencyFlowClick);
}

function handleDependencyFlowClick(event) {
    const target = event.target.closest('.flow-component');
    if (!target) return;
    
    // Prevent event bubbling
    event.preventDefault();
    event.stopPropagation();
    
    // Get component info from data attributes
    const componentName = target.getAttribute('data-component-name');
    const componentType = target.getAttribute('data-component-type');
    
    if (!componentName) {
        console.warn('No component name found for clicked element');
        return;
    }
    
    // Route to appropriate detail function
    switch (componentType) {
        case 'program':
            showProgramDetails(componentName);
            break;
        case 'file':
            showFileDetails(componentName);
            break;
        case 'db2':
            showDB2TableDetails(componentName);
            break;
        default:
            console.warn('Unknown component type:', componentType);
    }
}

function displayFieldMatrix(matrixData) {
            const tbody = document.getElementById('fieldMatrixTableBody');
            tbody.innerHTML = '';

            if (matrixData.program_layouts) {
                matrixData.program_layouts.forEach((layout, layoutIndex) => {
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'collapsible-row';
                    headerRow.onclick = () => toggleLayoutFields(layoutIndex);
                    
                    headerRow.innerHTML = `
                        <td>
                            <span class="expand-icon" id="expand-${layoutIndex}">â–¶</span>
                            <strong>${layout.layout_name}</strong>
                            <br><small class="text-muted">${layout.friendly_name}</small>
                        </td>
                        <td colspan="5">
                            <span class="badge badge-primary">Level ${layout.level}</span>
                            ${layout.fields.length} fields
                        </td>
                    `;
                    tbody.appendChild(headerRow);

                    const fieldsContainer = document.createElement('tbody');
                    fieldsContainer.id = `fields-${layoutIndex}`;
                    fieldsContainer.className = 'sub-fields';
                    fieldsContainer.style.display = 'none';
                    
                    layout.fields.forEach(field => {
                        const fieldRow = document.createElement('tr');
                        fieldRow.className = 'sub-field-row';
                        
                        const usageClass = `usage-${field.usage_type.toLowerCase()}`;
                        
                        fieldRow.innerHTML = `
                            <td style="padding-left: 2rem;">
                                ${field.field_name}
                                <br><small class="text-muted">${field.friendly_name || ''}</small>
                            </td>
                            <td>
                                <span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type}</span>
                                <br><small>${field.usage_description || ''}</small>
                            </td>
                            <td>${field.source_field || 'N/A'}</td>
                            <td>${field.business_purpose || 'N/A'}</td>
                            <td>${field.program_name || 'N/A'}</td>
                            <td>${field.line_number || 'N/A'}</td>
                        `;
                        fieldRow.className += ` ${usageClass}`;
                        fieldsContainer.appendChild(fieldRow);
                    });
                    
                    tbody.appendChild(fieldsContainer);
                });
            } else if (matrixData.fields) {
                matrixData.fields.forEach(field => {
                    const row = document.createElement('tr');
                    const usageClass = `usage-${field.usage_type.toLowerCase()}`;
                    
                    row.innerHTML = `
                        <td>
                            ${field.field_name}
                            <br><small class="text-muted">${field.friendly_name || ''}</small>
                        </td>
                        <td>
                            <span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type}</span>
                            <br><small>${field.usage_description || ''}</small>
                        </td>
                        <td>${field.source_field || 'N/A'}</td>
                        <td>${field.business_purpose || 'N/A'}</td>
                        <td>${field.program_name || 'N/A'}</td>
                        <td>${field.line_number || 'N/A'}</td>
                    `;
                    row.className = usageClass;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No field data available</td></tr>';
            }
        }

        function toggleLayoutFields(layoutIndex) {
            const fieldsContainer = document.getElementById(`fields-${layoutIndex}`);
            const expandIcon = document.getElementById(`expand-${layoutIndex}`);
            
            if (fieldsContainer.style.display === 'none') {
                fieldsContainer.style.display = 'table-row-group';
                expandIcon.textContent = 'â–¼';
            } else {
                fieldsContainer.style.display = 'none';
                expandIcon.textContent = 'â–¶';
            }
        }

        // Field Mapping Functions
        function initializeFieldMapping() {
            loadRecordLayoutSelector();
        }

        function loadRecordLayoutSelector() {
            const selector = document.getElementById('recordLayoutSelector');
            if (!selector) return;
            
            if (!currentSessionId) return;
            
            try {
                fetch(`/api/record-layouts/${currentSessionId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            selector.innerHTML = '<option value="">Or select a record layout</option>';
                            
                            if (data.layouts && data.layouts.length > 0) {
                                data.layouts.forEach(layout => {
                                    const option = document.createElement('option');
                                    option.value = layout.layout_name;
                                    option.textContent = `${layout.layout_name} (${layout.fields_count || 0} fields) - ${layout.program_name}`;
                                    selector.appendChild(option);
                                });
                            } else {
                                const option = document.createElement('option');
                                option.value = '';
                                option.textContent = 'No record layouts found';
                                option.disabled = true;
                                selector.appendChild(option);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading record layouts:', error);
                        selector.innerHTML = '<option value="">Error loading layouts</option>';
                    });
            } catch (error) {
                console.error('Error in loadRecordLayoutSelector:', error);
            }
        }

        function updateTargetFileFromLayout() {
            const selector = document.getElementById('recordLayoutSelector');
            const targetInput = document.getElementById('targetFileInput');
            
            if (selector && selector.value && targetInput) {
                targetInput.value = selector.value;
            }
        }

        async function analyzeFieldMapping() {
            const targetFile = document.getElementById('targetFileInput').value.trim();
            if (!targetFile) {
                showError('Please enter a target file name or select a record layout');
                return;
            }

            showLoading('Analyzing field mappings...');

            try {
                const response = await fetch('/api/field-mapping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        target_file: targetFile
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayFieldMappingsWithSummary(data.field_mappings, data.summary);
                        await displayLayoutSummary(targetFile);
                    } else {
                        showError(data.error || 'Failed to analyze field mappings');
                    }
                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error analyzing field mapping:', error);
                showError('Failed to analyze field mappings');
            }

            hideLoading();
        }

        function normalizeUsageType(usageType) {
            if (!usageType) return 'STATIC';
            
            const normalizedMappings = {
                'MOVE_TARGET': 'INPUT',
                'MOVE_SOURCE': 'OUTPUT', 
                'MOVE': 'INPUT_OUTPUT',
                'COMPUTED': 'DERIVED',
                'DEFINITION': 'STATIC',
                'CONDITION': 'REFERENCE',
                'CONDITIONAL': 'REFERENCE',
                'CICS_INPUT': 'INPUT',
                'CICS_OUTPUT': 'OUTPUT',
                'CICS_REWRITE': 'INPUT_OUTPUT',
                'STRING_MANIPULATION': 'DERIVED',
                'CALCULATED': 'DERIVED',
                'UNUSED': 'UNUSED'
            };
            
            return normalizedMappings[usageType.toUpperCase()] || usageType.toUpperCase();
        }

        function displayFieldMappingsWithSummary(mappings, summary) {
            const tbody = document.getElementById('fieldMappingTableBody');
            tbody.innerHTML = '';

            if (!mappings || mappings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No field mappings found</td></tr>';
                return;
            }

            mappings.forEach(mapping => {
                const row = document.createElement('tr');
                
                let normalizedUsageType = normalizeUsageType(mapping.usage_type || 'STATIC');
                
                row.innerHTML = `
                    <td>
                        <div style="min-width: 150px;">
                            <strong>${mapping.field_name || 'N/A'}</strong>
                            ${mapping.friendly_name && mapping.friendly_name !== mapping.field_name ? 
                                `<br><small class="text-muted">${mapping.friendly_name}</small>` : ''}
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 120px;">
                            <code style="font-size: 0.8rem;">${mapping.mainframe_data_type || 'UNKNOWN'}</code>
                            <br><small><strong>Length:</strong> ${mapping.mainframe_length || 0}</small>
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 120px;">
                            <code style="font-size: 0.8rem;">${mapping.oracle_data_type || 'VARCHAR2(50)'}</code>
                            <br><small><strong>Length:</strong> ${mapping.oracle_length || 50}</small>
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 150px;">
                            <strong>${mapping.population_source || 'Program logic'}</strong>
                            ${mapping.source_record_layout ? `<br><small>From: ${mapping.source_record_layout}</small>` : ''}
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 120px;">
                            <span class="badge ${getBadgeClass(normalizedUsageType)}">${normalizedUsageType}</span>
                            <br><small style="font-size: 0.75rem;">${mapping.business_logic_description || ''}</small>
                        </div>
                              ${mapping.sql_operations && mapping.sql_operations.length > 0 ? 
                            `<br><div class="db2-operations">
                                <strong>DB2:</strong> 
                                ${mapping.sql_operations.map(op => 
                                    `<span class="sql-operation">${op.sql_operation}</span>`
                                ).join(' ')}
                            </div>` : ''}
                    </td>
                    <td>
                        <div style="min-width: 100px;">
                            ${Array.isArray(mapping.programs_involved) ? 
                                mapping.programs_involved.join(', ') : 
                                mapping.programs_involved || 'Unknown'}
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 80px;">
                            <button class="btn btn-secondary" onclick="showFieldDetails('${mapping.field_name}')" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap;">
                                View Details
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function displayLayoutSummary(layoutName) {
            try {
                const response = await fetch(`/api/layout-summary/${currentSessionId}/${layoutName}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const summary = data.summary;
                        const summarySection = document.getElementById('layoutSummarySection');
                        const summaryContent = document.getElementById('layoutSummaryContent');
                        
                        if (!summarySection || !summaryContent) {
                            return;
                        }
                        
                        summaryContent.innerHTML = `
                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                                <div>
                                    <h5>${summary.layout_name}</h5>
                                    <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #666;">${summary.friendly_name}</p>
                                    <p style="font-size: 0.85rem; line-height: 1.4;">${summary.business_purpose}</p>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #667eea;">${summary.total_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Total</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">${summary.input_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Input</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #17a2b8;">${summary.output_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Output</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #6c757d;">${summary.static_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Static</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #dc3545;">${summary.unused_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Unused</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #ffc107;">${summary.io_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">IO-Fields</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        summarySection.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading layout summary:', error);
            }
        }

        async function showFieldDetails(fieldName) {
            try {
                const response = await fetch(`/api/field-details/${currentSessionId}/${fieldName}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayFieldDetailsModal(data.field_details);
                    } else {
                        showError(`Could not load details for field ${fieldName}`);
                    }
                }
            } catch (error) {
                console.error('Error loading field details:', error);
                showError('Error loading field details');
            }
        }

        function displayFieldDetailsModal(fieldDetails) {
            const modalTitle = document.getElementById('fieldModalTitle');
            const fieldDetailsContent = document.getElementById('fieldDetailsContent');
            
            if (!modalTitle || !fieldDetailsContent) {
                console.error('Modal elements not found');
                return;
            }
            
            try {
                modalTitle.textContent = `${fieldDetails.field_name} - Field Details`;
                
                const normalizedUsageType = normalizeUsageType(fieldDetails.usage_type || 'STATIC');
                const content = createFieldDetailsContent({...fieldDetails, usage_type: normalizedUsageType});
                fieldDetailsContent.innerHTML = content;
                
                const modal = document.getElementById('fieldDetailsModal');
                if (modal) {
                    modal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
            } catch (error) {
                console.error('Error displaying field details modal:', error);
                showError('Error displaying field details');
            }
        }

        function closeFieldDetailsModal() {
            const modal = document.getElementById('fieldDetailsModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }
        // Add this function to handle dynamic call details
        async function showDynamicCallDetails(variableName, sourceProgram) {
            try {
                const response = await fetch(`/api/dynamic-call-analysis/${currentSessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    const programAnalysis = data.dynamic_call_analysis.find(p => 
                        p.program_name === sourceProgram && 
                        p.variables_used.includes(variableName)
                    );
                    
                    if (programAnalysis) {
                        displayDynamicCallModal(programAnalysis, variableName);
                    }
                }
            } catch (error) {
                console.error('Error loading dynamic call details:', error);
            }
        }

        function displayDynamicCallModal(programAnalysis, variableName) {
            const modalHtml = `
                <div class="modal show" style="z-index: 10001;">
                    <div class="modal-content" style="width: 80%; max-width: 900px;">
                        <div class="modal-header">
                            <h3 class="modal-title">ðŸ”„ Dynamic Call: ${variableName}</h3>
                            <button class="close" onclick="closeDynamicCallModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                                <div>
                                    <h5>Dynamic Call Information</h5>
                                    <table style="width: 100%; font-size: 0.9rem;">
                                        <tr><td><strong>Variable Name:</strong></td><td>${variableName}</td></tr>
                                        <tr><td><strong>Source Program:</strong></td><td>${programAnalysis.program_name}</td></tr>
                                        <tr><td><strong>Total Dynamic Calls:</strong></td><td>${programAnalysis.total_dynamic_calls}</td></tr>
                                        <tr><td><strong>Resolved Programs:</strong></td><td>${programAnalysis.resolved_programs.length}</td></tr>
                                    </table>
                                </div>
                                <div>
                                    <h5>Resolution Details</h5>
                                    <div id="dynamicCallResolution">
                                        ${programAnalysis.resolved_programs.map(prog => `
                                            <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 4px;">
                                                <strong>${prog.program_name}</strong>
                                                <br><small>Status: ${prog.status || 'Unknown'}</small>
                                                <br><small>Method: ${prog.resolution_method || 'Code Analysis'}</small>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 2rem;">
                                <h5>Business Logic Summary</h5>
                                <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                                    ${programAnalysis.business_logic_summary || 'Dynamic call analysis available but summary not generated'}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="analyzeVariableUsage('${variableName}')">Analyze Variable Usage</button>
                            <button class="btn btn-secondary" onclick="askAboutDynamicCall('${variableName}')">Ask AI About This</button>
                            <button class="btn btn-secondary" onclick="closeDynamicCallModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.body.style.overflow = 'hidden';
        }

        function closeDynamicCallModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.style.zIndex === '10001') {
                    modal.remove();
                }
            });
            document.body.style.overflow = 'auto';
        }
        function createFieldDetailsContent(fieldDetails) {
            const operationsSummary = fieldDetails.operations ? 
                fieldDetails.operations.map(op => 
                    `${op.program_name}: ${normalizeUsageType(op.usage_type)} (${op.move_source_count + op.move_target_count + op.arithmetic_count + op.conditional_count} operations)`
                ).join('<br>') : 'No operations found';

            const referencesHtml = fieldDetails.references ? 
                fieldDetails.references.map(ref => `
                    <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 4px;">
                        <strong>Line ${ref.line_number}:</strong> ${normalizeUsageType(ref.operation_type)}<br>
                        <code style="font-size: 0.8rem;">${ref.line_content}</code>
                    </div>
                `).join('') : 'No references found';

            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <h5>Field Information</h5>
                        <table style="width: 100%; font-size: 0.9rem;">
                            <tr><td><strong>Name:</strong></td><td>${fieldDetails.field_name || 'N/A'}</td></tr>
                            <tr><td><strong>Friendly Name:</strong></td><td>${fieldDetails.friendly_name || 'N/A'}</td></tr>
                            <tr><td><strong>Usage Type:</strong></td><td><span class="badge ${getBadgeClass(fieldDetails.usage_type || 'UNKNOWN')}">${fieldDetails.usage_type || 'UNKNOWN'}</span></td></tr>
                            <tr><td><strong>Source Field:</strong></td><td>${fieldDetails.source_field || 'N/A'}</td></tr>
                            <tr><td><strong>Target Field:</strong></td><td>${fieldDetails.target_field || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div>
                        <h5>Data Types & Lengths</h5>
                        <table style="width: 100%; font-size: 0.9rem;">
                            <tr><td><strong>Mainframe Type:</strong></td><td><code>${fieldDetails.mainframe_data_type || 'UNKNOWN'}</code></td></tr>
                            <tr><td><strong>Mainframe Length:</strong></td><td>${fieldDetails.mainframe_length || 0}</td></tr>
                            <tr><td><strong>Oracle Type:</strong></td><td><code>${fieldDetails.oracle_data_type || 'VARCHAR2(50)'}</code></td></tr>
                            <tr><td><strong>Oracle Length:</strong></td><td>${fieldDetails.oracle_length || 50}</td></tr>
                            <tr><td><strong>Total References:</strong></td><td>${fieldDetails.total_references || 0}</td></tr>
                        </table>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h5>Business Purpose</h5>
                    <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                        ${fieldDetails.business_purpose || 'No description available'}
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h5>Field Definition</h5>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.9rem;">
                        ${fieldDetails.definition_code || 'Definition not available'}
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h5>Program Operations</h5>
                    <div style="font-size: 0.9rem;">
                        ${operationsSummary}
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h5>Field References (First 10)</h5>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${referencesHtml}
                    </div>
                </div>

                <div>
                    <h5>Source Code Context</h5>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                        <pre style="margin: 0; font-size: 0.8rem; white-space: pre-wrap;">${fieldDetails.source_code_snippet || 'Source code not available'}</pre>
                    </div>
                </div>
            `;
        }

       

        function exportFieldMappings() {
            const table = document.getElementById('fieldMappingTableBody');
            const rows = table.querySelectorAll('tr');
            
            if (rows.length === 0 || rows[0].textContent.includes('No field mappings')) {
                alert('No field mappings to export');
                return;
            }
            
            let csv = 'Field Name,Mainframe Data Type,Oracle Data Type,MF Length,Oracle Length,Population Source,Business Logic,Programs Involved\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                cells.forEach(cell => {
                    const text = cell.textContent.trim().replace(/\n/g, ' ').replace(/,/g, ';');
                    rowData.push(`"${text}"`);
                });
                csv += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `field_mappings_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function getBadgeClass(type) {
            const badgeMap = {
                'INPUT': 'badge-primary',
                'OUTPUT': 'badge-success', 
                'INPUT_OUTPUT': 'badge-warning',
                'DERIVED': 'badge-warning',
                'REFERENCE': 'badge-info',
                'STATIC': 'badge-secondary',
                'UNUSED': 'badge-danger',
                'MOVE': 'badge-primary',
                'CONDITIONAL': 'badge-warning',
                'CALCULATED': 'badge-success',
                'STRING_MANIPULATION': 'badge-info',
                'CICS_INPUT': 'badge-primary',
                'CICS_OUTPUT': 'badge-success',
                'CICS_REWRITE': 'badge-warning'
            };
            return badgeMap[type] || 'badge-secondary';
        }

        // Chat Functions
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addChatMessage('user', message);
            input.value = '';
            updateChatTokenCounter();

            const typingId = addChatMessage('assistant', 'Thinking...');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message: message,
                        conversation_id: currentConversationId
                    })
                });

               if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById(typingId).remove();
                    
                    if (data.success) {
                        const responseContent = data.response || data.content || data.message || 'No response';
                        addChatMessage('assistant', responseContent);
                        
                        if (data.tokens_used) {
                            updateTokenCounters();
                        }
                    } else {
                        addChatMessage('assistant', data.error || 'Sorry, I encountered an error.');
                    }

                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error sending chat message:', error);
                document.getElementById(typingId).remove();
                addChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            }
        }

        function addChatMessage(type, message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${type}`;
            
            let displayMessage = '';
            if (typeof message === 'string') {
                displayMessage = message;
            } else if (typeof message === 'object') {
                if (message.response) {
                    displayMessage = message.response;
                } else if (message.content) {
                    displayMessage = message.content;
                } else {
                    displayMessage = JSON.stringify(message, null, 2);
                }
            } else {
                displayMessage = String(message);
            }
            
            const formattedMessage = displayMessage
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `<p>${formattedMessage}</p>`;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageId;
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
            updateChatTokenCounter();
        }

        function updateChatTokenCounter() {
            const input = document.getElementById('chatInput');
            const counter = document.getElementById('chatTokenCounter');
            const tokenCount = Math.ceil(input.value.length / 4);
            counter.textContent = `${tokenCount} tokens`;
        }

        // Utility Functions
        function updateTokenCounters() {
            const totalComponents = componentsData.length;
            const estimatedTokens = totalComponents * 1500;
            
            document.getElementById('totalTokens').textContent = estimatedTokens;
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function showLoading(message = 'Processing...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showLoadingWithProgress(title) {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            updateLoadingProgress('Starting analysis...', 0, 'Initializing...');
            resetAnalysisSteps();
        }

        function updateLoadingProgress(message, percentage, progressText) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = progressText;
        }

        function resetAnalysisSteps() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                step.className = 'analysis-step';
            });
        }

        function updateAnalysisStep(stepNumber, status, message) {
            const stepElement = document.getElementById(`step${stepNumber}`);
            stepElement.className = `analysis-step ${status}`;
            
            if (message) {
                stepElement.innerHTML = `<span class="step-icon"></span> ${message}`;
            }
        }

        function showErrorInStep(fileName, error) {
            updateAnalysisStep(1, 'error', `Error parsing ${fileName}`);
            document.getElementById('progressText').textContent = `Error: ${error}`;
            document.getElementById('progressText').style.color = '#dc3545';
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }

        function getFileType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const typeMap = {
                'cbl': 'COBOL',
                'cob': 'COBOL',
                'cpy': 'COPYBOOK',
                'jcl': 'JCL'
            };
            return typeMap[ext] || 'COBOL';
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10001;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Panel Management
        function togglePanel(side) {
            const panel = document.getElementById(side + 'Panel');
            const isCollapsed = panel.classList.contains('collapsed');
            
            if (isCollapsed) {
                panel.classList.remove('collapsed');
                removeRestoreButton(side);
            } else {
                panel.classList.add('collapsed');
                addRestoreButton(side);
            }
        }

        function addRestoreButton(side) {
            const existing = document.getElementById(`restore-${side}`);
            if (existing) existing.remove();
            
            const button = document.createElement('button');
            button.id = `restore-${side}`;
            button.className = `panel-restore ${side}`;
            button.innerHTML = side === 'left' ? 'ðŸ“<br><small>Dashboard</small>' : 'ðŸ’¬<br><small>Chat</small>';
            button.title = `Restore ${side} panel`;
            button.onclick = () => togglePanel(side);
            
            document.body.appendChild(button);
        }

        function removeRestoreButton(side) {
            const button = document.getElementById(`restore-${side}`);
            if (button) button.remove();
        }

        async function refreshUI() {
            await loadMetrics();
            await loadComponentsList();
            await populateDependencyDropdown();
        }

        async function loadMetrics() {
            try {
                const response = await fetch(`/api/session-metrics/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateMetricsDisplay(data.metrics);
                    }
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        function updateMetricsDisplay(metrics) {
            document.getElementById('totalComponents').textContent = metrics.total_components || 0;
            document.getElementById('totalPrograms').textContent = metrics.component_counts?.PROGRAM || 0;
            document.getElementById('totalFields').textContent = metrics.total_fields || 0;
            document.getElementById('totalTokens').textContent = 
                (metrics.token_usage?.total_prompt_tokens || 0) + (metrics.token_usage?.total_response_tokens || 0);
        }

        async function loadComponentsList() {
            try {
                const response = await fetch(`/api/components/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateComponentsList(data.components);
                    }
                }
            } catch (error) {
                console.error('Error loading components list:', error);
            }
        }

        function updateComponentsList(components) {
            const container = document.getElementById('componentsList');
            container.innerHTML = '';

            if (!components || components.length === 0) {
                container.innerHTML = '<p class="text-muted">No components uploaded yet</p>';
                return;
            }

            const list = document.createElement('div');
            const typeGroups = {};

            components.forEach(component => {
                const type = component.component_type;
                if (!typeGroups[type]) {
                    typeGroups[type] = [];
                }
                typeGroups[type].push(component);
            });

            Object.keys(typeGroups).forEach(type => {
                const typeHeader = document.createElement('h5');
                typeHeader.textContent = `${type}s (${typeGroups[type].length})`;
                typeHeader.style.color = '#667eea';
                typeHeader.style.marginTop = '1rem';
                typeHeader.style.fontSize = '0.9rem';
                list.appendChild(typeHeader);

                typeGroups[type].forEach(component => {
                    const item = document.createElement('div');
                    item.style.padding = '0.5rem';
                    item.style.borderLeft = '3px solid #667eea';
                    item.style.paddingLeft = '0.5rem';
                    item.style.marginBottom = '0.5rem';
                    item.style.backgroundColor = '#f8f9ff';
                    item.style.borderRadius = '4px';
                    item.style.cursor = 'pointer';
                    
                    let businessPurpose = (component.llm_summary && component.llm_summary.business_purpose) || component.business_purpose || 'Analysis pending';
                    
                    if ((!component.llm_summary || !component.llm_summary.business_purpose) && component.analysis_result_json) {
                        try {
                            const analysis = JSON.parse(component.analysis_result_json);
                            if (analysis.llm_summary && analysis.llm_summary.business_purpose) {
                                businessPurpose = analysis.llm_summary.business_purpose;
                            } else if (analysis.business_purpose) {
                                businessPurpose = analysis.business_purpose;
                            }
                        } catch (e) {
                            console.warn('Could not parse analysis for', component.component_name);
                        }
                    }
                    
                    item.innerHTML = `
                        <div style="font-weight: bold; font-size: 0.8rem;">${component.component_name}</div>
                        <div style="font-size: 0.7rem; color: #666; margin-top: 0.2rem;">
                            ${component.total_lines || 0} lines
                        </div>
                        <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem; 
                                   max-height: 2.4em; overflow: hidden; line-height: 1.2em;">
                            ${businessPurpose}
                        </div>
                    `;
                    
                    item.onclick = () => {
                        alert(`${component.component_name}\n\nLines: ${component.total_lines || 0}\n\nPurpose: ${businessPurpose}`);
                    };
                    
                    list.appendChild(item);
                });
            });

            container.appendChild(list);
        }

        function updateDashboardMetrics(components) {
            const programs = components.filter(c => c.component_type === 'PROGRAM');
            const recordLayouts = components.filter(c => c.component_type === 'RECORD_LAYOUT');
            const cicsFiles = components.filter(c => c.component_type === 'CICS_FILE');
            
            document.getElementById('parsedPrograms').textContent = programs.length;
            document.getElementById('recordLayouts').textContent = recordLayouts.length;
            document.getElementById('cicsFiles').textContent = cicsFiles.length;
        }

        // Additional component actions
        function reAnalyzeComponent(componentName) {
            alert(`Re-analysis functionality for ${componentName} coming soon!`);
        }

        function askAboutThis(componentName) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value = `Tell me about the ${componentName} component. What does it do and how does it work?`;
            chatInput.focus();
        }

        function filterComponents() {
            console.log('Filtering components...');
        }

        // Component Details Functions
        async function showProgramDetails(programName) {
        try {
            // Get detailed program information from API
            const response = await fetch(`/api/component-source/${currentSessionId}/${programName}`);
            const data = await response.json();
            
            if (data.success) {
                displayProgramDetailsModal(data.components[0], programName);
            } else {
                // Fallback to basic component data
                showBasicProgramDetails(programName);
            }
        } catch (error) {
            console.error('Error loading program details:', error);
            showBasicProgramDetails(programName);
        }
    }

        async function showFileDetails(fileName) {
    try {
        // Get file and layout information
        const [dependencyResponse, layoutResponse] = await Promise.all([
            fetch(`/api/dependencies/${currentSessionId}`),
            fetch(`/api/record-layouts/${currentSessionId}`)
        ]);
        
        const dependencyData = await dependencyResponse.json();
        const layoutData = await layoutResponse.json();
        
        displayFileDetailsModal(fileName, dependencyData, layoutData);
    } catch (error) {
        console.error('Error loading file details:', error);
        showBasicFileDetails(fileName);
    }
}

function displayProgramDetailsModal(programData, programName) {
    // Safety check and defaults
    if (!programData) {
        programData = {
            component_name: programName,
            friendly_name: programName.replace('-', ' '),
            component_type: 'COBOL Program',
            total_lines: 'Unknown',
            total_fields: 'Unknown',
            business_purpose: 'Program analysis information not available',
            source_for_chat: 'Source code not available'
        };
    }

    const modalHtml = `
        <div class="modal" style="display: block; z-index: 10001;">
            <div class="modal-content" style="width: 80%; max-width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title">${programName} - Program Details</h3>
                    <button class="close" onclick="closeProgramModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h5>Program Information</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>Program Name:</strong></td><td>${programData.component_name || programName}</td></tr>
                                <tr><td><strong>Friendly Name:</strong></td><td>${programData.friendly_name || programName.replace('-', ' ')}</td></tr>
                                <tr><td><strong>Type:</strong></td><td>${programData.component_type || 'COBOL Program'}</td></tr>
                                <tr><td><strong>Lines of Code:</strong></td><td>${programData.total_lines || 'Unknown'}</td></tr>
                                <tr><td><strong>Total Fields:</strong></td><td>${programData.total_fields || 'Unknown'}</td></tr>
                            </table>
                        </div>
                        <div>
                            <h5>Analysis Metrics</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>Complexity Score:</strong></td><td>${programData.complexity_score ? Math.round(programData.complexity_score * 100) + '%' : 'N/A'}</td></tr>
                                <tr><td><strong>Analysis Status:</strong></td><td><span class="badge badge-success">Complete</span></td></tr>
                                <tr><td><strong>Dependencies:</strong></td><td id="programDependencyCount">Loading...</td></tr>
                                <tr><td><strong>Called By:</strong></td><td id="programCallerCount">Loading...</td></tr>
                            </table>
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <h5>Business Purpose</h5>
                        <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                            ${programData.business_purpose || 'This program handles mainframe business logic and data processing operations.'}
                        </div>
                    </div>

                    <div class="program-details-tabs">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; border-bottom: 1px solid #e9ecef;">
                            <button class="tab-button active" onclick="showProgramTab('dependencies', this)">Dependencies</button>
                            <button class="tab-button" onclick="showProgramTab('fields', this)">Field Usage</button>
                            <button class="tab-button" onclick="showProgramTab('source', this)">Source Code</button>
                        </div>

                        <div id="dependencies-tab" class="program-tab active">
                            <div id="programDependencies">Loading dependency information...</div>
                        </div>

                        <div id="fields-tab" class="program-tab" style="display: none;">
                            <div id="programFields">Loading field usage...</div>
                        </div>

                        <div id="source-tab" class="program-tab" style="display: none;">
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; max-height: 400px; overflow-y: auto;">
                                <pre style="margin: 0; font-size: 0.8rem; white-space: pre-wrap;">${programData.source_for_chat || 'Source code not available'}</pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="askAboutProgram('${programName}')">Ask AI About This</button>
                    <button class="btn btn-secondary" onclick="closeProgramModal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Load additional data
    loadProgramDependencies(programName);
    loadProgramFields(programName);
}

async function loadProgramDependencies(programName) {
    try {
        const response = await fetch(`/api/dependencies/${currentSessionId}`);
        const data = await response.json();
        
        if (data.success) {
            const outgoing = data.dependencies.filter(dep => dep.source_component === programName);
            const incoming = data.dependencies.filter(dep => dep.target_component === programName);
            
            document.getElementById('programDependencyCount').textContent = outgoing.length;
            document.getElementById('programCallerCount').textContent = incoming.length;
            
            const dependenciesHtml = createDependencyTables(outgoing, incoming);
            document.getElementById('programDependencies').innerHTML = dependenciesHtml;
        }
    } catch (error) {
        console.error('Error loading program dependencies:', error);
        document.getElementById('programDependencies').innerHTML = 'Error loading dependency information.';
    }
}

function createDependencyTables(outgoing, incoming) {
    let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">';
    
    html += '<div><h6>This Program Calls:</h6>';
    if (outgoing.length > 0) {
        html += '<div style="max-height: 200px; overflow-y: auto;">';
        outgoing.forEach(dep => {
            const icon = dep.interface_type === 'CICS' ? 'ðŸ¦' : dep.relationship_type.includes('FILE') ? 'ðŸ“' : 'ðŸ“ž';
            html += `<div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 4px; font-size: 0.8rem;">${icon} <strong>${dep.target_component}</strong><br><small>${dep.relationship_type} via ${dep.interface_type}</small></div>`;
        });
        html += '</div>';
    } else {
        html += '<p class="text-muted">No outgoing dependencies found.</p>';
    }
    html += '</div>';
    
    html += '<div><h6>Called By:</h6>';
    if (incoming.length > 0) {
        html += '<div style="max-height: 200px; overflow-y: auto;">';
        incoming.forEach(dep => {
            html += `<div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #28a745; border-radius: 4px; font-size: 0.8rem;">ðŸ“ž <strong>${dep.source_component}</strong><br><small>${dep.relationship_type}</small></div>`;
        });
        html += '</div>';
    } else {
        html += '<p class="text-muted">No incoming dependencies found.</p>';
    }
    html += '</div></div>';
    
    return html;
}

async function loadProgramFields(programName) {
    try {
        const response = await fetch(`/api/field-matrix?session_id=${currentSessionId}&program_name=${programName}`);
        const data = await response.json();
        
        if (data.success && data.matrix_data) {
            const fieldsHtml = createProgramFieldsDisplay(data.matrix_data);
            document.getElementById('programFields').innerHTML = fieldsHtml;
        } else {
            document.getElementById('programFields').innerHTML = '<p class="text-muted">No field usage information available.</p>';
        }
    } catch (error) {
        console.error('Error loading program fields:', error);
        document.getElementById('programFields').innerHTML = 'Error loading field information.';
    }
}

function createProgramFieldsDisplay(matrixData) {
    const fields = matrixData.fields || [];
    
    if (fields.length === 0) {
        return '<p class="text-muted">No field usage data found.</p>';
    }

    let html = `<div style="max-height: 300px; overflow-y: auto;"><table class="data-table" style="font-size: 0.8rem;"><thead><tr><th>Field Name</th><th>Usage</th><th>Source/Target</th><th>Purpose</th></tr></thead><tbody>`;

    fields.forEach(field => {
        html += `<tr><td><strong>${field.field_name}</strong>${field.friendly_name ? `<br><small class="text-muted">${field.friendly_name}</small>` : ''}</td><td><span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type || 'STATIC'}</span></td><td>${field.source_field || 'N/A'}</td><td>${field.business_purpose || 'Field processing'}</td></tr>`;
    });

    html += '</tbody></table></div>';
    return html;
}

function displayFileDetailsModal(fileName, dependencyData, layoutData) {
    // Find related layouts
    const relatedLayouts = layoutData.success ? 
        layoutData.layouts.filter(layout => 
            layout.layout_name.toUpperCase().includes(fileName.toUpperCase()) ||
            fileName.toUpperCase().includes(layout.layout_name.toUpperCase())
        ) : [];

    // Find file dependencies
    const fileDependencies = dependencyData.success ?
        dependencyData.dependencies.filter(dep => 
            dep.target_component.toUpperCase() === fileName.toUpperCase()
        ) : [];

    const modalHtml = `
        <div class="modal" style="display: block; z-index: 10001;">
            <div class="modal-content" style="width: 80%; max-width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title">${fileName} - File Details</h3>
                    <button class="close" onclick="closeFileModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h5>File Information</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>File Name:</strong></td><td>${fileName}</td></tr>
                                <tr><td><strong>Interface Type:</strong></td><td>${fileDependencies[0]?.interface_type || 'FILE_SYSTEM'}</td></tr>
                                <tr><td><strong>I/O Operations:</strong></td><td>${getFileOperations(fileDependencies)}</td></tr>
                                <tr><td><strong>Access Programs:</strong></td><td>${fileDependencies.length}</td></tr>
                            </table>
                        </div>
                        <div>
                            <h5>Layout Information</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>Associated Layouts:</strong></td><td>${relatedLayouts.length}</td></tr>
                                <tr><td><strong>Total Fields:</strong></td><td>${getTotalFields(relatedLayouts)}</td></tr>
                                <tr><td><strong>Layout Status:</strong></td><td>${relatedLayouts.length > 0 ? '<span class="badge badge-success">Available</span>' : '<span class="badge badge-warning">No Layouts</span>'}</td></tr>
                            </table>
                        </div>
                    </div>

                    <div class="file-details-tabs">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; border-bottom: 1px solid #e9ecef;">
                            <button class="tab-button active" onclick="showFileTab('access', this)">File Access</button>
                            <button class="tab-button" onclick="showFileTab('layouts', this)">Record Layouts</button>
                            <button class="tab-button" onclick="showFileTab('fields', this)">Field Structure</button>
                        </div>

                        <div id="access-tab" class="file-tab active">
                            <h6>Programs Accessing This File</h6>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${createFileAccessTable(fileDependencies)}
                            </div>
                        </div>

                        <div id="layouts-tab" class="file-tab" style="display: none;">
                            <h6>Associated Record Layouts</h6>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${createLayoutTable(relatedLayouts)}
                            </div>
                        </div>

                        <div id="fields-tab" class="file-tab" style="display: none;">
                            <h6>Field Structure Analysis</h6>
                            <div id="fileFieldStructure">
                                ${relatedLayouts.length > 0 ? 'Loading field structure...' : 'No layout information available for field analysis.'}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="analyzeFileMapping('${fileName}')">Analyze Field Mapping</button>
                    <button class="btn btn-secondary" onclick="askAboutFile('${fileName}')">Ask AI About This</button>
                    <button class="btn btn-secondary" onclick="closeFileModal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Load field structure if layouts are available
    if (relatedLayouts.length > 0) {
        loadFileFieldStructure(fileName, relatedLayouts[0].layout_name);
    }
}

// Helper functions for file details
function getFileOperations(dependencies) {
    const operations = new Set();
    dependencies.forEach(dep => {
        if (dep.analysis_details && dep.analysis_details.operations) {
            dep.analysis_details.operations.forEach(op => operations.add(op));
        }
    });
    return Array.from(operations).join(', ') || 'READ/WRITE';
}

function getTotalFields(layouts) {
    return layouts.reduce((total, layout) => total + (layout.fields_count || 0), 0);
}

function createFileAccessTable(dependencies) {
    if (dependencies.length === 0) {
        return '<p class="text-muted">No program access information available.</p>';
    }

    let html = `<table class="data-table" style="font-size: 0.9rem;"><thead><tr><th>Program</th><th>Operation</th><th>Interface</th><th>Confidence</th></tr></thead><tbody>`;

    dependencies.forEach(dep => {
        const operations = dep.analysis_details?.operations?.join(', ') || 'Unknown';
        const confidence = Math.round((dep.confidence_score || 0) * 100);
        html += `<tr><td>${dep.source_component}</td><td>${operations}</td><td>${dep.interface_type || 'FILE'}</td><td>${confidence}%</td></tr>`;
    });

    html += '</tbody></table>';
    return html;
}

function createLayoutTable(layouts) {
    if (layouts.length === 0) {
        return '<p class="text-muted">No record layouts found for this file.</p>';
    }

    let html = `<table class="data-table" style="font-size: 0.9rem;"><thead><tr><th>Layout Name</th><th>Program</th><th>Fields</th><th>Actions</th></tr></thead><tbody>`;

    layouts.forEach(layout => {
        html += `<tr><td><strong>${layout.layout_name}</strong>${layout.friendly_name ? `<br><small class="text-muted">${layout.friendly_name}</small>` : ''}</td><td>${layout.program_name || 'Unknown'}</td><td>${layout.fields_count || 0}</td><td><button class="btn btn-secondary" onclick="viewLayoutFields('${layout.layout_name}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Fields</button></td></tr>`;
    });

    html += '</tbody></table>';
    return html;
}

// Tab switching functions
function showProgramTab(tabName, button) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    document.querySelectorAll('.program-tab').forEach(tab => tab.style.display = 'none');
    document.getElementById(tabName + '-tab').style.display = 'block';
}

function showFileTab(tabName, button) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    document.querySelectorAll('.file-tab').forEach(tab => tab.style.display = 'none');
    document.getElementById(tabName + '-tab').style.display = 'block';
}

// Modal close functions
function closeProgramModal() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (modal.style.zIndex === '10001') {
            modal.remove();
        }
    });
}

function closeFileModal() {
    closeProgramModal();
}

// Action functions
function askAboutProgram(programName) {
    closeProgramModal();
    const chatInput = document.getElementById('chatInput');
    chatInput.value = `Tell me about the ${programName} program. What does it do, what are its key functions, and how does it interact with other components?`;
    chatInput.focus();
}

function askAboutFile(fileName) {
    closeFileModal();
    const chatInput = document.getElementById('chatInput');
    chatInput.value = `Explain the ${fileName} file. What data does it contain, which programs access it, and what is its business purpose?`;
    chatInput.focus();
}

function analyzeFileMapping(fileName) {
    closeFileModal();
    showTab({target: document.querySelector('.tab-btn:nth-child(5)')}, 'fieldMapping');
    document.getElementById('targetFileInput').value = fileName;
}

function viewLayoutFields(layoutName) {
    closeFileModal();
    showTab({target: document.querySelector('.tab-btn:nth-child(4)')}, 'fieldMatrix');
    document.getElementById('recordLayoutSelect').value = layoutName;
    loadFieldMatrix();
}

// Fallback functions
function showBasicProgramDetails(programName) {
    alert(`Program Details: ${programName}\n\nDetailed information could not be loaded.\nPlease check the connection and try again.`);
}

function showBasicFileDetails(fileName) {
    alert(`File Details: ${fileName}\n\nDetailed information could not be loaded.\nPlease check the connection and try again.`);
}



        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('configModal');
            const fieldModal = document.getElementById('fieldDetailsModal');
            
            if (event.target === modal) {
                closeConfigModal();
            }
            if (event.target === fieldModal) {
                closeFieldDetailsModal();
            }
        }

  


function createFileLayerWithLayouts(title, items, className) {
            let html = `
                <div class="flow-level">
                    <div class="flow-level-title">${title}</div>
                    <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">
 `;
            
            items.forEach(item => {
                const layoutInfo = item.hasLayoutAssociation && item.associatedLayouts.length > 0 ?
                    `<div style="font-size: 0.7rem; color: #666; margin-top: 0.5rem;">
                        ðŸ“‹ Layouts: ${item.associatedLayouts.slice(0, 2).join(', ')}
                        ${item.associatedLayouts.length > 2 ? ` (+${item.associatedLayouts.length - 2} more)` : ''}
                    </div>` : '';
                    
                const interfaceIcon = item.interface === 'CICS' ? 'ðŸ¦' : 'ðŸ“';
                const statusClass = item.hasLayoutAssociation ? 'file-with-layout' : 'file-only';
                
                html += `
                    <div class="flow-component ${className} ${statusClass}" onclick="showFileDetails('${item.name}')">
                        <div class="component-name">${interfaceIcon} ${item.name}</div>
                        <div class="component-type-badge">${item.type}</div>
                        <div class="component-description">
                            Operations: ${item.operations.join(', ') || 'Unknown'}
                            <br>Interface: ${item.interface}
                            ${layoutInfo}
                        </div>
                        <div class="confidence-indicator ${getConfidenceClass(item.confidence)}">
                            ${(item.confidence * 100).toFixed(0)}%
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

        function createProgramLayerWithArrows(title, items, className) {
            let html = `
                <div class="flow-level">
                    <div class="flow-level-title">${title}</div>
                    <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">
            `;
            
            items.forEach(item => {
                const arrowIcon = getCallArrowIcon(item.callType);
                const statusClass = item.status === 'missing' ? 'missing-dependency' : 'present-program';
                
                html += `
                    <div class="program-call-container">
                        <div class="call-arrow">${arrowIcon}</div>
                        <div class="flow-component ${className} ${statusClass}" onclick="showProgramDetails('${item.name}')">
                            <div class="component-name">${item.name}</div>
                            <div class="component-type-badge">${item.type}</div>
                            <div class="component-description">
                                Call Type: ${item.callType}
                                <br>Status: ${item.status || 'Present'}
                            </div>
                            <div class="confidence-indicator ${getConfidenceClass(item.confidence)}">
                                ${(item.confidence * 100).toFixed(0)}%
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

        function getCallArrowIcon(callType) {
            const arrowMap = {
                'CALL': 'â†”ï¸',
                'XCTL': 'â†’',
                'LINK': 'â†”ï¸',
                'DYNAMIC': 'â¤´ï¸',
                'CICS_LINK': 'â†”ï¸',
                'CICS_XCTL': 'â†’'
            };
            
            return arrowMap[callType] || 'â†’';
        }

        function getConfidenceClass(confidence) {
            if (confidence > 0.8) return 'confidence-high';
            if (confidence > 0.5) return 'confidence-medium';
            return 'confidence-low';
        }

        function categorizeDependenciesWithLayouts(dependencies, focusComponent = null) {
    const categorized = {
        inputFiles: [],
        outputFiles: [],
        inputOutputFiles: [],
        db2InputTables: [],      // NEW: DB2 input tables
        db2OutputTables: [],     // NEW: DB2 output tables
        db2IOTables: [],         // NEW: DB2 input/output tables
        corePrograms: [],
        calledPrograms: [],
        missingPrograms: []
    };
    
    dependencies.forEach(dep => {
        const source = dep.source_component;
        const target = dep.target_component;
        const type = dep.relationship_type;
        const analysis = dep.analysis_details || {};
        const interfaceType = dep.interface_type;
        
        if (type === 'PROGRAM_CALL' || type === 'DYNAMIC_PROGRAM_CALL') {
            const callType = analysis.call_type || 'CALL';
            const isTarget = target === focusComponent;
            
            if (focusComponent && isTarget) {
                categorized.corePrograms.push({
                    name: source,
                    type: 'Calling Program',
                    confidence: dep.confidence_score || 0.8,
                    callDirection: 'incoming',
                    callType: callType
                });
            } else {
                categorized.calledPrograms.push({
                    name: target,
                    type: 'Called Program',
                    confidence: dep.confidence_score || 0.8,
                    callDirection: getArrowDirection(callType),
                    callType: callType,
                    status: dep.dependency_status || 'unknown'
                });
            }
        }
        // Handle DB2 table operations
        else if (interfaceType === 'DB2' || type.includes('DB2')) {
            const sqlOperation = analysis.sql_operation || 'UNKNOWN';
            const ioDirection = analysis.io_direction || 'UNKNOWN';
            
            const db2Info = {
                name: target,
                type: 'DB2 Table',
                confidence: dep.confidence_score || 0.95,
                sqlOperation: sqlOperation,
                ioDirection: ioDirection,
                interface: 'DB2',
                operations: analysis.operations || [sqlOperation],
                sourceProgram: source,
                tableType: getDB2TableType(sqlOperation)
            };
            
            // Categorize by SQL operation type
            if (type === 'DB2_INPUT_TABLE' || sqlOperation.includes('SELECT') || sqlOperation.includes('FETCH')) {
                categorized.db2InputTables.push(db2Info);
            } else if (type === 'DB2_OUTPUT_TABLE' || sqlOperation.includes('INSERT') || sqlOperation.includes('UPDATE') || sqlOperation.includes('DELETE')) {
                categorized.db2OutputTables.push(db2Info);
            } else if (ioDirection === 'INPUT_OUTPUT') {
                categorized.db2IOTables.push(db2Info);
            } else {
                // Default categorization based on SQL keywords
                if (sqlOperation.includes('SELECT')) {
                    categorized.db2InputTables.push(db2Info);
                } else if (sqlOperation.includes('INSERT') || sqlOperation.includes('UPDATE') || sqlOperation.includes('DELETE')) {
                    categorized.db2OutputTables.push(db2Info);
                } else {
                    categorized.db2IOTables.push(db2Info);
                }
            }
        }
        // Handle regular file operations
        else if (type.includes('FILE')) {
            const ioDirection = analysis.io_direction || 'UNKNOWN';
            const associatedLayouts = analysis.associated_layouts || [];
            const hasLayout = analysis.has_layout_association || false;
            
            const fileInfo = {
                name: target,
                type: getFileTypeLabel(type),
                confidence: dep.confidence_score || 0.8,
                ioDirection: ioDirection,
                associatedLayouts: associatedLayouts,
                hasLayoutAssociation: hasLayout,
                interface: dep.interface_type || 'FILE',
                operations: analysis.operations || []
            };
            
            if (ioDirection === 'INPUT') {
                categorized.inputFiles.push(fileInfo);
            } else if (ioDirection === 'OUTPUT') {
                categorized.outputFiles.push(fileInfo);
            } else if (ioDirection === 'INPUT_OUTPUT') {
                categorized.inputOutputFiles.push(fileInfo);
            }
        }
        
        if (dep.dependency_status === 'missing') {
            categorized.missingPrograms.push({
                name: target,
                type: 'Missing Program',
                confidence: dep.confidence_score || 0.3,
                reason: 'Program not uploaded',
                calledFrom: source
            });
        }
    });
    
    return categorized;
}

// Helper function to determine DB2 table type based on SQL operation
function getDB2TableType(sqlOperation) {
    if (sqlOperation.includes('SELECT') || sqlOperation.includes('FETCH')) {
        return 'Source Table';
    } else if (sqlOperation.includes('INSERT')) {
        return 'Target Table';
    } else if (sqlOperation.includes('UPDATE')) {
        return 'Update Target';
    } else if (sqlOperation.includes('DELETE')) {
        return 'Delete Target';
    }
    return 'Data Table';
}

        function getArrowDirection(callType) {
            const directionMap = {
                'CALL': 'bidirectional',
                'XCTL': 'outgoing',
                'LINK': 'bidirectional',
                'DYNAMIC': 'outgoing',
                'CICS_LINK': 'bidirectional',
                'CICS_XCTL': 'outgoing'
            };
            
            return directionMap[callType] || 'outgoing';
        }

        function getFileTypeLabel(relationshipType) {
            if (relationshipType.includes('CICS')) {
                return 'CICS File';
            } else if (relationshipType.includes('INPUT_OUTPUT')) {
                return 'I/O File';
            } else if (relationshipType.includes('INPUT')) {
                return 'Input File';
            } else if (relationshipType.includes('OUTPUT')) {
                return 'Output File';
            }
            return 'File';
        }

        // Dependencies Flow Functions
        async function loadDependencyFlow() {
            const selectedComponent = document.getElementById('dependencyComponentSelect').value;
            
            try {
                console.log('Loading dependency flow for:', selectedComponent || 'Overall System');
                
                await populateDependencyDropdown();
                
                const response = await fetch(`/api/dependencies/${currentSessionId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Dependencies response:', data);
                    
                    if (data.success && data.dependencies && data.dependencies.length > 0) {
                        displayEnhancedDependencyFlowWithLayouts(data.dependencies, selectedComponent);
                        
                        if (document.getElementById('dependencyStatusSummary')) {
                            updateDependencyStatusDisplay(data.dependencies);
                        }
                    } else {
                        displayEmptyDependencyFlow();
                    }
                } else {
                    console.error('Dependencies API response not ok:', response.status);
                    displayEmptyDependencyFlow();
                }
            } catch (error) {
                console.error('Error loading dependency flow:', error);
                displayEmptyDependencyFlow();
            }
            setTimeout(() => {
                initializeDependencyFlowInteractivity();
            }, 100);
        }

        async function displayEnhancedDependencyFlowWithLayouts(dependencies, selectedComponent) {
    console.log('Displaying enhanced flow with layout associations');
    
    const flowContainer = document.getElementById('dependencyFlowContent');
    flowContainer.innerHTML = '';
    
    let filteredDeps = dependencies;
    if (selectedComponent) {
        filteredDeps = dependencies.filter(dep => 
            dep.source_component === selectedComponent || dep.target_component === selectedComponent
        );
    }
    
    if (filteredDeps.length === 0) {
        flowContainer.innerHTML = `<p class="text-muted">No dependencies found for ${selectedComponent || 'the system'}</p>`;
        return;
    }
    
    const categorizedDeps = categorizeDependenciesWithLayouts(filteredDeps, selectedComponent);
    
    const flowHtml = await createEnhancedDependencyFlowHTML(categorizedDeps, selectedComponent);
    flowContainer.innerHTML = flowHtml;
}

async function loadFileFieldStructure(fileName, layoutName) {
    try {
        const response = await fetch(`/api/field-matrix?session_id=${currentSessionId}&record_layout=${layoutName}`);
        const data = await response.json();
        
        if (data.success && data.matrix_data) {
            const fieldStructure = document.getElementById('fileFieldStructure');
            fieldStructure.innerHTML = createFieldStructureDisplay(data.matrix_data);
        }
    } catch (error) {
        console.error('Error loading field structure:', error);
        const fieldStructure = document.getElementById('fileFieldStructure');
        if (fieldStructure) {
            fieldStructure.innerHTML = '<p class="text-muted">Error loading field structure information.</p>';
        }
    }
}

function createFieldStructureDisplay(matrixData) {
    if (!matrixData.fields && !matrixData.program_layouts) {
        return '<p class="text-muted">No field structure data available.</p>';
    }

    const fields = matrixData.fields || (matrixData.program_layouts && matrixData.program_layouts[0]?.fields) || [];
    
    if (fields.length === 0) {
        return '<p class="text-muted">No fields found in layout.</p>';
    }

    let html = `
        <table class="data-table" style="font-size: 0.8rem;">
            <thead>
                <tr>
                    <th>Field Name</th>
                    <th>Usage Type</th>
                    <th>Data Type</th>
                    <th>Purpose</th>
                </tr>
            </thead>
            <tbody>
    `;

    fields.slice(0, 10).forEach(field => { // Show first 10 fields
        html += `
            <tr>
                <td>
                    <strong>${field.field_name}</strong>
                    ${field.friendly_name ? `<br><small class="text-muted">${field.friendly_name}</small>` : ''}
                </td>
                <td><span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type || 'STATIC'}</span></td>
                <td><code>${field.data_type || field.mainframe_data_type || 'UNKNOWN'}</code></td>
                <td>${field.business_purpose || 'Field usage analysis'}</td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    
    if (fields.length > 10) {
        html += `<p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">Showing first 10 of ${fields.length} fields. <a href="#" onclick="viewAllFields('${matrixData.layout_name || 'layout'}')">View all fields</a></p>`;
    }

    return html;
}

function viewAllFields(layoutName) {
    viewLayoutFields(layoutName);
}
function viewLayoutFields(layoutName) {
    closeFileModal();
    // Switch to field matrix tab and pre-populate
    showTab({target: document.querySelector('.tab-btn:nth-child(4)')}, 'fieldMatrix');
    const recordLayoutSelect = document.getElementById('recordLayoutSelect');
    if (recordLayoutSelect) {
        recordLayoutSelect.value = layoutName;
        loadFieldMatrix();
    }
}

        function displayEmptyDependencyFlow() {
            document.getElementById('dependencyFlowContent').innerHTML = 
                '<p class="text-muted">Upload and analyze COBOL programs to see system architecture flow</p>';
        }

        function updateDependencyStatusDisplay(dependencies) {
            const statusCounts = {
                present: 0,
                missing: 0,
                file: 0,
                file_with_layout: 0,
                unknown: 0
            };
            
            dependencies.forEach(dep => {
                const status = dep.dependency_status || 'unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            document.getElementById('present-count').textContent = statusCounts.present || 0;
            document.getElementById('missing-count').textContent = statusCounts.missing || 0;
            document.getElementById('file-count').textContent = (statusCounts.file || 0) + (statusCounts.file_with_layout || 0);
            document.getElementById('unknown-count').textContent = statusCounts.unknown || 0;
            
            const fileCountElement = document.getElementById('file-count');
            if (statusCounts.file_with_layout > 0) {
                fileCountElement.title = `${statusCounts.file_with_layout} files have associated record layouts`;
                fileCountElement.style.borderLeft = '4px solid #28a745';
            }
            
            document.getElementById('dependencyStatusSummary').style.display = 'grid';
        }

        async function populateDependencyDropdown() {
            const select = document.getElementById('dependencyComponentSelect');
            if (!select) return;
            
            try {
                const response = await fetch(`/api/components/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.components) {
                        const programs = data.components.filter(c => c.component_type === 'PROGRAM');
                        
                        select.innerHTML = '<option value="">Overall System View</option>';
                        
                        programs.forEach(program => {
                            const option = document.createElement('option');
                            option.value = program.component_name;
                            option.textContent = `${program.component_name} (${program.friendly_name || program.component_name})`;
                            select.appendChild(option);
                        });
                        
                        console.log(`Populated dependency dropdown with ${programs.length} programs`);
                    }
                }
            } catch (error) {
                console.error('Error populating dependency dropdown:', error);
            }
        }

        function refreshDependencyFlow() {
            loadDependencyFlow();
        }

        function restoreNormalView() {
    // Hide enhanced view
    document.getElementById('enhancedDependenciesContainer').style.display = 'none';
    
    // Show normal view
    document.getElementById('dependenciesVisualization').style.display = 'block';
    
    // Reload normal dependency flow
    loadDependencyFlow();
    
    // Toggle buttons
    document.getElementById('enhancedViewBtn').style.display = 'inline-block';
    document.getElementById('normalViewBtn').style.display = 'none';
}
        async function loadEnhancedDependencies() {
    if (!currentSessionId) {
        showError('No active session');
        return;
    }

    try {
        showLoading('Loading enhanced dependencies...');
        
        const response = await fetch(`/api/dependencies-enhanced-with-dynamic/${currentSessionId}`);
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                displayEnhancedDependencies(data);
                showDependencyStatusSummary(data.status_counts);
                
                // Toggle buttons
                document.getElementById('enhancedViewBtn').style.display = 'none';
                document.getElementById('normalViewBtn').style.display = 'inline-block';
            } else {
                showError(data.error || 'Failed to load enhanced dependencies');
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error loading enhanced dependencies:', error);
        showError('Failed to load enhanced dependencies');
    }
    
    hideLoading();
}

        function showDependencyStatusSummary(statusCounts) {
            document.getElementById('present-count').textContent = statusCounts.present || 0;
            document.getElementById('missing-count').textContent = statusCounts.missing || 0;
            document.getElementById('file-count').textContent = statusCounts.file || 0;
            document.getElementById('unknown-count').textContent = statusCounts.unknown || 0;
            
            document.getElementById('dependencyStatusSummary').style.display = 'grid';
        }

        function displayEnhancedDependencies(data) {
            const container = document.getElementById('enhancedDependenciesContainer');
            const categorizedDeps = data.categorized_dependencies;
            const missingSummary = data.missing_summary;
            
            let html = '';
            
            if (missingSummary && missingSummary.total_missing > 0) {
                html += `
                <div class="alert alert-warning">
                    <h4>âš ï¸ Missing Dependencies (${missingSummary.total_missing})</h4>
                    <p>The following programs are called but not uploaded:</p>
                    <ul>
                        ${missingSummary.missing_programs.map(prog => 
                            `<li><strong>${prog}</strong> - Upload this program for complete analysis</li>`
                        ).join('')}
                    </ul>
                </div>`;
            }
            
            if (categorizedDeps.dynamic_calls && categorizedDeps.dynamic_calls.length > 0) {
                html += createDependencySection('ðŸ”„ Dynamic Program Calls', categorizedDeps.dynamic_calls, 'dynamic');
            }
            
            if (categorizedDeps.program_calls && categorizedDeps.program_calls.length > 0) {
                html += createDependencySection('ðŸ“ž Static Program Calls', categorizedDeps.program_calls, 'static');
            }
            
            if (categorizedDeps.cics_operations && categorizedDeps.cics_operations.length > 0) {
                html += createDependencySection('ðŸ¦ CICS File Operations', categorizedDeps.cics_operations, 'cics');
            }
            
            if (categorizedDeps.file_operations && categorizedDeps.file_operations.length > 0) {
                html += createDependencySection('ðŸ“ File Operations', categorizedDeps.file_operations, 'file');
            }

            // Add DB2 section to enhanced view
            if (categorizedDeps.db2_input_tables && categorizedDeps.db2_input_tables.length > 0) {
                html += createDependencySection('ðŸ—ƒï¸ DB2 Input Tables', categorizedDeps.db2_input_tables, 'db2_input');
            }

            if (categorizedDeps.db2_output_tables && categorizedDeps.db2_output_tables.length > 0) {
                html += createDependencySection('ðŸ—ƒï¸ DB2 Output Tables', categorizedDeps.db2_output_tables, 'db2_output');
            }
            
            container.innerHTML = html;
            container.style.display = 'block';
            
            document.getElementById('dependenciesVisualization').style.display = 'none';
        }

        function createDependencySection(title, dependencies, type) {
    let html = `
    <div class="dependency-section">
        <h3>${title}</h3>
        <div class="dependency-grid">
    `;
    
    dependencies.forEach(dep => {
        const statusIcon = getStatusIcon(dep.display_status);
        const statusClass = getStatusClass(dep.display_status);
        const confidenceClass = getConfidenceClass(dep.confidence_score);
        
        // Special handling for dynamic calls
        if (type === 'dynamic') {
            html += `
            <div class="dependency-card ${statusClass}">
                <div class="confidence-indicator ${confidenceClass}">
                    ${Math.round((dep.confidence_score || 0) * 100)}%
                </div>
                <div class="dependency-header">
                    ${statusIcon} <strong>${dep.variable_name || dep.target_component}</strong>
                </div>
                <div class="dependency-details">
                    <p><strong>Source Program:</strong> <span>${dep.source_component}</span></p>
                    <p><strong>Variable:</strong> <span>${dep.variable_name || 'Unknown'}</span></p>
                    <p><strong>Resolved Programs:</strong> <span>${dep.total_resolved_programs || 0}</span></p>
                    <p><strong>Resolution Methods:</strong> <span>${(dep.resolution_methods || []).join(', ')}</span></p>
                    ${dep.has_missing_programs ? '<p style="color: #dc3545;"><strong>Has Missing Programs</strong></p>' : ''}
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="showDynamicCallDetails('${dep.variable_name}', '${dep.source_component}')" 
                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                        View Details
                    </button>
                </div>
            </div>`;
        } else {
            // Regular dependency handling (existing code)
            html += `
            <div class="dependency-card ${statusClass}">
                <div class="confidence-indicator ${confidenceClass}">
                    ${Math.round((dep.confidence_score || 0) * 100)}%
                </div>
                <div class="dependency-header">
                    ${statusIcon} <strong>${dep.target_component}</strong>
                </div>
                <div class="dependency-details">
                    <p><strong>Called from:</strong> <span>${dep.source_component}</span></p>
                    ${type === 'cics' || type === 'file' ? 
                        `<p><strong>I/O Type:</strong> <span>${dep.analysis_details?.io_direction || 'Unknown'}</span></p>
                        <p><strong>Operations:</strong> <span>${(dep.analysis_details?.operations || []).join(', ')}</span></p>` : ''}
                    <p><strong>Type:</strong> <span>${dep.relationship_type}</span></p>
                </div>
            </div>`;
        }
    });
    
    html += '</div></div>';
    return html;
}

        function getStatusIcon(status) {
            switch (status) {
                case 'present': return 'âœ…';
                case 'missing': return 'âŒ';
                case 'file': return 'ðŸ“';
                default: return 'â“';
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'present': return 'status-present';
                case 'missing': return 'status-missing';
                case 'file': return 'status-file';
                default: return 'status-unknown';
            }
        }

        function getConfidenceClass(confidence) {
            if (confidence > 0.8) return 'confidence-high';
            if (confidence > 0.5) return 'confidence-medium';
            return 'confidence-low';
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'components') {
                loadComponentsLibrary();
            } else if (tabName === 'fieldMatrix') {
                loadFieldMatrixSelectors();
            } else if (tabName === 'dashboard') {
                loadDashboardSummaries();
            } else if (tabName === 'dependencies') {
                loadDependencyFlow();
                if (currentSessionId) {
                    setTimeout(() => {
                        const enhancedButton = document.querySelector('button[onclick="loadEnhancedDependencies()"]');
                        if (enhancedButton) {
                            enhancedButton.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                            enhancedButton.style.color = 'white';
                        }
                    }, 100);
                }
            } else if (tabName === 'fieldMapping') {
                initializeFieldMapping();
            } else if (tabName === 'program-flow') {  // ADD THIS
                initializeProgramFlow();
            }
        }

        function initializeProgramFlow() {
            // Initialize the program flow tab
            console.log('Program Flow tab initialized');
        }

        function showLoadingSpinner(message) {
            showLoading(message);
        }

        function hideLoadingSpinner() {
            hideLoading();
        }
        // Components Library Functions
        async function loadComponentsLibrary() {
            try {
                const response = await fetch(`/api/components-with-derived/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayComponentsLibrary(data.components);
                    }
                }
            } catch (error) {
                console.error('Error loading components library:', error);
            }
        }

        function displayComponentsLibrary(components) {
            const container = document.getElementById('mainComponentsView');
            container.innerHTML = '';

            const programs = components.filter(c => c.component_type === 'PROGRAM');
            
            if (programs.length === 0) {
                container.innerHTML = '<p class="text-muted">No programs uploaded yet</p>';
                return;
            }

            programs.forEach(program => {
                const card = document.createElement('div');
                card.className = 'component-summary-card';
                
                let businessPurpose = (program.llm_summary && program.llm_summary.business_purpose) || program.business_purpose || 'Analysis pending';
                let derivedCount = program.derived_count || 0;
                
                card.innerHTML = `
                    <div class="component-header">
                        <div>
                            <div class="component-title">${program.component_name}</div>
                            <div class="text-muted" style="font-size: 0.8rem;">${program.friendly_name || ''}</div>
                        </div>
                        <span class="component-type badge badge-primary">COBOL Program</span>
                    </div>
                    
                    <div class="business-purpose">${businessPurpose}</div>
                    
                    <div class="component-metrics">
                        <div class="metric">
                            <span class="metric-value">${program.total_lines || 0}</span>
                            <span class="metric-label">Lines of Code</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${derivedCount}</span>
                            <span class="metric-label">Analyzed Components</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${program.total_fields || 0}</span>
                            <span class="metric-label">Total Fields</span>
                        </div>
                    </div>
                    
                    <div class="derived-components">
                        <button class="derived-toggle" onclick="toggleDerivedComponents('${program.component_name}', this)">
                            View ${derivedCount} Analyzed Components
                        </button>
                        <div class="derived-list" id="derived-${program.component_name}">
                            <!-- Will be populated when expanded -->
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="reAnalyzeComponent('${program.component_name}')">Re-analyze Component</button>
                        <button class="btn btn-secondary" onclick="askAboutThis('${program.component_name}')">Ask AI About This</button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        async function toggleDerivedComponents(programName, button) {
            const derivedList = document.getElementById(`derived-${programName}`);
            
            if (derivedList.classList.contains('show')) {
                derivedList.classList.remove('show');
                button.textContent = button.textContent.replace('Hide', 'View');
            } else {
                if (derivedList.children.length === 0) {
                    try {
                        const response = await fetch(`/api/derived-components/${currentSessionId}?parent_component=${programName}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                displayDerivedComponentsList(derivedList, data.derived_components);
                            }
                        }
                    } catch (error) {
                        console.error('Error loading derived components:', error);
                        derivedList.innerHTML = '<p class="text-muted">Error loading components</p>';
                    }
                }
                
                derivedList.classList.add('show');
                button.textContent = button.textContent.replace('View', 'Hide');
            }
        }

        function displayDerivedComponentsList(container, derivedComponents) {
            container.innerHTML = '';
            
            derivedComponents.forEach(component => {
                const item = document.createElement('div');
                item.className = 'derived-item';
                
                item.innerHTML = `
                    <div>
                        <div class="derived-item-name">${component.component_name}</div>
                        <div class="text-muted" style="font-size: 0.8rem;">${component.friendly_name || ''}</div>
                    </div>
                    <div class="derived-item-type">${component.component_type}</div>
                `;
                
                container.appendChild(item);
            });
        }

        // Field Matrix Functions
        async function loadFieldMatrixSelectors() {
            try {
                const [componentsResponse, layoutsResponse] = await Promise.all([
                    fetch(`/api/components/${currentSessionId}`),
                    fetch(`/api/record-layouts/${currentSessionId}`)
                ]);
                
                if (componentsResponse.ok) {
                    const componentsData = await componentsResponse.json();
                    if (componentsData.success) {
                        populateProgramSelectors(componentsData.components);
                    }
                }
                
                if (layoutsResponse.ok) {
                    const layoutsData = await layoutsResponse.json();
                    if (layoutsData.success) {
                        populateLayoutSelectors(layoutsData.layouts);
                    }
                }
            } catch (error) {
                console.error('Error loading selectors:', error);
            }
        }

        function populateProgramSelectors(components) {
            const programSelect = document.getElementById('programSelect');
            programSelect.innerHTML = '<option value="">Select Program</option>';

            const programs = components.filter(c => c.component_type === 'PROGRAM');
            
            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.component_name;
                option.textContent = `${program.component_name} (${program.total_lines || 0} lines)`;
                programSelect.appendChild(option);
            });
        }

        function populateLayoutSelectors(layouts) {
            const recordLayoutSelect = document.getElementById('recordLayoutSelect');
            recordLayoutSelect.innerHTML = '<option value="">Select Record Layout</option>';

            layouts.forEach(layout => {
                const option = document.createElement('option');
                option.value = layout.layout_name;
                option.textContent = `${layout.layout_name} (${layout.fields_count || 0} fields) - ${layout.program_name}`;
                recordLayoutSelect.appendChild(option);
            });
        }

        async function loadFieldMatrix() {
            const recordLayout = document.getElementById('recordLayoutSelect').value;
            const program = document.getElementById('programSelect').value;

            if (!recordLayout && !program) {
                return;
            }

            showLoading('Loading field matrix...');

            try {
                const params = new URLSearchParams({
                    session_id: currentSessionId
                });
                
                if (recordLayout) params.append('record_layout', recordLayout);
                if (program) params.append('program_name', program);

                const response = await fetch(`/api/field-matrix?${params}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayFieldMatrix(data.matrix_data);
                    } else {
                        showError(data.error || 'Failed to load field matrix');
                    }
                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error loading field matrix:', error);
                showError('Failed to load field matrix');
            }

            hideLoading();
        }

        // Add to your main UI
function createProgramFlowView(sessionId) {
    return `
        <div class="program-flow-container">
            <div class="flow-controls">
                <input type="text" id="startingProgram" placeholder="Enter program name (e.g., TMSTM6)">
                <button onclick="analyzeEnhancedFlow('${sessionId}')">Analyze Program Flow</button>
            </div>
            
            <div id="flowVisualization" class="flow-visualization">
                <!-- Flow diagram will be rendered here -->
            </div>
            
            <div id="flowDetails" class="flow-details">
                <div class="flow-summary"></div>
                <div class="missing-programs"></div>
                <div class="field-flows"></div>
                <div class="file-operations"></div>
            </div>
        </div>
    `;
}

        // Update the analyzeFlow function to use the correct session parameter
        async function analyzeFlow() {
            const programName = document.getElementById('startingProgram').value;
            if (!programName) {
                alert('Please enter a program name');
                return;
            }
            
            showLoadingSpinner('Analyzing program flow...');
            
            try {
                // Use currentSessionId from global scope
                const flowResponse = await fetch(`/api/program-flow/${currentSessionId}/${programName}`);
                const flowData = await flowResponse.json();
                
                if (!flowData.success) {
                    showError(flowData.error);
                    return;
                }
                
                // Get visualization data
                const vizResponse = await fetch(`/api/program-flow-visualization/${currentSessionId}/${programName}`);
                const vizData = await vizResponse.json();
                
                if (vizData.success) {
                    renderFlowVisualization(vizData.visualization_data);
                    renderFlowDetails(flowData.flow_analysis, vizData);
                }
                
            } catch (error) {
                showError(`Error analyzing flow: ${error.message}`);
            } finally {
                hideLoadingSpinner();
            }
        }


        function analyzeVariableUsage(variableName) {
            closeDynamicCallModal();
            const chatInput = document.getElementById('chatInput');
            chatInput.value = `Analyze the usage of variable ${variableName}. How is it populated and what programs can it call?`;
            chatInput.focus();
        }

        function askAboutDynamicCall(variableName) {
            closeDynamicCallModal();
            const chatInput = document.getElementById('chatInput');
            chatInput.value = `Tell me about the dynamic call using variable ${variableName}. What business logic determines which program gets called?`;
            chatInput.focus();
        }
        function renderFlowVisualization(vizData) {
    const container = document.getElementById('flowVisualization');
    container.innerHTML = '';
    
    // Create larger SVG dimensions to accommodate separated files
    const svgWidth = 1400;
    const svgHeight = 1400;  // Increased height for top/bottom files
    
    const svg = d3.select(container)
        .append('svg')
        .attr('width', '100%')
        .attr('height', '100%')
        .attr('viewBox', `0 0 ${svgWidth} ${svgHeight}`)
        .style('border', '1px solid #ddd')
        .style('background', '#fafafa');

    // Create zoom container with proper bounds
    const zoomContainer = svg.append('g').attr('class', 'zoom-container');
    
    // Create legend
    const legend = d3.select(container)
        .append('div')
        .attr('class', 'flow-legend');
    
    // Create hierarchical layout
    let layoutNodes, layoutEdges;
    try {
        const layoutResult = createHierarchicalLayout(vizData);
        layoutNodes = layoutResult.layoutNodes;
        layoutEdges = layoutResult.layoutEdges;
    } catch (error) {
        console.error('Error creating layout:', error);
        container.innerHTML = '<p style="color: red;">Error creating program flow layout. Please check the data.</p>';
        return;
    }
    
    console.log(`Rendering VERTICAL TREE: ${layoutNodes.length} nodes, ${layoutEdges.length} edges`);
    
    // Store edges globally for interaction
    window.currentFlowEdges = layoutEdges;
    
    // Add zoom functionality
    addZoomAndPan(svg);
    
    // Verify SVG was created
    if (svg.empty()) {
        console.error('Failed to create SVG element');
        container.innerHTML = '<p style="color: red;">Failed to create SVG visualization.</p>';
        return;
    }
    
    // Add arrow markers
    const defs = zoomContainer.append('defs');
    createArrowMarkers(defs);
    
    // Draw edges first
    const edges = zoomContainer.selectAll('.flow-edge')
        .data(layoutEdges)
        .enter()
        .append('g')
        .attr('class', 'flow-edge');
    
    edges.each(function(d, i) {
        try {
            drawEnhancedEdge(d3.select(this), d);
        } catch (error) {
            console.error(`Error drawing edge ${i}:`, error, d);
        }
    });
    
    // Draw nodes
    const nodes = zoomContainer.selectAll('.flow-node')
        .data(layoutNodes)
        .enter()
        .append('g')
        .attr('class', 'flow-node')
        .attr('transform', d => `translate(${d.x},${d.y})`);
    
    // Draw shapes for each node type
    nodes.each(function(d, i) {
        try {
            drawCustomShape(d3.select(this), d);
        } catch (error) {
            console.error(`Error drawing node ${i}:`, error, d);
        }
    });
    
    // Add interactivity
    addEnhancedInteractivity(nodes, layoutEdges);
    
    // Create legend
    createEnhancedVisualizationLegend(legend);
}    
    
function renderModalFlowDetails(vizData, containerId, programName) {
    const container = document.getElementById(containerId);
    
    if (!container) {
        console.error('Modal details container not found');
        return;
    }
    
    // Extract data from visualization
    const nodes = vizData.nodes || [];
    const edges = vizData.edges || [];
    const statistics = vizData.statistics || {};
    
    const programNodes = nodes.filter(n => n.type === 'program');
    const fileNodes = nodes.filter(n => n.type === 'file');
    const db2Nodes = nodes.filter(n => n.type === 'db2_table');
    const missingPrograms = programNodes.filter(p => p.status === 'missing');
    
    let html = `
        <div class="modal-flow-details">
            <div class="flow-summary-header">
                <h3>Program Flow Analysis: ${programName}</h3>
                <div class="flow-overview-stats">
                    <div class="overview-stat">
                        <span class="stat-value">${programNodes.length}</span>
                        <span class="stat-label">Programs</span>
                    </div>
                    <div class="overview-stat">
                        <span class="stat-value">${fileNodes.length}</span>
                        <span class="stat-label">Files</span>
                    </div>
                    <div class="overview-stat">
                        <span class="stat-value">${db2Nodes.length}</span>
                        <span class="stat-label">DB2 Tables</span>
                    </div>
                    <div class="overview-stat">
                        <span class="stat-value">${missingPrograms.length}</span>
                        <span class="stat-label">Missing</span>
                    </div>
                </div>
            </div>
    `;
    
    // Program Call Chain Section
    const programCallEdges = edges.filter(e => e.type === 'program_call');
    if (programCallEdges.length > 0) {
        html += `
            <div class="modal-section">
                <h4>Program Call Chain (${programCallEdges.length})</h4>
                <div class="call-chain-list">
        `;
        
        programCallEdges.forEach((edge, index) => {
            const sourceNode = nodes.find(n => n.id === edge.from);
            const targetNode = nodes.find(n => n.id === edge.to);
            const isTargetMissing = !targetNode || targetNode.status === 'missing';
            
            html += `
                <div class="call-chain-item ${isTargetMissing ? 'missing-call' : 'available-call'}">
                    <div class="chain-step">${index + 1}</div>
                    <div class="call-details">
                        <div class="call-flow">
                            <span class="caller">${edge.from}</span>
                            <span class="call-arrow">${getCallTypeIcon(edge.call_type || 'CALL')} ${edge.call_type || 'CALL'}</span>
                            <span class="target ${isTargetMissing ? 'missing' : 'available'}">${edge.to}</span>
                        </div>
                        ${edge.variable_name ? `
                            <div class="dynamic-info">Dynamic via: <code>${edge.variable_name}</code></div>
                        ` : ''}
                        ${isTargetMissing ? `
                            <div class="missing-warning">Program not uploaded - analysis incomplete</div>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // File Operations Section
    if (fileNodes.length > 0) {
        html += `
            <div class="modal-section">
                <h4>File Operations (${fileNodes.length})</h4>
                <div class="file-operations-list">
        `;
        
        fileNodes.forEach(file => {
            const fileEdges = edges.filter(e => e.to === file.id && e.type === 'file_operation');
            const connectedPrograms = fileEdges.map(e => e.from);
            
            html += `
                <div class="file-operation-item">
                    <div class="file-header">
                        <span class="file-icon">${file.interface === 'CICS' ? 'ðŸ¦' : 'ðŸ“'}</span>
                        <span class="file-name">${file.label}</span>
                        <span class="interface-badge">${file.interface || 'FILE'}</span>
                    </div>
                    <div class="file-details">
                        <div class="connected-programs">
                            <strong>Used by:</strong> ${connectedPrograms.join(', ')}
                        </div>
                        <div class="operations">
                            <strong>Operations:</strong> ${file.operations ? file.operations.join(', ') : 'READ/WRITE'}
                        </div>
                        ${file.io_direction ? `
                            <div class="io-direction">
                                <strong>Direction:</strong> ${file.io_direction}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // DB2 Operations Section
    if (db2Nodes.length > 0) {
        html += `
            <div class="modal-section">
                <h4>DB2 Operations (${db2Nodes.length})</h4>
                <div class="db2-operations-list">
        `;
        
        db2Nodes.forEach(db2 => {
            const db2Edges = edges.filter(e => e.to === db2.id && e.type === 'db2_operation');
            const connectedPrograms = db2Edges.map(e => e.from);
            
            html += `
                <div class="db2-operation-item">
                    <div class="db2-header">
                        <span class="db2-icon">ðŸ—ƒï¸</span>
                        <span class="table-name">${db2.label}</span>
                        <span class="sql-badge">${db2.sql_operation || 'SQL'}</span>
                    </div>
                    <div class="db2-details">
                        <div class="connected-programs">
                            <strong>Accessed by:</strong> ${connectedPrograms.join(', ')}
                        </div>
                        <div class="sql-operations">
                            <strong>SQL Type:</strong> ${db2.sql_operation || 'Database Operations'}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // Missing Programs Section
    if (missingPrograms.length > 0) {
        html += `
            <div class="modal-section missing-section">
                <h4>Missing Programs (${missingPrograms.length})</h4>
                <div class="alert alert-warning">
                    <strong>Analysis Incomplete:</strong> These programs are called but not uploaded.
                </div>
                <div class="missing-programs-list">
        `;
        
        missingPrograms.forEach(program => {
            const callingEdges = edges.filter(e => e.to === program.id && e.type === 'program_call');
            const callers = callingEdges.map(e => e.from);
            
            html += `
                <div class="missing-program-item">
                    <div class="missing-header">
                        <span class="missing-icon">âŒ</span>
                        <span class="program-name">${program.label}</span>
                    </div>
                    <div class="missing-details">
                        <div class="called-by">Called by: ${callers.join(', ')}</div>
                        <div class="impact">Upload this program to complete the flow analysis</div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
                <div class="recommendations">
                    <h5>Recommendations:</h5>
                    <ul>
                        <li>Upload missing programs to see complete call chains</li>
                        <li>Missing programs may contain additional file and DB2 operations</li>
                        <li>Complete program set provides better architecture understanding</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    // Flow Actions
    html += `
        <div class="modal-section">
            <h4>Analysis Actions</h4>
            <div class="flow-actions">
                <button class="action-btn" onclick="askAboutFlow('${programName}')">
                    Ask AI About This Flow
                </button>
                <button class="action-btn" onclick="exportFlowData('${programName}')">
                    Export Flow Data
                </button>
                <button class="action-btn" onclick="refreshFlowAnalysis('${programName}')">
                    Refresh Analysis
                </button>
            </div>
        </div>
    `;
    
    html += `</div>`; // Close modal-flow-details
    
    container.innerHTML = html;
}

// Helper functions for the modal details
function getCallTypeIcon(callType) {
    const icons = {
        'CALL': 'ðŸ“ž',
        'XCTL': 'ðŸ”„',
        'LINK': 'ðŸ”—',
        'DYNAMIC': 'âš¡'
    };
    return icons[callType] || 'ðŸ“ž';
}

function askAboutFlow(programName) {
    closeFlowModal();
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.value = `Explain the program flow starting from ${programName}. What business processes does this flow support?`;
        chatInput.focus();
    }
}

function exportFlowData(programName) {
    // Create export data
    const flowData = {
        program: programName,
        timestamp: new Date().toISOString(),
        visualization: window.currentFlowData
    };
    
    const dataStr = JSON.stringify(flowData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `${programName}_flow_analysis.json`;
    link.click();
}

function refreshFlowAnalysis(programName) {
    closeFlowModal();
    document.getElementById('startingProgram').value = programName;
    analyzeEnhancedFlow();
}
        function addZoomAndPan(svg) {
    const zoom = d3.zoom()
        .scaleExtent([0.2, 3])
        .on('zoom', function(event) {
            const { transform } = event;
            svg.select('g.zoom-container').attr('transform', transform);
        });
    
    svg.call(zoom);
    
    const controls = d3.select(svg.node().parentNode)
        .append('div')
        .attr('class', 'zoom-controls')
        .style('position', 'absolute')
        .style('top', '10px')
        .style('left', '10px')
        .style('z-index', '100');
    
    const buttonStyle = 'margin: 2px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;';
    
    controls.append('button')
        .attr('style', buttonStyle)
        .text('Zoom In')
        .on('click', function() {
            svg.transition().call(zoom.scaleBy, 1.2);
        });
    
    controls.append('button')
        .attr('style', buttonStyle)
        .text('Zoom Out')
        .on('click', function() {
            svg.transition().call(zoom.scaleBy, 0.8);
        });
    
    controls.append('button')
        .attr('style', buttonStyle)
        .text('Fit All')
        .on('click', function() {
            const bounds = svg.select('.zoom-container').node().getBBox();
            const parent = svg.node().parentNode;
            const fullWidth = parent.clientWidth;
            const fullHeight = parent.clientHeight;
            const width = bounds.width;
            const height = bounds.height;
            const midX = bounds.x + width / 2;
            const midY = bounds.y + height / 2;
            const scale = Math.min(fullWidth / width, fullHeight / height) * 0.8;
            const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];
            
            svg.transition().duration(750).call(zoom.transform, 
                d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        });
    
    controls.append('button')
        .attr('style', buttonStyle)
        .text('Reset')
        .on('click', function() {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        });
}
    




function calculateEnhancedEdgePath(sourceNode, targetNode, edge) {
            // Simple straight line for now - can be enhanced with curves
            return `M${sourceNode.x},${sourceNode.y} L${targetNode.x},${targetNode.y}`;
        }


function getPathType(edge, sourceNode, targetNode) {
    // Determine path type based on edge type and node layout
    const edgeType = edge.type;
    const levelDiff = Math.abs((sourceNode.level || 0) - (targetNode.level || 0));
    const distance = Math.abs(targetNode.x - sourceNode.x) + Math.abs(targetNode.y - sourceNode.y);
    
    if (edgeType === 'file_operation' || edgeType === 'db2_operation') {
        return 'curved';
    } else if (edgeType === 'dynamic_call') {
        return 'arc';
    } else if (levelDiff <= 1 && distance < 200) {
        return 'straight';
    } else {
        return 'stepped';
    }
}

function createStraightPath(source, target) {
    return `M${source.x},${source.y} L${target.x},${target.y}`;
}

function createCurvedPath(source, target, edge) {
    const dx = target.x - source.x;
    const dy = target.y - source.y;
    
    // Create a smooth curve with control points
    const controlX1 = source.x + dx * 0.3;
    const controlY1 = source.y;
    const controlX2 = target.x - dx * 0.3;
    const controlY2 = target.y;
    
    return `M${source.x},${source.y} C${controlX1},${controlY1} ${controlX2},${controlY2} ${target.x},${target.y}`;
}

function createSteppedPath(source, target, edge) {
    const dx = target.x - source.x;
    const dy = target.y - source.y;
    
    // Create a stepped path (L-shaped)
    if (Math.abs(dx) > Math.abs(dy)) {
        // Horizontal first, then vertical
        const midX = source.x + dx * 0.7;
        return `M${source.x},${source.y} L${midX},${source.y} L${midX},${target.y} L${target.x},${target.y}`;
    } else {
        // Vertical first, then horizontal
        const midY = source.y + dy * 0.7;
        return `M${source.x},${source.y} L${source.x},${midY} L${target.x},${midY} L${target.x},${target.y}`;
    }
}

function createArcPath(source, target, edge) {
    const dx = target.x - source.x;
    const dy = target.y - source.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    // Create an arc path for dynamic calls to show uncertainty
    const midX = source.x + dx * 0.5;
    const midY = source.y + dy * 0.5;
    
    // Add some curvature perpendicular to the direct line
    const perpX = -dy / distance * 30; // 30 pixels of curvature
    const perpY = dx / distance * 30;
    
    const controlX = midX + perpX;
    const controlY = midY + perpY;
    
    return `M${source.x},${source.y} Q${controlX},${controlY} ${target.x},${target.y}`;
}
function calculateProgramHierarchy(programNodes, edges) {
    const hierarchy = {};
    const visited = new Set();
    
    // Find starting program
    const startNode = programNodes.find(n => n.is_starting_program) || programNodes[0];
    if (!startNode) return { 0: programNodes };
    
    console.log('Starting node:', startNode.id);
    
    // Level 0 = top level (starting program)
    hierarchy[0] = [startNode];
    visited.add(startNode.id);
    
    const queue = [{ node: startNode, level: 0 }];
    
    while (queue.length > 0) {
        const { node: currentNode, level } = queue.shift();
        console.log(`Processing ${currentNode.id} at level ${level}`);
        
        // Find ALL outgoing program calls from this node
        const outgoingEdges = edges.filter(e => 
            e.from === currentNode.id && 
            (e.type === 'program_call' || e.call_type === 'CALL' || e.call_type === 'XCTL')
        );
        
        console.log(`Found ${outgoingEdges.length} outgoing calls from ${currentNode.id}`);
        
        outgoingEdges.forEach(edge => {
            const targetNode = programNodes.find(n => n.id === edge.to);
            if (targetNode && !visited.has(targetNode.id)) {
                const nextLevel = level + 1;
                console.log(`Adding ${targetNode.id} to level ${nextLevel}`);
                
                if (!hierarchy[nextLevel]) {
                    hierarchy[nextLevel] = [];
                }
                
                hierarchy[nextLevel].push(targetNode);
                visited.add(targetNode.id);
                queue.push({ node: targetNode, level: nextLevel });
            }
        });
    }
    
    // Add orphaned programs to last level
    programNodes.forEach(node => {
        if (!visited.has(node.id)) {
            const lastLevel = Math.max(...Object.keys(hierarchy).map(Number)) + 1;
            if (!hierarchy[lastLevel]) hierarchy[lastLevel] = [];
            hierarchy[lastLevel].push(node);
        }
    });
    
    console.log('Hierarchy created:', hierarchy);
    return hierarchy;
}

function drawEnhancedEdgeWithConnection(selection, edge) {
    const source = edge.source;
    const target = edge.target;
    
    // FIXED: Calculate proper connection points
    const sourcePoint = getEnhancedConnectionPoint(source, target, 'source');
    const targetPoint = getEnhancedConnectionPoint(target, source, 'target');
    
    // Determine edge style and color
    const edgeClass = getEdgeClass(edge);
    const markerEnd = getMarkerEnd(edge);
    const strokeColor = getEdgeColor(edge);
    
    // FIXED: Draw enhanced path with proper curves
    const path = selection.append('path')
        .attr('class', `flow-edge ${edgeClass}`)
        .attr('d', createEnhancedPath(sourcePoint, targetPoint, edge))
        .attr('fill', 'none')
        .attr('stroke', strokeColor)
        .attr('stroke-width', getStrokeWidth(edge))
        .attr('marker-end', `url(#${markerEnd})`);
    
    // Add stroke-dasharray for dynamic calls
    if (edge.type === 'dynamic_call' || edge.is_dynamic) {
        path.attr('stroke-dasharray', '8,4');
    }
    
    // FIXED: Add proper edge labels
    if (edge.label || edge.variable_name) {
        const midPoint = getMidPoint(sourcePoint, targetPoint);
        
        // Label background
        selection.append('rect')
            .attr('x', midPoint.x - 30)
            .attr('y', midPoint.y - 8)
            .attr('width', 60)
            .attr('height', 16)
            .attr('fill', 'white')
            .attr('stroke', strokeColor)
            .attr('stroke-width', 1)
            .attr('rx', 3);
        
        // Label text
        selection.append('text')
            .attr('x', midPoint.x)
            .attr('y', midPoint.y)
            .attr('text-anchor', 'middle')
            .attr('dy', '0.35em')
            .attr('font-size', '10px')
            .attr('font-weight', 'bold')
            .attr('fill', strokeColor)
            .text(edge.label || edge.variable_name || '');
    }
}

function getEnhancedConnectionPoint(node, otherNode, role) {
    const x = node.x || 0;
    const y = node.y || 0;
    const width = node.width || 100;
    const height = node.height || 50;
    
    // Calculate direction to other node
    const dx = (otherNode.x || 0) - x;
    const dy = (otherNode.y || 0) - y;
    
    // FIXED: Better connection point calculation
    if (Math.abs(dx) > Math.abs(dy)) {
        // Connect horizontally
        return {
            x: x + (dx > 0 ? width/2 : -width/2),
            y: y
        };
    } else {
        // Connect vertically
        return {
            x: x,
            y: y + (dy > 0 ? height/2 : -height/2)
        };
    }
}

function createEnhancedPath(source, target, edge) {
    const dx = target.x - source.x;
    const dy = target.y - source.y;
    
    // FIXED: Create smooth curves based on connection type
    if (edge.type === 'file_operation' || edge.type === 'db2_operation') {
        // Curved path for data connections
        const midY = source.y + dy * 0.6;
        return `M${source.x},${source.y} Q${source.x + dx * 0.3},${midY} ${target.x},${target.y}`;
    } else if (Math.abs(dy) < 30) {
        // Horizontal line for same-level connections
        return `M${source.x},${source.y} L${target.x},${target.y}`;
    } else {
        // Stepped path for program calls
        const midX = source.x + dx * 0.5;
        return `M${source.x},${source.y} L${midX},${source.y} L${midX},${target.y} L${target.x},${target.y}`;
    }
}

function getEdgeColor(edge) {
            const colorMap = {
                'program_call': '#2196f3',
                'file_operation': '#4caf50',
                'db2_operation': '#ff9800'
            };
            
            if (edge.call_type === 'XCTL') return '#ff5722';
            return colorMap[edge.type] || '#666';
        }


function drawEnhancedCustomShape(selection, node) {
    const g = selection;
    
    // Add enhanced drop shadow
    g.style('filter', 'drop-shadow(3px 3px 6px rgba(0,0,0,0.3))');
    
    // FIXED: Draw shapes based on node type with better styling
    switch (node.type) {
        case 'program':
            drawEnhancedProgramShape(g, node);
            break;
        case 'file':
            drawEnhancedFileShape(g, node);
            break;
        case 'db2_table':
            drawEnhancedDB2Shape(g, node);
            break;
        default:
            drawEnhancedDefaultShape(g, node);
    }
    
    // FIXED: Enhanced node labels with better formatting
    const labelText = node.label || node.id || 'Unknown';
    const maxLabelLength = 12;
    const displayText = labelText.length > maxLabelLength ? 
                       labelText.substring(0, maxLabelLength) + '...' : labelText;
    
    g.append('text')
        .attr('class', 'node-label')
        .attr('text-anchor', 'middle')
        .attr('dy', '0.35em')
        .style('font-size', '11px')
        .style('font-weight', 'bold')
        .style('fill', node.status === 'missing' ? '#d32f2f' : 'white')
        .style('pointer-events', 'none')
        .text(displayText)
        .append('title')
        .text(labelText); // Full text on hover
}

function drawEnhancedProgramShape(g, node) {
    const width = node.width || 120;
    const height = node.height || 60;
    
    let fillColor = '#4a90e2';
    let strokeColor = '#2c5aa0';
    
    if (node.is_starting_program) {
        fillColor = '#1a73e8';
        strokeColor = '#0d47a1';
    } else if (node.status === 'missing') {
        fillColor = '#ffcdd2';
        strokeColor = '#d32f2f';
    }
    
    if (node.status === 'missing') {
        // Diamond shape for missing programs
        g.append('polygon')
            .attr('points', `0,${-height/2} ${width/2},0 0,${height/2} ${-width/2},0`)
            .attr('fill', fillColor)
            .attr('stroke', strokeColor)
            .attr('stroke-width', 2)
            .attr('stroke-dasharray', '5,5');
    } else {
        // Enhanced rounded rectangle
        g.append('rect')
            .attr('x', -width/2)
            .attr('y', -height/2)
            .attr('width', width)
            .attr('height', height)
            .attr('rx', 10)
            .attr('ry', 10)
            .attr('fill', fillColor)
            .attr('stroke', strokeColor)
            .attr('stroke-width', 2);
        
        // Add gradient effect
        g.append('rect')
            .attr('x', -width/2)
            .attr('y', -height/2)
            .attr('width', width)
            .attr('height', height/3)
            .attr('rx', 10)
            .attr('ry', 10)
            .attr('fill', 'rgba(255,255,255,0.3)');
    }
    
    // Program type indicator
    if (node.is_starting_program) {
        g.append('circle')
            .attr('cx', width/2 - 10)
            .attr('cy', -height/2 + 10)
            .attr('r', 5)
            .attr('fill', '#fff')
            .attr('stroke', strokeColor)
            .attr('stroke-width', 2);
    }
}

function drawEnhancedFileShape(g, node) {
    const width = node.width || 100;
    const height = node.height || 50;
    
    // Enhanced cylinder shape
    const ellipseHeight = height * 0.25;
    const fillColor = '#4caf50';
    const strokeColor = '#2e7d32';
    
    // Cylinder body with gradient
    g.append('rect')
        .attr('x', -width/2)
        .attr('y', -height/2 + ellipseHeight/2)
        .attr('width', width)
        .attr('height', height - ellipseHeight)
        .attr('fill', fillColor)
        .attr('stroke', strokeColor)
        .attr('stroke-width', 2);
    
    // Top and bottom ellipses
    ['top', 'bottom'].forEach((pos, i) => {
        g.append('ellipse')
            .attr('cx', 0)
            .attr('cy', pos === 'top' ? -height/2 + ellipseHeight/2 : height/2 - ellipseHeight/2)
            .attr('rx', width/2)
            .attr('ry', ellipseHeight/2)
            .attr('fill', i === 0 ? fillColor : '#66bb6a')
            .attr('stroke', strokeColor)
            .attr('stroke-width', 2);
    });
    
    // Interface type indicator
    if (node.interface === 'CICS') {
        g.append('rect')
            .attr('x', -width/2 + 3)
            .attr('y', -height/2 + 3)
            .attr('width', 25)
            .attr('height', 12)
            .attr('fill', '#9c27b0')
            .attr('rx', 2);
        
        g.append('text')
            .attr('x', -width/2 + 15)
            .attr('y', -height/2 + 9)
            .attr('text-anchor', 'middle')
            .attr('font-size', '7px')
            .attr('fill', 'white')
            .text('CICS');
    }
}

function drawEnhancedDB2Shape(g, node) {
    const width = node.width || 110;
    const height = node.height || 50;
    
    // Database table with enhanced styling
    g.append('rect')
        .attr('x', -width/2)
        .attr('y', -height/2)
        .attr('width', width)
        .attr('height', height)
        .attr('rx', 5)
        .attr('ry', 5)
        .attr('fill', '#ff9800')
        .attr('stroke', '#f57c00')
        .attr('stroke-width', 2);
    
    // Table row indicators
    for (let i = 1; i <= 3; i++) {
        g.append('line')
            .attr('x1', -width/2 + 8)
            .attr('y1', -height/2 + (i * height/4))
            .attr('x2', width/2 - 8)
            .attr('y2', -height/2 + (i * height/4))
            .attr('stroke', '#f57c00')
            .attr('stroke-width', 1)
            .attr('opacity', 0.7);
    }
    
    // DB2 indicator
    g.append('text')
        .attr('x', width/2 - 8)
        .attr('y', -height/2 + 8)
        .attr('text-anchor', 'middle')
        .attr('font-size', '8px')
        .attr('font-weight', 'bold')
        .attr('fill', '#fff')
        .text('DB2');
}

function addEnhancedInteractivity(nodes, edges) {
    // Enhanced click handlers
    nodes.on('click', function(event, d) {
        showEnhancedNodeDetails(d);
    });
    
    nodes.on('mouseover', function(event, d) {
        // Use CSS transform instead of D3 style transform to avoid positioning issues
        d3.select(this)
            .transition()
            .duration(200)
            .attr('transform', function() {
                const currentTransform = d3.select(this).attr('transform');
                // Extract current translate values
                const translateMatch = currentTransform.match(/translate\(([^,]+),([^)]+)\)/);
                if (translateMatch) {
                    const x = parseFloat(translateMatch[1]);
                    const y = parseFloat(translateMatch[2]);
                    return `translate(${x},${y}) scale(1.05)`;
                }
                return currentTransform + ' scale(1.05)';
            })
            .style('cursor', 'pointer');
        
        highlightConnectedPaths(d, edges);
    });
    
    nodes.on('mouseout', function(event, d) {
        // Reset to original transform
        d3.select(this)
            .transition()
            .duration(200)
            .attr('transform', function() {
                const currentTransform = d3.select(this).attr('transform');
                // Remove scale transformation, keep translate
                const translateMatch = currentTransform.match(/translate\(([^,]+),([^)]+)\)/);
                if (translateMatch) {
                    const x = parseFloat(translateMatch[1]);
                    const y = parseFloat(translateMatch[2]);
                    return `translate(${x},${y})`;
                }
                return currentTransform.replace(/ scale\([^)]+\)/, '');
            });
        
        resetPathHighlights();
    });
}


function highlightConnectedPaths(node, edges) {
    // Dim all edges first
    d3.selectAll('.flow-edge path').style('opacity', 0.3);
    
    // Highlight connected edges
    edges.forEach((edge, index) => {
        if (edge.source && edge.target && 
            (edge.source.id === node.id || edge.target.id === node.id)) {
            
            d3.selectAll('.flow-edge path').filter(function(d, i) {
                return i === index;
            })
            .style('opacity', 1)
            .style('stroke-width', function() {
                const currentWidth = parseInt(d3.select(this).style('stroke-width')) || 2;
                return currentWidth + 1;
            });
        }
    });
}

function resetPathHighlights() {
    d3.selectAll('.flow-edge path')
        .style('opacity', 1)
        .style('stroke-width', function(d) {
            return getStrokeWidth(d) || 2;
        });
}

function createEnhancedArrowMarkers(defs) {
    const markers = [
        { id: 'arrow-call', color: '#2196f3', size: 6 },
        { id: 'arrow-xctl', color: '#ff5722', size: 8 },
        { id: 'arrow-dynamic', color: '#9c27b0', size: 6 },
        { id: 'arrow-file-read', color: '#4caf50', size: 6 },
        { id: 'arrow-file-write', color: '#ff9800', size: 6 },
        { id: 'arrow-db2', color: '#ff9800', size: 6 }
    ];
    
    markers.forEach(marker => {
        defs.append('marker')
            .attr('id', marker.id)
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 10)
            .attr('refY', 0)
            .attr('markerWidth', marker.size)
            .attr('markerHeight', marker.size)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', marker.color);
    });
}

function createEnhancedVisualizationLegend(legendContainer) {
    const legendData = [
        { type: 'program-main', label: 'Starting Program', color: '#1a73e8' },
        { type: 'program-called', label: 'Called Program', color: '#64b5f6' },
        { type: 'program-missing', label: 'Missing Program', color: '#ffcdd2', dashed: true },
        { type: 'file', label: 'File/Dataset', color: '#4caf50' },
        { type: 'db2', label: 'DB2 Table', color: '#ff9800' },
        { type: 'call', label: 'Program Call', color: '#2196f3', isEdge: true },
        { type: 'file-op', label: 'File Operation', color: '#4caf50', isEdge: true },
        { type: 'dynamic', label: 'Dynamic Call', color: '#9c27b0', isEdge: true, dashed: true }
    ];
    
    // Get the actual DOM element from the D3 selection or use it directly if it's already a DOM element
    const containerElement = legendContainer.node ? legendContainer.node() : legendContainer;
    
    containerElement.innerHTML = '<h4 style="margin: 0 0 10px 0; font-size: 14px;">Flow Legend</h4>';
    
    legendData.forEach(item => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.style.cssText = `
            display: flex; 
            align-items: center; 
            margin-bottom: 5px; 
            font-size: 12px;
        `;
        
        const symbol = document.createElement('div');
        symbol.className = 'legend-symbol';
        symbol.style.cssText = `
            width: 20px; 
            height: ${item.isEdge ? '2px' : '12px'}; 
            background-color: ${item.color}; 
            margin-right: 8px;
            border-radius: ${item.isEdge ? '0' : '2px'};
            ${item.dashed ? 'border: 2px dashed ' + item.color + '; background: none;' : ''}
        `;
        
        const label = document.createElement('span');
        label.textContent = item.label;
        
        legendItem.appendChild(symbol);
        legendItem.appendChild(label);
        containerElement.appendChild(legendItem);
    });
}

 function getNodeWidth(node) {
            const widthMap = {
                'program': 120,
                'file': 100,
                'db2_table': 110
            };
            return widthMap[node.type] || 100;
        }

        function getNodeHeight(node) {
            const heightMap = {
                'program': 60,
                'file': 50,
                'db2_table': 50
            };
            return heightMap[node.type] || 50;
        }

function getMidPoint(source, target) {
    return {
        x: (source.x + target.x) / 2,
        y: (source.y + target.y) / 2
    };
}
function calculateHierarchy(nodes, edges, startNode) {
    const hierarchy = { 0: [startNode] };
    const visited = new Set([startNode.id]);
    const queue = [{ node: startNode, level: 0 }];
    
    while (queue.length > 0) {
        const { node: currentNode, level } = queue.shift();
        
        // Find all nodes this one calls
        const outgoingEdges = edges.filter(e => e.from === currentNode.id);
        
        outgoingEdges.forEach(edge => {
            const targetNode = nodes.find(n => n.id === edge.to);
            if (targetNode && !visited.has(targetNode.id) && targetNode.type === 'program') {
                const nextLevel = level + 1;
                
                if (!hierarchy[nextLevel]) {
                    hierarchy[nextLevel] = [];
                }
                
                hierarchy[nextLevel].push(targetNode);
                visited.add(targetNode.id);
                queue.push({ node: targetNode, level: nextLevel });
            }
        });
    }
    
    return hierarchy;
}

function getNodeWidth(node) {
    switch (node.type) {
        case 'program': return 120;
        case 'file': return 100;
        case 'db2_table': return 110;
        default: return 100;
    }
}

function getNodeHeight(node) {
    switch (node.type) {
        case 'program': return 60;
        case 'file': return 50;
        case 'db2_table': return 50;
        default: return 50;
    }
}

function createArrowMarkers(defs) {
            // Call arrow
            defs.append('marker')
                .attr('id', 'arrow-call')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 10)
                .attr('refY', 0)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#2196f3');
            
            // XCTL arrow
            defs.append('marker')
                .attr('id', 'arrow-xctl')
                .attr('viewBox', '0 -8 15 16')
                .attr('refX', 15)
                .attr('refY', 0)
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-8L15,0L0,8')
                .attr('fill', '#ff5722');
            
            // File operation arrows
            ['read', 'write'].forEach(op => {
                const colors = { read: '#4caf50', write: '#ff9800' };
                defs.append('marker')
                    .attr('id', `arrow-file-${op}`)
                    .attr('viewBox', '0 -5 10 10')
                    .attr('refX', 10)
                    .attr('refY', 0)
                    .attr('markerWidth', 6)
                    .attr('markerHeight', 6)
                    .attr('orient', 'auto')
                    .append('path')
                    .attr('d', 'M0,-5L10,0L0,5')
                    .attr('fill', colors[op]);
            });
        }


function drawCustomShape(selection, node) {
            const g = selection;
            
            // Add drop shadow
            g.style('filter', 'drop-shadow(2px 2px 4px rgba(0,0,0,0.2))');
            
            switch (node.type) {
                case 'program':
                    drawProgramShape(g, node);
                    break;
                case 'file':
                    drawFileShape(g, node);
                    break;
                case 'db2_table':
                    drawDB2Shape(g, node);
                    break;
            }
            
            // Node label
            g.append('text')
                .attr('class', 'node-label')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .style('font-size', '10px')
                .style('font-weight', 'bold')
                .style('fill', node.status === 'missing' ? '#d32f2f' : 'white')
                .style('pointer-events', 'none')
                .text(node.label.length > 12 ? node.label.substring(0, 12) + '...' : node.label);
        }


function drawProgramShape(g, node) {
            const width = node.width;
            const height = node.height;
            
            let className = 'node-program';
            if (node.is_starting_program) className = 'node-program-main';
            else if (node.status === 'missing') className = 'node-program-missing';
            else className = 'node-program-called';
            
            if (node.status === 'missing') {
                // Diamond shape for missing programs
                g.append('polygon')
                    .attr('class', className)
                    .attr('points', `0,${-height/2} ${width/2},0 0,${height/2} ${-width/2},0`)
                    .attr('stroke-width', 2);
            } else {
                // Rounded rectangle for available programs
                g.append('rect')
                    .attr('class', className)
                    .attr('x', -width/2)
                    .attr('y', -height/2)
                    .attr('width', width)
                    .attr('height', height)
                    .attr('rx', 8)
                    .attr('ry', 8)
                    .attr('stroke-width', 2);
            }
        }

function drawFileShape(g, node) {
    const width = node.width;
    const height = node.height;
    
    // Use simple rectangle with document icon styling instead of cylinder
    g.append('rect')
        .attr('class', 'node-file')
        .attr('x', -width/2)
        .attr('y', -height/2)
        .attr('width', width)
        .attr('height', height)
        .attr('rx', 4)
        .attr('ry', 4)
        .attr('stroke-width', 2);
    
    // Add file icon indicator (folded corner)
    g.append('path')
        .attr('d', `M${width/2-15},${-height/2} L${width/2-15},${-height/2+10} L${width/2-5},${-height/2+10} L${width/2-5},${-height/2} Z`)
        .attr('fill', '#2e7d32')
        .attr('stroke', '#1b5e20');
}

function drawDB2Shape(g, node) {
            const width = node.width;
            const height = node.height;
            
            g.append('rect')
                .attr('class', 'node-db2')
                .attr('x', -width/2)
                .attr('y', -height/2)
                .attr('width', width)
                .attr('height', height)
                .attr('rx', 4)
                .attr('ry', 4)
                .attr('stroke-width', 2);
            
            // Add table lines
            for (let i = 1; i <= 3; i++) {
                g.append('line')
                    .attr('x1', -width/2 + 5)
                    .attr('y1', -height/2 + (i * height/4))
                    .attr('x2', width/2 - 5)
                    .attr('y2', -height/2 + (i * height/4))
                    .attr('stroke', '#f57c00')
                    .attr('stroke-width', 1)
                    .attr('opacity', 0.6);
            }
        }

function drawDefaultShape(g, node) {
    g.append('circle')
        .attr('r', 20)
        .attr('fill', '#ccc')
        .attr('stroke', '#999')
        .attr('stroke-width', 2);
}

function drawEnhancedEdge(selection, edge) {
    const source = edge.source;
    const target = edge.target;
    
    // Draw the line
    const path = selection.append('path')
        .attr('class', `flow-edge ${getEdgeClass(edge)}`)
        .attr('d', edge.path || `M${source.x},${source.y} L${target.x},${target.y}`)
        .attr('fill', 'none')
        .attr('stroke', getEdgeColor(edge))
        .attr('stroke-width', getStrokeWidth(edge))
        .attr('marker-end', `url(#${getMarkerEnd(edge)})`);
    
    // Add dasharray for dynamic calls
    if (edge.type === 'dynamic_call' || edge.is_dynamic) {
        path.attr('stroke-dasharray', '8,4');
    }
    
    // Calculate midpoint for label
    const midX = (source.x + target.x) / 2;
    const midY = (source.y + target.y) / 2;
    
    // Add edge label with call type and operation
    let labelText = '';
    if (edge.type === 'program_call') {
        labelText = edge.call_type || 'CALL';
    } else if (edge.type === 'file_operation') {
        labelText = `FILE ${edge.io_direction || 'READ'}`;
    } else if (edge.type === 'db2_operation') {
        labelText = `DB2 ${edge.io_direction || 'read'}`;
    }
    
    if (labelText) {
        // Background rectangle for label
        selection.append('rect')
            .attr('x', midX - 25)
            .attr('y', midY - 8)
            .attr('width', 50)
            .attr('height', 16)
            .attr('fill', 'white')
            .attr('stroke', getEdgeColor(edge))
            .attr('stroke-width', 1)
            .attr('rx', 3);
        
        // Label text
        selection.append('text')
            .attr('x', midX)
            .attr('y', midY)
            .attr('text-anchor', 'middle')
            .attr('dy', '0.35em')
            .attr('font-size', '9px')
            .attr('font-weight', 'bold')
            .attr('fill', getEdgeColor(edge))
            .text(labelText);
    }
}

function getConnectionPoint(node, otherNode, role) {
    const x = node.x;
    const y = node.y;
    const width = node.width;
    const height = node.height;
    
    // Calculate which side to connect to based on relative position
    const dx = otherNode.x - x;
    const dy = otherNode.y - y;
    
    if (Math.abs(dx) > Math.abs(dy)) {
        // Connect to left or right side
        return {
            x: x + (dx > 0 ? width/2 : -width/2),
            y: y
        };
    } else {
        // Connect to top or bottom side
        return {
            x: x,
            y: y + (dy > 0 ? height/2 : -height/2)
        };
    }
}

 function getEdgeClass(edge) {
            switch (edge.call_type || edge.type) {
                case 'XCTL': return 'edge-xctl';
                case 'file_operation': return 'edge-file';
                default: return 'edge-call';
            }
        }

 function getMarkerEnd(edge) {
            if (edge.type === 'file_operation') {
                return `arrow-file-${edge.io_direction}`;
            }
            switch (edge.call_type) {
                case 'XCTL': return 'arrow-xctl';
                default: return 'arrow-call';
            }
        }

function getStrokeWidth(edge) {
            switch (edge.call_type || edge.type) {
                case 'XCTL': return 3;
                default: return 2;
            }
        }

function renderLayoutAssociations(layoutAssociations) {
    if (!layoutAssociations || layoutAssociations.length === 0) {
        return '';
    }
    
    let html = `
        <div class="layout-associations-section">
            <h3>ðŸ“‹ Record Layout Flow & Data Structures</h3>
            <div class="layout-flow-grid">
    `;
    
    // Group layouts by program for better organization
    const layoutsByProgram = {};
    layoutAssociations.forEach(layout => {
        const program = layout.program_name || 'Unknown';
        if (!layoutsByProgram[program]) {
            layoutsByProgram[program] = [];
        }
        layoutsByProgram[program].push(layout);
    });
    
    Object.entries(layoutsByProgram).forEach(([program, layouts]) => {
        html += `
            <div class="program-layout-group">
                <h4 class="program-header">ðŸ—ï¸ ${program}</h4>
                <div class="layouts-list">
        `;
        
        layouts.forEach(layout => {
            const statusClass = layout.has_fields ? 'layout-complete' : 'layout-partial';
            const fieldCount = layout.fields_count || layout.actual_field_count || 0;
            const usageContext = layout.usage_context || 'Data structure processing';
            const connectedPrograms = layout.connected_programs || [];
            
            html += `
                <div class="layout-item ${statusClass}">
                    <div class="layout-header">
                        <span class="layout-name">${layout.layout_name}</span>
                        <span class="layout-type-badge">${layout.layout_type || layout.record_classification || 'RECORD'}</span>
                        <span class="field-count">${fieldCount} fields</span>
                    </div>
                    <div class="layout-details">
                        <div class="layout-purpose">${layout.business_purpose || layout.friendly_name || 'Data structure definition'}</div>
                        <div class="usage-context">
                            <strong>Usage:</strong> ${usageContext}
                        </div>
                        ${connectedPrograms.length > 0 ? `
                            <div class="connected-programs">
                                <strong>Also used by:</strong> ${connectedPrograms.join(', ')}
                            </div>
                        ` : ''}
                        ${layout.key_fields && layout.key_fields.length > 0 ? `
                            <div class="key-fields">
                                <strong>Key fields:</strong> 
                                <div class="field-tags">
                                    ${layout.key_fields.slice(0, 3).map(field => 
                                        `<span class="field-tag" title="${field.business_purpose || ''}">${field.field_name}</span>`
                                    ).join('')}
                                    ${layout.key_fields.length > 3 ? `<span class="more-fields">+${layout.key_fields.length - 3} more</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="layout-actions">
                        <button class="btn-sm" onclick="viewLayoutFields('${layout.layout_name}')">View Fields</button>
                        <button class="btn-sm" onclick="traceLayoutUsage('${layout.layout_name}')">Trace Usage</button>
                        ${fieldCount > 0 ? 
                            `<button class="btn-sm" onclick="viewLayoutFieldDetails('${layout.layout_name}')">Field Details</button>` : 
                            ''}
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

function renderFieldFlowsWithTransformations(fieldFlows) {
    if (!fieldFlows || Object.keys(fieldFlows).length === 0) {
        return '';
    }
    
    let html = `
        <div class="field-flows-section">
            <h3>ðŸ”„ Field Data Flow Analysis</h3>
            <div class="field-flows-grid">
    `;
    
    Object.entries(fieldFlows).forEach(([fieldName, flows]) => {
        html += `
            <div class="field-flow-card">
                <div class="field-header">
                    <h4 class="field-name">ðŸ“Š ${fieldName}</h4>
                    <span class="flow-steps-count">${flows.length} flow steps</span>
                </div>
                <div class="field-flow-path">
        `;
        
        flows.forEach((flow, index) => {
            const isLast = index === flows.length - 1;
            const transformationType = flow.transformation_details?.transformation_type || 'DIRECT_PASS';
            const hasBusinessLogic = flow.transformation_details?.business_logic_applied?.length > 0;
            const hasValidation = flow.transformation_details?.validation_rules?.length > 0;
            
            html += `
                <div class="flow-step">
                    <div class="step-header">
                        <div class="step-program">${flow.from}</div>
                        <div class="step-arrow">â†’</div>
                        <div class="step-program">${flow.to}</div>
                    </div>
                    ${flow.source_layouts && flow.source_layouts.length > 0 ? `
                        <div class="step-layout">
                            ðŸ“‹ From: ${flow.source_layouts.map(l => l.layout_name).join(', ')}
                        </div>
                    ` : ''}
                    ${flow.target_layouts && flow.target_layouts.length > 0 ? `
                        <div class="step-layout">
                            ðŸ“‹ To: ${flow.target_layouts.map(l => l.layout_name).join(', ')}
                        </div>
                    ` : ''}
                    <div class="step-transformation">
                        <span class="transformation-type ${transformationType.toLowerCase()}">${transformationType}</span>
                        ${flow.transformation || 'Direct transfer'}
                    </div>
                    ${hasBusinessLogic || hasValidation ? `
                        <div class="transformation-indicators">
                            ${hasBusinessLogic ? '<span class="indicator business-logic">ðŸ“Š Business Logic</span>' : ''}
                            ${hasValidation ? '<span class="indicator validation">âœ… Validation</span>' : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        html += `
                </div>
                <div class="field-actions">
                    <button class="trace-btn" onclick="traceFieldFlow('${currentSessionId}', '${fieldName}')">
                        Trace Complete Flow
                    </button>
                    <button class="analyze-btn" onclick="analyzeFieldTransformations('${fieldName}')">
                        Analyze Transformations
                    </button>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

function renderFileOperationsWithLayouts(fileOperations) {
    if (!fileOperations || fileOperations.length === 0) {
        return '';
    }
    
    let html = `
        <div class="file-operations-section">
            <h3>ðŸ“ File Operations & Data Access (${fileOperations.length})</h3>
            <div class="file-operations-grid">
    `;
    
    fileOperations.forEach(fileOp => {
        const statusClass = fileOp.has_layout_resolution ? 'has-layout' : 'no-layout';
        const interfaceIcon = fileOp.interface_type === 'CICS' ? 'ðŸ¦' : 'ðŸ“';
        const operations = fileOp.operations || [];
        const layoutConnections = fileOp.layout_connections || fileOp.layout_details || [];
        const fieldsInvolved = fileOp.fields_involved || [];
        
        html += `
            <div class="file-operation-card ${statusClass}">
                <div class="file-header">
                    <div class="file-info">
                        <span class="file-icon">${interfaceIcon}</span>
                        <span class="file-name">${fileOp.file_name}</span>
                        <span class="io-direction-badge ${fileOp.io_direction.toLowerCase()}">${fileOp.io_direction}</span>
                    </div>
                    ${fileOp.has_layout_resolution ? 
                        '<span class="layout-indicator">âœ… Has Layout</span>' : 
                        '<span class="no-layout-indicator">âš ï¸ No Layout</span>'}
                </div>
                
                <div class="file-details">
                    <div class="connected-program">
                        <strong>Connected to:</strong> 
                        <span class="program-link" onclick="showProgramDetails('${fileOp.program_name}')">${fileOp.program_name}</span>
                    </div>
                    <div class="file-operations">
                        <strong>Operations:</strong> ${operations.join(', ') || 'READ/WRITE'}
                    </div>
                    <div class="interface-type">
                        <strong>Interface:</strong> ${fileOp.interface_type}
                    </div>
                    
                    ${layoutConnections.length > 0 ? `
                        <div class="layout-connections">
                            <strong>Layout Connections:</strong>
                            <div class="layout-connection-list">
                                ${layoutConnections.map(layout => `
                                    <div class="layout-connection-item">
                                        <span class="layout-name" onclick="viewLayoutFieldDetails('${layout.layout_name}')">${layout.layout_name}</span>
                                        <span class="layout-fields">(${layout.fields_count || layout.key_fields?.length || 0} fields)</span>
                                        ${layout.business_purpose ? `<div class="layout-purpose-small">${layout.business_purpose}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${fieldsInvolved.length > 0 ? `
                        <div class="fields-involved">
                            <strong>Key Fields:</strong>
                            <div class="field-tags-small">
                                ${fieldsInvolved.slice(0, 5).map(field => 
                                    `<span class="field-tag-small">${field}</span>`
                                ).join('')}
                                ${fieldsInvolved.length > 5 ? `<span class="more-fields-small">+${fieldsInvolved.length - 5} more</span>` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="file-actions">
                    <button class="btn-sm" onclick="analyzeFileUsage('${fileOp.file_name}')">Analyze Usage</button>
                    ${fileOp.has_layout_resolution ? 
                        `<button class="btn-sm" onclick="viewFileLayoutConnections('${fileOp.file_name}')">View Layouts</button>` : 
                        `<button class="btn-sm" onclick="suggestLayoutCreation('${fileOp.file_name}')">Create Layout</button>`
                    }
                    <button class="btn-sm" onclick="traceFileDataFlow('${fileOp.file_name}')">Trace Data Flow</button>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

function renderMissingProgramsImpact(missingPrograms) {
    if (!missingPrograms || missingPrograms.length === 0) {
        return '';
    }
    
    let html = `
        <div class="missing-programs-section">
            <h3>âš ï¸ Missing Programs Impact (${missingPrograms.length})</h3>
            <div class="missing-programs-grid">
    `;
    
    missingPrograms.forEach(program => {
        html += `
            <div class="missing-program-card">
                <div class="missing-header">
                    <span class="missing-icon">âŒ</span>
                    <span class="program-name">${program.program_name}</span>
                    <span class="call-type-badge">${program.call_type}</span>
                </div>
                <div class="missing-details">
                    <div class="called-by">
                        <strong>Called by:</strong> ${program.called_by}
                    </div>
                    <div class="sequence-info">
                        <strong>At step:</strong> #${program.sequence}
                    </div>
                    <div class="impact-description">
                        This missing program blocks further flow analysis and may prevent complete understanding of data transformations and layout usage.
                    </div>
                </div>
                <div class="missing-actions">
                    <button class="impact-btn" onclick="showMissingProgramImpact('${currentSessionId}', '${program.program_name}')">
                        Analyze Impact
                    </button>
                    <button class="upload-btn" onclick="promptProgramUpload('${program.program_name}')">
                        Upload Program
                    </button>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
            <div class="missing-summary">
                <div class="recommendation-box">
                    <h4>ðŸŽ¯ Recommendations</h4>
                    <ul>
                        <li>Upload the missing programs to complete flow analysis</li>
                        <li>Each missing program may contain additional layout definitions and field transformations</li>
                        <li>Layout associations become more accurate with complete program set</li>
                        <li>Data flow tracing improves significantly with all programs available</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    
    return html;
}

// Additional helper functions for the new functionality
function viewFileLayoutConnections(fileName) {
    // Show all layout connections for a file
    const chatInput = document.getElementById('chatInput');
    chatInput.value = `Show me all layout connections for file ${fileName}. Which record structures are used to read from or write to this file?`;
    sendChatMessage();
}

function traceFileDataFlow(fileName) {
    // Trace data flow through file operations
    const chatInput = document.getElementById('chatInput');
    chatInput.value = `Trace the complete data flow for file ${fileName}. Show me which programs read from it, which write to it, and how data transforms through the file operations.`;
    sendChatMessage();
}

function suggestLayoutCreation(fileName) {
    // Suggest creating layouts for files without them
    alert(`File ${fileName} doesn't have associated record layouts. Consider:\n\n1. Uploading COBOL copybooks that define this file's structure\n2. Analyzing programs that use this file to infer its layout\n3. Creating manual layout documentation\n\nWould you like me to analyze programs that use this file to suggest a layout structure?`);
}

function promptProgramUpload(programName) {
    // Prompt user to upload missing program
    const uploadHint = `To complete the analysis for program ${programName}:\n\n1. Locate the ${programName}.cbl or ${programName}.cob file\n2. Use the upload button in the left panel\n3. The system will automatically analyze layout associations and data flows\n\nThis will provide complete visibility into the program call chain and data transformations.`;
    
    alert(uploadHint);
    
    // Highlight the upload area
    const uploadSection = document.querySelector('.upload-section');
    if (uploadSection) {
        uploadSection.style.border = '3px solid #28a745';
        uploadSection.style.backgroundColor = '#f8fff9';
        setTimeout(() => {
            uploadSection.style.border = '2px dashed #667eea';
            uploadSection.style.backgroundColor = '#f8f9ff';
        }, 3000);
    }
}

function createPath(source, target, edge) {
    // Create curved path for better visual flow
    const dx = target.x - source.x;
    const dy = target.y - source.y;
    
    if (Math.abs(dy) < 20) {
        // Horizontal line
        return `M${source.x},${source.y} L${target.x},${target.y}`;
    } else {
        // Curved path
        const midY = source.y + dy * 0.5;
        return `M${source.x},${source.y} Q${source.x},${midY} ${target.x},${target.y}`;
    }
}

function getMidPoint(source, target) {
    return {
        x: (source.x + target.x) / 2,
        y: (source.y + target.y) / 2
    };
}

function calculateEdgePath(sourceNode, targetNode, edge) {
    // This could be enhanced with more sophisticated path calculations
    return `M${sourceNode.x},${sourceNode.y} L${targetNode.x},${targetNode.y}`;
}

function addInteractivity(nodes, edges) {
            nodes.on('click', function(event, d) {
                console.log('Clicked node:', d);
            });
            
            nodes.on('mouseover', function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr('transform', function() {
                        const currentTransform = d3.select(this).attr('transform');
                        return currentTransform + ' scale(1.1)';
                    })
                    .style('cursor', 'pointer');
            });
            
            nodes.on('mouseout', function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }


function highlightConnectedComponents(node) {
    // Check if edges data is available
    const edges = window.currentFlowEdges;
    if (!edges || !Array.isArray(edges)) {
        console.warn('Edges data not available for highlighting');
        return;
    }
    
    // Highlight all edges connected to this node
    d3.selectAll('.flow-edge').style('opacity', 0.3);
    
    // Find and highlight connected edges
    let connectedEdgeCount = 0;
    edges.forEach((edge, index) => {
        if (edge.source && edge.target && 
            (edge.source.id === node.id || edge.target.id === node.id)) {
            
            // Use index-based selection which is more reliable
            d3.selectAll('.flow-edge').filter(function(d, i) {
                return i === index;
            })
            .style('opacity', 1)
            .style('stroke-width', function(d) {
                const currentWidth = d3.select(this).style('stroke-width');
                return (parseInt(currentWidth) || 2) + 1;
            });
            
            connectedEdgeCount++;
        }
    });
    
    console.log(`Highlighted ${connectedEdgeCount} edges for node ${node.id}`);
}

function resetHighlights() {
    d3.selectAll('.flow-edge')
        .style('opacity', 1)
        .style('stroke-width', function(d) {
            // Reset to original width based on edge type
            return getStrokeWidth(d) || 2;
        });
}

function highlightConnectedComponents(node, edges) {
    // Highlight all edges connected to this node
    d3.selectAll('.flow-edge').style('opacity', 0.3);
    
    edges.forEach(edge => {
        if (edge.source.id === node.id || edge.target.id === node.id) {
            d3.select(`.flow-edge:nth-child(${edges.indexOf(edge) + 1})`)
                .style('opacity', 1)
                .style('stroke-width', parseInt(getStrokeWidth(edge)) + 1);
        }
    });
}

function resetHighlights() {
    d3.selectAll('.flow-edge')
        .style('opacity', 1)
        .style('stroke-width', d => getStrokeWidth(d));
}

function createVisualizationLegend(legendContainer) {
            const legendData = [
                { type: 'program-main', label: 'Starting Program', color: '#1a73e8' },
                { type: 'program-called', label: 'Called Program', color: '#64b5f6' },
                { type: 'program-missing', label: 'Missing Program', color: '#ffcdd2' },
                { type: 'file', label: 'File/Dataset', color: '#4caf50' },
                { type: 'db2', label: 'DB2 Table', color: '#ff9800' }
            ];
            
            const container = legendContainer.node();
            container.innerHTML = '<h4 style="margin: 0 0 10px 0; font-size: 14px;">Legend</h4>';
            
            legendData.forEach(item => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                const symbol = document.createElement('div');
                symbol.className = 'legend-symbol';
                symbol.style.backgroundColor = item.color;
                if (item.type.includes('missing')) {
                    symbol.style.border = '2px dashed #d32f2f';
                    symbol.style.background = 'none';
                }
                
                const label = document.createElement('span');
                label.textContent = item.label;
                
                legendItem.appendChild(symbol);
                legendItem.appendChild(label);
                container.appendChild(legendItem);
            });
        }
function showEnhancedNodeDetails(node) {
    // Enhanced version of your existing showNodeDetails function
    const modalContent = {
        program: createProgramDetailsContent(node),
        file: createFileDetailsContent(node),
        db2_table: createDB2DetailsContent(node)
    };
    
    const content = modalContent[node.type] || createDefaultDetailsContent(node);
    
    // Create and show modal with enhanced content
    showNodeDetailsModal(node, content);
}

function createProgramDetailsContent(node) {
    return `
        <div class="enhanced-node-details">
            <h4>${node.label}</h4>
            <div class="detail-grid">
                <div><strong>Type:</strong> ${node.is_starting_program ? 'Main Program' : 'Called Program'}</div>
                <div><strong>Status:</strong> <span class="status-${node.status}">${node.status}</span></div>
                <div><strong>Level:</strong> ${node.level}</div>
                ${node.business_purpose ? `<div><strong>Purpose:</strong> ${node.business_purpose}</div>` : ''}
            </div>
        </div>
    `;
}

function createFileDetailsContent(node) {
    return `
        <div class="enhanced-node-details">
            <h4>${node.label}</h4>
            <div class="detail-grid">
                <div><strong>Type:</strong> File/Dataset</div>
                <div><strong>Interface:</strong> ${node.interface || 'FILE_SYSTEM'}</div>
                <div><strong>I/O Direction:</strong> ${node.io_direction || 'Unknown'}</div>
                ${node.has_layout ? '<div><strong>Layout:</strong> Available</div>' : ''}
            </div>
        </div>
    `;
}

function createDB2DetailsContent(node) {
    return `
        <div class="enhanced-node-details">
            <h4>${node.label}</h4>
            <div class="detail-grid">
                <div><strong>Type:</strong> DB2 Table</div>
                <div><strong>Operations:</strong> ${node.sql_operations || 'SELECT, INSERT, UPDATE'}</div>
                <div><strong>Schema:</strong> ${node.schema || 'Default'}</div>
            </div>
        </div>
    `;
}

function showNodeDetailsModal(node, content) {
    // Use your existing modal system but with enhanced content
    showNodeDetails(node, { visualization_data: { enhanced_content: content }});
}

function getSampleFlowData() {
            return {
                nodes: [
                    // Program nodes with hierarchy
                    { id: 'TMSTMPM4', type: 'program', label: 'TMSTMPM4', is_starting_program: true, status: 'present' },
                    { id: 'TRECHECM', type: 'program', label: 'TRECHECM', status: 'missing' },
                    { id: 'TMSAUTH', type: 'program', label: 'TMSAUTH', status: 'present' },
                    { id: 'TMSTIP19', type: 'program', label: 'TMSTIP19', status: 'present' },
                    { id: 'CKS910', type: 'program', label: 'CKS910', status: 'present' },
                    { id: 'TMSTMND', type: 'program', label: 'TMSTMND', status: 'present' },
                    { id: 'TMSDYTAG', type: 'program', label: 'TMSDYTAG', status: 'present' },
                    { id: 'TMSDMPM4', type: 'program', label: 'TMSDMPM4', status: 'present' },
                    // File nodes
                    { id: 'TMSS0CKO', type: 'file', label: 'TMSS0CKO', interface: 'CICS', connected_to_program: 'TMSDMPM4' },
                    { id: 'TMSS6ACO', type: 'file', label: 'TMSS6ACO', interface: 'CICS', connected_to_program: 'TMSDMPM4' },
                    // DB2 nodes
                    { id: 'CUSTOMER_TABLE', type: 'db2_table', label: 'CUSTOMER_TABLE', connected_to_program: 'TMSTMPM4' },
                    { id: 'TRANSACTION_LOG', type: 'db2_table', label: 'TRANSACTION_LOG', connected_to_program: 'TMSDMPM4' }
                ],
                edges: [
                    // Program calls
                    { from: 'TMSTMPM4', to: 'TRECHECM', type: 'program_call', call_type: 'CALL' },
                    { from: 'TMSTMPM4', to: 'TMSAUTH', type: 'program_call', call_type: 'CALL' },
                    { from: 'TMSTMPM4', to: 'TMSTIP19', type: 'program_call', call_type: 'XCTL' },
                    { from: 'TMSTIP19', to: 'CKS910', type: 'program_call', call_type: 'CALL' },
                    { from: 'CKS910', to: 'TMSTMND', type: 'program_call', call_type: 'CALL' },
                    { from: 'TMSTMND', to: 'TMSDYTAG', type: 'program_call', call_type: 'CALL' },
                    { from: 'TMSDYTAG', to: 'TMSDMPM4', type: 'program_call', call_type: 'XCTL' },
                    // File operations
                    { from: 'TMSDMPM4', to: 'TMSS0CKO', type: 'file_operation', io_direction: 'READ' },
                    { from: 'TMSDMPM4', to: 'TMSS6ACO', type: 'file_operation', io_direction: 'write' },
                    // DB2 operations
                    { from: 'TMSTMPM4', to: 'CUSTOMER_TABLE', type: 'db2_operation', io_direction: 'read' },
                    { from: 'TMSDMPM4', to: 'TRANSACTION_LOG', type: 'db2_operation', io_direction: 'write' }
                ]
            };
        }

        function renderSampleFlow() {
            const vizData = getSampleFlowData();
            renderFlowVisualization(vizData);
        }
        window.onload = function() {
            renderSampleFlow();
        };
    
function createHierarchicalLayout(vizData) {
    const nodes = vizData.nodes || [];
    const edges = vizData.edges || [];
    
    if (!nodes.length) {
        throw new Error('No nodes provided for layout');
    }
    
    const programNodes = nodes.filter(n => n.type === 'program');
    const fileNodes = nodes.filter(n => n.type === 'file');
    const db2Nodes = nodes.filter(n => n.type === 'db2_table');
    
    const layoutNodes = [];
    const levelHeight = 160;
    const svgWidth = 1400;
    
    // Build program hierarchy
    const startingProgram = programNodes.find(n => n.is_starting_program) || programNodes[0];
    const programLevels = buildProgramHierarchyWithMissing(programNodes, edges, startingProgram);
    
    // Position programs at their correct levels
    Object.entries(programLevels).forEach(([level, programs]) => {
        const levelNum = parseInt(level);
        const yPosition = 120 + (levelNum * levelHeight);  // Start programs lower
        const spacing = Math.min(220, (svgWidth - 200) / Math.max(programs.length, 1));
        const startX = (svgWidth - (programs.length - 1) * spacing) / 2;
        
        programs.forEach((program, index) => {
            layoutNodes.push({
                ...program,
                x: startX + (index * spacing),
                y: yPosition,
                level: levelNum,
                width: 120,
                height: 60
            });
        });
    });
    
    // SEPARATE INPUT AND OUTPUT FILES BY POSITION
    const inputFiles = [];
    const outputFiles = [];
    const ioFiles = [];
    
    // Categorize files by their I/O direction
    fileNodes.forEach(file => {
        const fileEdges = edges.filter(e => e.to === file.id && e.type === 'file_operation');
        let ioDirection = 'unknown';
        
        fileEdges.forEach(edge => {
            const analysis = edge.analysis_details || {};
            if (analysis.io_direction) {
                ioDirection = analysis.io_direction;
            }
        });
        
        if (ioDirection === 'INPUT' || ioDirection.includes('read')) {
            inputFiles.push(file);
        } else if (ioDirection === 'OUTPUT' || ioDirection.includes('write')) {
            outputFiles.push(file);
        } else {
            ioFiles.push(file);
        }
    });
    
    // Position INPUT files at the TOP (above programs)
    const inputY = 40;  // Above programs
    inputFiles.forEach((file, index) => {
        const xPos = 100 + (index * 150);
        layoutNodes.push({
            ...file,
            x: xPos,
            y: inputY,
            level: -1,
            width: 100,
            height: 50
        });
    });
    
    // Position OUTPUT files at the BOTTOM (below programs)
    const maxProgramLevel = Math.max(...Object.keys(programLevels).map(Number));
    const outputY = 120 + ((maxProgramLevel + 1) * levelHeight) + 80;
    outputFiles.forEach((file, index) => {
        const xPos = 100 + (index * 150);
        layoutNodes.push({
            ...file,
            x: xPos,
            y: outputY,
            level: maxProgramLevel + 2,
            width: 100,
            height: 50
        });
    });
    
    // Position I/O files on the right side to avoid overlap
    ioFiles.forEach((file, index) => {
        layoutNodes.push({
            ...file,
            x: svgWidth - 150,
            y: 120 + (index * 80),
            level: 1,
            width: 100,
            height: 50
        });
    });
    
    // Position DB2 nodes on the left side
    db2Nodes.forEach((node, index) => {
        layoutNodes.push({
            ...node,
            x: 80,
            y: 120 + (index * 80),
            level: 1,
            width: 110,
            height: 50
        });
    });
    
    // Create edges
    const layoutEdges = [];
    edges.forEach(edge => {
        const source = layoutNodes.find(n => n.id === edge.from);
        const target = layoutNodes.find(n => n.id === edge.to);
        if (source && target) {
            layoutEdges.push({ ...edge, source, target });
        }
    });
    
    return { layoutNodes, layoutEdges };
}

function buildProgramHierarchyWithMissing(programNodes, edges, startingProgram) {
    const hierarchy = {};
    const visited = new Set();
    const queue = [{ program: startingProgram, level: 0 }];
    
    // Level 0: Starting program
    hierarchy[0] = [startingProgram];
    visited.add(startingProgram.id);
    
    while (queue.length > 0) {
        const { program: currentProgram, level } = queue.shift();
        
        // Find all programs called by current program
        const outgoingCalls = edges.filter(e => 
            e.from === currentProgram.id && 
            e.type === 'program_call'
        );
        
        outgoingCalls.forEach(call => {
            let targetProgram = programNodes.find(p => p.id === call.to);
            
            // If program not found, create a missing program node
            if (!targetProgram) {
                targetProgram = {
                    id: call.to,
                    label: call.to,
                    type: 'program',
                    status: 'missing',
                    is_starting_program: false
                };
                programNodes.push(targetProgram);
            }
            
            if (!visited.has(targetProgram.id)) {
                const nextLevel = level + 1;
                
                if (!hierarchy[nextLevel]) {
                    hierarchy[nextLevel] = [];
                }
                
                hierarchy[nextLevel].push(targetProgram);
                visited.add(targetProgram.id);
                queue.push({ program: targetProgram, level: nextLevel });
            }
        });
    }
    
    // Add any orphaned programs to the last level
    programNodes.forEach(program => {
        if (!visited.has(program.id)) {
            const lastLevel = Math.max(...Object.keys(hierarchy).map(Number)) + 1;
            if (!hierarchy[lastLevel]) hierarchy[lastLevel] = [];
            hierarchy[lastLevel].push(program);
        }
    });
    
    return hierarchy;
}
function buildProgramCallChain(programNodes, edges) {
    const chainSteps = [];
    const processedEdges = new Set();
    
    edges.forEach(edge => {
        if (edge.type !== 'program_call' || processedEdges.has(`${edge.from}-${edge.to}`)) return;
        
        const sourceProgram = programNodes.find(p => p.id === edge.from);
        let targetProgram = programNodes.find(p => p.id === edge.to);
        
        // Handle missing programs
        if (!targetProgram) {
            targetProgram = {
                id: edge.to,
                label: edge.to,
                status: 'missing',
                level: 999 // High level for missing programs
            };
        }
        
        if (sourceProgram) {
            chainSteps.push({
                source: edge.from,
                target: edge.to,
                call_type: edge.call_type || 'CALL',
                source_level: sourceProgram.level || 0,
                target_level: targetProgram.level || 999,
                target_status: targetProgram.status || 'missing',
                variable_name: edge.variable_name,
                business_context: edge.business_context,
                confidence: edge.confidence_score || 0.9
            });
            processedEdges.add(`${edge.from}-${edge.to}`);
        }
    });
    
    // Sort by source level to show proper hierarchy
    return chainSteps.sort((a, b) => a.source_level - b.source_level);
}

function buildProgramHierarchy(programNodes, edges, startingProgram) {
    const hierarchy = {};
    const visited = new Set();
    const queue = [{ program: startingProgram, level: 0 }];
    
    // Level 0: Starting program
    hierarchy[0] = [startingProgram];
    visited.add(startingProgram.id);
    
    while (queue.length > 0) {
        const { program: currentProgram, level } = queue.shift();
        
        // Find all programs called by current program
        const outgoingCalls = edges.filter(e => 
            e.from === currentProgram.id && 
            e.type === 'program_call'
        );
        
        outgoingCalls.forEach(call => {
            const targetProgram = programNodes.find(p => p.id === call.to);
            if (targetProgram && !visited.has(targetProgram.id)) {
                const nextLevel = level + 1;
                
                if (!hierarchy[nextLevel]) {
                    hierarchy[nextLevel] = [];
                }
                
                hierarchy[nextLevel].push(targetProgram);
                visited.add(targetProgram.id);
                queue.push({ program: targetProgram, level: nextLevel });
            }
        });
    }
    
    // Add any orphaned programs to the last level
    programNodes.forEach(program => {
        if (!visited.has(program.id)) {
            const lastLevel = Math.max(...Object.keys(hierarchy).map(Number)) + 1;
            if (!hierarchy[lastLevel]) hierarchy[lastLevel] = [];
            hierarchy[lastLevel].push(program);
        }
    });
    
    return hierarchy;
}
function buildProgramHierarchy(programNodes, edges, startingProgram) {
    const hierarchy = {};
    const visited = new Set();
    const queue = [{ program: startingProgram, level: 0 }];
    
    // Level 0: Starting program
    hierarchy[0] = [startingProgram];
    visited.add(startingProgram.id);
    
    while (queue.length > 0) {
        const { program: currentProgram, level } = queue.shift();
        
        // Find all programs called by current program
        const outgoingCalls = edges.filter(e => 
            e.from === currentProgram.id && 
            e.type === 'program_call'
        );
        
        outgoingCalls.forEach(call => {
            const targetProgram = programNodes.find(p => p.id === call.to);
            if (targetProgram && !visited.has(targetProgram.id)) {
                const nextLevel = level + 1;
                
                if (!hierarchy[nextLevel]) {
                    hierarchy[nextLevel] = [];
                }
                
                hierarchy[nextLevel].push(targetProgram);
                visited.add(targetProgram.id);
                queue.push({ program: targetProgram, level: nextLevel });
            }
        });
    }
    
    // Add any orphaned programs to the last level
    programNodes.forEach(program => {
        if (!visited.has(program.id)) {
            const lastLevel = Math.max(...Object.keys(hierarchy).map(Number)) + 1;
            if (!hierarchy[lastLevel]) hierarchy[lastLevel] = [];
            hierarchy[lastLevel].push(program);
        }
    });
    
    return hierarchy;
}

function getCallTypeIcon(callType) {
    const icons = {
        'CALL': 'ðŸ“ž',
        'XCTL': 'ðŸ”„',
        'LINK': 'ðŸ”—',
        'DYNAMIC': 'âš¡'
    };
    return icons[callType] || 'ðŸ“ž';
}

// Action functions for enhanced interactivity
function viewLayoutFields(layoutName) {
    // Switch to field matrix tab and show layout fields
    showTab({target: document.querySelector('.tab-btn:nth-child(4)')}, 'fieldMatrix');
    const recordLayoutSelect = document.getElementById('recordLayoutSelect');
    if (recordLayoutSelect) {
        recordLayoutSelect.value = layoutName;
        loadFieldMatrix();
    }
}

function traceLayoutUsage(layoutName) {
    // Open chat with layout usage query
    const chatInput = document.getElementById('chatInput');
    chatInput.value = `Trace the usage of layout ${layoutName}. Show me which programs use it, how fields are populated, and what business processes it supports.`;
    chatInput.focus();
}

function traceFieldFlow(sessionId, fieldName) {
    // Enhanced field flow tracing with visual representation
    fetch(`/api/field-flow-trace/${sessionId}/${fieldName}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showFieldFlowModal(data.field_journey);
            } else {
                alert('Could not trace field flow: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            console.error('Error tracing field flow:', error);
            alert('Error tracing field flow');
        });
}

function analyzeFieldTransformations(fieldName) {
    // Open AI analysis for field transformations
    const chatInput = document.getElementById('chatInput');
    chatInput.value = `Analyze all transformations applied to field ${fieldName} throughout the program flow. Include business logic, data type changes, and validation rules.`;
    sendChatMessage();
}
function renderEnhancedFlowDetails(flowAnalysis, vizData) {
    const detailsContainer = document.getElementById('flowDetails');
    
    let html = `
        <div class="enhanced-flow-header">
            <h2>ðŸ“Š Enhanced Program Flow Analysis</h2>
            <div class="flow-overview-stats">
                <div class="overview-stat">
                    <span class="stat-value">${vizData.statistics.total_programs}</span>
                    <span class="stat-label">Programs</span>
                </div>
                <div class="overview-stat">
                    <span class="stat-value">${vizData.statistics.layout_associations}</span>
                    <span class="stat-label">Layouts</span>
                </div>
                <div class="overview-stat">
                    <span class="stat-value">${vizData.statistics.field_flows}</span>
                    <span class="stat-label">Field Flows</span>
                </div>
                <div class="overview-stat">
                    <span class="stat-value">${vizData.statistics.file_operations}</span>
                    <span class="stat-label">File Ops</span>
                </div>
            </div>
        </div>
    `;
    
    // Use the enhanced rendering functions from the previous artifacts
    html += renderProgramChainWithDetails(vizData.visualization_data.program_chain_summary);
    html += renderLayoutAssociations(vizData.visualization_data.layout_associations);
    html += renderFieldFlowsWithTransformations(vizData.visualization_data.field_flows);
    html += renderFileOperationsWithLayouts(vizData.visualization_data.file_operations);
    
    if (vizData.visualization_data.missing_programs.length > 0) {
        html += renderMissingProgramsImpact(vizData.visualization_data.missing_programs);
    }
    
    detailsContainer.innerHTML = html;
}
async function analyzeEnhancedFlow() {
    const programName = document.getElementById('startingProgram').value;
    if (!programName) {
        alert('Please enter a program name');
        return;
    }
    
    showLoadingSpinner('Analyzing enhanced program flow...');
    
    try {
        const response = await fetch(`/api/program-flow-visualization/${currentSessionId}/${programName}`);
        const data = await response.json();
        
        if (!data.success) {
            showError(data.error || 'Failed to analyze program flow');
            return;
        }
        
        // Render the flow visualization
        // Replace the existing flow visualization with a modal button
if (data.flow_visualization) {
    console.log('Preparing modal flow visualization...');
    
    document.getElementById('flowVisualization').innerHTML = `
        <div style="
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 10px;
            flex-direction: column;
        ">
            <div style="font-size: 3rem; margin-bottom: 20px;">ðŸ”</div>
            <h3 style="color: #667eea; margin-bottom: 15px;">Program Flow Visualization</h3>
            <p style="color: #666; margin-bottom: 20px;">Click below to view the complete program flow in an expanded view</p>
            <button onclick="openProgramFlowModal(${JSON.stringify(data.flow_visualization).replace(/"/g, '&quot;')}, '${programName}')" 
                    style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                    ">
                ðŸ“Š View Detailed Program Flow
            </button>
        </div>
    `;
    
    // Store the data globally for the modal
    window.currentFlowData = data.flow_visualization;
    
} else {
    console.error('No flow visualization data received');
    showError('No visualization data received from server');
    return;
}
        
        // Display flow details with proper data structure
        const flowDetails = document.getElementById('flowDetails');
        if (data.statistics) {
            let html = `
                <div class="flow-summary-section">
                    <h3>Program Flow: ${programName}</h3>
                    <div class="flow-business-summary">
                        Analysis complete for program ${programName}
                    </div>
                    <div class="flow-statistics">
                        <div class="stat-item">
                            <span class="stat-value">${data.statistics.total_programs_in_flow || 0}</span>
                            <span class="stat-label">Programs</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${data.statistics.file_operations || 0}</span>
                            <span class="stat-label">File Operations</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${data.statistics.db2_operations || 0}</span>
                            <span class="stat-label">DB2 Operations</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${data.statistics.missing_programs || 0}</span>
                            <span class="stat-label">Missing Programs</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Show program chain summary if available
            // Show program chain summary if available
const programNodes = data.flow_visualization.nodes?.filter(n => n.type === 'program') || [];
if (programNodes.length > 0) {
    html += `
        <div class="program-chain-section">
            <h3>Program Call Chain</h3>
            <div class="program-chain-list">
    `;
    
    // Sort by level to show proper call hierarchy
    programNodes.sort((a, b) => (a.level || 0) - (b.level || 0));
    
    // Build the actual call chain from edges
    // Enhanced program call chain with layout information
const edges = data.flow_visualization.edges?.filter(e => e.type === 'program_call') || [];
const chainSteps = buildProgramCallChainWithLayouts(programNodes, edges, currentSessionId);

chainSteps.forEach((step, index) => {
    const statusClass = step.target_status === 'missing' ? 'missing-program' : 'available-program';
    const callIcon = getCallTypeIcon(step.call_type);
    
    html += `
        <div class="program-chain-item ${statusClass}">
            <div class="chain-sequence">#${index + 1}</div>
            <div class="chain-flow-details">
                <div class="program-call-header">
                    <span class="source-program">${step.source}</span>
                    <span class="call-arrow">${callIcon} ${step.call_type}</span>
                    <span class="target-program">${step.target}</span>
                    ${step.target_status === 'missing' ? 
                        '<span class="missing-indicator">âŒ MISSING</span>' : 
                        '<span class="available-indicator">âœ… AVAILABLE</span>'}
                </div>
                
                ${step.layout_info && step.layout_info.length > 0 ? `
                    <div class="layout-flow-info">
                        <strong>Data Layouts Used:</strong>
                        <div class="layout-details">
                            ${step.layout_info.map(layout => `
                                <div class="layout-item">
                                    <span class="layout-name">${layout.layout_name}</span>
                                    <span class="layout-fields">(${layout.key_fields.slice(0,3).join(', ')})${layout.key_fields.length > 3 ? '...' : ''}</span>
                                    <span class="layout-purpose">${layout.usage_type}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${step.file_operations && step.file_operations.length > 0 ? `
                    <div class="file-operations-info">
                        <strong>File Operations:</strong> ${step.file_operations.map(f => `${f.file_name} (${f.operation})`).join(', ')}
                    </div>
                ` : ''}
                
                <div class="business-context">
                    <strong>Call Flow:</strong> ${step.business_context || `${step.source} transfers control to ${step.target}`}
                </div>
                
                <div class="call-metadata">
                    <span class="confidence-badge">Confidence: ${Math.round((step.confidence || 0.9) * 100)}%</span>
                    <span class="data-passed-count">Level: ${step.source_level} â†’ ${step.target_level}</span>
                </div>
            </div>
        </div>
    `;
});
    
    html += `
            </div>
        </div>
    `;
}
            
            // Show file operations if available
            const fileNodes = data.flow_visualization.nodes?.filter(n => n.type === 'file') || [];
            if (fileNodes.length > 0) {
                html += `
                    <div class="file-operations-section">
                        <h3>File Operations (${fileNodes.length})</h3>
                        <div class="file-operations-grid">
                `;
                
                fileNodes.forEach(fileNode => {
                    const statusClass = fileNode.has_layout_resolution ? 'has-layout' : 'no-layout';
                    const interfaceIcon = fileNode.interface_type === 'CICS' ? 'CICS' : 'FILE';
                    
                    html += `
                        <div class="file-operation-card ${statusClass}">
                            <div class="file-header">
                                <div class="file-info">
                                    <span class="file-icon">[${interfaceIcon}]</span>
                                    <span class="file-name">${fileNode.label}</span>
                                    <span class="io-direction-badge ${fileNode.io_direction?.toLowerCase() || 'unknown'}">${fileNode.io_direction || 'UNKNOWN'}</span>
                                </div>
                                ${fileNode.has_layout_resolution ? 
                                    '<span class="layout-indicator">Has Layout</span>' : 
                                    '<span class="no-layout-indicator">No Layout</span>'}
                            </div>
                            <div class="file-details">
                                <div class="connected-program">
                                    <strong>Connected to:</strong> ${fileNode.connected_to_program || 'Unknown'}
                                </div>
                                <div class="file-operations">
                                    <strong>Operations:</strong> ${fileNode.operations?.join(', ') || 'READ/WRITE'}
                                </div>
                                <div class="interface-type">
                                    <strong>Interface:</strong> ${fileNode.interface_type || 'FILE'}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Show DB2 operations if available
            const db2Nodes = data.flow_visualization.nodes?.filter(n => n.type === 'db2_table') || [];
            if (db2Nodes.length > 0) {
                html += `
                    <div class="db2-operations-section">
                        <h3>DB2 Operations (${db2Nodes.length})</h3>
                        <div class="file-operations-grid">
                `;
                
                db2Nodes.forEach(db2Node => {
                    html += `
                        <div class="file-operation-card has-layout">
                            <div class="file-header">
                                <div class="file-info">
                                    <span class="file-icon">[DB2]</span>
                                    <span class="file-name">${db2Node.label}</span>
                                    <span class="io-direction-badge ${db2Node.io_direction?.toLowerCase() || 'unknown'}">${db2Node.sql_operation || 'SQL'}</span>
                                </div>
                                <span class="layout-indicator">Database Table</span>
                            </div>
                            <div class="file-details">
                                <div class="connected-program">
                                    <strong>Connected to:</strong> ${db2Node.connected_to_program || 'Unknown'}
                                </div>
                                <div class="file-operations">
                                    <strong>SQL Operation:</strong> ${db2Node.sql_operation || 'UNKNOWN'}
                                </div>
                                <div class="interface-type">
                                    <strong>Interface:</strong> DB2
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            // Show missing programs summary with impact
const missingPrograms = programNodes.filter(p => p.status === 'missing');
if (missingPrograms.length > 0) {
    html += `
        <div class="missing-programs-section">
            <h3>âš ï¸ Missing Programs Impact (${missingPrograms.length})</h3>
            <div class="alert alert-warning">
                <strong>Analysis Incomplete:</strong> ${missingPrograms.length} programs are called but not uploaded, 
                which limits the complete flow analysis.
            </div>
            <div class="missing-programs-grid">
    `;
    
    // Group missing programs by their calling programs
    const missingByCallers = {};
    edges.filter(e => e.type === 'program_call').forEach(edge => {
        const targetProgram = programNodes.find(p => p.id === edge.to);
        if (targetProgram && targetProgram.status === 'missing') {
            if (!missingByCallers[edge.from]) {
                missingByCallers[edge.from] = [];
            }
            missingByCallers[edge.from].push({
                program: edge.to,
                call_type: edge.call_type || 'CALL',
                variable_name: edge.variable_name
            });
        }
    });
    
    Object.entries(missingByCallers).forEach(([caller, missingList]) => {
        missingList.forEach(missing => {
            html += `
                <div class="missing-program-card">
                    <div class="missing-header">
                        <span class="missing-icon">âŒ</span>
                        <span class="program-name">${missing.program}</span>
                        <span class="call-type-badge">${missing.call_type}</span>
                    </div>
                    <div class="missing-details">
                        <div class="called-by">
                            <strong>Called by:</strong> ${caller}
                        </div>
                        ${missing.variable_name ? `
                            <div class="dynamic-call-info">
                                <strong>Dynamic Call via:</strong> <code>${missing.variable_name}</code>
                            </div>
                        ` : ''}
                        <div class="impact-description">
                            This missing program blocks complete flow analysis. File operations and data 
                            transformations in ${missing.program} cannot be analyzed.
                        </div>
                    </div>
                    <div class="missing-actions">
                        <button class="impact-btn" onclick="showMissingProgramImpact('${currentSessionId}', '${missing.program}')">
                            Analyze Impact
                        </button>
                        <button class="upload-btn" onclick="promptProgramUpload('${missing.program}')">
                            Upload Program
                        </button>
                    </div>
                </div>
            `;
        });
    });
    
    html += `
            </div>
            <div class="missing-summary">
                <div class="recommendation-box">
                    <h4>ðŸŽ¯ Recommendations to Complete Analysis</h4>
                    <ul>
                        <li>Upload the missing programs to see complete call chains</li>
                        <li>Missing programs may contain additional file operations and DB2 access</li>
                        <li>Data flow analysis becomes more accurate with complete program set</li>
                        <li>Layout associations and field transformations may be incomplete</li>
                    </ul>
                    <div style="margin-top: 15px;">
                        <strong>Priority Upload Order:</strong>
                        <ol>
                            ${Object.values(missingByCallers).flat().map(m => `<li>${m.program}</li>`).join('')}
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    `;
}
            // Show missing programs summary
            if (data.statistics.missing_programs > 0) {
                html += `
                    <div class="missing-programs-section">
                        <h3>Missing Programs (${data.statistics.missing_programs})</h3>
                        <div class="recommendation-box">
                            <h4>Recommendations</h4>
                            <ul>
                                <li>Upload the missing programs to complete flow analysis</li>
                                <li>Missing programs may contain additional file operations and data transformations</li>
                                <li>Complete program set provides better understanding of the system architecture</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            flowDetails.innerHTML = html;
        } else {
            flowDetails.innerHTML = `
                <div class="flow-summary">
                    <h3>Program Flow: ${programName}</h3>
                    <p>Flow analysis completed. Check the visualization above for program dependencies.</p>
                </div>
            `;
        }
        
    } catch (error) {
        showError(`Error analyzing flow: ${error.message}`);
        console.error('Flow analysis error:', error);
    } finally {
        hideLoadingSpinner();
    }
}

function buildProgramCallChainWithLayouts(programNodes, edges, sessionId) {
    const chainSteps = [];
    const processedEdges = new Set();
    
    edges.forEach(edge => {
        if (edge.type !== 'program_call' || processedEdges.has(`${edge.from}-${edge.to}`)) return;
        
        const sourceProgram = programNodes.find(p => p.id === edge.from);
        let targetProgram = programNodes.find(p => p.id === edge.to);
        
        if (!targetProgram) {
            targetProgram = { id: edge.to, label: edge.to, status: 'missing', level: 999 };
        }
        
        if (sourceProgram) {
            const step = {
                source: edge.from,
                target: edge.to,
                call_type: edge.call_type || 'CALL',
                source_level: sourceProgram.level || 0,
                target_level: targetProgram.level || 999,
                target_status: targetProgram.status || 'missing',
                variable_name: edge.variable_name,
                confidence: edge.confidence_score || 0.9,
                layout_info: [],
                file_operations: [],
                business_context: `${edge.from} calls ${edge.to} using ${edge.call_type || 'CALL'}`
            };
            
            // Add layout information if available
            if (edge.layout_data) {
                step.layout_info = edge.layout_data;
            }
            
            // Add file operations if available
            if (edge.file_operations) {
                step.file_operations = edge.file_operations;
            }
            
            chainSteps.push(step);
            processedEdges.add(`${edge.from}-${edge.to}`);
        }
    });
    
    return chainSteps.sort((a, b) => a.source_level - b.source_level);
}

function openProgramFlowModal(vizData, programName) {
    const modal = document.createElement('div');
    modal.className = 'program-flow-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: white;
        width: 95vw;
        height: 90vh;
        border-radius: 10px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    `;
    
    modalContent.innerHTML = `
        <div class="modal-header" style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        ">
            <h3>Program Flow Analysis: ${programName}</h3>
            <div>
                <button onclick="toggleFlowLayout()" style="
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    padding: 8px 15px;
                    margin-right: 10px;
                    border-radius: 5px;
                    cursor: pointer;
                ">Switch Layout</button>
                <button onclick="closeFlowModal()" style="
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    padding: 8px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 18px;
                ">âœ•</button>
            </div>
        </div>
        <div style="display: flex; height: calc(100% - 70px);">
            <div id="modalFlowVisualization" style="
                flex: 1;
                background: #f9f9f9;
                position: relative;
                overflow: hidden;
            "></div>
            <div id="modalFlowDetails" style="
                width: 400px;
                background: white;
                border-left: 1px solid #ddd;
                overflow-y: auto;
                padding: 20px;
            "></div>
        </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    // Render the flow in modal with better spacing
    renderModalFlowVisualization(vizData, 'modalFlowVisualization');
    renderModalFlowDetails(vizData, 'modalFlowDetails', programName);
    
    // Make modal closable by clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeFlowModal();
        }
    });
}

function closeFlowModal() {
    const modal = document.querySelector('.program-flow-modal');
    if (modal) {
        modal.remove();
    }
}

window.closeFlowModal = closeFlowModal;

function renderModalFlowVisualization(vizData, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    // Create larger SVG for modal
    const svgWidth = 1600;
    const svgHeight = 1000;
    
    const svg = d3.select(container)
        .append('svg')
        .attr('width', '100%')
        .attr('height', '100%')
        .attr('viewBox', `0 0 ${svgWidth} ${svgHeight}`)
        .style('background', '#fafafa');
    
    // Add zoom functionality
    const zoom = d3.zoom()
        .scaleExtent([0.3, 2])
        .on('zoom', function(event) {
            zoomContainer.attr('transform', event.transform);
        });
    
    svg.call(zoom);
    
    const zoomContainer = svg.append('g').attr('class', 'zoom-container');
    
    // Create better spaced layout for modal
    const modalLayout = createModalHierarchicalLayout(vizData, svgWidth, svgHeight);
    
    // Add zoom controls
    addModalZoomControls(container, svg, zoom);
    
    // Draw everything
    const defs = zoomContainer.append('defs');
    createArrowMarkers(defs);
    
    // Draw edges
    const edges = zoomContainer.selectAll('.flow-edge')
        .data(modalLayout.layoutEdges)
        .enter()
        .append('g')
        .attr('class', 'flow-edge');
    
    edges.each(function(d) {
        drawEnhancedEdge(d3.select(this), d);
    });
    
    // Draw nodes
    const nodes = zoomContainer.selectAll('.flow-node')
        .data(modalLayout.layoutNodes)
        .enter()
        .append('g')
        .attr('class', 'flow-node')
        .attr('transform', d => `translate(${d.x},${d.y})`);
    
    nodes.each(function(d) {
        drawEnhancedCustomShape(d3.select(this), d);
    });
    
    // Add interactivity
    addEnhancedInteractivity(nodes, modalLayout.layoutEdges);
}

function createModalHierarchicalLayout(vizData, svgWidth, svgHeight) {
    const nodes = vizData.nodes || [];
    const edges = vizData.edges || [];
    
    const programNodes = nodes.filter(n => n.type === 'program');
    const fileNodes = nodes.filter(n => n.type === 'file');
    const db2Nodes = nodes.filter(n => n.type === 'db2_table');
    
    const layoutNodes = [];
    const levelHeight = 200; // More space between levels
    
    // Build program hierarchy
    const startingProgram = programNodes.find(n => n.is_starting_program) || programNodes[0];
    const programLevels = buildProgramHierarchyWithMissing(programNodes, edges, startingProgram);
    
    // Position programs with more space
    Object.entries(programLevels).forEach(([level, programs]) => {
        const levelNum = parseInt(level);
        const yPosition = 100 + (levelNum * levelHeight);
        const spacing = Math.min(280, (svgWidth - 300) / Math.max(programs.length, 1));
        const startX = (svgWidth - (programs.length - 1) * spacing) / 2;
        
        programs.forEach((program, index) => {
            layoutNodes.push({
                ...program,
                x: startX + (index * spacing),
                y: yPosition,
                level: levelNum,
                width: 140,
                height: 70
            });
        });
    });
    
    // Position files in multiple rows to avoid overlap
    const maxProgramLevel = Math.max(...Object.keys(programLevels).map(Number));
    const dataStartY = 100 + ((maxProgramLevel + 1) * levelHeight);
    
    const nodeConnections = {};
    edges.forEach(edge => {
        if (edge.type === 'file_operation' || edge.type === 'db2_operation') {
            if (!nodeConnections[edge.from]) {
                nodeConnections[edge.from] = [];
            }
            nodeConnections[edge.from].push(edge.to);
        }
    });
    
    // Group files by rows to prevent overlap
    const allDataNodes = [...fileNodes, ...db2Nodes];
    const filesPerRow = Math.ceil(Math.sqrt(allDataNodes.length));
    let fileIndex = 0;
    
    allDataNodes.forEach((node) => {
        let connectedProgram = null;
        let programPosition = null;
        
        for (const [progName, connections] of Object.entries(nodeConnections)) {
            if (connections.includes(node.id)) {
                connectedProgram = progName;
                programPosition = layoutNodes.find(n => n.id === progName);
                break;
            }
        }
        
        let xPosition, yPosition;
        if (programPosition) {
            const siblingsCount = nodeConnections[connectedProgram].length;
            const siblingIndex = nodeConnections[connectedProgram].indexOf(node.id);
            
            if (siblingsCount <= 3) {
                // Small groups: spread horizontally under program
                const spacing = 150;
                xPosition = programPosition.x - ((siblingsCount - 1) * spacing) / 2 + (siblingIndex * spacing);
                yPosition = dataStartY;
            } else {
                // Large groups: arrange in grid pattern
                const cols = Math.ceil(Math.sqrt(siblingsCount));
                const row = Math.floor(siblingIndex / cols);
                const col = siblingIndex % cols;
                xPosition = programPosition.x - ((cols - 1) * 130) / 2 + (col * 130);
                yPosition = dataStartY + (row * 80);
            }
        } else {
            // Unconnected nodes: arrange in grid on the right
            const row = Math.floor(fileIndex / 3);
            const col = fileIndex % 3;
            xPosition = svgWidth - 300 + (col * 120);
            yPosition = dataStartY + (row * 80);
            fileIndex++;
        }
        
        layoutNodes.push({
            ...node,
            x: xPosition,
            y: yPosition,
            level: maxProgramLevel + 2,
            width: 110,
            height: 60,
            connected_to_program: connectedProgram
        });
    });
    
    // Create edges
    const layoutEdges = [];
    edges.forEach(edge => {
        const source = layoutNodes.find(n => n.id === edge.from);
        const target = layoutNodes.find(n => n.id === edge.to);
        if (source && target) {
            layoutEdges.push({ ...edge, source, target });
        }
    });
    
    return { layoutNodes, layoutEdges };
}
function addModalZoomControls(container, svg, zoom) {
    const controls = d3.select(container)
        .append('div')
        .style('position', 'absolute')
        .style('top', '15px')
        .style('left', '15px')
        .style('z-index', '100');
    
    const buttonStyle = `
        background: #667eea;
        color: white;
        border: none;
        padding: 8px 12px;
        margin: 2px;
        border-radius: 5px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    `;
    
    controls.append('button')
        .attr('style', buttonStyle)
        .text('ðŸ”+')
        .on('click', function() {
            svg.transition().call(zoom.scaleBy, 1.3);
        });
    
    controls.append('button')
        .attr('style', buttonStyle)
        .text('ðŸ”-')
        .on('click', function() {
            svg.transition().call(zoom.scaleBy, 0.7);
        });
    
    controls.append('button')
        .attr('style', buttonStyle)
        .text('â†» Reset')
        .on('click', function() {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        });
    
    controls.append('button')
        .attr('style', buttonStyle)
        .text('ðŸŽ¯ Fit')
        .on('click', function() {
            const bounds = svg.select('.zoom-container').node().getBBox();
            const parent = svg.node().parentNode;
            const fullWidth = parent.clientWidth;
            const fullHeight = parent.clientHeight;
            const width = bounds.width;
            const height = bounds.height;
            const midX = bounds.x + width / 2;
            const midY = bounds.y + height / 2;
            const scale = Math.min(fullWidth / width, fullHeight / height) * 0.9;
            const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];
            
            svg.transition().call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        });
}

// Add these helper functions for better interaction
function viewLayoutFieldDetails(layoutName) {
    // Open a detailed modal for layout fields
    fetch(`/api/layout-field-details/${currentSessionId}/${layoutName}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showLayoutFieldDetailsModal(data.layout_details);
            }
        })
        .catch(error => console.error('Error loading layout details:', error));
}

function showLayoutFieldDetailsModal(layoutDetails) {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 1200px;">
            <div class="modal-header">
                <h3>ðŸ“‹ Layout Fields: ${layoutDetails.layout_name}</h3>
                <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="layout-field-details">
                    <div class="layout-summary">
                        <h4>${layoutDetails.friendly_name}</h4>
                        <p>${layoutDetails.business_purpose}</p>
                        <div class="field-statistics">
                            <span>Total Fields: ${layoutDetails.fields.length}</span>
                            <span>Usage Context: ${layoutDetails.usage_context}</span>
                        </div>
                    </div>
                    
                    <div class="fields-table">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Data Type</th>
                                    <th>Usage</th>
                                    <th>Business Purpose</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${layoutDetails.fields.map(field => `
                                    <tr>
                                        <td><strong>${field.field_name}</strong></td>
                                        <td><code>${field.data_type}</code></td>
                                        <td><span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type}</span></td>
                                        <td>${field.business_purpose}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
function renderProgramChainWithDetails(programChain) {
    let html = `
        <div class="program-chain-section">
            <h3>ðŸ“ž Program Call Chain & Data Flow</h3>
            <div class="program-chain-list">
    `;
    
    programChain.forEach((step, index) => {
        const statusClass = step.status === 'MISSING' ? 'missing-program' : 'available-program';
        const callIcon = getCallTypeIcon(step.call_type);
        
        html += `
            <div class="program-chain-item ${statusClass}">
                <div class="chain-sequence">#${step.sequence}</div>
                <div class="chain-flow-details">
                    <div class="program-call-header">
                        <span class="source-program">${step.source_program}</span>
                        <span class="call-arrow">${callIcon} ${step.call_type}</span>
                        <span class="target-program">${step.target_program}</span>
                        ${step.status === 'MISSING' ? 
                            '<span class="missing-indicator">âŒ MISSING</span>' : 
                            '<span class="available-indicator">âœ… AVAILABLE</span>'}
                    </div>
                    
                    ${step.variable_name ? `
                        <div class="dynamic-call-info">
                            <strong>Dynamic Call:</strong> Variable <code>${step.variable_name}</code>
                            <div class="resolution-details">Resolved at runtime based on business logic</div>
                        </div>
                    ` : ''}
                    
                    ${step.business_context ? `
                        <div class="business-context">
                            <strong>Business Purpose:</strong> ${step.business_context}
                        </div>
                    ` : ''}
                    
                    <div class="call-metadata">
                        <span class="confidence-badge">Confidence: ${Math.round(step.confidence * 100)}%</span>
                        <span class="data-passed-count">Fields Passed: ${step.data_passed_count || 0}</span>
                        <span class="layout-count">Layouts: ${step.layout_associations_count || 0}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

function showFieldFlowModal(fieldJourney) {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="width: 80%; max-width: 1000px;">
            <div class="modal-header">
                <h3>ðŸ”„ Field Flow Journey: ${fieldJourney.field_name}</h3>
                <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="field-journey-visualization">
                    <div class="journey-summary">
                        <strong>Programs Involved:</strong> ${fieldJourney.programs_involved.join(' â†’ ')}
                    </div>
                    <div class="flow-steps-detailed">
                        ${fieldJourney.flow_steps.map((step, index) => `
                            <div class="detailed-flow-step">
                                <div class="step-number">${step.sequence}</div>
                                <div class="step-content">
                                    <div class="programs">${step.source_program} â†’ ${step.target_program}</div>
                                    <div class="transformation">${step.transformation}</div>
                                    <div class="mechanism">${step.call_mechanism}</div>
                                </div>
                                ${index < fieldJourney.flow_steps.length - 1 ? '<div class="step-arrow">â†“</div>' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}


        function showNodeDetails(node, vizData) {
            const modal = document.createElement('div');
            modal.className = 'node-details-modal';
            
            let content = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${node.label} Details</h3>
                        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="node-info">
                            <p><strong>Type:</strong> ${node.type}</p>
                            <p><strong>Status:</strong> ${node.status}</p>
            `;
            
            if (node.type === 'program') {
                if (node.status === 'missing') {
                    content += `
                        <div class="missing-program-info">
                            <p class="missing-notice">This program is missing from the analysis.</p>
                            <button onclick="showMissingProgramImpact('${sessionId}', '${node.id}')" 
                                    class="impact-analysis-btn">View Impact Analysis</button>
                        </div>
                    `;
                } else {
                    content += `
                        <div class="program-actions">
                            <button onclick="viewProgramSource('${sessionId}', '${node.id}')" 
                                    class="view-source-btn">View Source Code</button>
                            <button onclick="analyzeProgram('${sessionId}', '${node.id}')" 
                                    class="analyze-btn">Analyze Program</button>
                        </div>
                    `;
                }
            } else if (node.type === 'file') {
                content += `
                    <p><strong>Interface:</strong> ${node.interface}</p>
                    <p><strong>I/O Direction:</strong> ${node.io_direction}</p>
                    <p><strong>Has Layout:</strong> ${node.has_layout ? 'Yes' : 'No'}</p>
                `;
            }
            
            content += `
                        </div>
                    </div>
                </div>
            `;
            
            modal.innerHTML = content;
            document.body.appendChild(modal);
        }

        async function showMissingProgramImpact(sessionId, programName) {
            try {
                const response = await fetch(`/api/missing-program-impact/${sessionId}/${programName}`);
                const data = await response.json();
                
                if (data.success) {
                    const impact = data.impact_analysis;
                    
                    const modal = document.createElement('div');
                    modal.className = 'impact-modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Impact Analysis: ${impact.missing_program}</h3>
                                <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
                            </div>
                            <div class="modal-body">
                                <div class="impact-summary">
                                    <p><strong>Impact:</strong> ${impact.impact_description}</p>
                                </div>
                                <div class="calling-programs">
                                    <h4>Programs that call ${impact.missing_program}:</h4>
                                    <ul>
                                        ${impact.calling_programs.map(prog => `<li>${prog}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="recommendations">
                                    <h4>Recommendations:</h4>
                                    <ul>
                                        ${impact.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="upload-hint">
                                    <p class="highlight">Upload ${impact.missing_program} to restore complete flow analysis</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                }
            } catch (error) {
                showError(`Error getting impact analysis: ${error.message}`);
            }
        }

        async function traceFieldFlow(sessionId, fieldName) {
            try {
                const response = await fetch(`/api/field-flow-trace/${sessionId}/${fieldName}`);
                const data = await response.json();
                
                if (data.success) {
                    const journey = data.field_journey;
                    
                    const modal = document.createElement('div');
                    modal.className = 'field-trace-modal';
                    
                    let flowStepsHtml = '';
                    journey.flow_steps.forEach((step, index) => {
                        flowStepsHtml += `
                            <div class="flow-step">
                                <div class="step-number">${step.sequence}</div>
                                <div class="step-content">
                                    <div class="step-programs">
                                        ${step.source_program} â†’ ${step.target_program}
                                    </div>
                                    <div class="step-type">${step.flow_type}</div>
                                    <div class="step-transformation">${step.transformation}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Field Flow Trace: ${journey.field_name}</h3>
                                <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
                            </div>
                            <div class="modal-body">
                                <div class="field-journey">
                                    <div class="journey-summary">
                                        <p><strong>Programs Involved:</strong> ${journey.programs_involved.join(' â†’ ')}</p>
                                    </div>
                                    <div class="flow-steps">
                                        <h4>Flow Steps:</h4>
                                        ${flowStepsHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                } else {
                    showError(data.message || 'No flow data found for this field');
                }
            } catch (error) {
                showError(`Error tracing field: ${error.message}`);
            }
        }

      // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced Code Analyzer initialized');
        });
    </script>
</body>
</html>   