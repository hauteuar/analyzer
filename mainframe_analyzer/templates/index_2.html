<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Code Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            overflow-x: hidden;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-metrics {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .metric-label {
            opacity: 0.8;
            font-size: 0.8rem;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 1rem;
            padding: 1rem;
            min-height: calc(100vh - 100px);
        }

        /* Left Panel */
        .left-panel {
            width: 420px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
            height: fit-content;
            transition: all 0.3s ease;
        }

        .left-panel.collapsed {
            display: none;
        }

        .panel-restore {
            position: fixed;
            top: 50%;
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            transform: translateY(-50%);
            z-index: 1001;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .panel-restore:hover {
            background: #5a6fd8;
            transform: translateY(-50%) scale(1.1);
        }

        .panel-restore.left {
            left: 0;
        }

        .panel-restore.right {
            right: 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
        }

        .collapse-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        .collapse-btn:hover {
            transform: scale(1.1);
        }

        /* Upload Section */
        .upload-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9ff;
            border-radius: 8px;
            border: 2px dashed #667eea;
        }

        .upload-area {
            text-align: center;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #e8ecff;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f1f3f4;
            color: #667eea;
            border: 1px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* Main Content */
        .content-area {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-btn:hover:not(.active) {
            background: #e9ecef;
        }

        /* Tab Content */
        .tab-content {
            padding: 2rem;
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Enhanced Component Summaries */
        .component-summaries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .component-summary-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .component-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .component-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }

        .component-type {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: auto;
        }

        .business-purpose {
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 1rem;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .raw-analysis {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .component-metrics {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            min-width: 60px;
        }

        .metric-value {
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            font-size: 0.7rem;
            color: #6c757d;
            text-align: center;
        }

        .complexity-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .complexity-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            transition: width 0.3s ease;
        }

        .derived-components {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .derived-toggle {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .derived-toggle:hover {
            background: #5a6fd8;
        }

        .derived-list {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9ff;
            border-radius: 6px;
            border: 1px solid #e8ecff;
        }

        .derived-list.show {
            display: block;
        }

        .derived-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }

        .derived-item-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .derived-item-type {
            font-size: 0.75rem;
            background: #e8ecff;
            color: #667eea;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        /* Enhanced Dependency Flow */
        .dependency-flow-container {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 2rem;
            min-height: 600px;
        }

        .dependency-controls {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dependency-flow {
            display: flex;
            flex-direction: column;
            gap: 4rem;
            position: relative;
        }
        
        .dependency-status-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .status-card {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .status-present {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .status-missing {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .status-file {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .status-unknown {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .status-count {
            font-size: 2rem;
            font-weight: bold;
        }

        .status-label {
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .dependency-section {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dependency-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .dependency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .dependency-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
            transition: all 0.3s ease;
            position: relative;
        }

        .dependency-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dependency-card.status-present {
            border-left: 4px solid #28a745;
            background: #f8fff9;
        }

        .dependency-card.status-missing {
            border-left: 4px solid #dc3545;
            background: #fff8f8;
        }

        .dependency-card.status-file {
            border-left: 4px solid #007bff;
            background: #f8f9ff;
        }

        .dependency-card.status-unknown {
            border-left: 4px solid #6c757d;
            background: #f8f9fa;
        }

        .dependency-header {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .dependency-details {
            font-size: 0.9rem;
        }

        .dependency-details p {
            margin: 6px 0;
            display: flex;
            justify-content: space-between;
        }

        .confidence-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        .confidence-low { background: #f8d7da; color: #721c24; }

        .alert {
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 8px;
            position: relative;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        /* Enhanced Flow Visualization Styles */
        .flow-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .flow-node:hover {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .flow-edge {
            transition: all 0.3s ease;
        }

        .flow-edge:hover {
            stroke-width: 3;
        }

        .node-program { fill: #4a90e2; stroke: #2c5aa0; }
        .node-program-main { fill: #1a73e8; stroke: #0d47a1; }
        .node-program-called { fill: #64b5f6; stroke: #1976d2; }
        .node-program-missing { fill: #ffcdd2; stroke: #d32f2f; stroke-dasharray: 5,5; }
        .node-file { fill: #4caf50; stroke: #2e7d32; }
        .node-db2 { fill: #ff9800; stroke: #f57c00; }

        
        .node-cics { fill: #9c27b0; stroke: #6a1b9a; }

        .edge-call { stroke: #2196f3; }
        .edge-xctl { stroke: #ff5722; }
        .edge-link { stroke: #4caf50; }
        .edge-dynamic { stroke: #9c27b0; stroke-dasharray: 8,4; }
        .edge-file-read { stroke: #4caf50; }
        .edge-file-write { stroke: #ff9800; }
        .edge-file-update { stroke: #2196f3; }

         .flow-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            max-width: 200px;
            z-index: 100;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-symbol {
            width: 20px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
        }

        .sequence-label {
            font-size: 10px;
            fill: white;
            text-anchor: middle;
            font-weight: bold;
        }
        .flow-level {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            position: relative;
            min-height: 140px;
        }

        .flow-level-title {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .flow-component {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 200px;
            max-width: 280px;
            text-align: center;
            position: relative;
        }

        .flow-component:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .flow-component.input-source {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .flow-component.core-program {
            border-color: #667eea;
            background: linear-gradient(135deg, #e8ecff 0%, #ffffff 100%);
        }

        .flow-component.called-program {
            border-color: #fd7e14;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .flow-component.input-output-file {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%);
        }

        .flow-component.output-file {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%);
        }

        .flow-component.missing-dependency {
            border-color: #dc3545;
            border-style: dashed;
            background: linear-gradient(135deg, #f8d7da 0%, #ffffff 100%);
            opacity: 0.8;
        }

        .flow-component.present-program {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .flow-component.file-with-layout {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .flow-component.file-only {
            border-left: 4px solid #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .component-name {
            font-weight: bold;
            font-size: 1rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .component-type-badge {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .component-description {
            font-size: 0.8rem;
            color: #6c757d;
            line-height: 1.3;
        }

        .flow-arrow {
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            margin: 1rem auto;
        }

        .program-call-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem;
        }

        .call-arrow {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #667eea;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .program-call-arrows {
            animation: pulse 2s infinite;
        }

        .call-arrow-indicator {
            color: #667eea;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .program-chain-section {
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .program-chain-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }
    
    .program-chain-item.missing-program {
        background: #fff3cd;
        border-color: #ffeaa7;
    }
    
    .program-chain-item.available-program {
        background: #d4edda;
        border-color: #c3e6cb;
    }
    
    .chain-sequence {
        background: #667eea;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
    }
    
    .chain-flow {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .source-program, .target-program {
        background: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .call-arrow {
        color: #667eea;
        font-weight: bold;
    }
    
    .missing-indicator {
        background: #dc3545;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
    }
    
    .dynamic-info {
        font-size: 0.85rem;
        color: #9c27b0;
        font-style: italic;
        margin-top: 4px;
    }
    
    .business-context {
        font-size: 0.85rem;
        color: #666;
        margin-top: 4px;
    }
    
    .file-operation-item .connected-program {
        background: #e8ecff;
        color: #667eea;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
        margin-left: 10px;
    }
    
    .layout-info {
        font-size: 0.75rem;
        color: #28a745;
        margin-left: 4px;
    }
    
    .flow-business-summary {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #667eea;
        margin-bottom: 15px;
    }
    
    .flow-statistics {
        display: flex;
        gap: 20px;
        margin-top: 15px;
    }
    
    .stat-item {
        text-align: center;
        padding: 10px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-value {
        display: block;
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 4px;
    }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f3f4;
        }

        .data-table tbody tr:hover {
            background: #f8f9ff;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .badge-primary {
            color: #fff;
            background-color: #667eea;
        }

        .badge-success {
            color: #fff;
            background-color: #28a745;
        }

        .badge-warning {
            color: #212529;
            background-color: #ffc107;
        }

        .badge-danger {
            color: #fff;
            background-color: #dc3545;
        }

        .badge-info {
            color: #fff;
            background-color: #17a2b8;
        }

        .badge-secondary {
            color: #fff;
            background-color: #6c757d;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            min-width: 400px;
            max-width: 500px;
        }

        .analysis-step {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .analysis-step.completed {
            background: #d4edda;
            color: #155724;
        }

        .analysis-step.current {
            background: #d1ecf1;
            color: #0c5460;
            font-weight: 500;
        }

        .step-icon {
            margin-right: 0.5rem;
            font-size: 1rem;
        }

        .analysis-step.completed .step-icon::before {
            content: 'âœ…';
        }

        .analysis-step.current .step-icon::before {
            content: 'ðŸ”„';
        }

        /* Chat Panel */
        .right-panel {
            width: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
            transition: all 0.3s ease;
        }

        .right-panel.collapsed {
            display: none;
        }

        /* Modal Styles */
        /* Modal Styles */
        .modal {
            display: none !important; /* Force hidden by default */
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: block !important;
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 700px;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-help {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .connection-status {
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .connection-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status.testing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .server-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .server-info h5 {
            margin: 0 0 0.5rem 0;
            color: #667eea;
        }

        .server-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .btn-test {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .btn-test:hover {
            transform: translateY(-1px);
        }

        .btn-test:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .test-results {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
        }

        .test-results h6 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }

        .test-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-testing { background-color: #ffc107; }

        .chat-header {
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: white;
            border: 1px solid #e9ecef;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            background: white;
            border-radius: 0 0 10px 10px;
        }

        .chat-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .chat-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }

        .token-counter {
            font-size: 0.8rem;
            color: #666;
        }

        /* Field Matrix and Mapping styles */
        .field-mapping-controls, .field-matrix-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .field-mapping-controls input, .field-matrix-controls select {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .field-mapping-table, .field-matrix-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

                /* DB2 Table Styles */
        .flow-component.db2-input-table {
            border-color: #007bff;
            background: linear-gradient(135deg, #cce5ff 0%, #ffffff 100%);
        }

        .flow-component.db2-output-table {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .flow-component.db2-io-table {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .db2-operations {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .sql-operation {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            margin: 0.1rem;
        }


        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: #6c757d;
        }

        .program-flow-container {
        padding: 20px;
    }
    
    .flow-controls {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .flow-controls input, .flow-controls button {
            padding: 8px 16px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .flow-controls button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }
    
    
    
    .flow-visualization {
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 20px;
    height: 800px;
    overflow-x: auto;
    overflow-y: auto;
    width: 100%;
    max-width: 100%;
    background: #f9f9f9;
}

.flow-visualization svg {
    width: 1400px;
    height: 1200px;  /* Increased from 1000px */
    display: block;
}


    .flow-details {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 5px;
    }
    
    .flow-summary-section h3,
    .missing-programs-section h3,
    .field-flows-section h3,
    .file-operations-section h3 {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
        margin-bottom: 15px;
    }
    
    .missing-program-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 3px;
    }
    
    .missing-program-item .program-name {
        font-weight: bold;
        margin-right: 10px;
    }
    
    .missing-program-item .impact-btn {
        margin: 0 10px;
        padding: 5px 10px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    
    .missing-program-item .upload-hint {
        color: #856404;
        font-style: italic;
    }
    
    .field-flow-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 3px;
    }
    
    .field-flow-item .field-name {
        font-weight: bold;
        margin-right: 15px;
        min-width: 120px;
    }
    
    .field-flow-item .field-flow-path {
        flex: 1;
        margin-right: 10px;
    }
    
    .field-flow-item .trace-btn {
        padding: 5px 10px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    
    .file-operation-item {
        padding: 10px;
        margin: 5px 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 3px;
    }
    
    .file-operation-item.has-layout {
        border-left: 4px solid #28a745;
    }
    
    .file-operation-item.no-layout {
        border-left: 4px solid #ffc107;
    }
    
    .file-info {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .file-name {
        font-weight: bold;
        margin-right: 10px;
    }
    
    .io-direction {
        color: #6c757d;
        margin-right: 10px;
    }
    
    .layout-indicator {
        background: #28a745;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .enhanced-node-details {
        padding: 15px;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 10px;
    }

    .detail-grid div {
        padding: 5px;
        background: #f5f5f5;
        border-radius: 4px;
    }

    .status-present { color: #4caf50; font-weight: bold; }
    .status-missing { color: #f44336; font-weight: bold; }
    .status-file { color: #2196f3; font-weight: bold; }
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: white;
        border-radius: 5px;
        max-width: 80%;
        max-height: 80%;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #ddd;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
    }
    
    .close-btn:hover {
        color: #333;
    }
    
    .highlight {
        background: #fff3cd;
        padding: 10px;
        border-radius: 3px;
        font-weight: bold;
    }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                width: 100%;
                max-width: none;
            }

            .right-panel {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 2% auto;
                width: 95%;
            }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">Enhanced Code Analyzer</div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openConfigModal()">LLM Config</button>
            </div>
            <div class="header-metrics">
                <div class="metric-item">
                    <span class="metric-value" id="totalComponents">0</span>
                    <span class="metric-label">Components</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalPrograms">0</span>
                    <span class="metric-label">Programs</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalFields">0</span>
                    <span class="metric-label">Fields</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalTokens">0</span>
                    <span class="metric-label">Tokens Used</span>
                </div>
            </div>
        </div>
    </div>

    <!-- LLM Configuration Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">VLLM Server Configuration</h3>
                <button class="close" onclick="closeConfigModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="llmConfigForm">
                    <div class="form-group">
                        <label class="form-label" for="llmEndpoint">VLLM Server Endpoint</label>
                        <input type="url" id="llmEndpoint" class="form-input" 
                               placeholder="http://192.168.1.100:8100/generate"
                               value="http://localhost:8100/generate">
                        <div class="form-help">Enter the full URL to your VLLM server's /generate endpoint</div>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="maxTokens">Max Tokens per Call</label>
                            <input type="number" id="maxTokens" class="form-input" 
                                   value="6000" min="1000" max="32000" step="500">
                            <div class="form-help">Maximum tokens for each LLM request</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="temperature">Temperature</label>
                            <input type="number" id="temperature" class="form-input" 
                                   value="0.1" min="0" max="2" step="0.1">
                            <div class="form-help">Creativity level (0.0 = deterministic, 2.0 = creative)</div>
                        </div>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="timeout">Request Timeout (seconds)</label>
                            <input type="number" id="timeout" class="form-input" 
                                   value="60" min="10" max="300" step="5">
                            <div class="form-help">How long to wait for LLM response</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="retries">Max Retries</label>
                            <input type="number" id="retries" class="form-input" 
                                   value="3" min="1" max="5" step="1">
                            <div class="form-help">Number of retry attempts on failure</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn-test" onclick="testLLMConnection()" id="testButton">
                            Test Connection
                        </button>
                    </div>

                    <div id="connectionStatus" class="connection-status" style="display: none;">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="statusMessage"></span>
                    </div>

                    <div id="serverInfo" class="server-info" style="display: none;">
                        <h5>Server Information</h5>
                        <div class="server-info-item">
                            <span>Model:</span>
                            <span id="modelName">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Max Context Length:</span>
                            <span id="contextLength">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Response Time:</span>
                            <span id="responseTime">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Status:</span>
                            <span id="serverStatus">-</span>
                        </div>
                    </div>

                    <div id="testResults" class="test-results" style="display: none;">
                        <h6>Test Results</h6>
                        <div class="test-detail">
                            <span>Endpoint Reachable:</span>
                            <span id="endpointStatus">-</span>
                        </div>
                        <div class="test-detail">
                            <span>Response Format:</span>
                            <span id="responseFormat">-</span>
                        </div>
                        <div class="test-detail">
                            <span>Token Generation:</span>
                            <span id="tokenGeneration">-</span>
                        </div>
                        <div class="test-detail">
                            <span>Model Compatibility:</span>
                            <span id="modelCompatibility">-</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">Reset to Defaults</button>
                <button type="button" class="btn btn-secondary" onclick="closeConfigModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveLLMConfig()">Save & Apply</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel -->
        <div class="left-panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-title">Component Dashboard</div>
                <button class="collapse-btn" onclick="togglePanel('left')">â—€</button>
            </div>

            <div class="panel-content">
                <!-- Upload Section -->
                <div class="upload-section">
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;">ðŸ“</div>
                        <div>Click to upload COBOL files</div>
                        <small class="text-muted">Supports .cbl, .cob, .cpy, .jcl files</small>
                    </div>
                    <input type="file" id="fileInput" class="file-input" multiple 
                           accept=".cbl,.cob,.cpy,.jcl,.txt" onchange="handleFileUpload(event)">
                </div>

                <!-- Session Info -->
                <div class="session-info" style="margin-bottom: 2rem;">
                    <h4>Session Overview</h4>
                    <div id="sessionStats">
                        <p>Project: <span id="projectName">New Project</span></p>
                        <p>Session ID: <span id="sessionId">Not started</span></p>
                    </div>
                </div>

                <!-- Components List -->
                <div class="components-list">
                    <h4>Components</h4>
                    <div id="componentsList">
                        <p class="text-muted">No components uploaded yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard Overview</button>
                <button class="tab-btn" onclick="showTab('components')">Components Library</button>
                <button class="tab-btn" onclick="showTab('dependencies')">Dependencies Flow</button>
                <button class="tab-btn" onclick="showTab('fieldMatrix')">Field Matrix</button>
                <button class="tab-btn" onclick="showTab('fieldMapping')">Field Mapping Analysis</button>
                <button class="tab-btn" onclick="showTab('program-flow')">Program Flow</button>
            </div>

            <!-- Tab Contents -->
            <div class="tab-content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-pane active">
                    <h2>Project Dashboard</h2>
                    
                    <!-- Summary Cards -->
                    <div class="dashboard-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 2rem;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Analysis Status</h3>
                            <p id="analysisStatus">Ready for upload</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>Parsed Programs: <span id="parsedPrograms">0</span></div>
                                <div>Record Layouts: <span id="recordLayouts">0</span></div>
                                <div>CICS Files: <span id="cicsFiles">0</span></div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Processing Queue</h3>
                            <p id="processingQueue">0 files in queue</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>Token Usage: <span id="dashTokenUsage">0</span></div>
                                <div>LLM Calls: <span id="llmCalls">0</span></div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Success Rate</h3>
                            <p id="successRate">100%</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>Complexity Avg: <span id="avgComplexity">N/A</span></div>
                                <div>Confidence: <span id="avgConfidence">N/A</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Component Summaries -->
                    <div style="margin-top: 2rem;">
                        <h3>Component Analysis Summary</h3>
                        <div id="componentSummaries" class="component-summaries">
                            <p class="text-muted">Upload COBOL files to see AI-generated business summaries</p>
                        </div>
                    </div>
                </div>

                <!-- Components Library Tab -->
                <div id="components" class="tab-pane">
                    <h2>Components Library</h2>
                    
                    <!-- Filter Controls -->
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                        <select id="componentTypeFilter" onchange="filterComponents()">
                            <option value="">All File Types</option>
                            <option value="PROGRAM">Programs Only</option>
                            <option value="COPYBOOK">Copybooks Only</option>
                            <option value="JCL">JCL Only</option>
                        </select>
                        <input type="text" id="componentSearchFilter" placeholder="Search components..." onkeyup="filterComponents()" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <select id="componentViewFilter" onchange="filterComponents()">
                            <option value="">All Components</option>
                            <option value="analyzed">Analyzed Components</option>
                            <option value="extracted">Extracted Components</option>
                        </select>
                    </div>

                    <div id="componentsTable">
                        <div class="component-section">
                            <h4>Uploaded Files & Discovered Components</h4>
                            <p class="text-muted">Click on any file to expand and view its discovered components</p>
                            
                            <div id="mainComponentsView" style="margin-top: 1rem;">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dependencies Flow Tab -->
                <div id="dependencies" class="tab-pane">
                    <h2>Dependencies Flow</h2>
                    
                    <!-- Dependency Controls -->
                    <div class="dependency-controls">
                        <label for="dependencyComponentSelect" style="font-weight: 600;">View Dependencies For:</label>
                        <select id="dependencyComponentSelect" onchange="loadDependencyFlow()" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
                            <option value="">Overall System View</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshDependencyFlow()">Refresh</button>
                        <button class="btn btn-secondary" onclick="loadEnhancedDependencies()" id="enhancedViewBtn">Load Enhanced View</button>
                        <button class="btn btn-secondary" onclick="restoreNormalView()" id="normalViewBtn" style="display: none;">Restore Normal View</button>
                    </div>

                    <!-- Dependency Status Summary -->
                    <div id="dependencyStatusSummary" class="dependency-status-summary" style="display: none;">
                        <div class="status-card status-present">
                            <div class="status-count" id="present-count">0</div>
                            <div class="status-label">Present Programs</div>
                        </div>
                        <div class="status-card status-missing">
                            <div class="status-count" id="missing-count">0</div>
                            <div class="status-label">Missing Programs</div>
                        </div>
                        <div class="status-card status-file">
                            <div class="status-count" id="file-count">0</div>
                            <div class="status-label">Files & CICS</div>
                        </div>
                        <div class="status-card status-unknown">
                            <div class="status-count" id="unknown-count">0</div>
                            <div class="status-label">Unknown</div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Dependencies Container -->
                    <div id="enhancedDependenciesContainer" style="display: none;"></div>
                    
                    <!-- Original Dependency Flow Container -->
                    <div id="dependenciesVisualization">
                        <div class="dependency-flow-container">
                            <div id="dependencyFlowContent">
                                <p class="text-muted">Upload and analyze COBOL programs to see system architecture flow</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Field Matrix Tab -->
                <div id="fieldMatrix" class="tab-pane">
                    <h2>Field Matrix</h2>
                    <div class="field-matrix-controls">
                        <select id="recordLayoutSelect" onchange="loadFieldMatrix()">
                            <option value="">Select Record Layout</option>
                        </select>
                        <select id="programSelect" onchange="loadFieldMatrix()">
                            <option value="">Select Program</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadFieldMatrix()">Refresh Matrix</button>
                    </div>
                    <div id="fieldMatrixTable">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Usage Type</th>
                                    <th>Source Field</th>
                                    <th>Business Purpose</th>
                                    <th>Program</th>
                                    <th>Line #</th>
                                </tr>
                            </thead>
                            <tbody id="fieldMatrixTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No field data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Field Mapping Analysis Tab -->
                <div id="fieldMapping" class="tab-pane">
                    <h2>Field Mapping Analysis</h2>
                    <div class="field-mapping-controls">
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="targetFileInput" placeholder="Enter target file name (e.g., CUSTOMER-FILE)" style="flex: 1; min-width: 200px;">
                            <select id="recordLayoutSelector" onchange="updateTargetFileFromLayout()" style="min-width: 200px;">
                                <option value="">Or select a record layout</option>
                            </select>
                            <button class="btn btn-primary" onclick="analyzeFieldMapping()">Analyze Field Mapping</button>
                            <button class="btn btn-secondary" onclick="exportFieldMappings()">Export to CSV</button>
                        </div>
                    </div>

                    <!-- Layout Summary Section -->
                    <div id="layoutSummarySection" style="display: none; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <h4>Layout Summary</h4>
                        <div id="layoutSummaryContent"></div>
                    </div>
                    
                    <div id="fieldMappingResults">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Mainframe Type & Length</th>
                                    <th>Oracle Type & Length</th>
                                    <th>Population Source</th>
                                    <th>Business Logic</th>
                                    <th>Programs Involved</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fieldMappingTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Enter a target file name or select a layout and click Analyze</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Field Details Modal -->
                <div id="fieldDetailsModal" class="modal">
                    <div class="modal-content" style="width: 80%; max-width: 900px;">
                        <div class="modal-header">
                            <h3 class="modal-title" id="fieldModalTitle">Field Details</h3>
                            <button class="close" onclick="closeFieldDetailsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="fieldDetailsContent">
                                <!-- Will be populated with field details -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeFieldDetailsModal()">Close</button>
                        </div>
                    </div>
                </div>
            
                <!-- Program Flow -->
                <div id="program-flow" class="tab-pane" >
                    <div class="program-flow-container">
                        <div class="flow-controls">
                            <input type="text" id="startingProgram" placeholder="Enter program name (e.g., TMSTMPM4)" value="TMSTMPM4">
                            <button onclick="renderSampleFlow()">Analyze Program Flow</button>
                        </div>
                        
                        <div id="flowVisualization" class="flow-visualization">
                            <!-- Flow diagram will be rendered here -->
                        </div>
                        
                        <div id="flowDetails" class="flow-details">
                            <div class="flow-summary"></div>
                            <div class="missing-programs"></div>
                            <div class="field-flows"></div>
                            <div class="file-operations"></div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Right Panel - Chat -->
        <div class="right-panel" id="rightPanel">
            <div class="chat-header">
                <div>AI Assistant</div>
                <button class="collapse-btn" onclick="togglePanel('right')" style="background: none; border: none; color: white; font-size: 1.2rem;">â–¶</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message assistant">
                    <p>Hello! I'm your mainframe analysis assistant. I can help you understand:</p>
                    <ul>
                        <li>Field mappings and data relationships</li>
                        <li>Record layout structures</li>
                        <li>Program dependencies and business logic</li>
                        <li>COBOL to Oracle conversion guidance</li>
                    </ul>
                    <p>Ask me about any field, record layout, or program in your analysis!</p>
                </div>
            </div>
            <div class="chat-input-area">
                <textarea id="chatInput" class="chat-input" 
                         placeholder="Ask about fields, record layouts, or programs..."
                         onkeydown="handleChatKeydown(event)"></textarea>
                <div class="chat-controls">
                    <span class="token-counter" id="chatTokenCounter">0 tokens</span>
                    <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading"></div>
            <h3 id="loadingTitle">Processing...</h3>
            <p id="loadingMessage">Analyzing your files...</p>
            <div id="loadingProgress" style="margin-top: 1rem;">
                <div style="background: #e9ecef; border-radius: 10px; height: 6px; margin-bottom: 0.5rem;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="font-size: 0.9rem; color: #6c757d;">Starting analysis...</div>
            </div>
            <div id="analysisSteps" style="margin-top: 1rem; text-align: left; max-width: 400px;">
                <div class="analysis-step" id="step1">
                    <span class="step-icon"></span> Parsing COBOL structure...
                </div>
                <div class="analysis-step" id="step2">
                    <span class="step-icon"></span> Extracting components...
                </div>
                <div class="analysis-step" id="step3">
                    <span class="step-icon"></span> Generating business summary...
                </div>
                <div class="analysis-step" id="step4">
                    <span class="step-icon"></span> Storing results...
                </div>
            </div>
            <div id="processingStatus" style="margin-top: 1rem;"></div>
        </div>
    </div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Global variables
        let currentSessionId = null;
        let currentConversationId = null;
        let fieldMatrixData = {};
        let componentsData = [];
        let dependenciesData = [];
        let llmConfig = {
            endpoint: 'http://localhost:8100/generate',
            maxTokens: 6000,
            temperature: 0.1,
            timeout: 60,
            retries: 3
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadLLMConfig();
            initializeSession();
            updateTokenCounters();
        });

        // LLM Configuration Management
        function loadLLMConfig() {
            const saved = localStorage.getItem('llmConfig');
            if (saved) {
                try {
                    llmConfig = { ...llmConfig, ...JSON.parse(saved) };
                    updateConfigForm();
                } catch (e) {
                    console.error('Error loading LLM config:', e);
                }
            }
        }

        function openConfigModal() {
            updateConfigForm();
            const modal = document.getElementById('configModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeConfigModal() {
            const modal = document.getElementById('configModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
            
            // Hide status messages
            document.getElementById('connectionStatus').style.display = 'none';
            document.getElementById('serverInfo').style.display = 'none';
            document.getElementById('testResults').style.display = 'none';
        }

        function updateConfigForm() {
            document.getElementById('llmEndpoint').value = llmConfig.endpoint;
            document.getElementById('maxTokens').value = llmConfig.maxTokens;
            document.getElementById('temperature').value = llmConfig.temperature;
            document.getElementById('timeout').value = llmConfig.timeout;
            document.getElementById('retries').value = llmConfig.retries;
        }

        async function testLLMConnection() {
            const endpoint = document.getElementById('llmEndpoint').value.trim();
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const timeout = parseInt(document.getElementById('timeout').value);

            if (!endpoint) {
                showConnectionStatus('error', 'Please enter a VLLM endpoint URL first');
                return;
            }

            showConnectionStatus('testing', 'Testing connection to VLLM server...');
            
            const testButton = document.getElementById('testButton');
            testButton.disabled = true;
            testButton.textContent = 'Testing...';

            document.getElementById('testResults').style.display = 'block';
            resetTestResults();

            try {
                const startTime = Date.now();
                
                const response = await fetch('/api/test-llm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        endpoint,
                        maxTokens,
                        temperature,
                        timeout
                    })
                });

                const responseTime = Date.now() - startTime;

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        showConnectionStatus('success', 'Connection successful! VLLM server is responding normally.');
                        
                        updateTestResults({
                            endpointReachable: true,
                            responseFormat: 'Valid JSON',
                            tokenGeneration: data.response_tokens > 0 ? 'Working' : 'Limited',
                            modelCompatibility: data.model_name ? 'Compatible' : 'Unknown'
                        });
                        
                        displayServerInfo({
                            model: data.model_name || 'Unknown',
                            contextLength: data.max_context_length || 'Unknown',
                            responseTime: `${responseTime}ms`,
                            status: 'Online',
                            promptTokens: data.prompt_tokens || 0,
                            responseTokens: data.response_tokens || 0
                        });
                    } else {
                        showConnectionStatus('error', `Connection failed: ${data.error || 'Unknown error'}`);
                        updateTestResults({
                            endpointReachable: false,
                            responseFormat: 'Error',
                            tokenGeneration: 'Failed',
                            modelCompatibility: 'Incompatible'
                        });
                        hideServerInfo();
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('LLM connection test failed:', error);
                showConnectionStatus('error', `Connection failed: ${error.message}`);
                updateTestResults({
                    endpointReachable: false,
                    responseFormat: 'Network Error',
                    tokenGeneration: 'Failed',
                    modelCompatibility: 'Cannot Determine'
                });
                hideServerInfo();
            } finally {
                testButton.disabled = false;
                testButton.textContent = 'Test Connection';
            }
        }

        function showConnectionStatus(type, message) {
            const status = document.getElementById('connectionStatus');
            const indicator = document.getElementById('statusIndicator');
            const statusMessage = document.getElementById('statusMessage');

            status.className = `connection-status ${type}`;
            status.style.display = 'flex';
            
            indicator.className = `status-indicator status-${type === 'testing' ? 'testing' : type === 'success' ? 'online' : 'offline'}`;
            
            statusMessage.textContent = message;
        }

        function resetTestResults() {
            document.getElementById('endpointStatus').textContent = 'Testing...';
            document.getElementById('responseFormat').textContent = 'Testing...';
            document.getElementById('tokenGeneration').textContent = 'Testing...';
            document.getElementById('modelCompatibility').textContent = 'Testing...';
        }

        function updateTestResults(results) {
            document.getElementById('endpointStatus').textContent = results.endpointReachable ? 'âœ… Reachable' : 'âŒ Failed';
            document.getElementById('responseFormat').textContent = results.responseFormat;
            document.getElementById('tokenGeneration').textContent = results.tokenGeneration;
            document.getElementById('modelCompatibility').textContent = results.modelCompatibility;
        }

        function displayServerInfo(info) {
            document.getElementById('modelName').textContent = info.model;
            document.getElementById('contextLength').textContent = info.contextLength;
            document.getElementById('responseTime').textContent = info.responseTime;
            document.getElementById('serverStatus').textContent = info.status;
            document.getElementById('serverInfo').style.display = 'block';
        }

        function hideServerInfo() {
            document.getElementById('serverInfo').style.display = 'none';
        }

        async function saveLLMConfig() {
            const endpoint = document.getElementById('llmEndpoint').value.trim();
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const timeout = parseInt(document.getElementById('timeout').value);
            const retries = parseInt(document.getElementById('retries').value);

            if (!endpoint) {
                showError('Please enter a valid VLLM endpoint URL');
                return;
            }

            if (maxTokens < 1000 || maxTokens > 32000) {
                showError('Max tokens must be between 1000 and 32000');
                return;
            }

            if (temperature < 0 || temperature > 2) {
                showError('Temperature must be between 0.0 and 2.0');
                return;
            }

            llmConfig = {
                endpoint,
                maxTokens,
                temperature,
                timeout,
                retries
            };

            localStorage.setItem('llmConfig', JSON.stringify(llmConfig));

            try {
                await updateBackendConfig();
                closeConfigModal();
                showSuccess('LLM configuration saved successfully!');
            } catch (error) {
                showError('Failed to update backend configuration');
            }
        }

        async function updateBackendConfig() {
            try {
                const response = await fetch('/api/llm-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(llmConfig)
                });

                if (!response.ok) {
                    throw new Error('Failed to update backend configuration');
                }
            } catch (error) {
                console.error('Error updating backend config:', error);
                throw error;
            }
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to default values?')) {
                llmConfig = {
                    endpoint: 'http://localhost:8100/generate',
                    maxTokens: 6000,
                    temperature: 0.1,
                    timeout: 60,
                    retries: 3
                };
                updateConfigForm();
                localStorage.removeItem('llmConfig');
                
                document.getElementById('connectionStatus').style.display = 'none';
                document.getElementById('serverInfo').style.display = 'none';
                document.getElementById('testResults').style.display = 'none';
            }
        }

        // Session Management
        async function initializeSession() {
            try {
                const savedSessionId = localStorage.getItem('currentSessionId');
                if (savedSessionId) {
                    currentSessionId = savedSessionId;
                    currentConversationId = generateUUID();
                    
                    const response = await fetch(`/api/components/${currentSessionId}`);
                    if (response.ok) {
                        console.log('Using existing session:', currentSessionId);
                        document.getElementById('sessionId').textContent = currentSessionId.slice(0, 8) + '...';
                        document.getElementById('projectName').textContent = 'Existing Project';
                        return;
                    }
                }
                
                const response = await fetch('/api/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_name: `Project_${new Date().toISOString().slice(0,19)}` })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentSessionId = data.session_id;
                    currentConversationId = generateUUID();
                    
                    localStorage.setItem('currentSessionId', currentSessionId);
                    
                    document.getElementById('sessionId').textContent = currentSessionId.slice(0, 8) + '...';
                    document.getElementById('projectName').textContent = data.project_name;
                    
                    console.log('New session initialized:', currentSessionId);
                } else {
                    throw new Error('Failed to create session');
                }
            } catch (error) {
                console.error('Error initializing session:', error);
                showError('Failed to initialize session');
            }
        }

        // File Upload with Progress Tracking
        async function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            showLoadingWithProgress(`Processing ${files.length} files...`);
            
            let processedCount = 0;
            let successCount = 0;
            let errorCount = 0;
            const results = [];

            const loadingContent = document.querySelector('.loading-content');
            const statusContainer = document.createElement('div');
            statusContainer.id = 'processingStatus';
            statusContainer.style.marginTop = '2rem';
            loadingContent.appendChild(statusContainer);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileNumber = i + 1;
                
                try {
                    updateLoadingProgress(
                        `Processing ${file.name} (${fileNumber}/${files.length})...`,
                        (i / files.length) * 90,
                        `Analyzing ${file.name}`
                    );
                    
                    updateProcessingStatus(fileNumber, files.length, file.name, 'processing');
                    
                    updateAnalysisStep(1, 'current', `Parsing ${file.name}...`);
                    updateAnalysisStep(2, 'current', 'Extracting components...');
                    updateAnalysisStep(3, 'current', 'Generating AI analysis...');
                    updateAnalysisStep(4, 'current', 'Storing results...');

                    const content = await readFileContent(file);
                    const fileType = getFileType(file.name);
                    
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: currentSessionId,
                            content: content,
                            filename: file.name,
                            file_type: fileType
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            successCount++;
                            results.push({ file: file.name, success: true, data: data });
                            
                            updateAnalysisStep(1, 'completed', `Parsed ${file.name}`);
                            updateAnalysisStep(2, 'completed', `Found ${data.components.length} components`);
                            updateAnalysisStep(3, 'completed', `Generated business summaries`);
                            updateAnalysisStep(4, 'completed', `Stored in database`);
                            
                            updateProcessingStatus(fileNumber, files.length, file.name, 'success', data.components.length);
                            
                            componentsData = componentsData.concat(data.components);
                            
                            console.log(`Successfully processed ${file.name}:`, data.components.length, 'components');
                        } else {
                            errorCount++;
                            results.push({ file: file.name, success: false, error: data.error });
                            updateProcessingStatus(fileNumber, files.length, file.name, 'error', 0, data.error);
                            showErrorInStep(file.name, data.error);
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    errorCount++;
                    results.push({ file: file.name, success: false, error: error.message });
                    console.error(`Error processing ${file.name}:`, error);
                    updateProcessingStatus(fileNumber, files.length, file.name, 'error', 0, error.message);
                    showErrorInStep(file.name, error.message);
                }
                
                processedCount++;
                
                const overallProgress = (processedCount / files.length) * 90;
                updateLoadingProgress(
                    `Processed ${processedCount}/${files.length} files (${successCount} successful, ${errorCount} failed)`,
                    overallProgress,
                    `${processedCount} of ${files.length} complete`
                );
            }

            updateLoadingProgress(
                `Analysis complete! Processed ${processedCount} files`,
                95,
                'Updating interface...'
            );

            const finalSummaryHtml = `
                <div style="background: #d4edda; padding: 1rem; border-radius: 8px; border: 1px solid #c3e6cb; margin-top: 1rem;">
                    <h4 style="color: #155724; margin: 0 0 0.5rem 0;">Processing Complete!</h4>
                    <div style="color: #155724;">
                        <strong>Total Files:</strong> ${files.length}<br>
                        <strong>Successful:</strong> ${successCount}<br>
                        <strong>Failed:</strong> ${errorCount}<br>
                        <strong>Total Components:</strong> ${results.reduce((sum, r) => sum + (r.data?.components?.length || 0), 0)}
                    </div>
                </div>
            `;
            statusContainer.insertAdjacentHTML('beforeend', finalSummaryHtml);

            updateLoadingProgress('All files processed successfully!', 100, 'Ready!');
            
            setTimeout(async () => {
                hideLoading();
                
                await refreshUI();
                await loadDashboardSummaries();
                
                showCompletionNotification(successCount, errorCount, files.length);
                
            }, 2000);
            
            event.target.value = '';
        }

        function updateProcessingStatus(currentFile, totalFiles, fileName, status, componentsFound = 0, error = null) {
            const container = document.getElementById('processingStatus');
            if (!container) return;

            let statusItem = document.getElementById(`status-${currentFile}`);
            if (!statusItem) {
                statusItem = document.createElement('div');
                statusItem.id = `status-${currentFile}`;
                statusItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 0.5rem;
                    margin-bottom: 0.5rem;
                    border-radius: 6px;
                    font-size: 0.9rem;
                `;
                container.appendChild(statusItem);
            }

            let statusIcon, statusColor, statusText, backgroundColor;
            
            switch (status) {
                case 'processing':
                    statusIcon = 'ðŸ”„';
                    statusColor = '#0c5460';
                    backgroundColor = '#d1ecf1';
                    statusText = `Processing ${fileName}...`;
                    break;
                case 'success':
                    statusIcon = 'âœ…';
                    statusColor = '#155724';
                    backgroundColor = '#d4edda';
                    statusText = `${fileName} - ${componentsFound} components found`;
                    break;
                case 'error':
                    statusIcon = 'âŒ';
                    statusColor = '#721c24';
                    backgroundColor = '#f8d7da';
                    statusText = `${fileName} - Error: ${error?.substring(0, 50) || 'Unknown error'}`;
                    break;
            }

            statusItem.style.color = statusColor;
            statusItem.style.backgroundColor = backgroundColor;
            statusItem.innerHTML = `
                <span style="margin-right: 0.5rem; font-size: 1rem;">${statusIcon}</span>
                <span><strong>File ${currentFile}/${totalFiles}:</strong> ${statusText}</span>
            `;
        }

        function showCompletionNotification(successCount, errorCount, totalFiles) {
            const notificationHtml = `
                <div id="completionNotification" style="
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    background: ${errorCount > 0 ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)' : 'linear-gradient(135deg, #28a745 0%, #20c997 100%)'};
                    color: white;
                    padding: 1.5rem;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    z-index: 10000;
                    min-width: 300px;
                    animation: slideIn 0.3s ease;
                ">
                    <h4 style="margin: 0 0 0.5rem 0;">${errorCount > 0 ? 'âš ï¸' : 'ðŸŽ‰'} Processing Complete!</h4>
                    <div>
                        <strong>Files Processed:</strong> ${successCount}/${totalFiles}<br>
                        ${errorCount > 0 ? `<strong>Errors:</strong> ${errorCount}<br>` : ''}
                        <strong>Total Components:</strong> ${componentsData.length}
                    </div>
                    <button onclick="closeCompletionNotification()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        padding: 0.25rem 0.5rem;
                        border-radius: 4px;
                        margin-top: 0.5rem;
                        cursor: pointer;
                    ">Close</button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', notificationHtml);
            
            setTimeout(() => {
                closeCompletionNotification();
            }, 10000);
        }

        function closeCompletionNotification() {
            const notification = document.getElementById('completionNotification');
            if (notification) {
                notification.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => notification.remove(), 300);
            }
        }

        // Dashboard Summaries
        async function loadDashboardSummaries() {
            try {
                const response = await fetch(`/api/llm-summaries/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayComponentSummariesFromLLMTable(data.summaries);
                        updateDashboardMetrics(data.summaries);
                    }
                }
            } catch (error) {
                console.error('Error loading LLM summaries:', error);
            }
        }

        function displayComponentSummariesFromLLMTable(summaries) {
            const container = document.getElementById('componentSummaries');
            container.innerHTML = '';

            if (summaries.length === 0) {
                container.innerHTML = '<p class="text-muted">No component summaries available</p>';
                return;
            }

            summaries.forEach(summary => {
                const card = document.createElement('div');
                card.className = 'component-summary-card';
                
                const businessPurpose = summary.business_purpose || 'No business purpose available';
                const complexityScore = summary.complexity_score || 0.5;
                const keyFeatures = summary.key_features || [];
                
                if (summary.is_raw_response) {
                    card.innerHTML = `
                        <div class="component-header">
                            <div>
                                <div class="component-title">${summary.component_name}</div>
                                <div class="text-muted">${summary.friendly_name || ''}</div>
                            </div>
                            <span class="component-type badge badge-warning">RAW AI ANALYSIS</span>
                        </div>
                        
                        <div class="business-purpose raw-analysis">
                            <strong>AI Analysis (Raw Response):</strong><br>
                            <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; max-height: 150px; overflow-y: auto;">
                                ${businessPurpose}
                            </div>
                        </div>
                        
                        <div class="component-metrics">
                            <div class="metric">
                                <span class="metric-value">RAW</span>
                                <span class="metric-label">Analysis</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${Math.round(complexityScore * 100)}%</span>
                                <span class="metric-label">Complexity</span>
                            </div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="component-header">
                            <div>
                                <div class="component-title">${summary.component_name}</div>
                                <div class="text-muted">${summary.friendly_name || ''}</div>
                            </div>
                            <span class="component-type badge badge-primary">${summary.component_type}</span>
                        </div>
                        
                        <div class="business-purpose">${businessPurpose}</div>
                        
                        <div class="component-metrics">
                            <div class="metric">
                                <span class="metric-value">${summary.primary_function || 'GENERAL'}</span>
                                <span class="metric-label">Function</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${Math.round(complexityScore * 100)}%</span>
                                <span class="metric-label">Complexity</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${keyFeatures.length}</span>
                                <span class="metric-label">Features</span>
                            </div>
                        </div>
                        
                        <div class="complexity-bar">
                            <div class="complexity-fill" style="width: ${complexityScore * 100}%"></div>
                        </div>
                    `;
                }
                
                container.appendChild(card);
            });
        }

        // Enhanced Dependencies Flow with Fixed Core Component Display
        async function createEnhancedDependencyFlowHTML(categorized, focusComponent) {
    let html = '<div class="dependency-flow">';
    
    // Input Sources Level (Files + DB2 Input Tables)
    if ((categorized.inputFiles && categorized.inputFiles.length > 0) || 
        (categorized.db2InputTables && categorized.db2InputTables.length > 0)) {
        
        html += '<div class="flow-level">';
        html += '<div class="flow-level-title">Input Sources</div>';
        html += '<div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">';
        
        // Regular input files
        if (categorized.inputFiles) {
            categorized.inputFiles.forEach(file => {
                html += createFileComponent(file, 'input-source');
            });
        }
        
        // DB2 input tables
        if (categorized.db2InputTables) {
            categorized.db2InputTables.forEach(table => {
                html += createDB2Component(table, 'db2-input-table');
            });
        }
        
        html += '</div></div>';
        html += '<div class="flow-arrow">â†“</div>';
    }
    
    // Core Programs Level
    let coreItems;
    if (focusComponent) {
        coreItems = [{name: focusComponent, type: 'Focus Program', confidence: 1.0}];
    } else if (categorized.corePrograms && categorized.corePrograms.length > 0) {
        coreItems = categorized.corePrograms;
    } else {
        coreItems = await getAllUploadedPrograms() || [{name: 'MAIN-PROGRAM', type: 'Core Program', confidence: 0.9}];
    }
    
    html += createProgramLayer('Core Programs', coreItems, 'core-program');
    
    // Add arrows to called programs if any exist
    if (categorized.calledPrograms && categorized.calledPrograms.length > 0) {
        html += '<div style="position: relative; height: 80px; display: flex; justify-content: center; align-items: center;">';
        html += createProgramCallArrows(categorized.calledPrograms);
        html += '</div>';
    } else {
        html += '<div class="flow-arrow">â†“</div>';
    }
    
    // Called Programs Level
    if (categorized.calledPrograms && categorized.calledPrograms.length > 0) {
        html += createProgramLayerWithArrows('Called Programs', categorized.calledPrograms, 'called-program');
        html += '<div class="flow-arrow">â†“</div>';
    }
    
    // Output Destinations Level (Files + DB2 Output Tables)
    if ((categorized.outputFiles && categorized.outputFiles.length > 0) || 
        (categorized.inputOutputFiles && categorized.inputOutputFiles.length > 0) ||
        (categorized.db2OutputTables && categorized.db2OutputTables.length > 0) ||
        (categorized.db2IOTables && categorized.db2IOTables.length > 0)) {
        
        html += '<div class="flow-level">';
        html += '<div class="flow-level-title">Output Destinations</div>';
        html += '<div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">';
        
        // Regular output files
        if (categorized.outputFiles) {
            categorized.outputFiles.forEach(file => {
                html += createFileComponent(file, 'output-file');
            });
        }
        
        // Input/Output files
        if (categorized.inputOutputFiles) {
            categorized.inputOutputFiles.forEach(file => {
                html += createFileComponent(file, 'input-output-file');
            });
        }
        
        // DB2 output tables
        if (categorized.db2OutputTables) {
            categorized.db2OutputTables.forEach(table => {
                html += createDB2Component(table, 'db2-output-table');
            });
        }
        
        // DB2 I/O tables
        if (categorized.db2IOTables) {
            categorized.db2IOTables.forEach(table => {
                html += createDB2Component(table, 'db2-io-table');
            });
        }
        
        html += '</div></div>';
    }
    
    // Missing Dependencies Level
    if (categorized.missingPrograms && categorized.missingPrograms.length > 0) {
        html += '<div style="margin-top: 3rem; padding-top: 2rem; border-top: 3px dashed #dc3545;">';
        html += '<h4 style="color: #dc3545; text-align: center; margin-bottom: 2rem;">âš ï¸ Missing Dependencies</h4>';
        html += createProgramLayer('Missing Programs', categorized.missingPrograms, 'missing-dependency');
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

function createDB2Component(table, className) {
    const tableIcon = 'ðŸ—ƒï¸';
    const operationIcon = getDB2OperationIcon(table.sqlOperation);
    
    return `
        <div class="flow-component ${className}" onclick="showDB2TableDetails('${table.name}', '${table.sourceProgram}')">
            <div class="component-name">${tableIcon} ${table.name}</div>
            <div class="component-type-badge">${table.tableType}</div>
            <div class="component-description">
                ${operationIcon} ${table.sqlOperation}
                <br>Source: ${table.sourceProgram}
                <br>Interface: DB2
            </div>
            <div class="confidence-indicator ${getConfidenceClass(table.confidence)}">
                ${(table.confidence * 100).toFixed(0)}%
            </div>
        </div>
    `;
}

// Helper function to get DB2 operation icons
function getDB2OperationIcon(sqlOperation) {
    if (sqlOperation.includes('SELECT')) return 'ðŸ“¥';
    if (sqlOperation.includes('INSERT')) return 'ðŸ“¤';
    if (sqlOperation.includes('UPDATE')) return 'ðŸ”„';
    if (sqlOperation.includes('DELETE')) return 'ðŸ—‘ï¸';
    return 'ðŸ’¾';
}

// Helper function to create file components (updated to work with existing code)
function createFileComponent(file, className) {
    const layoutInfo = file.hasLayoutAssociation && file.associatedLayouts.length > 0 ?
        `<div style="font-size: 0.7rem; color: #666; margin-top: 0.5rem;">
            ðŸ“‹ Layouts: ${file.associatedLayouts.slice(0, 2).join(', ')}
            ${file.associatedLayouts.length > 2 ? ` (+${file.associatedLayouts.length - 2} more)` : ''}
        </div>` : '';
        
    const interfaceIcon = file.interface === 'CICS' ? 'ðŸ¦' : 'ðŸ“';
    const statusClass = file.hasLayoutAssociation ? 'file-with-layout' : 'file-only';
    
    return `
        <div class="flow-component ${className} ${statusClass}" 
             data-component-name="${file.name}" 
             data-component-type="file"
             style="cursor: pointer;">
            <div class="component-name">${interfaceIcon} ${file.name}</div>
            <div class="component-type-badge">${file.type}</div>
            <div class="component-description">
                Operations: ${file.operations.join(', ') || 'Unknown'}
                <br>Interface: ${file.interface}
                ${layoutInfo}
            </div>
            <div class="confidence-indicator ${getConfidenceClass(file.confidence)}">
                ${(file.confidence * 100).toFixed(0)}%
            </div>
        </div>
    `;
}


// Function to show DB2 table details (modal)
function showDB2TableDetails(tableName, sourceProgram) {
    const modalHtml = `
        <div class="modal" style="display: block; z-index: 10001;">
            <div class="modal-content" style="width: 70%; max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title">ðŸ—ƒï¸ ${tableName} - DB2 Table Details</h3>
                    <button class="close" onclick="closeDB2Modal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h5>Table Information</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>Table Name:</strong></td><td>${tableName}</td></tr>
                                <tr><td><strong>Interface:</strong></td><td>DB2 Database</td></tr>
                                <tr><td><strong>Source Program:</strong></td><td>${sourceProgram}</td></tr>
                                <tr><td><strong>Access Type:</strong></td><td>SQL Operations</td></tr>
                            </table>
                        </div>
                        <div>
                            <h5>SQL Operations</h5>
                            <div id="db2SqlOperations">Loading SQL operations...</div>
                        </div>
                    </div>
                    <div>
                        <h5>Field Mappings</h5>
                        <div id="db2FieldMappings">Loading field mapping information...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="analyzeDB2Table('${tableName}')">Analyze Table Fields</button>
                    <button class="btn btn-secondary" onclick="askAboutDB2Table('${tableName}')">Ask AI About This</button>
                    <button class="btn btn-secondary" onclick="closeDB2Modal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    loadDB2TableDetails(tableName, sourceProgram);
}

// Function to load DB2 table details
async function loadDB2TableDetails(tableName, sourceProgram) {
    try {
        const response = await fetch(`/api/dependencies/${currentSessionId}`);
        const data = await response.json();
        
        if (data.success) {
            const db2Deps = data.dependencies.filter(dep => 
                dep.target_component === tableName && 
                (dep.interface_type === 'DB2' || dep.relationship_type.includes('DB2'))
            );
            
            displayDB2Operations(db2Deps);
        }
    } catch (error) {
        console.error('Error loading DB2 table details:', error);
        document.getElementById('db2SqlOperations').innerHTML = 'Error loading SQL operations';
        document.getElementById('db2FieldMappings').innerHTML = 'Error loading field mappings';
    }
}

function displayDB2Operations(db2Dependencies) {
    const operationsContainer = document.getElementById('db2SqlOperations');
    const fieldMappingsContainer = document.getElementById('db2FieldMappings');
    
    if (db2Dependencies.length === 0) {
        operationsContainer.innerHTML = '<p class="text-muted">No SQL operations found</p>';
        fieldMappingsContainer.innerHTML = '<p class="text-muted">No field mappings available</p>';
        return;
    }
    
    // Display SQL operations
    let operationsHtml = '<div style="max-height: 200px; overflow-y: auto;">';
    db2Dependencies.forEach(dep => {
        const analysis = dep.analysis_details || {};
        const sqlOp = analysis.sql_operation || 'Unknown SQL';
        const icon = getDB2OperationIcon(sqlOp);
        
        operationsHtml += `
            <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #007bff; border-radius: 4px;">
                <strong>${icon} ${sqlOp}</strong>
                <br><small>Program: ${dep.source_component}</small>
                ${analysis.sql_context ? `<br><small>Context: ${analysis.sql_context.substring(0, 100)}...</small>` : ''}
            </div>
        `;
    });
    operationsHtml += '</div>';
    operationsContainer.innerHTML = operationsHtml;
    
    // Display field mappings info
    fieldMappingsContainer.innerHTML = `
        <p>To see detailed field mappings for this DB2 table, use the Field Mapping Analysis tab.</p>
        <button class="btn btn-primary" onclick="analyzeDB2TableFields('${db2Dependencies[0].target_component}')">
            Analyze DB2 Field Mappings
        </button>
    `;
}

function closeDB2Modal() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (modal.style.zIndex === '10001') {
            modal.remove();
        }
    });
}

function analyzeDB2Table(tableName) {
    closeDB2Modal();
    showTab('fieldMapping');
    document.getElementById('targetFileInput').value = tableName;
}

function askAboutDB2Table(tableName) {
    closeDB2Modal();
    const chatInput = document.getElementById('chatInput');
    chatInput.value = `Tell me about the ${tableName} DB2 table. What data does it contain, which programs access it, and what SQL operations are performed on it?`;
    chatInput.focus();
}

function analyzeDB2TableFields(tableName) {
    closeDB2Modal();
    showTab('fieldMapping');
    document.getElementById('targetFileInput').value = tableName;
    analyzeFieldMapping();
}

    async function getAllUploadedPrograms() {
    try {
        // Get actual components from the API instead of relying on local data
        const response = await fetch(`/api/components/${currentSessionId}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.components) {
                const programs = data.components.filter(c => c.component_type === 'PROGRAM');
                if (programs.length > 0) {
                    console.log('Found uploaded programs:', programs.map(p => p.component_name));
                    return programs.map(program => ({
                        name: program.component_name,
                        friendly_name: program.friendly_name || program.component_name,
                        type: 'Core Program',
                        confidence: 0.9
                    }));
                }
            }
        }
    } catch (error) {
        console.error('Error fetching uploaded programs:', error);
    }
    
    // Fallback - try componentsData if API fails
    if (componentsData && componentsData.length > 0) {
        const programs = componentsData.filter(c => c.component_type === 'PROGRAM');
        if (programs.length > 0) {
            return programs.map(program => ({
                name: program.component_name,
                friendly_name: program.friendly_name || program.component_name,
                type: 'Core Program',
                confidence: 0.9
            }));
        }
    }
    
    return null;
}
        function createProgramCallArrows(calledPrograms) {
            let html = '<div class="program-call-arrows" style="display: flex; justify-content: center; align-items: center; gap: 1rem; height: 60px; margin: 1rem 0;">';
            
            calledPrograms.slice(0, 5).forEach((program, index) => {
                const arrowIcon = getCallArrowIcon(program.callType);
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; margin: 0 1rem;">
                        <div style="font-size: 1.8rem; color: #667eea; text-shadow: 0 2px 4px rgba(0,0,0,0.3); margin-bottom: 0.2rem;">${arrowIcon}</div>
                        <div style="font-size: 0.7rem; color: #666; text-align: center; max-width: 60px;">${program.name.substring(0, 8)}</div>
                    </div>
                `;
            });
            
            if (calledPrograms.length > 5) {
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; margin: 0 1rem;">
                        <div style="font-size: 1.5rem; color: #999;">...</div>
                        <div style="font-size: 0.7rem; color: #666;">+${calledPrograms.length - 5} more</div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        function createProgramLayer(title, items, className) {
            let html = `
                <div class="flow-level">
                    <div class="flow-level-title">${title}</div>
                    <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">
            `;
            
            items.forEach(item => {
                const displayName = item.name || item.friendly_name || 'UNKNOWN';
                const confidenceClass = item.confidence > 0.8 ? 'confidence-high' : 
                                    item.confidence > 0.5 ? 'confidence-medium' : 'confidence-low';
                
                html += `
                    <div class="flow-component ${className}" 
                        data-component-name="${item.name}" 
                        data-component-type="program"
                        style="cursor: pointer;">
                        <div class="confidence-indicator ${confidenceClass}"></div>
                        <div class="component-name">${displayName}</div>
                        <div class="component-type-badge">${item.type}</div>
                        <div class="component-description">
                            Confidence: ${(item.confidence * 100).toFixed(0)}%
                            ${item.reason ? `<br><small>${item.reason}</small>` : ''}
                            ${item.calledFrom ? `<br><small>Called from: ${item.calledFrom}</small>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

function initializeDependencyFlowInteractivity() {
    // Remove any existing event listeners
    document.removeEventListener('click', handleDependencyFlowClick);
    
    // Add event delegation for dependency flow clicks
    document.addEventListener('click', handleDependencyFlowClick);
}

function handleDependencyFlowClick(event) {
    const target = event.target.closest('.flow-component');
    if (!target) return;
    
    // Prevent event bubbling
    event.preventDefault();
    event.stopPropagation();
    
    // Get component info from data attributes
    const componentName = target.getAttribute('data-component-name');
    const componentType = target.getAttribute('data-component-type');
    
    if (!componentName) {
        console.warn('No component name found for clicked element');
        return;
    }
    
    // Route to appropriate detail function
    switch (componentType) {
        case 'program':
            showProgramDetails(componentName);
            break;
        case 'file':
            showFileDetails(componentName);
            break;
        case 'db2':
            showDB2TableDetails(componentName);
            break;
        default:
            console.warn('Unknown component type:', componentType);
    }
}

function displayFieldMatrix(matrixData) {
            const tbody = document.getElementById('fieldMatrixTableBody');
            tbody.innerHTML = '';

            if (matrixData.program_layouts) {
                matrixData.program_layouts.forEach((layout, layoutIndex) => {
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'collapsible-row';
                    headerRow.onclick = () => toggleLayoutFields(layoutIndex);
                    
                    headerRow.innerHTML = `
                        <td>
                            <span class="expand-icon" id="expand-${layoutIndex}">â–¶</span>
                            <strong>${layout.layout_name}</strong>
                            <br><small class="text-muted">${layout.friendly_name}</small>
                        </td>
                        <td colspan="5">
                            <span class="badge badge-primary">Level ${layout.level}</span>
                            ${layout.fields.length} fields
                        </td>
                    `;
                    tbody.appendChild(headerRow);

                    const fieldsContainer = document.createElement('tbody');
                    fieldsContainer.id = `fields-${layoutIndex}`;
                    fieldsContainer.className = 'sub-fields';
                    fieldsContainer.style.display = 'none';
                    
                    layout.fields.forEach(field => {
                        const fieldRow = document.createElement('tr');
                        fieldRow.className = 'sub-field-row';
                        
                        const usageClass = `usage-${field.usage_type.toLowerCase()}`;
                        
                        fieldRow.innerHTML = `
                            <td style="padding-left: 2rem;">
                                ${field.field_name}
                                <br><small class="text-muted">${field.friendly_name || ''}</small>
                            </td>
                            <td>
                                <span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type}</span>
                                <br><small>${field.usage_description || ''}</small>
                            </td>
                            <td>${field.source_field || 'N/A'}</td>
                            <td>${field.business_purpose || 'N/A'}</td>
                            <td>${field.program_name || 'N/A'}</td>
                            <td>${field.line_number || 'N/A'}</td>
                        `;
                        fieldRow.className += ` ${usageClass}`;
                        fieldsContainer.appendChild(fieldRow);
                    });
                    
                    tbody.appendChild(fieldsContainer);
                });
            } else if (matrixData.fields) {
                matrixData.fields.forEach(field => {
                    const row = document.createElement('tr');
                    const usageClass = `usage-${field.usage_type.toLowerCase()}`;
                    
                    row.innerHTML = `
                        <td>
                            ${field.field_name}
                            <br><small class="text-muted">${field.friendly_name || ''}</small>
                        </td>
                        <td>
                            <span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type}</span>
                            <br><small>${field.usage_description || ''}</small>
                        </td>
                        <td>${field.source_field || 'N/A'}</td>
                        <td>${field.business_purpose || 'N/A'}</td>
                        <td>${field.program_name || 'N/A'}</td>
                        <td>${field.line_number || 'N/A'}</td>
                    `;
                    row.className = usageClass;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No field data available</td></tr>';
            }
        }

        function toggleLayoutFields(layoutIndex) {
            const fieldsContainer = document.getElementById(`fields-${layoutIndex}`);
            const expandIcon = document.getElementById(`expand-${layoutIndex}`);
            
            if (fieldsContainer.style.display === 'none') {
                fieldsContainer.style.display = 'table-row-group';
                expandIcon.textContent = 'â–¼';
            } else {
                fieldsContainer.style.display = 'none';
                expandIcon.textContent = 'â–¶';
            }
        }

        // Field Mapping Functions
        function initializeFieldMapping() {
            loadRecordLayoutSelector();
        }

        function loadRecordLayoutSelector() {
            const selector = document.getElementById('recordLayoutSelector');
            if (!selector) return;
            
            if (!currentSessionId) return;
            
            try {
                fetch(`/api/record-layouts/${currentSessionId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            selector.innerHTML = '<option value="">Or select a record layout</option>';
                            
                            if (data.layouts && data.layouts.length > 0) {
                                data.layouts.forEach(layout => {
                                    const option = document.createElement('option');
                                    option.value = layout.layout_name;
                                    option.textContent = `${layout.layout_name} (${layout.fields_count || 0} fields) - ${layout.program_name}`;
                                    selector.appendChild(option);
                                });
                            } else {
                                const option = document.createElement('option');
                                option.value = '';
                                option.textContent = 'No record layouts found';
                                option.disabled = true;
                                selector.appendChild(option);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading record layouts:', error);
                        selector.innerHTML = '<option value="">Error loading layouts</option>';
                    });
            } catch (error) {
                console.error('Error in loadRecordLayoutSelector:', error);
            }
        }

        function updateTargetFileFromLayout() {
            const selector = document.getElementById('recordLayoutSelector');
            const targetInput = document.getElementById('targetFileInput');
            
            if (selector && selector.value && targetInput) {
                targetInput.value = selector.value;
            }
        }

        async function analyzeFieldMapping() {
            const targetFile = document.getElementById('targetFileInput').value.trim();
            if (!targetFile) {
                showError('Please enter a target file name or select a record layout');
                return;
            }

            showLoading('Analyzing field mappings...');

            try {
                const response = await fetch('/api/field-mapping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        target_file: targetFile
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayFieldMappingsWithSummary(data.field_mappings, data.summary);
                        await displayLayoutSummary(targetFile);
                    } else {
                        showError(data.error || 'Failed to analyze field mappings');
                    }
                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error analyzing field mapping:', error);
                showError('Failed to analyze field mappings');
            }

            hideLoading();
        }

        function normalizeUsageType(usageType) {
            if (!usageType) return 'STATIC';
            
            const normalizedMappings = {
                'MOVE_TARGET': 'INPUT',
                'MOVE_SOURCE': 'OUTPUT', 
                'MOVE': 'INPUT_OUTPUT',
                'COMPUTED': 'DERIVED',
                'DEFINITION': 'STATIC',
                'CONDITION': 'REFERENCE',
                'CONDITIONAL': 'REFERENCE',
                'CICS_INPUT': 'INPUT',
                'CICS_OUTPUT': 'OUTPUT',
                'CICS_REWRITE': 'INPUT_OUTPUT',
                'STRING_MANIPULATION': 'DERIVED',
                'CALCULATED': 'DERIVED',
                'UNUSED': 'UNUSED'
            };
            
            return normalizedMappings[usageType.toUpperCase()] || usageType.toUpperCase();
        }

        function displayFieldMappingsWithSummary(mappings, summary) {
            const tbody = document.getElementById('fieldMappingTableBody');
            tbody.innerHTML = '';

            if (!mappings || mappings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No field mappings found</td></tr>';
                return;
            }

            mappings.forEach(mapping => {
                const row = document.createElement('tr');
                
                let normalizedUsageType = normalizeUsageType(mapping.usage_type || 'STATIC');
                
                row.innerHTML = `
                    <td>
                        <div style="min-width: 150px;">
                            <strong>${mapping.field_name || 'N/A'}</strong>
                            ${mapping.friendly_name && mapping.friendly_name !== mapping.field_name ? 
                                `<br><small class="text-muted">${mapping.friendly_name}</small>` : ''}
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 120px;">
                            <code style="font-size: 0.8rem;">${mapping.mainframe_data_type || 'UNKNOWN'}</code>
                            <br><small><strong>Length:</strong> ${mapping.mainframe_length || 0}</small>
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 120px;">
                            <code style="font-size: 0.8rem;">${mapping.oracle_data_type || 'VARCHAR2(50)'}</code>
                            <br><small><strong>Length:</strong> ${mapping.oracle_length || 50}</small>
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 150px;">
                            <strong>${mapping.population_source || 'Program logic'}</strong>
                            ${mapping.source_record_layout ? `<br><small>From: ${mapping.source_record_layout}</small>` : ''}
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 120px;">
                            <span class="badge ${getBadgeClass(normalizedUsageType)}">${normalizedUsageType}</span>
                            <br><small style="font-size: 0.75rem;">${mapping.business_logic_description || ''}</small>
                        </div>
                              ${mapping.sql_operations && mapping.sql_operations.length > 0 ? 
                            `<br><div class="db2-operations">
                                <strong>DB2:</strong> 
                                ${mapping.sql_operations.map(op => 
                                    `<span class="sql-operation">${op.sql_operation}</span>`
                                ).join(' ')}
                            </div>` : ''}
                    </td>
                    <td>
                        <div style="min-width: 100px;">
                            ${Array.isArray(mapping.programs_involved) ? 
                                mapping.programs_involved.join(', ') : 
                                mapping.programs_involved || 'Unknown'}
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 80px;">
                            <button class="btn btn-secondary" onclick="showFieldDetails('${mapping.field_name}')" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap;">
                                View Details
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function displayLayoutSummary(layoutName) {
            try {
                const response = await fetch(`/api/layout-summary/${currentSessionId}/${layoutName}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const summary = data.summary;
                        const summarySection = document.getElementById('layoutSummarySection');
                        const summaryContent = document.getElementById('layoutSummaryContent');
                        
                        if (!summarySection || !summaryContent) {
                            return;
                        }
                        
                        summaryContent.innerHTML = `
                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                                <div>
                                    <h5>${summary.layout_name}</h5>
                                    <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #666;">${summary.friendly_name}</p>
                                    <p style="font-size: 0.85rem; line-height: 1.4;">${summary.business_purpose}</p>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #667eea;">${summary.total_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Total</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">${summary.input_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Input</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #17a2b8;">${summary.output_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Output</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #6c757d;">${summary.static_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Static</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #dc3545;">${summary.unused_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">Unused</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #ffc107;">${summary.io_fields}</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;">IO-Fields</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        summarySection.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading layout summary:', error);
            }
        }

        async function showFieldDetails(fieldName) {
            try {
                const response = await fetch(`/api/field-details/${currentSessionId}/${fieldName}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayFieldDetailsModal(data.field_details);
                    } else {
                        showError(`Could not load details for field ${fieldName}`);
                    }
                }
            } catch (error) {
                console.error('Error loading field details:', error);
                showError('Error loading field details');
            }
        }

        function displayFieldDetailsModal(fieldDetails) {
            const modalTitle = document.getElementById('fieldModalTitle');
            const fieldDetailsContent = document.getElementById('fieldDetailsContent');
            
            if (!modalTitle || !fieldDetailsContent) {
                console.error('Modal elements not found');
                return;
            }
            
            try {
                modalTitle.textContent = `${fieldDetails.field_name} - Field Details`;
                
                const normalizedUsageType = normalizeUsageType(fieldDetails.usage_type || 'STATIC');
                const content = createFieldDetailsContent({...fieldDetails, usage_type: normalizedUsageType});
                fieldDetailsContent.innerHTML = content;
                
                const modal = document.getElementById('fieldDetailsModal');
                if (modal) {
                    modal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
            } catch (error) {
                console.error('Error displaying field details modal:', error);
                showError('Error displaying field details');
            }
        }

        function closeFieldDetailsModal() {
            const modal = document.getElementById('fieldDetailsModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }
        // Add this function to handle dynamic call details
        async function showDynamicCallDetails(variableName, sourceProgram) {
            try {
                const response = await fetch(`/api/dynamic-call-analysis/${currentSessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    const programAnalysis = data.dynamic_call_analysis.find(p => 
                        p.program_name === sourceProgram && 
                        p.variables_used.includes(variableName)
                    );
                    
                    if (programAnalysis) {
                        displayDynamicCallModal(programAnalysis, variableName);
                    }
                }
            } catch (error) {
                console.error('Error loading dynamic call details:', error);
            }
        }

        function displayDynamicCallModal(programAnalysis, variableName) {
            const modalHtml = `
                <div class="modal show" style="z-index: 10001;">
                    <div class="modal-content" style="width: 80%; max-width: 900px;">
                        <div class="modal-header">
                            <h3 class="modal-title">ðŸ”„ Dynamic Call: ${variableName}</h3>
                            <button class="close" onclick="closeDynamicCallModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                                <div>
                                    <h5>Dynamic Call Information</h5>
                                    <table style="width: 100%; font-size: 0.9rem;">
                                        <tr><td><strong>Variable Name:</strong></td><td>${variableName}</td></tr>
                                        <tr><td><strong>Source Program:</strong></td><td>${programAnalysis.program_name}</td></tr>
                                        <tr><td><strong>Total Dynamic Calls:</strong></td><td>${programAnalysis.total_dynamic_calls}</td></tr>
                                        <tr><td><strong>Resolved Programs:</strong></td><td>${programAnalysis.resolved_programs.length}</td></tr>
                                    </table>
                                </div>
                                <div>
                                    <h5>Resolution Details</h5>
                                    <div id="dynamicCallResolution">
                                        ${programAnalysis.resolved_programs.map(prog => `
                                            <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 4px;">
                                                <strong>${prog.program_name}</strong>
                                                <br><small>Status: ${prog.status || 'Unknown'}</small>
                                                <br><small>Method: ${prog.resolution_method || 'Code Analysis'}</small>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 2rem;">
                                <h5>Business Logic Summary</h5>
                                <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                                    ${programAnalysis.business_logic_summary || 'Dynamic call analysis available but summary not generated'}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="analyzeVariableUsage('${variableName}')">Analyze Variable Usage</button>
                            <button class="btn btn-secondary" onclick="askAboutDynamicCall('${variableName}')">Ask AI About This</button>
                            <button class="btn btn-secondary" onclick="closeDynamicCallModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.body.style.overflow = 'hidden';
        }

        function closeDynamicCallModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.style.zIndex === '10001') {
                    modal.remove();
                }
            });
            document.body.style.overflow = 'auto';
        }
        function createFieldDetailsContent(fieldDetails) {
            const operationsSummary = fieldDetails.operations ? 
                fieldDetails.operations.map(op => 
                    `${op.program_name}: ${normalizeUsageType(op.usage_type)} (${op.move_source_count + op.move_target_count + op.arithmetic_count + op.conditional_count} operations)`
                ).join('<br>') : 'No operations found';

            const referencesHtml = fieldDetails.references ? 
                fieldDetails.references.map(ref => `
                    <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 4px;">
                        <strong>Line ${ref.line_number}:</strong> ${normalizeUsageType(ref.operation_type)}<br>
                        <code style="font-size: 0.8rem;">${ref.line_content}</code>
                    </div>
                `).join('') : 'No references found';

            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <h5>Field Information</h5>
                        <table style="width: 100%; font-size: 0.9rem;">
                            <tr><td><strong>Name:</strong></td><td>${fieldDetails.field_name || 'N/A'}</td></tr>
                            <tr><td><strong>Friendly Name:</strong></td><td>${fieldDetails.friendly_name || 'N/A'}</td></tr>
                            <tr><td><strong>Usage Type:</strong></td><td><span class="badge ${getBadgeClass(fieldDetails.usage_type || 'UNKNOWN')}">${fieldDetails.usage_type || 'UNKNOWN'}</span></td></tr>
                            <tr><td><strong>Source Field:</strong></td><td>${fieldDetails.source_field || 'N/A'}</td></tr>
                            <tr><td><strong>Target Field:</strong></td><td>${fieldDetails.target_field || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div>
                        <h5>Data Types & Lengths</h5>
                        <table style="width: 100%; font-size: 0.9rem;">
                            <tr><td><strong>Mainframe Type:</strong></td><td><code>${fieldDetails.mainframe_data_type || 'UNKNOWN'}</code></td></tr>
                            <tr><td><strong>Mainframe Length:</strong></td><td>${fieldDetails.mainframe_length || 0}</td></tr>
                            <tr><td><strong>Oracle Type:</strong></td><td><code>${fieldDetails.oracle_data_type || 'VARCHAR2(50)'}</code></td></tr>
                            <tr><td><strong>Oracle Length:</strong></td><td>${fieldDetails.oracle_length || 50}</td></tr>
                            <tr><td><strong>Total References:</strong></td><td>${fieldDetails.total_references || 0}</td></tr>
                        </table>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h5>Business Purpose</h5>
                    <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                        ${fieldDetails.business_purpose || 'No description available'}
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h5>Field Definition</h5>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.9rem;">
                        ${fieldDetails.definition_code || 'Definition not available'}
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h5>Program Operations</h5>
                    <div style="font-size: 0.9rem;">
                        ${operationsSummary}
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h5>Field References (First 10)</h5>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${referencesHtml}
                    </div>
                </div>

                <div>
                    <h5>Source Code Context</h5>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                        <pre style="margin: 0; font-size: 0.8rem; white-space: pre-wrap;">${fieldDetails.source_code_snippet || 'Source code not available'}</pre>
                    </div>
                </div>
            `;
        }

       

        function exportFieldMappings() {
            const table = document.getElementById('fieldMappingTableBody');
            const rows = table.querySelectorAll('tr');
            
            if (rows.length === 0 || rows[0].textContent.includes('No field mappings')) {
                alert('No field mappings to export');
                return;
            }
            
            let csv = 'Field Name,Mainframe Data Type,Oracle Data Type,MF Length,Oracle Length,Population Source,Business Logic,Programs Involved\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                cells.forEach(cell => {
                    const text = cell.textContent.trim().replace(/\n/g, ' ').replace(/,/g, ';');
                    rowData.push(`"${text}"`);
                });
                csv += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `field_mappings_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function getBadgeClass(type) {
            const badgeMap = {
                'INPUT': 'badge-primary',
                'OUTPUT': 'badge-success', 
                'INPUT_OUTPUT': 'badge-warning',
                'DERIVED': 'badge-warning',
                'REFERENCE': 'badge-info',
                'STATIC': 'badge-secondary',
                'UNUSED': 'badge-danger',
                'MOVE': 'badge-primary',
                'CONDITIONAL': 'badge-warning',
                'CALCULATED': 'badge-success',
                'STRING_MANIPULATION': 'badge-info',
                'CICS_INPUT': 'badge-primary',
                'CICS_OUTPUT': 'badge-success',
                'CICS_REWRITE': 'badge-warning'
            };
            return badgeMap[type] || 'badge-secondary';
        }

        // Chat Functions
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addChatMessage('user', message);
            input.value = '';
            updateChatTokenCounter();

            const typingId = addChatMessage('assistant', 'Thinking...');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message: message,
                        conversation_id: currentConversationId
                    })
                });

               if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById(typingId).remove();
                    
                    if (data.success) {
                        const responseContent = data.response || data.content || data.message || 'No response';
                        addChatMessage('assistant', responseContent);
                        
                        if (data.tokens_used) {
                            updateTokenCounters();
                        }
                    } else {
                        addChatMessage('assistant', data.error || 'Sorry, I encountered an error.');
                    }

                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error sending chat message:', error);
                document.getElementById(typingId).remove();
                addChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            }
        }

        function addChatMessage(type, message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${type}`;
            
            let displayMessage = '';
            if (typeof message === 'string') {
                displayMessage = message;
            } else if (typeof message === 'object') {
                if (message.response) {
                    displayMessage = message.response;
                } else if (message.content) {
                    displayMessage = message.content;
                } else {
                    displayMessage = JSON.stringify(message, null, 2);
                }
            } else {
                displayMessage = String(message);
            }
            
            const formattedMessage = displayMessage
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `<p>${formattedMessage}</p>`;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageId;
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
            updateChatTokenCounter();
        }

        function updateChatTokenCounter() {
            const input = document.getElementById('chatInput');
            const counter = document.getElementById('chatTokenCounter');
            const tokenCount = Math.ceil(input.value.length / 4);
            counter.textContent = `${tokenCount} tokens`;
        }

        // Utility Functions
        function updateTokenCounters() {
            const totalComponents = componentsData.length;
            const estimatedTokens = totalComponents * 1500;
            
            document.getElementById('totalTokens').textContent = estimatedTokens;
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function showLoading(message = 'Processing...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showLoadingWithProgress(title) {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            updateLoadingProgress('Starting analysis...', 0, 'Initializing...');
            resetAnalysisSteps();
        }

        function updateLoadingProgress(message, percentage, progressText) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = progressText;
        }

        function resetAnalysisSteps() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                step.className = 'analysis-step';
            });
        }

        function updateAnalysisStep(stepNumber, status, message) {
            const stepElement = document.getElementById(`step${stepNumber}`);
            stepElement.className = `analysis-step ${status}`;
            
            if (message) {
                stepElement.innerHTML = `<span class="step-icon"></span> ${message}`;
            }
        }

        function showErrorInStep(fileName, error) {
            updateAnalysisStep(1, 'error', `Error parsing ${fileName}`);
            document.getElementById('progressText').textContent = `Error: ${error}`;
            document.getElementById('progressText').style.color = '#dc3545';
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }

        function getFileType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const typeMap = {
                'cbl': 'COBOL',
                'cob': 'COBOL',
                'cpy': 'COPYBOOK',
                'jcl': 'JCL'
            };
            return typeMap[ext] || 'COBOL';
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10001;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Panel Management
        function togglePanel(side) {
            const panel = document.getElementById(side + 'Panel');
            const isCollapsed = panel.classList.contains('collapsed');
            
            if (isCollapsed) {
                panel.classList.remove('collapsed');
                removeRestoreButton(side);
            } else {
                panel.classList.add('collapsed');
                addRestoreButton(side);
            }
        }

        function addRestoreButton(side) {
            const existing = document.getElementById(`restore-${side}`);
            if (existing) existing.remove();
            
            const button = document.createElement('button');
            button.id = `restore-${side}`;
            button.className = `panel-restore ${side}`;
            button.innerHTML = side === 'left' ? 'ðŸ“<br><small>Dashboard</small>' : 'ðŸ’¬<br><small>Chat</small>';
            button.title = `Restore ${side} panel`;
            button.onclick = () => togglePanel(side);
            
            document.body.appendChild(button);
        }

        function removeRestoreButton(side) {
            const button = document.getElementById(`restore-${side}`);
            if (button) button.remove();
        }

        async function refreshUI() {
            await loadMetrics();
            await loadComponentsList();
            await populateDependencyDropdown();
        }

        async function loadMetrics() {
            try {
                const response = await fetch(`/api/session-metrics/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateMetricsDisplay(data.metrics);
                    }
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        function updateMetricsDisplay(metrics) {
            document.getElementById('totalComponents').textContent = metrics.total_components || 0;
            document.getElementById('totalPrograms').textContent = metrics.component_counts?.PROGRAM || 0;
            document.getElementById('totalFields').textContent = metrics.total_fields || 0;
            document.getElementById('totalTokens').textContent = 
                (metrics.token_usage?.total_prompt_tokens || 0) + (metrics.token_usage?.total_response_tokens || 0);
        }

        async function loadComponentsList() {
            try {
                const response = await fetch(`/api/components/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateComponentsList(data.components);
                    }
                }
            } catch (error) {
                console.error('Error loading components list:', error);
            }
        }

        function updateComponentsList(components) {
            const container = document.getElementById('componentsList');
            container.innerHTML = '';

            if (!components || components.length === 0) {
                container.innerHTML = '<p class="text-muted">No components uploaded yet</p>';
                return;
            }

            const list = document.createElement('div');
            const typeGroups = {};

            components.forEach(component => {
                const type = component.component_type;
                if (!typeGroups[type]) {
                    typeGroups[type] = [];
                }
                typeGroups[type].push(component);
            });

            Object.keys(typeGroups).forEach(type => {
                const typeHeader = document.createElement('h5');
                typeHeader.textContent = `${type}s (${typeGroups[type].length})`;
                typeHeader.style.color = '#667eea';
                typeHeader.style.marginTop = '1rem';
                typeHeader.style.fontSize = '0.9rem';
                list.appendChild(typeHeader);

                typeGroups[type].forEach(component => {
                    const item = document.createElement('div');
                    item.style.padding = '0.5rem';
                    item.style.borderLeft = '3px solid #667eea';
                    item.style.paddingLeft = '0.5rem';
                    item.style.marginBottom = '0.5rem';
                    item.style.backgroundColor = '#f8f9ff';
                    item.style.borderRadius = '4px';
                    item.style.cursor = 'pointer';
                    
                    let businessPurpose = (component.llm_summary && component.llm_summary.business_purpose) || component.business_purpose || 'Analysis pending';
                    
                    if ((!component.llm_summary || !component.llm_summary.business_purpose) && component.analysis_result_json) {
                        try {
                            const analysis = JSON.parse(component.analysis_result_json);
                            if (analysis.llm_summary && analysis.llm_summary.business_purpose) {
                                businessPurpose = analysis.llm_summary.business_purpose;
                            } else if (analysis.business_purpose) {
                                businessPurpose = analysis.business_purpose;
                            }
                        } catch (e) {
                            console.warn('Could not parse analysis for', component.component_name);
                        }
                    }
                    
                    item.innerHTML = `
                        <div style="font-weight: bold; font-size: 0.8rem;">${component.component_name}</div>
                        <div style="font-size: 0.7rem; color: #666; margin-top: 0.2rem;">
                            ${component.total_lines || 0} lines
                        </div>
                        <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem; 
                                   max-height: 2.4em; overflow: hidden; line-height: 1.2em;">
                            ${businessPurpose}
                        </div>
                    `;
                    
                    item.onclick = () => {
                        alert(`${component.component_name}\n\nLines: ${component.total_lines || 0}\n\nPurpose: ${businessPurpose}`);
                    };
                    
                    list.appendChild(item);
                });
            });

            container.appendChild(list);
        }

        function updateDashboardMetrics(components) {
            const programs = components.filter(c => c.component_type === 'PROGRAM');
            const recordLayouts = components.filter(c => c.component_type === 'RECORD_LAYOUT');
            const cicsFiles = components.filter(c => c.component_type === 'CICS_FILE');
            
            document.getElementById('parsedPrograms').textContent = programs.length;
            document.getElementById('recordLayouts').textContent = recordLayouts.length;
            document.getElementById('cicsFiles').textContent = cicsFiles.length;
        }

        // Additional component actions
        function reAnalyzeComponent(componentName) {
            alert(`Re-analysis functionality for ${componentName} coming soon!`);
        }

        function askAboutThis(componentName) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value = `Tell me about the ${componentName} component. What does it do and how does it work?`;
            chatInput.focus();
        }

        function filterComponents() {
            console.log('Filtering components...');
        }

        // Component Details Functions
        async function showProgramDetails(programName) {
        try {
            // Get detailed program information from API
            const response = await fetch(`/api/component-source/${currentSessionId}/${programName}`);
            const data = await response.json();
            
            if (data.success) {
                displayProgramDetailsModal(data.components[0], programName);
            } else {
                // Fallback to basic component data
                showBasicProgramDetails(programName);
            }
        } catch (error) {
            console.error('Error loading program details:', error);
            showBasicProgramDetails(programName);
        }
    }

        async function showFileDetails(fileName) {
    try {
        // Get file and layout information
        const [dependencyResponse, layoutResponse] = await Promise.all([
            fetch(`/api/dependencies/${currentSessionId}`),
            fetch(`/api/record-layouts/${currentSessionId}`)
        ]);
        
        const dependencyData = await dependencyResponse.json();
        const layoutData = await layoutResponse.json();
        
        displayFileDetailsModal(fileName, dependencyData, layoutData);
    } catch (error) {
        console.error('Error loading file details:', error);
        showBasicFileDetails(fileName);
    }
}

function displayProgramDetailsModal(programData, programName) {
    // Safety check and defaults
    if (!programData) {
        programData = {
            component_name: programName,
            friendly_name: programName.replace('-', ' '),
            component_type: 'COBOL Program',
            total_lines: 'Unknown',
            total_fields: 'Unknown',
            business_purpose: 'Program analysis information not available',
            source_for_chat: 'Source code not available'
        };
    }

    const modalHtml = `
        <div class="modal" style="display: block; z-index: 10001;">
            <div class="modal-content" style="width: 80%; max-width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title">${programName} - Program Details</h3>
                    <button class="close" onclick="closeProgramModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h5>Program Information</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>Program Name:</strong></td><td>${programData.component_name || programName}</td></tr>
                                <tr><td><strong>Friendly Name:</strong></td><td>${programData.friendly_name || programName.replace('-', ' ')}</td></tr>
                                <tr><td><strong>Type:</strong></td><td>${programData.component_type || 'COBOL Program'}</td></tr>
                                <tr><td><strong>Lines of Code:</strong></td><td>${programData.total_lines || 'Unknown'}</td></tr>
                                <tr><td><strong>Total Fields:</strong></td><td>${programData.total_fields || 'Unknown'}</td></tr>
                            </table>
                        </div>
                        <div>
                            <h5>Analysis Metrics</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>Complexity Score:</strong></td><td>${programData.complexity_score ? Math.round(programData.complexity_score * 100) + '%' : 'N/A'}</td></tr>
                                <tr><td><strong>Analysis Status:</strong></td><td><span class="badge badge-success">Complete</span></td></tr>
                                <tr><td><strong>Dependencies:</strong></td><td id="programDependencyCount">Loading...</td></tr>
                                <tr><td><strong>Called By:</strong></td><td id="programCallerCount">Loading...</td></tr>
                            </table>
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <h5>Business Purpose</h5>
                        <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                            ${programData.business_purpose || 'This program handles mainframe business logic and data processing operations.'}
                        </div>
                    </div>

                    <div class="program-details-tabs">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; border-bottom: 1px solid #e9ecef;">
                            <button class="tab-button active" onclick="showProgramTab('dependencies', this)">Dependencies</button>
                            <button class="tab-button" onclick="showProgramTab('fields', this)">Field Usage</button>
                            <button class="tab-button" onclick="showProgramTab('source', this)">Source Code</button>
                        </div>

                        <div id="dependencies-tab" class="program-tab active">
                            <div id="programDependencies">Loading dependency information...</div>
                        </div>

                        <div id="fields-tab" class="program-tab" style="display: none;">
                            <div id="programFields">Loading field usage...</div>
                        </div>

                        <div id="source-tab" class="program-tab" style="display: none;">
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; max-height: 400px; overflow-y: auto;">
                                <pre style="margin: 0; font-size: 0.8rem; white-space: pre-wrap;">${programData.source_for_chat || 'Source code not available'}</pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="askAboutProgram('${programName}')">Ask AI About This</button>
                    <button class="btn btn-secondary" onclick="closeProgramModal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Load additional data
    loadProgramDependencies(programName);
    loadProgramFields(programName);
}

async function loadProgramDependencies(programName) {
    try {
        const response = await fetch(`/api/dependencies/${currentSessionId}`);
        const data = await response.json();
        
        if (data.success) {
            const outgoing = data.dependencies.filter(dep => dep.source_component === programName);
            const incoming = data.dependencies.filter(dep => dep.target_component === programName);
            
            document.getElementById('programDependencyCount').textContent = outgoing.length;
            document.getElementById('programCallerCount').textContent = incoming.length;
            
            const dependenciesHtml = createDependencyTables(outgoing, incoming);
            document.getElementById('programDependencies').innerHTML = dependenciesHtml;
        }
    } catch (error) {
        console.error('Error loading program dependencies:', error);
        document.getElementById('programDependencies').innerHTML = 'Error loading dependency information.';
    }
}

function createDependencyTables(outgoing, incoming) {
    let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">';
    
    html += '<div><h6>This Program Calls:</h6>';
    if (outgoing.length > 0) {
        html += '<div style="max-height: 200px; overflow-y: auto;">';
        outgoing.forEach(dep => {
            const icon = dep.interface_type === 'CICS' ? 'ðŸ¦' : dep.relationship_type.includes('FILE') ? 'ðŸ“' : 'ðŸ“ž';
            html += `<div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 4px; font-size: 0.8rem;">${icon} <strong>${dep.target_component}</strong><br><small>${dep.relationship_type} via ${dep.interface_type}</small></div>`;
        });
        html += '</div>';
    } else {
        html += '<p class="text-muted">No outgoing dependencies found.</p>';
    }
    html += '</div>';
    
    html += '<div><h6>Called By:</h6>';
    if (incoming.length > 0) {
        html += '<div style="max-height: 200px; overflow-y: auto;">';
        incoming.forEach(dep => {
            html += `<div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #28a745; border-radius: 4px; font-size: 0.8rem;">ðŸ“ž <strong>${dep.source_component}</strong><br><small>${dep.relationship_type}</small></div>`;
        });
        html += '</div>';
    } else {
        html += '<p class="text-muted">No incoming dependencies found.</p>';
    }
    html += '</div></div>';
    
    return html;
}

async function loadProgramFields(programName) {
    try {
        const response = await fetch(`/api/field-matrix?session_id=${currentSessionId}&program_name=${programName}`);
        const data = await response.json();
        
        if (data.success && data.matrix_data) {
            const fieldsHtml = createProgramFieldsDisplay(data.matrix_data);
            document.getElementById('programFields').innerHTML = fieldsHtml;
        } else {
            document.getElementById('programFields').innerHTML = '<p class="text-muted">No field usage information available.</p>';
        }
    } catch (error) {
        console.error('Error loading program fields:', error);
        document.getElementById('programFields').innerHTML = 'Error loading field information.';
    }
}

function createProgramFieldsDisplay(matrixData) {
    const fields = matrixData.fields || [];
    
    if (fields.length === 0) {
        return '<p class="text-muted">No field usage data found.</p>';
    }

    let html = `<div style="max-height: 300px; overflow-y: auto;"><table class="data-table" style="font-size: 0.8rem;"><thead><tr><th>Field Name</th><th>Usage</th><th>Source/Target</th><th>Purpose</th></tr></thead><tbody>`;

    fields.forEach(field => {
        html += `<tr><td><strong>${field.field_name}</strong>${field.friendly_name ? `<br><small class="text-muted">${field.friendly_name}</small>` : ''}</td><td><span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type || 'STATIC'}</span></td><td>${field.source_field || 'N/A'}</td><td>${field.business_purpose || 'Field processing'}</td></tr>`;
    });

    html += '</tbody></table></div>';
    return html;
}

function displayFileDetailsModal(fileName, dependencyData, layoutData) {
    // Find related layouts
    const relatedLayouts = layoutData.success ? 
        layoutData.layouts.filter(layout => 
            layout.layout_name.toUpperCase().includes(fileName.toUpperCase()) ||
            fileName.toUpperCase().includes(layout.layout_name.toUpperCase())
        ) : [];

    // Find file dependencies
    const fileDependencies = dependencyData.success ?
        dependencyData.dependencies.filter(dep => 
            dep.target_component.toUpperCase() === fileName.toUpperCase()
        ) : [];

    const modalHtml = `
        <div class="modal" style="display: block; z-index: 10001;">
            <div class="modal-content" style="width: 80%; max-width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title">${fileName} - File Details</h3>
                    <button class="close" onclick="closeFileModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h5>File Information</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>File Name:</strong></td><td>${fileName}</td></tr>
                                <tr><td><strong>Interface Type:</strong></td><td>${fileDependencies[0]?.interface_type || 'FILE_SYSTEM'}</td></tr>
                                <tr><td><strong>I/O Operations:</strong></td><td>${getFileOperations(fileDependencies)}</td></tr>
                                <tr><td><strong>Access Programs:</strong></td><td>${fileDependencies.length}</td></tr>
                            </table>
                        </div>
                        <div>
                            <h5>Layout Information</h5>
                            <table style="width: 100%; font-size: 0.9rem;">
                                <tr><td><strong>Associated Layouts:</strong></td><td>${relatedLayouts.length}</td></tr>
                                <tr><td><strong>Total Fields:</strong></td><td>${getTotalFields(relatedLayouts)}</td></tr>
                                <tr><td><strong>Layout Status:</strong></td><td>${relatedLayouts.length > 0 ? '<span class="badge badge-success">Available</span>' : '<span class="badge badge-warning">No Layouts</span>'}</td></tr>
                            </table>
                        </div>
                    </div>

                    <div class="file-details-tabs">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; border-bottom: 1px solid #e9ecef;">
                            <button class="tab-button active" onclick="showFileTab('access', this)">File Access</button>
                            <button class="tab-button" onclick="showFileTab('layouts', this)">Record Layouts</button>
                            <button class="tab-button" onclick="showFileTab('fields', this)">Field Structure</button>
                        </div>

                        <div id="access-tab" class="file-tab active">
                            <h6>Programs Accessing This File</h6>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${createFileAccessTable(fileDependencies)}
                            </div>
                        </div>

                        <div id="layouts-tab" class="file-tab" style="display: none;">
                            <h6>Associated Record Layouts</h6>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${createLayoutTable(relatedLayouts)}
                            </div>
                        </div>

                        <div id="fields-tab" class="file-tab" style="display: none;">
                            <h6>Field Structure Analysis</h6>
                            <div id="fileFieldStructure">
                                ${relatedLayouts.length > 0 ? 'Loading field structure...' : 'No layout information available for field analysis.'}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="analyzeFileMapping('${fileName}')">Analyze Field Mapping</button>
                    <button class="btn btn-secondary" onclick="askAboutFile('${fileName}')">Ask AI About This</button>
                    <button class="btn btn-secondary" onclick="closeFileModal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Load field structure if layouts are available
    if (relatedLayouts.length > 0) {
        loadFileFieldStructure(fileName, relatedLayouts[0].layout_name);
    }
}

// Helper functions for file details
function getFileOperations(dependencies) {
    const operations = new Set();
    dependencies.forEach(dep => {
        if (dep.analysis_details && dep.analysis_details.operations) {
            dep.analysis_details.operations.forEach(op => operations.add(op));
        }
    });
    return Array.from(operations).join(', ') || 'READ/WRITE';
}

function getTotalFields(layouts) {
    return layouts.reduce((total, layout) => total + (layout.fields_count || 0), 0);
}

function createFileAccessTable(dependencies) {
    if (dependencies.length === 0) {
        return '<p class="text-muted">No program access information available.</p>';
    }

    let html = `<table class="data-table" style="font-size: 0.9rem;"><thead><tr><th>Program</th><th>Operation</th><th>Interface</th><th>Confidence</th></tr></thead><tbody>`;

    dependencies.forEach(dep => {
        const operations = dep.analysis_details?.operations?.join(', ') || 'Unknown';
        const confidence = Math.round((dep.confidence_score || 0) * 100);
        html += `<tr><td>${dep.source_component}</td><td>${operations}</td><td>${dep.interface_type || 'FILE'}</td><td>${confidence}%</td></tr>`;
    });

    html += '</tbody></table>';
    return html;
}

function createLayoutTable(layouts) {
    if (layouts.length === 0) {
        return '<p class="text-muted">No record layouts found for this file.</p>';
    }

    let html = `<table class="data-table" style="font-size: 0.9rem;"><thead><tr><th>Layout Name</th><th>Program</th><th>Fields</th><th>Actions</th></tr></thead><tbody>`;

    layouts.forEach(layout => {
        html += `<tr><td><strong>${layout.layout_name}</strong>${layout.friendly_name ? `<br><small class="text-muted">${layout.friendly_name}</small>` : ''}</td><td>${layout.program_name || 'Unknown'}</td><td>${layout.fields_count || 0}</td><td><button class="btn btn-secondary" onclick="viewLayoutFields('${layout.layout_name}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Fields</button></td></tr>`;
    });

    html += '</tbody></table>';
    return html;
}

// Tab switching functions
function showProgramTab(tabName, button) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    document.querySelectorAll('.program-tab').forEach(tab => tab.style.display = 'none');
    document.getElementById(tabName + '-tab').style.display = 'block';
}

function showFileTab(tabName, button) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    document.querySelectorAll('.file-tab').forEach(tab => tab.style.display = 'none');
    document.getElementById(tabName + '-tab').style.display = 'block';
}

// Modal close functions
function closeProgramModal() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (modal.style.zIndex === '10001') {
            modal.remove();
        }
    });
}

function closeFileModal() {
    closeProgramModal();
}

// Action functions
function askAboutProgram(programName) {
    closeProgramModal();
    const chatInput = document.getElementById('chatInput');
    chatInput.value = `Tell me about the ${programName} program. What does it do, what are its key functions, and how does it interact with other components?`;
    chatInput.focus();
}

function askAboutFile(fileName) {
    closeFileModal();
    const chatInput = document.getElementById('chatInput');
    chatInput.value = `Explain the ${fileName} file. What data does it contain, which programs access it, and what is its business purpose?`;
    chatInput.focus();
}

function analyzeFileMapping(fileName) {
    closeFileModal();
    showTab({target: document.querySelector('.tab-btn:nth-child(5)')}, 'fieldMapping');
    document.getElementById('targetFileInput').value = fileName;
}

function viewLayoutFields(layoutName) {
    closeFileModal();
    showTab({target: document.querySelector('.tab-btn:nth-child(4)')}, 'fieldMatrix');
    document.getElementById('recordLayoutSelect').value = layoutName;
    loadFieldMatrix();
}

// Fallback functions
function showBasicProgramDetails(programName) {
    alert(`Program Details: ${programName}\n\nDetailed information could not be loaded.\nPlease check the connection and try again.`);
}

function showBasicFileDetails(fileName) {
    alert(`File Details: ${fileName}\n\nDetailed information could not be loaded.\nPlease check the connection and try again.`);
}



        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('configModal');
            const fieldModal = document.getElementById('fieldDetailsModal');
            
            if (event.target === modal) {
                closeConfigModal();
            }
            if (event.target === fieldModal) {
                closeFieldDetailsModal();
            }
        }

  


function createFileLayerWithLayouts(title, items, className) {
            let html = `
                <div class="flow-level">
                    <div class="flow-level-title">${title}</div>
                    <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">
 `;
            
            items.forEach(item => {
                const layoutInfo = item.hasLayoutAssociation && item.associatedLayouts.length > 0 ?
                    `<div style="font-size: 0.7rem; color: #666; margin-top: 0.5rem;">
                        ðŸ“‹ Layouts: ${item.associatedLayouts.slice(0, 2).join(', ')}
                        ${item.associatedLayouts.length > 2 ? ` (+${item.associatedLayouts.length - 2} more)` : ''}
                    </div>` : '';
                    
                const interfaceIcon = item.interface === 'CICS' ? 'ðŸ¦' : 'ðŸ“';
                const statusClass = item.hasLayoutAssociation ? 'file-with-layout' : 'file-only';
                
                html += `
                    <div class="flow-component ${className} ${statusClass}" onclick="showFileDetails('${item.name}')">
                        <div class="component-name">${interfaceIcon} ${item.name}</div>
                        <div class="component-type-badge">${item.type}</div>
                        <div class="component-description">
                            Operations: ${item.operations.join(', ') || 'Unknown'}
                            <br>Interface: ${item.interface}
                            ${layoutInfo}
                        </div>
                        <div class="confidence-indicator ${getConfidenceClass(item.confidence)}">
                            ${(item.confidence * 100).toFixed(0)}%
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

        function createProgramLayerWithArrows(title, items, className) {
            let html = `
                <div class="flow-level">
                    <div class="flow-level-title">${title}</div>
                    <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">
            `;
            
            items.forEach(item => {
                const arrowIcon = getCallArrowIcon(item.callType);
                const statusClass = item.status === 'missing' ? 'missing-dependency' : 'present-program';
                
                html += `
                    <div class="program-call-container">
                        <div class="call-arrow">${arrowIcon}</div>
                        <div class="flow-component ${className} ${statusClass}" onclick="showProgramDetails('${item.name}')">
                            <div class="component-name">${item.name}</div>
                            <div class="component-type-badge">${item.type}</div>
                            <div class="component-description">
                                Call Type: ${item.callType}
                                <br>Status: ${item.status || 'Present'}
                            </div>
                            <div class="confidence-indicator ${getConfidenceClass(item.confidence)}">
                                ${(item.confidence * 100).toFixed(0)}%
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

        function getCallArrowIcon(callType) {
            const arrowMap = {
                'CALL': 'â†”ï¸',
                'XCTL': 'â†’',
                'LINK': 'â†”ï¸',
                'DYNAMIC': 'â¤´ï¸',
                'CICS_LINK': 'â†”ï¸',
                'CICS_XCTL': 'â†’'
            };
            
            return arrowMap[callType] || 'â†’';
        }

        function getConfidenceClass(confidence) {
            if (confidence > 0.8) return 'confidence-high';
            if (confidence > 0.5) return 'confidence-medium';
            return 'confidence-low';
        }

        function categorizeDependenciesWithLayouts(dependencies, focusComponent = null) {
    const categorized = {
        inputFiles: [],
        outputFiles: [],
        inputOutputFiles: [],
        db2InputTables: [],      // NEW: DB2 input tables
        db2OutputTables: [],     // NEW: DB2 output tables
        db2IOTables: [],         // NEW: DB2 input/output tables
        corePrograms: [],
        calledPrograms: [],
        missingPrograms: []
    };
    
    dependencies.forEach(dep => {
        const source = dep.source_component;
        const target = dep.target_component;
        const type = dep.relationship_type;
        const analysis = dep.analysis_details || {};
        const interfaceType = dep.interface_type;
        
        if (type === 'PROGRAM_CALL' || type === 'DYNAMIC_PROGRAM_CALL') {
            const callType = analysis.call_type || 'CALL';
            const isTarget = target === focusComponent;
            
            if (focusComponent && isTarget) {
                categorized.corePrograms.push({
                    name: source,
                    type: 'Calling Program',
                    confidence: dep.confidence_score || 0.8,
                    callDirection: 'incoming',
                    callType: callType
                });
            } else {
                categorized.calledPrograms.push({
                    name: target,
                    type: 'Called Program',
                    confidence: dep.confidence_score || 0.8,
                    callDirection: getArrowDirection(callType),
                    callType: callType,
                    status: dep.dependency_status || 'unknown'
                });
            }
        }
        // Handle DB2 table operations
        else if (interfaceType === 'DB2' || type.includes('DB2')) {
            const sqlOperation = analysis.sql_operation || 'UNKNOWN';
            const ioDirection = analysis.io_direction || 'UNKNOWN';
            
            const db2Info = {
                name: target,
                type: 'DB2 Table',
                confidence: dep.confidence_score || 0.95,
                sqlOperation: sqlOperation,
                ioDirection: ioDirection,
                interface: 'DB2',
                operations: analysis.operations || [sqlOperation],
                sourceProgram: source,
                tableType: getDB2TableType(sqlOperation)
            };
            
            // Categorize by SQL operation type
            if (type === 'DB2_INPUT_TABLE' || sqlOperation.includes('SELECT') || sqlOperation.includes('FETCH')) {
                categorized.db2InputTables.push(db2Info);
            } else if (type === 'DB2_OUTPUT_TABLE' || sqlOperation.includes('INSERT') || sqlOperation.includes('UPDATE') || sqlOperation.includes('DELETE')) {
                categorized.db2OutputTables.push(db2Info);
            } else if (ioDirection === 'INPUT_OUTPUT') {
                categorized.db2IOTables.push(db2Info);
            } else {
                // Default categorization based on SQL keywords
                if (sqlOperation.includes('SELECT')) {
                    categorized.db2InputTables.push(db2Info);
                } else if (sqlOperation.includes('INSERT') || sqlOperation.includes('UPDATE') || sqlOperation.includes('DELETE')) {
                    categorized.db2OutputTables.push(db2Info);
                } else {
                    categorized.db2IOTables.push(db2Info);
                }
            }
        }
        // Handle regular file operations
        else if (type.includes('FILE')) {
            const ioDirection = analysis.io_direction || 'UNKNOWN';
            const associatedLayouts = analysis.associated_layouts || [];
            const hasLayout = analysis.has_layout_association || false;
            
            const fileInfo = {
                name: target,
                type: getFileTypeLabel(type),
                confidence: dep.confidence_score || 0.8,
                ioDirection: ioDirection,
                associatedLayouts: associatedLayouts,
                hasLayoutAssociation: hasLayout,
                interface: dep.interface_type || 'FILE',
                operations: analysis.operations || []
            };
            
            if (ioDirection === 'INPUT') {
                categorized.inputFiles.push(fileInfo);
            } else if (ioDirection === 'OUTPUT') {
                categorized.outputFiles.push(fileInfo);
            } else if (ioDirection === 'INPUT_OUTPUT') {
                categorized.inputOutputFiles.push(fileInfo);
            }
        }
        
        if (dep.dependency_status === 'missing') {
            categorized.missingPrograms.push({
                name: target,
                type: 'Missing Program',
                confidence: dep.confidence_score || 0.3,
                reason: 'Program not uploaded',
                calledFrom: source
            });
        }
    });
    
    return categorized;
}

// Helper function to determine DB2 table type based on SQL operation
function getDB2TableType(sqlOperation) {
    if (sqlOperation.includes('SELECT') || sqlOperation.includes('FETCH')) {
        return 'Source Table';
    } else if (sqlOperation.includes('INSERT')) {
        return 'Target Table';
    } else if (sqlOperation.includes('UPDATE')) {
        return 'Update Target';
    } else if (sqlOperation.includes('DELETE')) {
        return 'Delete Target';
    }
    return 'Data Table';
}

        function getArrowDirection(callType) {
            const directionMap = {
                'CALL': 'bidirectional',
                'XCTL': 'outgoing',
                'LINK': 'bidirectional',
                'DYNAMIC': 'outgoing',
                'CICS_LINK': 'bidirectional',
                'CICS_XCTL': 'outgoing'
            };
            
            return directionMap[callType] || 'outgoing';
        }

        function getFileTypeLabel(relationshipType) {
            if (relationshipType.includes('CICS')) {
                return 'CICS File';
            } else if (relationshipType.includes('INPUT_OUTPUT')) {
                return 'I/O File';
            } else if (relationshipType.includes('INPUT')) {
                return 'Input File';
            } else if (relationshipType.includes('OUTPUT')) {
                return 'Output File';
            }
            return 'File';
        }

        // Dependencies Flow Functions
        async function loadDependencyFlow() {
            const selectedComponent = document.getElementById('dependencyComponentSelect').value;
            
            try {
                console.log('Loading dependency flow for:', selectedComponent || 'Overall System');
                
                await populateDependencyDropdown();
                
                const response = await fetch(`/api/dependencies/${currentSessionId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Dependencies response:', data);
                    
                    if (data.success && data.dependencies && data.dependencies.length > 0) {
                        displayEnhancedDependencyFlowWithLayouts(data.dependencies, selectedComponent);
                        
                        if (document.getElementById('dependencyStatusSummary')) {
                            updateDependencyStatusDisplay(data.dependencies);
                        }
                    } else {
                        displayEmptyDependencyFlow();
                    }
                } else {
                    console.error('Dependencies API response not ok:', response.status);
                    displayEmptyDependencyFlow();
                }
            } catch (error) {
                console.error('Error loading dependency flow:', error);
                displayEmptyDependencyFlow();
            }
            setTimeout(() => {
                initializeDependencyFlowInteractivity();
            }, 100);
        }

        async function displayEnhancedDependencyFlowWithLayouts(dependencies, selectedComponent) {
    console.log('Displaying enhanced flow with layout associations');
    
    const flowContainer = document.getElementById('dependencyFlowContent');
    flowContainer.innerHTML = '';
    
    let filteredDeps = dependencies;
    if (selectedComponent) {
        filteredDeps = dependencies.filter(dep => 
            dep.source_component === selectedComponent || dep.target_component === selectedComponent
        );
    }
    
    if (filteredDeps.length === 0) {
        flowContainer.innerHTML = `<p class="text-muted">No dependencies found for ${selectedComponent || 'the system'}</p>`;
        return;
    }
    
    const categorizedDeps = categorizeDependenciesWithLayouts(filteredDeps, selectedComponent);
    
    const flowHtml = await createEnhancedDependencyFlowHTML(categorizedDeps, selectedComponent);
    flowContainer.innerHTML = flowHtml;
}

async function loadFileFieldStructure(fileName, layoutName) {
    try {
        const response = await fetch(`/api/field-matrix?session_id=${currentSessionId}&record_layout=${layoutName}`);
        const data = await response.json();
        
        if (data.success && data.matrix_data) {
            const fieldStructure = document.getElementById('fileFieldStructure');
            fieldStructure.innerHTML = createFieldStructureDisplay(data.matrix_data);
        }
    } catch (error) {
        console.error('Error loading field structure:', error);
        const fieldStructure = document.getElementById('fileFieldStructure');
        if (fieldStructure) {
            fieldStructure.innerHTML = '<p class="text-muted">Error loading field structure information.</p>';
        }
    }
}

function createFieldStructureDisplay(matrixData) {
    if (!matrixData.fields && !matrixData.program_layouts) {
        return '<p class="text-muted">No field structure data available.</p>';
    }

    const fields = matrixData.fields || (matrixData.program_layouts && matrixData.program_layouts[0]?.fields) || [];
    
    if (fields.length === 0) {
        return '<p class="text-muted">No fields found in layout.</p>';
    }

    let html = `
        <table class="data-table" style="font-size: 0.8rem;">
            <thead>
                <tr>
                    <th>Field Name</th>
                    <th>Usage Type</th>
                    <th>Data Type</th>
                    <th>Purpose</th>
                </tr>
            </thead>
            <tbody>
    `;

    fields.slice(0, 10).forEach(field => { // Show first 10 fields
        html += `
            <tr>
                <td>
                    <strong>${field.field_name}</strong>
                    ${field.friendly_name ? `<br><small class="text-muted">${field.friendly_name}</small>` : ''}
                </td>
                <td><span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type || 'STATIC'}</span></td>
                <td><code>${field.data_type || field.mainframe_data_type || 'UNKNOWN'}</code></td>
                <td>${field.business_purpose || 'Field usage analysis'}</td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    
    if (fields.length > 10) {
        html += `<p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">Showing first 10 of ${fields.length} fields. <a href="#" onclick="viewAllFields('${matrixData.layout_name || 'layout'}')">View all fields</a></p>`;
    }

    return html;
}

function viewAllFields(layoutName) {
    viewLayoutFields(layoutName);
}
function viewLayoutFields(layoutName) {
    closeFileModal();
    // Switch to field matrix tab and pre-populate
    showTab({target: document.querySelector('.tab-btn:nth-child(4)')}, 'fieldMatrix');
    const recordLayoutSelect = document.getElementById('recordLayoutSelect');
    if (recordLayoutSelect) {
        recordLayoutSelect.value = layoutName;
        loadFieldMatrix();
    }
}

        function displayEmptyDependencyFlow() {
            document.getElementById('dependencyFlowContent').innerHTML = 
                '<p class="text-muted">Upload and analyze COBOL programs to see system architecture flow</p>';
        }

        function updateDependencyStatusDisplay(dependencies) {
            const statusCounts = {
                present: 0,
                missing: 0,
                file: 0,
                file_with_layout: 0,
                unknown: 0
            };
            
            dependencies.forEach(dep => {
                const status = dep.dependency_status || 'unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            document.getElementById('present-count').textContent = statusCounts.present || 0;
            document.getElementById('missing-count').textContent = statusCounts.missing || 0;
            document.getElementById('file-count').textContent = (statusCounts.file || 0) + (statusCounts.file_with_layout || 0);
            document.getElementById('unknown-count').textContent = statusCounts.unknown || 0;
            
            const fileCountElement = document.getElementById('file-count');
            if (statusCounts.file_with_layout > 0) {
                fileCountElement.title = `${statusCounts.file_with_layout} files have associated record layouts`;
                fileCountElement.style.borderLeft = '4px solid #28a745';
            }
            
            document.getElementById('dependencyStatusSummary').style.display = 'grid';
        }

        async function populateDependencyDropdown() {
            const select = document.getElementById('dependencyComponentSelect');
            if (!select) return;
            
            try {
                const response = await fetch(`/api/components/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.components) {
                        const programs = data.components.filter(c => c.component_type === 'PROGRAM');
                        
                        select.innerHTML = '<option value="">Overall System View</option>';
                        
                        programs.forEach(program => {
                            const option = document.createElement('option');
                            option.value = program.component_name;
                            option.textContent = `${program.component_name} (${program.friendly_name || program.component_name})`;
                            select.appendChild(option);
                        });
                        
                        console.log(`Populated dependency dropdown with ${programs.length} programs`);
                    }
                }
            } catch (error) {
                console.error('Error populating dependency dropdown:', error);
            }
        }

        function refreshDependencyFlow() {
            loadDependencyFlow();
        }

        function restoreNormalView() {
    // Hide enhanced view
    document.getElementById('enhancedDependenciesContainer').style.display = 'none';
    
    // Show normal view
    document.getElementById('dependenciesVisualization').style.display = 'block';
    
    // Reload normal dependency flow
    loadDependencyFlow();
    
    // Toggle buttons
    document.getElementById('enhancedViewBtn').style.display = 'inline-block';
    document.getElementById('normalViewBtn').style.display = 'none';
}
        async function loadEnhancedDependencies() {
    if (!currentSessionId) {
        showError('No active session');
        return;
    }

    try {
        showLoading('Loading enhanced dependencies...');
        
        const response = await fetch(`/api/dependencies-enhanced-with-dynamic/${currentSessionId}`);
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                displayEnhancedDependencies(data);
                showDependencyStatusSummary(data.status_counts);
                
                // Toggle buttons
                document.getElementById('enhancedViewBtn').style.display = 'none';
                document.getElementById('normalViewBtn').style.display = 'inline-block';
            } else {
                showError(data.error || 'Failed to load enhanced dependencies');
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error loading enhanced dependencies:', error);
        showError('Failed to load enhanced dependencies');
    }
    
    hideLoading();
}

        function showDependencyStatusSummary(statusCounts) {
            document.getElementById('present-count').textContent = statusCounts.present || 0;
            document.getElementById('missing-count').textContent = statusCounts.missing || 0;
            document.getElementById('file-count').textContent = statusCounts.file || 0;
            document.getElementById('unknown-count').textContent = statusCounts.unknown || 0;
            
            document.getElementById('dependencyStatusSummary').style.display = 'grid';
        }

        function displayEnhancedDependencies(data) {
            const container = document.getElementById('enhancedDependenciesContainer');
            const categorizedDeps = data.categorized_dependencies;
            const missingSummary = data.missing_summary;
            
            let html = '';
            
            if (missingSummary && missingSummary.total_missing > 0) {
                html += `
                <div class="alert alert-warning">
                    <h4>âš ï¸ Missing Dependencies (${missingSummary.total_missing})</h4>
                    <p>The following programs are called but not uploaded:</p>
                    <ul>
                        ${missingSummary.missing_programs.map(prog => 
                            `<li><strong>${prog}</strong> - Upload this program for complete analysis</li>`
                        ).join('')}
                    </ul>
                </div>`;
            }
            
            if (categorizedDeps.dynamic_calls && categorizedDeps.dynamic_calls.length > 0) {
                html += createDependencySection('ðŸ”„ Dynamic Program Calls', categorizedDeps.dynamic_calls, 'dynamic');
            }
            
            if (categorizedDeps.program_calls && categorizedDeps.program_calls.length > 0) {
                html += createDependencySection('ðŸ“ž Static Program Calls', categorizedDeps.program_calls, 'static');
            }
            
            if (categorizedDeps.cics_operations && categorizedDeps.cics_operations.length > 0) {
                html += createDependencySection('ðŸ¦ CICS File Operations', categorizedDeps.cics_operations, 'cics');
            }
            
            if (categorizedDeps.file_operations && categorizedDeps.file_operations.length > 0) {
                html += createDependencySection('ðŸ“ File Operations', categorizedDeps.file_operations, 'file');
            }

            // Add DB2 section to enhanced view
            if (categorizedDeps.db2_input_tables && categorizedDeps.db2_input_tables.length > 0) {
                html += createDependencySection('ðŸ—ƒï¸ DB2 Input Tables', categorizedDeps.db2_input_tables, 'db2_input');
            }

            if (categorizedDeps.db2_output_tables && categorizedDeps.db2_output_tables.length > 0) {
                html += createDependencySection('ðŸ—ƒï¸ DB2 Output Tables', categorizedDeps.db2_output_tables, 'db2_output');
            }
            
            container.innerHTML = html;
            container.style.display = 'block';
            
            document.getElementById('dependenciesVisualization').style.display = 'none';
        }

        function createDependencySection(title, dependencies, type) {
    let html = `
    <div class="dependency-section">
        <h3>${title}</h3>
        <div class="dependency-grid">
    `;
    
    dependencies.forEach(dep => {
        const statusIcon = getStatusIcon(dep.display_status);
        const statusClass = getStatusClass(dep.display_status);
        const confidenceClass = getConfidenceClass(dep.confidence_score);
        
        // Special handling for dynamic calls
        if (type === 'dynamic') {
            html += `
            <div class="dependency-card ${statusClass}">
                <div class="confidence-indicator ${confidenceClass}">
                    ${Math.round((dep.confidence_score || 0) * 100)}%
                </div>
                <div class="dependency-header">
                    ${statusIcon} <strong>${dep.variable_name || dep.target_component}</strong>
                </div>
                <div class="dependency-details">
                    <p><strong>Source Program:</strong> <span>${dep.source_component}</span></p>
                    <p><strong>Variable:</strong> <span>${dep.variable_name || 'Unknown'}</span></p>
                    <p><strong>Resolved Programs:</strong> <span>${dep.total_resolved_programs || 0}</span></p>
                    <p><strong>Resolution Methods:</strong> <span>${(dep.resolution_methods || []).join(', ')}</span></p>
                    ${dep.has_missing_programs ? '<p style="color: #dc3545;"><strong>Has Missing Programs</strong></p>' : ''}
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="showDynamicCallDetails('${dep.variable_name}', '${dep.source_component}')" 
                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                        View Details
                    </button>
                </div>
            </div>`;
        } else {
            // Regular dependency handling (existing code)
            html += `
            <div class="dependency-card ${statusClass}">
                <div class="confidence-indicator ${confidenceClass}">
                    ${Math.round((dep.confidence_score || 0) * 100)}%
                </div>
                <div class="dependency-header">
                    ${statusIcon} <strong>${dep.target_component}</strong>
                </div>
                <div class="dependency-details">
                    <p><strong>Called from:</strong> <span>${dep.source_component}</span></p>
                    ${type === 'cics' || type === 'file' ? 
                        `<p><strong>I/O Type:</strong> <span>${dep.analysis_details?.io_direction || 'Unknown'}</span></p>
                        <p><strong>Operations:</strong> <span>${(dep.analysis_details?.operations || []).join(', ')}</span></p>` : ''}
                    <p><strong>Type:</strong> <span>${dep.relationship_type}</span></p>
                </div>
            </div>`;
        }
    });
    
    html += '</div></div>';
    return html;
}

        function getStatusIcon(status) {
            switch (status) {
                case 'present': return 'âœ…';
                case 'missing': return 'âŒ';
                case 'file': return 'ðŸ“';
                default: return 'â“';
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'present': return 'status-present';
                case 'missing': return 'status-missing';
                case 'file': return 'status-file';
                default: return 'status-unknown';
            }
        }

        function getConfidenceClass(confidence) {
            if (confidence > 0.8) return 'confidence-high';
            if (confidence > 0.5) return 'confidence-medium';
            return 'confidence-low';
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'components') {
                loadComponentsLibrary();
            } else if (tabName === 'fieldMatrix') {
                loadFieldMatrixSelectors();
            } else if (tabName === 'dashboard') {
                loadDashboardSummaries();
            } else if (tabName === 'dependencies') {
                loadDependencyFlow();
                if (currentSessionId) {
                    setTimeout(() => {
                        const enhancedButton = document.querySelector('button[onclick="loadEnhancedDependencies()"]');
                        if (enhancedButton) {
                            enhancedButton.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                            enhancedButton.style.color = 'white';
                        }
                    }, 100);
                }
            } else if (tabName === 'fieldMapping') {
                initializeFieldMapping();
            } else if (tabName === 'program-flow') {  // ADD THIS
                initializeProgramFlow();
            }
        }

        function initializeProgramFlow() {
            // Initialize the program flow tab
            console.log('Program Flow tab initialized');
        }

        function showLoadingSpinner(message) {
            showLoading(message);
        }

        function hideLoadingSpinner() {
            hideLoading();
        }
        // Components Library Functions
        async function loadComponentsLibrary() {
            try {
                const response = await fetch(`/api/components-with-derived/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayComponentsLibrary(data.components);
                    }
                }
            } catch (error) {
                console.error('Error loading components library:', error);
            }
        }

        function displayComponentsLibrary(components) {
            const container = document.getElementById('mainComponentsView');
            container.innerHTML = '';

            const programs = components.filter(c => c.component_type === 'PROGRAM');
            
            if (programs.length === 0) {
                container.innerHTML = '<p class="text-muted">No programs uploaded yet</p>';
                return;
            }

            programs.forEach(program => {
                const card = document.createElement('div');
                card.className = 'component-summary-card';
                
                let businessPurpose = (program.llm_summary && program.llm_summary.business_purpose) || program.business_purpose || 'Analysis pending';
                let derivedCount = program.derived_count || 0;
                
                card.innerHTML = `
                    <div class="component-header">
                        <div>
                            <div class="component-title">${program.component_name}</div>
                            <div class="text-muted" style="font-size: 0.8rem;">${program.friendly_name || ''}</div>
                        </div>
                        <span class="component-type badge badge-primary">COBOL Program</span>
                    </div>
                    
                    <div class="business-purpose">${businessPurpose}</div>
                    
                    <div class="component-metrics">
                        <div class="metric">
                            <span class="metric-value">${program.total_lines || 0}</span>
                            <span class="metric-label">Lines of Code</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${derivedCount}</span>
                            <span class="metric-label">Analyzed Components</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${program.total_fields || 0}</span>
                            <span class="metric-label">Total Fields</span>
                        </div>
                    </div>
                    
                    <div class="derived-components">
                        <button class="derived-toggle" onclick="toggleDerivedComponents('${program.component_name}', this)">
                            View ${derivedCount} Analyzed Components
                        </button>
                        <div class="derived-list" id="derived-${program.component_name}">
                            <!-- Will be populated when expanded -->
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="reAnalyzeComponent('${program.component_name}')">Re-analyze Component</button>
                        <button class="btn btn-secondary" onclick="askAboutThis('${program.component_name}')">Ask AI About This</button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        async function toggleDerivedComponents(programName, button) {
            const derivedList = document.getElementById(`derived-${programName}`);
            
            if (derivedList.classList.contains('show')) {
                derivedList.classList.remove('show');
                button.textContent = button.textContent.replace('Hide', 'View');
            } else {
                if (derivedList.children.length === 0) {
                    try {
                        const response = await fetch(`/api/derived-components/${currentSessionId}?parent_component=${programName}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                displayDerivedComponentsList(derivedList, data.derived_components);
                            }
                        }
                    } catch (error) {
                        console.error('Error loading derived components:', error);
                        derivedList.innerHTML = '<p class="text-muted">Error loading components</p>';
                    }
                }
                
                derivedList.classList.add('show');
                button.textContent = button.textContent.replace('View', 'Hide');
            }
        }

        function displayDerivedComponentsList(container, derivedComponents) {
            container.innerHTML = '';
            
            derivedComponents.forEach(component => {
                const item = document.createElement('div');
                item.className = 'derived-item';
                
                item.innerHTML = `
                    <div>
                        <div class="derived-item-name">${component.component_name}</div>
                        <div class="text-muted" style="font-size: 0.8rem;">${component.friendly_name || ''}</div>
                    </div>
                    <div class="derived-item-type">${component.component_type}</div>
                `;
                
                container.appendChild(item);
            });
        }

        // Field Matrix Functions
        async function loadFieldMatrixSelectors() {
            try {
                const [componentsResponse, layoutsResponse] = await Promise.all([
                    fetch(`/api/components/${currentSessionId}`),
                    fetch(`/api/record-layouts/${currentSessionId}`)
                ]);
                
                if (componentsResponse.ok) {
                    const componentsData = await componentsResponse.json();
                    if (componentsData.success) {
                        populateProgramSelectors(componentsData.components);
                    }
                }
                
                if (layoutsResponse.ok) {
                    const layoutsData = await layoutsResponse.json();
                    if (layoutsData.success) {
                        populateLayoutSelectors(layoutsData.layouts);
                    }
                }
            } catch (error) {
                console.error('Error loading selectors:', error);
            }
        }

        function populateProgramSelectors(components) {
            const programSelect = document.getElementById('programSelect');
            programSelect.innerHTML = '<option value="">Select Program</option>';

            const programs = components.filter(c => c.component_type === 'PROGRAM');
            
            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.component_name;
                option.textContent = `${program.component_name} (${program.total_lines || 0} lines)`;
                programSelect.appendChild(option);
            });
        }

        function populateLayoutSelectors(layouts) {
            const recordLayoutSelect = document.getElementById('recordLayoutSelect');
            recordLayoutSelect.innerHTML = '<option value="">Select Record Layout</option>';

            layouts.forEach(layout => {
                const option = document.createElement('option');
                option.value = layout.layout_name;
                option.textContent = `${layout.layout_name} (${layout.fields_count || 0} fields) - ${layout.program_name}`;
                recordLayoutSelect.appendChild(option);
            });
        }

        async function loadFieldMatrix() {
            const recordLayout = document.getElementById('recordLayoutSelect').value;
            const program = document.getElementById('programSelect').value;

            if (!recordLayout && !program) {
                return;
            }

            showLoading('Loading field matrix...');

            try {
                const params = new URLSearchParams({
                    session_id: currentSessionId
                });
                
                if (recordLayout) params.append('record_layout', recordLayout);
                if (program) params.append('program_name', program);

                const response = await fetch(`/api/field-matrix?${params}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayFieldMatrix(data.matrix_data);
                    } else {
                        showError(data.error || 'Failed to load field matrix');
                    }
                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error loading field matrix:', error);
                showError('Failed to load field matrix');
            }

            hideLoading();
        }

        // Add to your main UI
function createProgramFlowView(sessionId) {
    return `
        <div class="program-flow-container">
            <div class="flow-controls">
                <input type="text" id="startingProgram" placeholder="Enter program name (e.g., TMSTM6)">
                <button onclick="analyzeFlow('${sessionId}')">Analyze Program Flow</button>
            </div>
            
            <div id="flowVisualization" class="flow-visualization">
                <!-- Flow diagram will be rendered here -->
            </div>
            
            <div id="flowDetails" class="flow-details">
                <div class="flow-summary"></div>
                <div class="missing-programs"></div>
                <div class="field-flows"></div>
                <div class="file-operations"></div>
            </div>
        </div>
    `;
}

        // Update the analyzeFlow function to use the correct session parameter
        async function analyzeFlow() {
            const programName = document.getElementById('startingProgram').value;
            if (!programName) {
                alert('Please enter a program name');
                return;
            }
            
            showLoadingSpinner('Analyzing program flow...');
            
            try {
                // Use currentSessionId from global scope
                const flowResponse = await fetch(`/api/program-flow/${currentSessionId}/${programName}`);
                const flowData = await flowResponse.json();
                
                if (!flowData.success) {
                    showError(flowData.error);
                    return;
                }
                
                // Get visualization data
                const vizResponse = await fetch(`/api/program-flow-visualization/${currentSessionId}/${programName}`);
                const vizData = await vizResponse.json();
                
                if (vizData.success) {
                    renderFlowVisualization(vizData.visualization_data);
                    renderFlowDetails(flowData.flow_analysis, vizData);
                }
                
            } catch (error) {
                showError(`Error analyzing flow: ${error.message}`);
            } finally {
                hideLoadingSpinner();
            }
        }


        function analyzeVariableUsage(variableName) {
            closeDynamicCallModal();
            const chatInput = document.getElementById('chatInput');
            chatInput.value = `Analyze the usage of variable ${variableName}. How is it populated and what programs can it call?`;
            chatInput.focus();
        }

        function askAboutDynamicCall(variableName) {
            closeDynamicCallModal();
            const chatInput = document.getElementById('chatInput');
            chatInput.value = `Tell me about the dynamic call using variable ${variableName}. What business logic determines which program gets called?`;
            chatInput.focus();
        }
        function renderFlowVisualization(vizData) {
    const container = document.getElementById('flowVisualization');
    
    // Clear previous content
    container.innerHTML = '';
    
    // Create hierarchical layout first
    let layoutNodes, layoutEdges;
    try {
        const layoutResult = createHierarchicalLayout(vizData);
        layoutNodes = layoutResult.layoutNodes;
        layoutEdges = layoutResult.layoutEdges;
    } catch (error) {
        console.error('Error creating layout:', error);
        container.innerHTML = '<p style="color: red;">Error creating program flow layout. Please check the data.</p>';
        return;
    }
    
    console.log(`Rendering VERTICAL TREE: ${layoutNodes.length} nodes, ${layoutEdges.length} edges`);
    
    console.log('=== DEBUGGING NODE POSITIONS ===');
    layoutNodes.forEach(node => {
        console.log(`${node.id}: x=${node.x}, y=${node.y}, level=${node.level}`);
    });
    console.log('=== END DEBUG ===');
    const legend = d3.select(container)
    .append('div')
    .attr('class', 'flow-legend');
    // Create SVG with proper vertical tree dimensions
     const svg = d3.select(container)
        .append('svg')
        .attr('width', '1400px')
        .attr('height', '1200px')
        .attr('viewBox', '0 0 1400 1200');

    
    // Verify SVG was created
    if (svg.empty()) {
        console.error('Failed to create SVG element');
        container.innerHTML = '<p style="color: red;">Failed to create SVG visualization.</p>';
        return;
    }
            // Add arrow markers
            const defs = svg.append('defs');
            createArrowMarkers(defs);
            
            // Draw edges first
            const edges = svg.selectAll('.flow-edge')
                .data(layoutEdges)
                .enter()
                .append('g')
                .attr('class', 'flow-edge');
            
            edges.each(function(d, i) {
                try {
                    drawEnhancedEdge(d3.select(this), d);
                } catch (error) {
                    console.error(`Error drawing edge ${i}:`, error, d);
                }
            });
            
            // Draw nodes
            const nodes = svg.selectAll('.flow-node')
                .data(layoutNodes)
                .enter()
                .append('g')
                .attr('class', 'flow-node')
                .attr('transform', d => `translate(${d.x},${d.y})`);
            
            // Draw shapes for each node type
            nodes.each(function(d, i) {
                try {
                    drawCustomShape(d3.select(this), d);
                } catch (error) {
                    console.error(`Error drawing node ${i}:`, error, d);
                }
            });
            
            // Add interactivity
            addEnhancedInteractivity(nodes, layoutEdges);
            
            // Create legend
            createEnhancedVisualizationLegend(legend);
        }
    
    
        
    

function createHierarchicalLayout(vizData) {
    const nodes = vizData.nodes || [];
    const edges = vizData.edges || [];
    
    if (!nodes.length) {
        throw new Error('No nodes provided for layout');
    }
    
    // Organize nodes by type
    const programNodes = nodes.filter(n => n.type === 'program');
    const fileNodes = nodes.filter(n => n.type === 'file');
    const db2Nodes = nodes.filter(n => n.type === 'db2_table');
    
    // Calculate proper hierarchy levels for vertical tree layout
    const hierarchy = calculateProgramHierarchy(programNodes, edges);
    
    // Vertical tree layout with centered positioning
    const layoutNodes = [];
    const levelHeight = 140;  // Vertical spacing between levels
    const svgWidth = 1400;
    const nodeSpacing = 180;  // Horizontal spacing between nodes at same level
    
    // Position program nodes in vertical hierarchy levels (top to bottom)
    // In createHierarchicalLayout, make sure this part is correct:
Object.keys(hierarchy).forEach((level, levelIndex) => {
    const nodesInLevel = hierarchy[level];
    const levelY = 80 + (levelIndex * 150);  // DIFFERENT Y for each level
    
    console.log(`Level ${level} (${levelIndex}): Y=${levelY}, nodes=${nodesInLevel.map(n => n.id)}`);
    
    // Position nodes horizontally within this level
    const nodeSpacing = 200;
    const totalWidth = nodesInLevel.length * nodeSpacing;
    const startX = (1400 - totalWidth) / 2;
    
    nodesInLevel.forEach((node, nodeIndex) => {
        const nodeX = startX + (nodeIndex * nodeSpacing);
        
        layoutNodes.push({
            ...node,
            x: nodeX,
            y: levelY,  // Different Y for each level = vertical layout
            level: parseInt(level),
            width: getNodeWidth(node),
            height: getNodeHeight(node)
        });
    });
});
    
    // Build program position lookup for files/DB2 placement
    const programPositions = {};
    layoutNodes.forEach(node => {
        if (node.type === 'program') {
            programPositions[node.id] = { x: node.x, y: node.y, level: node.level };
        }
    });
    
    // Position file nodes below their connected programs in vertical tree
    const maxProgramLevel = Math.max(...layoutNodes.filter(n => n.type === 'program').map(n => n.level));
    const filesStartY = 60 + ((maxProgramLevel + 1) * levelHeight) + 40;
    
    fileNodes.forEach((fileNode, index) => {
        const connectedProgram = fileNode.connected_to_program;
        const programPos = programPositions[connectedProgram];
        
        if (programPos) {
            // Group files under their parent program vertically
            const filesForThisProgram = fileNodes.filter(f => f.connected_to_program === connectedProgram);
            const fileIndex = filesForThisProgram.indexOf(fileNode);
            
            layoutNodes.push({
                ...fileNode,
                x: programPos.x + ((fileIndex - (filesForThisProgram.length - 1) / 2) * 140),
                y: filesStartY,
                level: maxProgramLevel + 2,
                width: getNodeWidth(fileNode),
                height: getNodeHeight(fileNode),
                parentProgram: connectedProgram
            });
        } else {
            // Fallback: arrange orphaned files horizontally at bottom
            const filesPerRow = Math.floor(svgWidth / 150);
            const row = Math.floor(index / filesPerRow);
            const col = index % filesPerRow;
            
            layoutNodes.push({
                ...fileNode,
                x: 100 + (col * 150),
                y: filesStartY + (row * 70),
                level: 999,
                width: getNodeWidth(fileNode),
                height: getNodeHeight(fileNode)
            });
        }
    });
    
    // Position DB2 nodes below files in vertical hierarchy
    const db2StartY = filesStartY + 100;
    db2Nodes.forEach((db2Node, index) => {
        const connectedProgram = db2Node.connected_to_program;
        const programPos = programPositions[connectedProgram];
        
        if (programPos) {
            const db2ForThisProgram = db2Nodes.filter(d => d.connected_to_program === connectedProgram);
            const db2Index = db2ForThisProgram.indexOf(db2Node);
            
            layoutNodes.push({
                ...db2Node,
                x: programPos.x + ((db2Index - (db2ForThisProgram.length - 1) / 2) * 150),
                y: db2StartY,
                level: maxProgramLevel + 3,
                width: getNodeWidth(db2Node),
                height: getNodeHeight(db2Node),
                parentProgram: connectedProgram
            });
        } else {
            // Fallback: arrange orphaned DB2 nodes horizontally
            const db2PerRow = Math.floor(svgWidth / 160);
            const row = Math.floor(index / db2PerRow);
            const col = index % db2PerRow;
            
            layoutNodes.push({
                ...db2Node,
                x: 100 + (col * 160),
                y: db2StartY + (row * 70),
                level: 998,
                width: getNodeWidth(db2Node),
                height: getNodeHeight(db2Node)
            });
        }
    });
    
    // Calculate enhanced edge positions with proper connections
    const layoutEdges = edges.map(edge => {
        const sourceNode = layoutNodes.find(n => n.id === edge.from);
        const targetNode = layoutNodes.find(n => n.id === edge.to);
        
        if (!sourceNode || !targetNode) {
            console.warn(`Missing nodes for edge: ${edge.from} -> ${edge.to}`);
            return null;
        }
        
        return {
            ...edge,
            source: sourceNode,
            target: targetNode,
            path: calculateEnhancedEdgePath(sourceNode, targetNode, edge)
        };
    }).filter(e => e !== null);
    
    return { layoutNodes, layoutEdges };
}

function calculateEnhancedEdgePath(sourceNode, targetNode, edge) {
            // Simple straight line for now - can be enhanced with curves
            return `M${sourceNode.x},${sourceNode.y} L${targetNode.x},${targetNode.y}`;
        }


function getPathType(edge, sourceNode, targetNode) {
    // Determine path type based on edge type and node layout
    const edgeType = edge.type;
    const levelDiff = Math.abs((sourceNode.level || 0) - (targetNode.level || 0));
    const distance = Math.abs(targetNode.x - sourceNode.x) + Math.abs(targetNode.y - sourceNode.y);
    
    if (edgeType === 'file_operation' || edgeType === 'db2_operation') {
        return 'curved';
    } else if (edgeType === 'dynamic_call') {
        return 'arc';
    } else if (levelDiff <= 1 && distance < 200) {
        return 'straight';
    } else {
        return 'stepped';
    }
}

function createStraightPath(source, target) {
    return `M${source.x},${source.y} L${target.x},${target.y}`;
}

function createCurvedPath(source, target, edge) {
    const dx = target.x - source.x;
    const dy = target.y - source.y;
    
    // Create a smooth curve with control points
    const controlX1 = source.x + dx * 0.3;
    const controlY1 = source.y;
    const controlX2 = target.x - dx * 0.3;
    const controlY2 = target.y;
    
    return `M${source.x},${source.y} C${controlX1},${controlY1} ${controlX2},${controlY2} ${target.x},${target.y}`;
}

function createSteppedPath(source, target, edge) {
    const dx = target.x - source.x;
    const dy = target.y - source.y;
    
    // Create a stepped path (L-shaped)
    if (Math.abs(dx) > Math.abs(dy)) {
        // Horizontal first, then vertical
        const midX = source.x + dx * 0.7;
        return `M${source.x},${source.y} L${midX},${source.y} L${midX},${target.y} L${target.x},${target.y}`;
    } else {
        // Vertical first, then horizontal
        const midY = source.y + dy * 0.7;
        return `M${source.x},${source.y} L${source.x},${midY} L${target.x},${midY} L${target.x},${target.y}`;
    }
}

function createArcPath(source, target, edge) {
    const dx = target.x - source.x;
    const dy = target.y - source.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    // Create an arc path for dynamic calls to show uncertainty
    const midX = source.x + dx * 0.5;
    const midY = source.y + dy * 0.5;
    
    // Add some curvature perpendicular to the direct line
    const perpX = -dy / distance * 30; // 30 pixels of curvature
    const perpY = dx / distance * 30;
    
    const controlX = midX + perpX;
    const controlY = midY + perpY;
    
    return `M${source.x},${source.y} Q${controlX},${controlY} ${target.x},${target.y}`;
}
function calculateProgramHierarchy(programNodes, edges) {
    const hierarchy = {};
    const visited = new Set();
    
    // Find starting program
    const startNode = programNodes.find(n => n.is_starting_program) || programNodes[0];
    if (!startNode) return { 0: programNodes };
    
    console.log('Starting node:', startNode.id);
    
    // Level 0 = top level (starting program)
    hierarchy[0] = [startNode];
    visited.add(startNode.id);
    
    const queue = [{ node: startNode, level: 0 }];
    
    while (queue.length > 0) {
        const { node: currentNode, level } = queue.shift();
        console.log(`Processing ${currentNode.id} at level ${level}`);
        
        // Find ALL outgoing program calls from this node
        const outgoingEdges = edges.filter(e => 
            e.from === currentNode.id && 
            (e.type === 'program_call' || e.call_type === 'CALL' || e.call_type === 'XCTL')
        );
        
        console.log(`Found ${outgoingEdges.length} outgoing calls from ${currentNode.id}`);
        
        outgoingEdges.forEach(edge => {
            const targetNode = programNodes.find(n => n.id === edge.to);
            if (targetNode && !visited.has(targetNode.id)) {
                const nextLevel = level + 1;
                console.log(`Adding ${targetNode.id} to level ${nextLevel}`);
                
                if (!hierarchy[nextLevel]) {
                    hierarchy[nextLevel] = [];
                }
                
                hierarchy[nextLevel].push(targetNode);
                visited.add(targetNode.id);
                queue.push({ node: targetNode, level: nextLevel });
            }
        });
    }
    
    // Add orphaned programs to last level
    programNodes.forEach(node => {
        if (!visited.has(node.id)) {
            const lastLevel = Math.max(...Object.keys(hierarchy).map(Number)) + 1;
            if (!hierarchy[lastLevel]) hierarchy[lastLevel] = [];
            hierarchy[lastLevel].push(node);
        }
    });
    
    console.log('Hierarchy created:', hierarchy);
    return hierarchy;
}

function drawEnhancedEdgeWithConnection(selection, edge) {
    const source = edge.source;
    const target = edge.target;
    
    // FIXED: Calculate proper connection points
    const sourcePoint = getEnhancedConnectionPoint(source, target, 'source');
    const targetPoint = getEnhancedConnectionPoint(target, source, 'target');
    
    // Determine edge style and color
    const edgeClass = getEdgeClass(edge);
    const markerEnd = getMarkerEnd(edge);
    const strokeColor = getEdgeColor(edge);
    
    // FIXED: Draw enhanced path with proper curves
    const path = selection.append('path')
        .attr('class', `flow-edge ${edgeClass}`)
        .attr('d', createEnhancedPath(sourcePoint, targetPoint, edge))
        .attr('fill', 'none')
        .attr('stroke', strokeColor)
        .attr('stroke-width', getStrokeWidth(edge))
        .attr('marker-end', `url(#${markerEnd})`);
    
    // Add stroke-dasharray for dynamic calls
    if (edge.type === 'dynamic_call' || edge.is_dynamic) {
        path.attr('stroke-dasharray', '8,4');
    }
    
    // FIXED: Add proper edge labels
    if (edge.label || edge.variable_name) {
        const midPoint = getMidPoint(sourcePoint, targetPoint);
        
        // Label background
        selection.append('rect')
            .attr('x', midPoint.x - 30)
            .attr('y', midPoint.y - 8)
            .attr('width', 60)
            .attr('height', 16)
            .attr('fill', 'white')
            .attr('stroke', strokeColor)
            .attr('stroke-width', 1)
            .attr('rx', 3);
        
        // Label text
        selection.append('text')
            .attr('x', midPoint.x)
            .attr('y', midPoint.y)
            .attr('text-anchor', 'middle')
            .attr('dy', '0.35em')
            .attr('font-size', '10px')
            .attr('font-weight', 'bold')
            .attr('fill', strokeColor)
            .text(edge.label || edge.variable_name || '');
    }
}

function getEnhancedConnectionPoint(node, otherNode, role) {
    const x = node.x || 0;
    const y = node.y || 0;
    const width = node.width || 100;
    const height = node.height || 50;
    
    // Calculate direction to other node
    const dx = (otherNode.x || 0) - x;
    const dy = (otherNode.y || 0) - y;
    
    // FIXED: Better connection point calculation
    if (Math.abs(dx) > Math.abs(dy)) {
        // Connect horizontally
        return {
            x: x + (dx > 0 ? width/2 : -width/2),
            y: y
        };
    } else {
        // Connect vertically
        return {
            x: x,
            y: y + (dy > 0 ? height/2 : -height/2)
        };
    }
}

function createEnhancedPath(source, target, edge) {
    const dx = target.x - source.x;
    const dy = target.y - source.y;
    
    // FIXED: Create smooth curves based on connection type
    if (edge.type === 'file_operation' || edge.type === 'db2_operation') {
        // Curved path for data connections
        const midY = source.y + dy * 0.6;
        return `M${source.x},${source.y} Q${source.x + dx * 0.3},${midY} ${target.x},${target.y}`;
    } else if (Math.abs(dy) < 30) {
        // Horizontal line for same-level connections
        return `M${source.x},${source.y} L${target.x},${target.y}`;
    } else {
        // Stepped path for program calls
        const midX = source.x + dx * 0.5;
        return `M${source.x},${source.y} L${midX},${source.y} L${midX},${target.y} L${target.x},${target.y}`;
    }
}

function getEdgeColor(edge) {
            const colorMap = {
                'program_call': '#2196f3',
                'file_operation': '#4caf50',
                'db2_operation': '#ff9800'
            };
            
            if (edge.call_type === 'XCTL') return '#ff5722';
            return colorMap[edge.type] || '#666';
        }


function drawEnhancedCustomShape(selection, node) {
    const g = selection;
    
    // Add enhanced drop shadow
    g.style('filter', 'drop-shadow(3px 3px 6px rgba(0,0,0,0.3))');
    
    // FIXED: Draw shapes based on node type with better styling
    switch (node.type) {
        case 'program':
            drawEnhancedProgramShape(g, node);
            break;
        case 'file':
            drawEnhancedFileShape(g, node);
            break;
        case 'db2_table':
            drawEnhancedDB2Shape(g, node);
            break;
        default:
            drawEnhancedDefaultShape(g, node);
    }
    
    // FIXED: Enhanced node labels with better formatting
    const labelText = node.label || node.id || 'Unknown';
    const maxLabelLength = 12;
    const displayText = labelText.length > maxLabelLength ? 
                       labelText.substring(0, maxLabelLength) + '...' : labelText;
    
    g.append('text')
        .attr('class', 'node-label')
        .attr('text-anchor', 'middle')
        .attr('dy', '0.35em')
        .style('font-size', '11px')
        .style('font-weight', 'bold')
        .style('fill', node.status === 'missing' ? '#d32f2f' : 'white')
        .style('pointer-events', 'none')
        .text(displayText)
        .append('title')
        .text(labelText); // Full text on hover
}

function drawEnhancedProgramShape(g, node) {
    const width = node.width || 120;
    const height = node.height || 60;
    
    let fillColor = '#4a90e2';
    let strokeColor = '#2c5aa0';
    
    if (node.is_starting_program) {
        fillColor = '#1a73e8';
        strokeColor = '#0d47a1';
    } else if (node.status === 'missing') {
        fillColor = '#ffcdd2';
        strokeColor = '#d32f2f';
    }
    
    if (node.status === 'missing') {
        // Diamond shape for missing programs
        g.append('polygon')
            .attr('points', `0,${-height/2} ${width/2},0 0,${height/2} ${-width/2},0`)
            .attr('fill', fillColor)
            .attr('stroke', strokeColor)
            .attr('stroke-width', 2)
            .attr('stroke-dasharray', '5,5');
    } else {
        // Enhanced rounded rectangle
        g.append('rect')
            .attr('x', -width/2)
            .attr('y', -height/2)
            .attr('width', width)
            .attr('height', height)
            .attr('rx', 10)
            .attr('ry', 10)
            .attr('fill', fillColor)
            .attr('stroke', strokeColor)
            .attr('stroke-width', 2);
        
        // Add gradient effect
        g.append('rect')
            .attr('x', -width/2)
            .attr('y', -height/2)
            .attr('width', width)
            .attr('height', height/3)
            .attr('rx', 10)
            .attr('ry', 10)
            .attr('fill', 'rgba(255,255,255,0.3)');
    }
    
    // Program type indicator
    if (node.is_starting_program) {
        g.append('circle')
            .attr('cx', width/2 - 10)
            .attr('cy', -height/2 + 10)
            .attr('r', 5)
            .attr('fill', '#fff')
            .attr('stroke', strokeColor)
            .attr('stroke-width', 2);
    }
}

function drawEnhancedFileShape(g, node) {
    const width = node.width || 100;
    const height = node.height || 50;
    
    // Enhanced cylinder shape
    const ellipseHeight = height * 0.25;
    const fillColor = '#4caf50';
    const strokeColor = '#2e7d32';
    
    // Cylinder body with gradient
    g.append('rect')
        .attr('x', -width/2)
        .attr('y', -height/2 + ellipseHeight/2)
        .attr('width', width)
        .attr('height', height - ellipseHeight)
        .attr('fill', fillColor)
        .attr('stroke', strokeColor)
        .attr('stroke-width', 2);
    
    // Top and bottom ellipses
    ['top', 'bottom'].forEach((pos, i) => {
        g.append('ellipse')
            .attr('cx', 0)
            .attr('cy', pos === 'top' ? -height/2 + ellipseHeight/2 : height/2 - ellipseHeight/2)
            .attr('rx', width/2)
            .attr('ry', ellipseHeight/2)
            .attr('fill', i === 0 ? fillColor : '#66bb6a')
            .attr('stroke', strokeColor)
            .attr('stroke-width', 2);
    });
    
    // Interface type indicator
    if (node.interface === 'CICS') {
        g.append('rect')
            .attr('x', -width/2 + 3)
            .attr('y', -height/2 + 3)
            .attr('width', 25)
            .attr('height', 12)
            .attr('fill', '#9c27b0')
            .attr('rx', 2);
        
        g.append('text')
            .attr('x', -width/2 + 15)
            .attr('y', -height/2 + 9)
            .attr('text-anchor', 'middle')
            .attr('font-size', '7px')
            .attr('fill', 'white')
            .text('CICS');
    }
}

function drawEnhancedDB2Shape(g, node) {
    const width = node.width || 110;
    const height = node.height || 50;
    
    // Database table with enhanced styling
    g.append('rect')
        .attr('x', -width/2)
        .attr('y', -height/2)
        .attr('width', width)
        .attr('height', height)
        .attr('rx', 5)
        .attr('ry', 5)
        .attr('fill', '#ff9800')
        .attr('stroke', '#f57c00')
        .attr('stroke-width', 2);
    
    // Table row indicators
    for (let i = 1; i <= 3; i++) {
        g.append('line')
            .attr('x1', -width/2 + 8)
            .attr('y1', -height/2 + (i * height/4))
            .attr('x2', width/2 - 8)
            .attr('y2', -height/2 + (i * height/4))
            .attr('stroke', '#f57c00')
            .attr('stroke-width', 1)
            .attr('opacity', 0.7);
    }
    
    // DB2 indicator
    g.append('text')
        .attr('x', width/2 - 8)
        .attr('y', -height/2 + 8)
        .attr('text-anchor', 'middle')
        .attr('font-size', '8px')
        .attr('font-weight', 'bold')
        .attr('fill', '#fff')
        .text('DB2');
}

function addEnhancedInteractivity(nodes, edges) {
    // Enhanced click handlers
    nodes.on('click', function(event, d) {
        showEnhancedNodeDetails(d);
    });
    
    nodes.on('mouseover', function(event, d) {
        // Use CSS transform instead of D3 style transform to avoid positioning issues
        d3.select(this)
            .transition()
            .duration(200)
            .attr('transform', function() {
                const currentTransform = d3.select(this).attr('transform');
                // Extract current translate values
                const translateMatch = currentTransform.match(/translate\(([^,]+),([^)]+)\)/);
                if (translateMatch) {
                    const x = parseFloat(translateMatch[1]);
                    const y = parseFloat(translateMatch[2]);
                    return `translate(${x},${y}) scale(1.05)`;
                }
                return currentTransform + ' scale(1.05)';
            })
            .style('cursor', 'pointer');
        
        highlightConnectedPaths(d, edges);
    });
    
    nodes.on('mouseout', function(event, d) {
        // Reset to original transform
        d3.select(this)
            .transition()
            .duration(200)
            .attr('transform', function() {
                const currentTransform = d3.select(this).attr('transform');
                // Remove scale transformation, keep translate
                const translateMatch = currentTransform.match(/translate\(([^,]+),([^)]+)\)/);
                if (translateMatch) {
                    const x = parseFloat(translateMatch[1]);
                    const y = parseFloat(translateMatch[2]);
                    return `translate(${x},${y})`;
                }
                return currentTransform.replace(/ scale\([^)]+\)/, '');
            });
        
        resetPathHighlights();
    });
}


function highlightConnectedPaths(node, edges) {
    // Dim all edges first
    d3.selectAll('.flow-edge path').style('opacity', 0.3);
    
    // Highlight connected edges
    edges.forEach((edge, index) => {
        if (edge.source && edge.target && 
            (edge.source.id === node.id || edge.target.id === node.id)) {
            
            d3.selectAll('.flow-edge path').filter(function(d, i) {
                return i === index;
            })
            .style('opacity', 1)
            .style('stroke-width', function() {
                const currentWidth = parseInt(d3.select(this).style('stroke-width')) || 2;
                return currentWidth + 1;
            });
        }
    });
}

function resetPathHighlights() {
    d3.selectAll('.flow-edge path')
        .style('opacity', 1)
        .style('stroke-width', function(d) {
            return getStrokeWidth(d) || 2;
        });
}

function createEnhancedArrowMarkers(defs) {
    const markers = [
        { id: 'arrow-call', color: '#2196f3', size: 6 },
        { id: 'arrow-xctl', color: '#ff5722', size: 8 },
        { id: 'arrow-dynamic', color: '#9c27b0', size: 6 },
        { id: 'arrow-file-read', color: '#4caf50', size: 6 },
        { id: 'arrow-file-write', color: '#ff9800', size: 6 },
        { id: 'arrow-db2', color: '#ff9800', size: 6 }
    ];
    
    markers.forEach(marker => {
        defs.append('marker')
            .attr('id', marker.id)
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 10)
            .attr('refY', 0)
            .attr('markerWidth', marker.size)
            .attr('markerHeight', marker.size)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', marker.color);
    });
}

function createEnhancedVisualizationLegend(legendContainer) {
    const legendData = [
        { type: 'program-main', label: 'Starting Program', color: '#1a73e8' },
        { type: 'program-called', label: 'Called Program', color: '#64b5f6' },
        { type: 'program-missing', label: 'Missing Program', color: '#ffcdd2', dashed: true },
        { type: 'file', label: 'File/Dataset', color: '#4caf50' },
        { type: 'db2', label: 'DB2 Table', color: '#ff9800' },
        { type: 'call', label: 'Program Call', color: '#2196f3', isEdge: true },
        { type: 'file-op', label: 'File Operation', color: '#4caf50', isEdge: true },
        { type: 'dynamic', label: 'Dynamic Call', color: '#9c27b0', isEdge: true, dashed: true }
    ];
    
    // Get the actual DOM element from the D3 selection or use it directly if it's already a DOM element
    const containerElement = legendContainer.node ? legendContainer.node() : legendContainer;
    
    containerElement.innerHTML = '<h4 style="margin: 0 0 10px 0; font-size: 14px;">Flow Legend</h4>';
    
    legendData.forEach(item => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.style.cssText = `
            display: flex; 
            align-items: center; 
            margin-bottom: 5px; 
            font-size: 12px;
        `;
        
        const symbol = document.createElement('div');
        symbol.className = 'legend-symbol';
        symbol.style.cssText = `
            width: 20px; 
            height: ${item.isEdge ? '2px' : '12px'}; 
            background-color: ${item.color}; 
            margin-right: 8px;
            border-radius: ${item.isEdge ? '0' : '2px'};
            ${item.dashed ? 'border: 2px dashed ' + item.color + '; background: none;' : ''}
        `;
        
        const label = document.createElement('span');
        label.textContent = item.label;
        
        legendItem.appendChild(symbol);
        legendItem.appendChild(label);
        containerElement.appendChild(legendItem);
    });
}

 function getNodeWidth(node) {
            const widthMap = {
                'program': 120,
                'file': 100,
                'db2_table': 110
            };
            return widthMap[node.type] || 100;
        }

        function getNodeHeight(node) {
            const heightMap = {
                'program': 60,
                'file': 50,
                'db2_table': 50
            };
            return heightMap[node.type] || 50;
        }

function getMidPoint(source, target) {
    return {
        x: (source.x + target.x) / 2,
        y: (source.y + target.y) / 2
    };
}
function calculateHierarchy(nodes, edges, startNode) {
    const hierarchy = { 0: [startNode] };
    const visited = new Set([startNode.id]);
    const queue = [{ node: startNode, level: 0 }];
    
    while (queue.length > 0) {
        const { node: currentNode, level } = queue.shift();
        
        // Find all nodes this one calls
        const outgoingEdges = edges.filter(e => e.from === currentNode.id);
        
        outgoingEdges.forEach(edge => {
            const targetNode = nodes.find(n => n.id === edge.to);
            if (targetNode && !visited.has(targetNode.id) && targetNode.type === 'program') {
                const nextLevel = level + 1;
                
                if (!hierarchy[nextLevel]) {
                    hierarchy[nextLevel] = [];
                }
                
                hierarchy[nextLevel].push(targetNode);
                visited.add(targetNode.id);
                queue.push({ node: targetNode, level: nextLevel });
            }
        });
    }
    
    return hierarchy;
}

function getNodeWidth(node) {
    switch (node.type) {
        case 'program': return 120;
        case 'file': return 100;
        case 'db2_table': return 110;
        default: return 100;
    }
}

function getNodeHeight(node) {
    switch (node.type) {
        case 'program': return 60;
        case 'file': return 50;
        case 'db2_table': return 50;
        default: return 50;
    }
}

function createArrowMarkers(defs) {
            // Call arrow
            defs.append('marker')
                .attr('id', 'arrow-call')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 10)
                .attr('refY', 0)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#2196f3');
            
            // XCTL arrow
            defs.append('marker')
                .attr('id', 'arrow-xctl')
                .attr('viewBox', '0 -8 15 16')
                .attr('refX', 15)
                .attr('refY', 0)
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-8L15,0L0,8')
                .attr('fill', '#ff5722');
            
            // File operation arrows
            ['read', 'write'].forEach(op => {
                const colors = { read: '#4caf50', write: '#ff9800' };
                defs.append('marker')
                    .attr('id', `arrow-file-${op}`)
                    .attr('viewBox', '0 -5 10 10')
                    .attr('refX', 10)
                    .attr('refY', 0)
                    .attr('markerWidth', 6)
                    .attr('markerHeight', 6)
                    .attr('orient', 'auto')
                    .append('path')
                    .attr('d', 'M0,-5L10,0L0,5')
                    .attr('fill', colors[op]);
            });
        }


function drawCustomShape(selection, node) {
            const g = selection;
            
            // Add drop shadow
            g.style('filter', 'drop-shadow(2px 2px 4px rgba(0,0,0,0.2))');
            
            switch (node.type) {
                case 'program':
                    drawProgramShape(g, node);
                    break;
                case 'file':
                    drawFileShape(g, node);
                    break;
                case 'db2_table':
                    drawDB2Shape(g, node);
                    break;
            }
            
            // Node label
            g.append('text')
                .attr('class', 'node-label')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .style('font-size', '10px')
                .style('font-weight', 'bold')
                .style('fill', node.status === 'missing' ? '#d32f2f' : 'white')
                .style('pointer-events', 'none')
                .text(node.label.length > 12 ? node.label.substring(0, 12) + '...' : node.label);
        }


function drawProgramShape(g, node) {
            const width = node.width;
            const height = node.height;
            
            let className = 'node-program';
            if (node.is_starting_program) className = 'node-program-main';
            else if (node.status === 'missing') className = 'node-program-missing';
            else className = 'node-program-called';
            
            if (node.status === 'missing') {
                // Diamond shape for missing programs
                g.append('polygon')
                    .attr('class', className)
                    .attr('points', `0,${-height/2} ${width/2},0 0,${height/2} ${-width/2},0`)
                    .attr('stroke-width', 2);
            } else {
                // Rounded rectangle for available programs
                g.append('rect')
                    .attr('class', className)
                    .attr('x', -width/2)
                    .attr('y', -height/2)
                    .attr('width', width)
                    .attr('height', height)
                    .attr('rx', 8)
                    .attr('ry', 8)
                    .attr('stroke-width', 2);
            }
        }

function drawFileShape(g, node) {
            const width = node.width;
            const height = node.height;
            const ellipseHeight = height * 0.2;
            
            // Cylinder body
            g.append('rect')
                .attr('class', 'node-file')
                .attr('x', -width/2)
                .attr('y', -height/2 + ellipseHeight/2)
                .attr('width', width)
                .attr('height', height - ellipseHeight)
                .attr('stroke-width', 2);
            
            // Top and bottom ellipses
            g.append('ellipse')
                .attr('class', 'node-file')
                .attr('cx', 0)
                .attr('cy', -height/2 + ellipseHeight/2)
                .attr('rx', width/2)
                .attr('ry', ellipseHeight/2)
                .attr('stroke-width', 2);
                
            g.append('ellipse')
                .attr('class', 'node-file')
                .attr('cx', 0)
                .attr('cy', height/2 - ellipseHeight/2)
                .attr('rx', width/2)
                .attr('ry', ellipseHeight/2)
                .attr('stroke-width', 2);
        }


function drawDB2Shape(g, node) {
            const width = node.width;
            const height = node.height;
            
            g.append('rect')
                .attr('class', 'node-db2')
                .attr('x', -width/2)
                .attr('y', -height/2)
                .attr('width', width)
                .attr('height', height)
                .attr('rx', 4)
                .attr('ry', 4)
                .attr('stroke-width', 2);
            
            // Add table lines
            for (let i = 1; i <= 3; i++) {
                g.append('line')
                    .attr('x1', -width/2 + 5)
                    .attr('y1', -height/2 + (i * height/4))
                    .attr('x2', width/2 - 5)
                    .attr('y2', -height/2 + (i * height/4))
                    .attr('stroke', '#f57c00')
                    .attr('stroke-width', 1)
                    .attr('opacity', 0.6);
            }
        }

function drawDefaultShape(g, node) {
    g.append('circle')
        .attr('r', 20)
        .attr('fill', '#ccc')
        .attr('stroke', '#999')
        .attr('stroke-width', 2);
}

function drawEnhancedEdge(selection, edge) {
    const source = edge.source;
    const target = edge.target;
    
    // Draw the line
    const path = selection.append('path')
        .attr('class', `flow-edge ${getEdgeClass(edge)}`)
        .attr('d', edge.path || `M${source.x},${source.y} L${target.x},${target.y}`)
        .attr('fill', 'none')
        .attr('stroke', getEdgeColor(edge))
        .attr('stroke-width', getStrokeWidth(edge))
        .attr('marker-end', `url(#${getMarkerEnd(edge)})`);
    
    // Add dasharray for dynamic calls
    if (edge.type === 'dynamic_call' || edge.is_dynamic) {
        path.attr('stroke-dasharray', '8,4');
    }
    
    // Calculate midpoint for label
    const midX = (source.x + target.x) / 2;
    const midY = (source.y + target.y) / 2;
    
    // Add edge label with call type and operation
    let labelText = '';
    if (edge.type === 'program_call') {
        labelText = edge.call_type || 'CALL';
    } else if (edge.type === 'file_operation') {
        labelText = `FILE ${edge.io_direction || 'READ'}`;
    } else if (edge.type === 'db2_operation') {
        labelText = `DB2 ${edge.io_direction || 'read'}`;
    }
    
    if (labelText) {
        // Background rectangle for label
        selection.append('rect')
            .attr('x', midX - 25)
            .attr('y', midY - 8)
            .attr('width', 50)
            .attr('height', 16)
            .attr('fill', 'white')
            .attr('stroke', getEdgeColor(edge))
            .attr('stroke-width', 1)
            .attr('rx', 3);
        
        // Label text
        selection.append('text')
            .attr('x', midX)
            .attr('y', midY)
            .attr('text-anchor', 'middle')
            .attr('dy', '0.35em')
            .attr('font-size', '9px')
            .attr('font-weight', 'bold')
            .attr('fill', getEdgeColor(edge))
            .text(labelText);
    }
}

function getConnectionPoint(node, otherNode, role) {
    const x = node.x;
    const y = node.y;
    const width = node.width;
    const height = node.height;
    
    // Calculate which side to connect to based on relative position
    const dx = otherNode.x - x;
    const dy = otherNode.y - y;
    
    if (Math.abs(dx) > Math.abs(dy)) {
        // Connect to left or right side
        return {
            x: x + (dx > 0 ? width/2 : -width/2),
            y: y
        };
    } else {
        // Connect to top or bottom side
        return {
            x: x,
            y: y + (dy > 0 ? height/2 : -height/2)
        };
    }
}

 function getEdgeClass(edge) {
            switch (edge.call_type || edge.type) {
                case 'XCTL': return 'edge-xctl';
                case 'file_operation': return 'edge-file';
                default: return 'edge-call';
            }
        }

 function getMarkerEnd(edge) {
            if (edge.type === 'file_operation') {
                return `arrow-file-${edge.io_direction}`;
            }
            switch (edge.call_type) {
                case 'XCTL': return 'arrow-xctl';
                default: return 'arrow-call';
            }
        }

function getStrokeWidth(edge) {
            switch (edge.call_type || edge.type) {
                case 'XCTL': return 3;
                default: return 2;
            }
        }

function createPath(source, target, edge) {
    // Create curved path for better visual flow
    const dx = target.x - source.x;
    const dy = target.y - source.y;
    
    if (Math.abs(dy) < 20) {
        // Horizontal line
        return `M${source.x},${source.y} L${target.x},${target.y}`;
    } else {
        // Curved path
        const midY = source.y + dy * 0.5;
        return `M${source.x},${source.y} Q${source.x},${midY} ${target.x},${target.y}`;
    }
}

function getMidPoint(source, target) {
    return {
        x: (source.x + target.x) / 2,
        y: (source.y + target.y) / 2
    };
}

function calculateEdgePath(sourceNode, targetNode, edge) {
    // This could be enhanced with more sophisticated path calculations
    return `M${sourceNode.x},${sourceNode.y} L${targetNode.x},${targetNode.y}`;
}

function addInteractivity(nodes, edges) {
            nodes.on('click', function(event, d) {
                console.log('Clicked node:', d);
            });
            
            nodes.on('mouseover', function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr('transform', function() {
                        const currentTransform = d3.select(this).attr('transform');
                        return currentTransform + ' scale(1.1)';
                    })
                    .style('cursor', 'pointer');
            });
            
            nodes.on('mouseout', function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }


function highlightConnectedComponents(node) {
    // Check if edges data is available
    const edges = window.currentFlowEdges;
    if (!edges || !Array.isArray(edges)) {
        console.warn('Edges data not available for highlighting');
        return;
    }
    
    // Highlight all edges connected to this node
    d3.selectAll('.flow-edge').style('opacity', 0.3);
    
    // Find and highlight connected edges
    let connectedEdgeCount = 0;
    edges.forEach((edge, index) => {
        if (edge.source && edge.target && 
            (edge.source.id === node.id || edge.target.id === node.id)) {
            
            // Use index-based selection which is more reliable
            d3.selectAll('.flow-edge').filter(function(d, i) {
                return i === index;
            })
            .style('opacity', 1)
            .style('stroke-width', function(d) {
                const currentWidth = d3.select(this).style('stroke-width');
                return (parseInt(currentWidth) || 2) + 1;
            });
            
            connectedEdgeCount++;
        }
    });
    
    console.log(`Highlighted ${connectedEdgeCount} edges for node ${node.id}`);
}

function resetHighlights() {
    d3.selectAll('.flow-edge')
        .style('opacity', 1)
        .style('stroke-width', function(d) {
            // Reset to original width based on edge type
            return getStrokeWidth(d) || 2;
        });
}

function highlightConnectedComponents(node, edges) {
    // Highlight all edges connected to this node
    d3.selectAll('.flow-edge').style('opacity', 0.3);
    
    edges.forEach(edge => {
        if (edge.source.id === node.id || edge.target.id === node.id) {
            d3.select(`.flow-edge:nth-child(${edges.indexOf(edge) + 1})`)
                .style('opacity', 1)
                .style('stroke-width', parseInt(getStrokeWidth(edge)) + 1);
        }
    });
}

function resetHighlights() {
    d3.selectAll('.flow-edge')
        .style('opacity', 1)
        .style('stroke-width', d => getStrokeWidth(d));
}

function createVisualizationLegend(legendContainer) {
            const legendData = [
                { type: 'program-main', label: 'Starting Program', color: '#1a73e8' },
                { type: 'program-called', label: 'Called Program', color: '#64b5f6' },
                { type: 'program-missing', label: 'Missing Program', color: '#ffcdd2' },
                { type: 'file', label: 'File/Dataset', color: '#4caf50' },
                { type: 'db2', label: 'DB2 Table', color: '#ff9800' }
            ];
            
            const container = legendContainer.node();
            container.innerHTML = '<h4 style="margin: 0 0 10px 0; font-size: 14px;">Legend</h4>';
            
            legendData.forEach(item => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                const symbol = document.createElement('div');
                symbol.className = 'legend-symbol';
                symbol.style.backgroundColor = item.color;
                if (item.type.includes('missing')) {
                    symbol.style.border = '2px dashed #d32f2f';
                    symbol.style.background = 'none';
                }
                
                const label = document.createElement('span');
                label.textContent = item.label;
                
                legendItem.appendChild(symbol);
                legendItem.appendChild(label);
                container.appendChild(legendItem);
            });
        }
function showEnhancedNodeDetails(node) {
    // Enhanced version of your existing showNodeDetails function
    const modalContent = {
        program: createProgramDetailsContent(node),
        file: createFileDetailsContent(node),
        db2_table: createDB2DetailsContent(node)
    };
    
    const content = modalContent[node.type] || createDefaultDetailsContent(node);
    
    // Create and show modal with enhanced content
    showNodeDetailsModal(node, content);
}

function createProgramDetailsContent(node) {
    return `
        <div class="enhanced-node-details">
            <h4>${node.label}</h4>
            <div class="detail-grid">
                <div><strong>Type:</strong> ${node.is_starting_program ? 'Main Program' : 'Called Program'}</div>
                <div><strong>Status:</strong> <span class="status-${node.status}">${node.status}</span></div>
                <div><strong>Level:</strong> ${node.level}</div>
                ${node.business_purpose ? `<div><strong>Purpose:</strong> ${node.business_purpose}</div>` : ''}
            </div>
        </div>
    `;
}

function createFileDetailsContent(node) {
    return `
        <div class="enhanced-node-details">
            <h4>${node.label}</h4>
            <div class="detail-grid">
                <div><strong>Type:</strong> File/Dataset</div>
                <div><strong>Interface:</strong> ${node.interface || 'FILE_SYSTEM'}</div>
                <div><strong>I/O Direction:</strong> ${node.io_direction || 'Unknown'}</div>
                ${node.has_layout ? '<div><strong>Layout:</strong> Available</div>' : ''}
            </div>
        </div>
    `;
}

function createDB2DetailsContent(node) {
    return `
        <div class="enhanced-node-details">
            <h4>${node.label}</h4>
            <div class="detail-grid">
                <div><strong>Type:</strong> DB2 Table</div>
                <div><strong>Operations:</strong> ${node.sql_operations || 'SELECT, INSERT, UPDATE'}</div>
                <div><strong>Schema:</strong> ${node.schema || 'Default'}</div>
            </div>
        </div>
    `;
}

function showNodeDetailsModal(node, content) {
    // Use your existing modal system but with enhanced content
    showNodeDetails(node, { visualization_data: { enhanced_content: content }});
}

function getSampleFlowData() {
            return {
                nodes: [
                    // Program nodes with hierarchy
                    { id: 'TMSTMPM4', type: 'program', label: 'TMSTMPM4', is_starting_program: true, status: 'present' },
                    { id: 'TRECHECM', type: 'program', label: 'TRECHECM', status: 'missing' },
                    { id: 'TMSAUTH', type: 'program', label: 'TMSAUTH', status: 'present' },
                    { id: 'TMSTIP19', type: 'program', label: 'TMSTIP19', status: 'present' },
                    { id: 'CKS910', type: 'program', label: 'CKS910', status: 'present' },
                    { id: 'TMSTMND', type: 'program', label: 'TMSTMND', status: 'present' },
                    { id: 'TMSDYTAG', type: 'program', label: 'TMSDYTAG', status: 'present' },
                    { id: 'TMSDMPM4', type: 'program', label: 'TMSDMPM4', status: 'present' },
                    // File nodes
                    { id: 'TMSS0CKO', type: 'file', label: 'TMSS0CKO', interface: 'CICS', connected_to_program: 'TMSDMPM4' },
                    { id: 'TMSS6ACO', type: 'file', label: 'TMSS6ACO', interface: 'CICS', connected_to_program: 'TMSDMPM4' },
                    // DB2 nodes
                    { id: 'CUSTOMER_TABLE', type: 'db2_table', label: 'CUSTOMER_TABLE', connected_to_program: 'TMSTMPM4' },
                    { id: 'TRANSACTION_LOG', type: 'db2_table', label: 'TRANSACTION_LOG', connected_to_program: 'TMSDMPM4' }
                ],
                edges: [
                    // Program calls
                    { from: 'TMSTMPM4', to: 'TRECHECM', type: 'program_call', call_type: 'CALL' },
                    { from: 'TMSTMPM4', to: 'TMSAUTH', type: 'program_call', call_type: 'CALL' },
                    { from: 'TMSTMPM4', to: 'TMSTIP19', type: 'program_call', call_type: 'XCTL' },
                    { from: 'TMSTIP19', to: 'CKS910', type: 'program_call', call_type: 'CALL' },
                    { from: 'CKS910', to: 'TMSTMND', type: 'program_call', call_type: 'CALL' },
                    { from: 'TMSTMND', to: 'TMSDYTAG', type: 'program_call', call_type: 'CALL' },
                    { from: 'TMSDYTAG', to: 'TMSDMPM4', type: 'program_call', call_type: 'XCTL' },
                    // File operations
                    { from: 'TMSDMPM4', to: 'TMSS0CKO', type: 'file_operation', io_direction: 'READ' },
                    { from: 'TMSDMPM4', to: 'TMSS6ACO', type: 'file_operation', io_direction: 'write' },
                    // DB2 operations
                    { from: 'TMSTMPM4', to: 'CUSTOMER_TABLE', type: 'db2_operation', io_direction: 'read' },
                    { from: 'TMSDMPM4', to: 'TRANSACTION_LOG', type: 'db2_operation', io_direction: 'write' }
                ]
            };
        }

        function renderSampleFlow() {
            const vizData = getSampleFlowData();
            renderFlowVisualization(vizData);
        }
        window.onload = function() {
            renderSampleFlow();
        };
    function renderFlowDetails(flowAnalysis, vizData) {
        const detailsContainer = document.getElementById('flowDetails');
        
        let html = `
            <div class="flow-summary-section">
                <h3>Flow Summary</h3>
                <div class="flow-business-summary">
                    ${flowAnalysis.business_flow_summary || 'Program flow analysis completed'}
                </div>
                <div class="flow-statistics">
                    <div class="stat-item">
                        <span class="stat-value">${vizData.statistics.program_chain_steps}</span>
                        <span class="stat-label">Program Steps</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${vizData.statistics.file_operations}</span>
                        <span class="stat-label">File Operations</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${vizData.statistics.db2_operations}</span>
                        <span class="stat-label">DB2 Operations</span>
                    </div>
                </div>
            </div>
        `;
        
        // FIXED: Program Chain Summary (replaces missing [object Object])
        if (vizData.visualization_data.program_chain_summary && 
            vizData.visualization_data.program_chain_summary.length > 0) {
            html += `
                <div class="program-chain-section">
                    <h3>Program Call Chain</h3>
                    <div class="program-chain-list">
            `;
            
            vizData.visualization_data.program_chain_summary.forEach((step, index) => {
                const statusClass = step.status === 'MISSING' ? 'missing-program' : 'available-program';
                const callIcon = step.call_type === 'XCTL' ? 'â†’' : step.call_type === 'LINK' ? 'â†”' : 'ðŸ“ž';
                
                html += `
                    <div class="program-chain-item ${statusClass}">
                        <div class="chain-sequence">#${step.sequence}</div>
                        <div class="chain-flow">
                            <span class="source-program">${step.source_program}</span>
                            <span class="call-arrow">${callIcon} ${step.call_type}</span>
                            <span class="target-program">${step.target_program}</span>
                            ${step.status === 'MISSING' ? '<span class="missing-indicator">âŒ MISSING</span>' : ''}
                        </div>
                        ${step.variable_name ? `<div class="dynamic-info">Dynamic via: ${step.variable_name}</div>` : ''}
                        ${step.business_context ? `<div class="business-context">${step.business_context}</div>` : ''}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        // FIXED: Missing programs section (properly formatted)
        if (vizData.visualization_data.missing_programs && 
            vizData.visualization_data.missing_programs.length > 0) {
            html += `
                <div class="missing-programs-section">
                    <h3>Missing Programs (${vizData.visualization_data.missing_programs.length})</h3>
                    <div class="missing-programs-list">
            `;
            
            vizData.visualization_data.missing_programs.forEach(program => {
                html += `
                    <div class="missing-program-item">
                        <span class="program-name">${program.program_name}</span>
                        <span class="called-by">Called by: ${program.called_by}</span>
                        <span class="call-type">${program.call_type}</span>
                        <button onclick="showMissingProgramImpact('${sessionId}', '${program.program_name}')" 
                                class="impact-btn">Show Impact</button>
                        <span class="upload-hint">Upload this program to continue flow analysis</span>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        // FIXED: Field flows section with layout information
        if (Object.keys(vizData.visualization_data.field_flows).length > 0) {
            html += `
                <div class="field-flows-section">
                    <h3>Key Field Data Flows</h3>
                    <div class="field-flows-list">
            `;
            
            Object.entries(vizData.visualization_data.field_flows).forEach(([fieldName, flows]) => {
                html += `
                    <div class="field-flow-item">
                        <div class="field-name">${fieldName}</div>
                        <div class="field-flow-path">
                `;
                
                flows.forEach((flow, index) => {
                    if (index > 0) html += ' â†’ ';
                    html += `<span class="flow-step">${flow.from}</span>`;
                    if (flow.source_layout) {
                        html += `<span class="layout-info">[${flow.source_layout}]</span>`;
                    }
                });
                
                html += `
                        </div>
                        <button onclick="traceFieldFlow('${sessionId}', '${fieldName}')" 
                                class="trace-btn">Trace Field</button>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        // File operations section (with program connections)
        const fileOpsCount = vizData.visualization_data.nodes.filter(n => n.type === 'file').length;
        if (fileOpsCount > 0) {
            html += `
                <div class="file-operations-section">
                    <h3>File Operations in Flow (${fileOpsCount})</h3>
                    <div class="file-operations-list">
            `;
            
            vizData.visualization_data.nodes.filter(n => n.type === 'file').forEach(fileNode => {
                const statusClass = fileNode.has_layout ? 'has-layout' : 'no-layout';
                html += `
                    <div class="file-operation-item ${statusClass}">
                        <div class="file-info">
                            <span class="file-name">${fileNode.label}</span>
                            <span class="io-direction">(${fileNode.io_direction})</span>
                            <span class="connected-program">Connected to: ${fileNode.connected_to_program}</span>
                            ${fileNode.has_layout ? '<span class="layout-indicator">Has Layout</span>' : ''}
                        </div>
                        <div class="file-interface">Interface: ${fileNode.interface}</div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        detailsContainer.innerHTML = html;
    }



        function showNodeDetails(node, vizData) {
            const modal = document.createElement('div');
            modal.className = 'node-details-modal';
            
            let content = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${node.label} Details</h3>
                        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="node-info">
                            <p><strong>Type:</strong> ${node.type}</p>
                            <p><strong>Status:</strong> ${node.status}</p>
            `;
            
            if (node.type === 'program') {
                if (node.status === 'missing') {
                    content += `
                        <div class="missing-program-info">
                            <p class="missing-notice">This program is missing from the analysis.</p>
                            <button onclick="showMissingProgramImpact('${sessionId}', '${node.id}')" 
                                    class="impact-analysis-btn">View Impact Analysis</button>
                        </div>
                    `;
                } else {
                    content += `
                        <div class="program-actions">
                            <button onclick="viewProgramSource('${sessionId}', '${node.id}')" 
                                    class="view-source-btn">View Source Code</button>
                            <button onclick="analyzeProgram('${sessionId}', '${node.id}')" 
                                    class="analyze-btn">Analyze Program</button>
                        </div>
                    `;
                }
            } else if (node.type === 'file') {
                content += `
                    <p><strong>Interface:</strong> ${node.interface}</p>
                    <p><strong>I/O Direction:</strong> ${node.io_direction}</p>
                    <p><strong>Has Layout:</strong> ${node.has_layout ? 'Yes' : 'No'}</p>
                `;
            }
            
            content += `
                        </div>
                    </div>
                </div>
            `;
            
            modal.innerHTML = content;
            document.body.appendChild(modal);
        }

        async function showMissingProgramImpact(sessionId, programName) {
            try {
                const response = await fetch(`/api/missing-program-impact/${sessionId}/${programName}`);
                const data = await response.json();
                
                if (data.success) {
                    const impact = data.impact_analysis;
                    
                    const modal = document.createElement('div');
                    modal.className = 'impact-modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Impact Analysis: ${impact.missing_program}</h3>
                                <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
                            </div>
                            <div class="modal-body">
                                <div class="impact-summary">
                                    <p><strong>Impact:</strong> ${impact.impact_description}</p>
                                </div>
                                <div class="calling-programs">
                                    <h4>Programs that call ${impact.missing_program}:</h4>
                                    <ul>
                                        ${impact.calling_programs.map(prog => `<li>${prog}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="recommendations">
                                    <h4>Recommendations:</h4>
                                    <ul>
                                        ${impact.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="upload-hint">
                                    <p class="highlight">Upload ${impact.missing_program} to restore complete flow analysis</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                }
            } catch (error) {
                showError(`Error getting impact analysis: ${error.message}`);
            }
        }

        async function traceFieldFlow(sessionId, fieldName) {
            try {
                const response = await fetch(`/api/field-flow-trace/${sessionId}/${fieldName}`);
                const data = await response.json();
                
                if (data.success) {
                    const journey = data.field_journey;
                    
                    const modal = document.createElement('div');
                    modal.className = 'field-trace-modal';
                    
                    let flowStepsHtml = '';
                    journey.flow_steps.forEach((step, index) => {
                        flowStepsHtml += `
                            <div class="flow-step">
                                <div class="step-number">${step.sequence}</div>
                                <div class="step-content">
                                    <div class="step-programs">
                                        ${step.source_program} â†’ ${step.target_program}
                                    </div>
                                    <div class="step-type">${step.flow_type}</div>
                                    <div class="step-transformation">${step.transformation}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Field Flow Trace: ${journey.field_name}</h3>
                                <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
                            </div>
                            <div class="modal-body">
                                <div class="field-journey">
                                    <div class="journey-summary">
                                        <p><strong>Programs Involved:</strong> ${journey.programs_involved.join(' â†’ ')}</p>
                                    </div>
                                    <div class="flow-steps">
                                        <h4>Flow Steps:</h4>
                                        ${flowStepsHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                } else {
                    showError(data.message || 'No flow data found for this field');
                }
            } catch (error) {
                showError(`Error tracing field: ${error.message}`);
            }
        }

      // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced Code Analyzer initialized');
        });
    </script>
</body>
</html>   