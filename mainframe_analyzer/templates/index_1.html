<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Code Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            overflow-x: hidden;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-metrics {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .metric-label {
            opacity: 0.8;
            font-size: 0.8rem;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 1rem;
            padding: 1rem;
            min-height: calc(100vh - 100px);
        }

        /* Left Panel */
        .left-panel {
            width: 420px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
            height: fit-content;
            transition: all 0.3s ease;
        }

        .left-panel.collapsed {
            display: none;
        }

        .panel-restore {
            position: fixed;
            top: 50%;
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            transform: translateY(-50%);
            z-index: 1001;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .panel-restore:hover {
            background: #5a6fd8;
            transform: translateY(-50%) scale(1.1);
        }

        .panel-restore.left {
            left: 0;
        }

        .panel-restore.right {
            right: 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
        }

        .collapse-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        .collapse-btn:hover {
            transform: scale(1.1);
        }

        /* Upload Section */
        .upload-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9ff;
            border-radius: 8px;
            border: 2px dashed #667eea;
        }

        .upload-area {
            text-align: center;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #e8ecff;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f1f3f4;
            color: #667eea;
            border: 1px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* Main Content */
        .content-area {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-btn:hover:not(.active) {
            background: #e9ecef;
        }

        /* Tab Content */
        .tab-content {
            padding: 2rem;
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Enhanced Component Summaries */
        .component-summaries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .component-summary-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .component-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .component-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }

        .component-type {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: auto;
        }

        .business-purpose {
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 1rem;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .raw-analysis {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .component-metrics {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            min-width: 60px;
        }

        .metric-value {
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            font-size: 0.7rem;
            color: #6c757d;
            text-align: center;
        }

        .complexity-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .complexity-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            transition: width 0.3s ease;
        }

        .derived-components {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .derived-toggle {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .derived-toggle:hover {
            background: #5a6fd8;
        }

        .derived-list {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9ff;
            border-radius: 6px;
            border: 1px solid #e8ecff;
        }

        .derived-list.show {
            display: block;
        }

        .derived-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }

        .derived-item-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .derived-item-type {
            font-size: 0.75rem;
            background: #e8ecff;
            color: #667eea;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        /* Enhanced Dependency Flow */
        .dependency-flow-container {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 2rem;
            min-height: 600px;
        }

        .dependency-controls {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dependency-flow {
            display: flex;
            flex-direction: column;
            gap: 4rem;
            position: relative;
        }

        .flow-level {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            position: relative;
            min-height: 140px;
        }

        .flow-level-title {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .flow-component {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 200px;
            max-width: 280px;
            text-align: center;
            position: relative;
        }

        .flow-component:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .flow-component.input-source {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .flow-component.core-program {
            border-color: #667eea;
            background: linear-gradient(135deg, #e8ecff 0%, #ffffff 100%);
        }

        .flow-component.cics-interface {
            border-color: #fd7e14;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .flow-component.output-file {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%);
        }

        .flow-component.missing-dependency {
            border-color: #dc3545;
            border-style: dashed;
            background: linear-gradient(135deg, #f8d7da 0%, #ffffff 100%);
            opacity: 0.8;
        }

        .component-name {
            font-weight: bold;
            font-size: 1rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .component-type-badge {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .component-description {
            font-size: 0.8rem;
            color: #6c757d;
            line-height: 1.3;
        }

        .flow-arrow {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            bottom: -16px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f3f4;
        }

        .data-table tbody tr:hover {
            background: #f8f9ff;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .badge-primary {
            color: #fff;
            background-color: #667eea;
        }

        .badge-success {
            color: #fff;
            background-color: #28a745;
        }

        .badge-warning {
            color: #212529;
            background-color: #ffc107;
        }

        .badge-danger {
            color: #fff;
            background-color: #dc3545;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            min-width: 400px;
            max-width: 500px;
        }

        .analysis-step {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .analysis-step.completed {
            background: #d4edda;
            color: #155724;
        }

        .analysis-step.current {
            background: #d1ecf1;
            color: #0c5460;
            font-weight: 500;
        }

        .step-icon {
            margin-right: 0.5rem;
            font-size: 1rem;
        }

        .analysis-step.completed .step-icon::before {
            content: '‚úÖ';
        }

        .analysis-step.current .step-icon::before {
            content: 'üîÑ';
        }

        /* Chat Panel */
        .right-panel {
            width: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
            transition: all 0.3s ease;
        }

        .right-panel.collapsed {
            display: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 700px;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-help {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .connection-status {
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .connection-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status.testing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .server-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .server-info h5 {
            margin: 0 0 0.5rem 0;
            color: #667eea;
        }

        .server-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .btn-test {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .btn-test:hover {
            transform: translateY(-1px);
        }

        .btn-test:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .test-results {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
        }

        .test-results h6 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }

        .test-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-testing { background-color: #ffc107; }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 2% auto;
                width: 95%;
            }
        }

        .chat-header {
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: white;
            border: 1px solid #e9ecef;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            background: white;
            border-radius: 0 0 10px 10px;
        }

        .chat-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .chat-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }

        .token-counter {
            font-size: 0.8rem;
            color: #666;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: #6c757d;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                width: 100%;
                max-width: none;
            }

            .right-panel {
                height: 400px;
            }
        }

        /* Field Matrix and Mapping styles remain the same */
        .field-mapping-controls, .field-matrix-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .field-mapping-controls input, .field-matrix-controls select {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">Enhanced Code Analyzer</div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openConfigModal()">LLM Config</button>
            </div>

    <!-- LLM Configuration Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">VLLM Server Configuration</h3>
                <button class="close" onclick="closeConfigModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="llmConfigForm">
                    <div class="form-group">
                        <label class="form-label" for="llmEndpoint">
                            VLLM Server Endpoint
                        </label>
                        <input type="url" id="llmEndpoint" class="form-input" 
                               placeholder="http://192.168.1.100:8100/generate"
                               value="http://localhost:8100/generate">
                        <div class="form-help">Enter the full URL to your VLLM server's /generate endpoint</div>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="maxTokens">
                                Max Tokens per Call
                            </label>
                            <input type="number" id="maxTokens" class="form-input" 
                                   value="6000" min="1000" max="32000" step="500">
                            <div class="form-help">Maximum tokens for each LLM request</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="temperature">
                                Temperature
                            </label>
                            <input type="number" id="temperature" class="form-input" 
                                   value="0.1" min="0" max="2" step="0.1">
                            <div class="form-help">Creativity level (0.0 = deterministic, 2.0 = creative)</div>
                        </div>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="timeout">
                                Request Timeout (seconds)
                            </label>
                            <input type="number" id="timeout" class="form-input" 
                                   value="60" min="10" max="300" step="5">
                            <div class="form-help">How long to wait for LLM response</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="retries">
                                Max Retries
                            </label>
                            <input type="number" id="retries" class="form-input" 
                                   value="3" min="1" max="5" step="1">
                            <div class="form-help">Number of retry attempts on failure</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn-test" onclick="testLLMConnection()" id="testButton">
                            Test Connection
                        </button>
                    </div>

                    <div id="connectionStatus" class="connection-status" style="display: none;">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="statusMessage"></span>
                    </div>

                    <div id="serverInfo" class="server-info" style="display: none;">
                        <h5>Server Information</h5>
                        <div class="server-info-item">
                            <span>Model:</span>
                            <span id="modelName">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Max Context Length:</span>
                            <span id="contextLength">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Response Time:</span>
                            <span id="responseTime">-</span>
                        </div>
                        <div class="server-info-item">
                            <span>Status:</span>
                            <span id="serverStatus">-</span>
                        </div>
                    </div>

                    <div id="testResults" class="test-results" style="display: none;">
                        <h6>Test Results</h6>
                        <div class="test-detail">
                            <span>Endpoint Reachable:</span>
                            <span id="endpointStatus">-</span>
                        </div>
                        <div class="test-detail">
                            <span>Response Format:</span>
                            <span id="responseFormat">-</span>
                        </div>
                        <div class="test-detail">
                            <span>Token Generation:</span>
                            <span id="tokenGeneration">-</span>
                        </div>
                        <div class="test-detail">
                            <span>Model Compatibility:</span>
                            <span id="modelCompatibility">-</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">
                    Reset to Defaults
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeConfigModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveLLMConfig()">
                    Save & Apply
                </button>
            </div>
        </div>
    </div>
            <div class="header-metrics">
                <div class="metric-item">
                    <span class="metric-value" id="totalComponents">0</span>
                    <span class="metric-label">Components</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalPrograms">0</span>
                    <span class="metric-label">Programs</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalFields">0</span>
                    <span class="metric-label">Fields</span>
                </div>
                <div class="metric-item">
                    <span class="metric-value" id="totalTokens">0</span>
                    <span class="metric-label">Tokens Used</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel -->
        <div class="left-panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-title">Component Dashboard</div>
                <button class="collapse-btn" onclick="togglePanel('left')">‚óÄ</button>
            </div>

            <div class="panel-content">
                <!-- Upload Section -->
                <div class="upload-section">
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;">üìÅ</div>
                        <div>Click to upload COBOL files</div>
                        <small class="text-muted">Supports .cbl, .cob, .cpy, .jcl files</small>
                    </div>
                    <input type="file" id="fileInput" class="file-input" multiple 
                           accept=".cbl,.cob,.cpy,.jcl,.txt" onchange="handleFileUpload(event)">
                </div>

                <!-- Session Info -->
                <div class="session-info" style="margin-bottom: 2rem;">
                    <h4>Session Overview</h4>
                    <div id="sessionStats">
                        <p>Project: <span id="projectName">New Project</span></p>
                        <p>Session ID: <span id="sessionId">Not started</span></p>
                    </div>
                </div>

                <!-- Components List -->
                <div class="components-list">
                    <h4>Components</h4>
                    <div id="componentsList">
                        <p class="text-muted">No components uploaded yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard Overview</button>
                <button class="tab-btn" onclick="showTab('components')">Components Library</button>
                <button class="tab-btn" onclick="showTab('dependencies')">Dependencies Flow</button>
                <button class="tab-btn" onclick="showTab('fieldMatrix')">Field Matrix</button>
                <button class="tab-btn" onclick="showTab('fieldMapping')">Field Mapping Analysis</button>
            </div>

            <!-- Tab Contents -->
            <div class="tab-content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-pane active">
                    <h2>Project Dashboard</h2>
                    
                    <!-- Summary Cards -->
                    <div class="dashboard-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 2rem;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Analysis Status</h3>
                            <p id="analysisStatus">Ready for upload</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>Parsed Programs: <span id="parsedPrograms">0</span></div>
                                <div>Record Layouts: <span id="recordLayouts">0</span></div>
                                <div>CICS Files: <span id="cicsFiles">0</span></div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Processing Queue</h3>
                            <p id="processingQueue">0 files in queue</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>Token Usage: <span id="dashTokenUsage">0</span></div>
                                <div>LLM Calls: <span id="llmCalls">0</span></div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); color: white; padding: 2rem; border-radius: 10px;">
                            <h3>Success Rate</h3>
                            <p id="successRate">100%</p>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div>Complexity Avg: <span id="avgComplexity">N/A</span></div>
                                <div>Confidence: <span id="avgConfidence">N/A</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Component Summaries -->
                    <div style="margin-top: 2rem;">
                        <h3>Component Analysis Summary</h3>
                        <div id="componentSummaries" class="component-summaries">
                            <p class="text-muted">Upload COBOL files to see AI-generated business summaries</p>
                        </div>
                    </div>
                </div>

                <!-- Components Library Tab -->
                <div id="components" class="tab-pane">
                    <h2>Components Library</h2>
                    
                    <!-- Filter Controls -->
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                        <select id="componentTypeFilter" onchange="filterComponents()">
                            <option value="">All File Types</option>
                            <option value="PROGRAM">Programs Only</option>
                            <option value="COPYBOOK">Copybooks Only</option>
                            <option value="JCL">JCL Only</option>
                        </select>
                        <input type="text" id="componentSearchFilter" placeholder="Search components..." onkeyup="filterComponents()" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <select id="componentViewFilter" onchange="filterComponents()">
                            <option value="">All Components</option>
                            <option value="analyzed">Analyzed Components</option>
                            <option value="extracted">Extracted Components</option>
                        </select>
                    </div>

                    <div id="componentsTable">
                        <!-- Main Components View -->
                        <div class="component-section">
                            <h4>Uploaded Files & Discovered Components</h4>
                            <p class="text-muted">Click on any file to expand and view its discovered components</p>
                            
                            <div id="mainComponentsView" style="margin-top: 1rem;">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dependencies Flow Tab -->
                <div id="dependencies" class="tab-pane">
                    <h2>Dependencies Flow</h2>
                    
                    <!-- Dependency Controls -->
                    <div class="dependency-controls">
                        <label for="dependencyComponentSelect" style="font-weight: 600;">View Dependencies For:</label>
                        <select id="dependencyComponentSelect" onchange="loadDependencyFlow()" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
                            <option value="">Overall System View</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshDependencyFlow()">Refresh</button>
                        <button class="btn btn-secondary" onclick="exportDependencyDiagram()">Export Diagram</button>
                    </div>
                    
                    <!-- Dependency Flow Container -->
                    <div id="dependenciesVisualization">
                        <div class="dependency-flow-container">
                            <div id="dependencyFlowContent">
                                <p class="text-muted">Upload and analyze COBOL programs to see system architecture flow</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Field Matrix Tab -->
                <div id="fieldMatrix" class="tab-pane">
                    <h2>Field Matrix</h2>
                    <div class="field-matrix-controls">
                        <select id="recordLayoutSelect" onchange="loadFieldMatrix()">
                            <option value="">Select Record Layout</option>
                        </select>
                        <select id="programSelect" onchange="loadFieldMatrix()">
                            <option value="">Select Program</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadFieldMatrix()">Refresh Matrix</button>
                    </div>
                    <div id="fieldMatrixTable">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Usage Type</th>
                                    <th>Source Field</th>
                                    <th>Business Purpose</th>
                                    <th>Program</th>
                                    <th>Line #</th>
                                </tr>
                            </thead>
                            <tbody id="fieldMatrixTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No field data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                
                <!-- Field Mapping Analysis Tab -->
                <div id="fieldMapping" class="tab-pane">
                    <h2>Field Mapping Analysis</h2>
                    <div class="field-mapping-controls">
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="targetFileInput" placeholder="Enter target file name (e.g., CUSTOMER-FILE)" style="flex: 1; min-width: 200px;">
                            <select id="recordLayoutSelector" onchange="updateTargetFileFromLayout()" style="min-width: 200px;">
                                <option value="">Or select a record layout</option>
                            </select>
                            <button class="btn btn-primary" onclick="analyzeFieldMapping()">Analyze Field Mapping</button>
                            <button class="btn btn-secondary" onclick="exportFieldMappings()">Export to CSV</button>
                        </div>
                    </div>

                    <!-- Layout Summary Section -->
                    <div id="layoutSummarySection" style="display: none; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <h4>Layout Summary</h4>
                        <div id="layoutSummaryContent"></div>
                    </div>
                    
                    <div id="fieldMappingResults">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Mainframe Type & Length</th>
                                    <th>Oracle Type & Length</th>
                                    <th>Population Source</th>
                                    <th>Business Logic</th>
                                    <th>Programs Involved</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fieldMappingTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Enter a target file name or select a layout and click Analyze</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Field Details Modal -->
                <div id="fieldDetailsModal" class="modal">
                    <div class="modal-content" style="width: 80%; max-width: 900px;">
                        <div class="modal-header">
                            <h3 class="modal-title" id="fieldModalTitle">Field Details</h3>
                            <button class="close" onclick="closeFieldDetailsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="fieldDetailsContent">
                                <!-- Will be populated with field details -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeFieldDetailsModal()">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Chat -->
        <div class="right-panel" id="rightPanel">
            <div class="chat-header">
                <div>AI Assistant</div>
                <button class="collapse-btn" onclick="togglePanel('right')" style="background: none; border: none; color: white; font-size: 1.2rem;">‚ñ∂</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message assistant">
                    <p>Hello! I'm your mainframe analysis assistant. I can help you understand:</p>
                    <ul>
                        <li>Field mappings and data relationships</li>
                        <li>Record layout structures</li>
                        <li>Program dependencies and business logic</li>
                        <li>COBOL to Oracle conversion guidance</li>
                    </ul>
                    <p>Ask me about any field, record layout, or program in your analysis!</p>
                </div>
            </div>
            <div class="chat-input-area">
                <textarea id="chatInput" class="chat-input" 
                         placeholder="Ask about fields, record layouts, or programs..."
                         onkeydown="handleChatKeydown(event)"></textarea>
                <div class="chat-controls">
                    <span class="token-counter" id="chatTokenCounter">0 tokens</span>
                    <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading"></div>
            <h3 id="loadingTitle">Processing...</h3>
            <p id="loadingMessage">Analyzing your files...</p>
            <div id="loadingProgress" style="margin-top: 1rem;">
                <div style="background: #e9ecef; border-radius: 10px; height: 6px; margin-bottom: 0.5rem;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="font-size: 0.9rem; color: #6c757d;">Starting analysis...</div>
            </div>
            <div id="analysisSteps" style="margin-top: 1rem; text-align: left; max-width: 400px;">
                <div class="analysis-step" id="step1">
                    <span class="step-icon"></span> Parsing COBOL structure...
                </div>
                <div class="analysis-step" id="step2">
                    <span class="step-icon"></span> Extracting components...
                </div>
                <div class="analysis-step" id="step3">
                    <span class="step-icon"></span> Generating business summary...
                </div>
                <div class="analysis-step" id="step4">
                    <span class="step-icon"></span> Storing results...
                </div>
            </div>
            <div id="processingStatus" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <script>
        // Global variables
        let currentSessionId = null;
        let currentConversationId = null;
        let fieldMatrixData = {};
        let componentsData = [];
        let dependenciesData = [];
        let llmConfig = {
            endpoint: 'http://localhost:8100/generate',
            maxTokens: 6000,
            temperature: 0.1,
            timeout: 60,
            retries: 3
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadLLMConfig();
            initializeSession();
            updateTokenCounters();
        });

        // LLM Configuration Management
        function loadLLMConfig() {
            const saved = localStorage.getItem('llmConfig');
            if (saved) {
                try {
                    llmConfig = { ...llmConfig, ...JSON.parse(saved) };
                    updateConfigForm();
                } catch (e) {
                    console.error('Error loading LLM config:', e);
                }
            }
        }

        function openConfigModal() {
            updateConfigForm();
            document.getElementById('configModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Hide status messages
            document.getElementById('connectionStatus').style.display = 'none';
            document.getElementById('serverInfo').style.display = 'none';
            document.getElementById('testResults').style.display = 'none';
        }

        function updateConfigForm() {
            document.getElementById('llmEndpoint').value = llmConfig.endpoint;
            document.getElementById('maxTokens').value = llmConfig.maxTokens;
            document.getElementById('temperature').value = llmConfig.temperature;
            document.getElementById('timeout').value = llmConfig.timeout;
            document.getElementById('retries').value = llmConfig.retries;
        }

        async function testLLMConnection() {
            const endpoint = document.getElementById('llmEndpoint').value.trim();
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const timeout = parseInt(document.getElementById('timeout').value);

            if (!endpoint) {
                showConnectionStatus('error', 'Please enter a VLLM endpoint URL first');
                return;
            }

            // Show testing status
            showConnectionStatus('testing', 'Testing connection to VLLM server...');
            
            const testButton = document.getElementById('testButton');
            testButton.disabled = true;
            testButton.textContent = 'Testing...';

            // Show test results section
            document.getElementById('testResults').style.display = 'block';
            resetTestResults();

            try {
                const startTime = Date.now();
                
                // Test connection with comprehensive testing
                const response = await fetch('/api/test-llm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        endpoint,
                        maxTokens,
                        temperature,
                        timeout
                    })
                });

                const responseTime = Date.now() - startTime;

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        // Show success status
                        showConnectionStatus('success', 'Connection successful! VLLM server is responding normally.');
                        
                        // Update test results
                        updateTestResults({
                            endpointReachable: true,
                            responseFormat: 'Valid JSON',
                            tokenGeneration: data.response_tokens > 0 ? 'Working' : 'Limited',
                            modelCompatibility: data.model_name ? 'Compatible' : 'Unknown'
                        });
                        
                        // Display server information
                        displayServerInfo({
                            model: data.model_name || 'Unknown',
                            contextLength: data.max_context_length || 'Unknown',
                            responseTime: `${responseTime}ms`,
                            status: 'Online',
                            promptTokens: data.prompt_tokens || 0,
                            responseTokens: data.response_tokens || 0
                        });
                    } else {
                        showConnectionStatus('error', `Connection failed: ${data.error || 'Unknown error'}`);
                        updateTestResults({
                            endpointReachable: false,
                            responseFormat: 'Error',
                            tokenGeneration: 'Failed',
                            modelCompatibility: 'Incompatible'
                        });
                        hideServerInfo();
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('LLM connection test failed:', error);
                showConnectionStatus('error', `Connection failed: ${error.message}`);
                updateTestResults({
                    endpointReachable: false,
                    responseFormat: 'Network Error',
                    tokenGeneration: 'Failed',
                    modelCompatibility: 'Cannot Determine'
                });
                hideServerInfo();
            } finally {
                testButton.disabled = false;
                testButton.textContent = 'Test Connection';
            }
        }

        function showConnectionStatus(type, message) {
            const status = document.getElementById('connectionStatus');
            const indicator = document.getElementById('statusIndicator');
            const statusMessage = document.getElementById('statusMessage');

            status.className = `connection-status ${type}`;
            status.style.display = 'flex';
            
            // Update indicator
            indicator.className = `status-indicator status-${type === 'testing' ? 'testing' : type === 'success' ? 'online' : 'offline'}`;
            
            statusMessage.textContent = message;
        }

        function resetTestResults() {
            document.getElementById('endpointStatus').textContent = 'Testing...';
            document.getElementById('responseFormat').textContent = 'Testing...';
            document.getElementById('tokenGeneration').textContent = 'Testing...';
            document.getElementById('modelCompatibility').textContent = 'Testing...';
        }

        function updateTestResults(results) {
            document.getElementById('endpointStatus').textContent = results.endpointReachable ? '‚úÖ Reachable' : '‚ùå Failed';
            document.getElementById('responseFormat').textContent = results.responseFormat;
            document.getElementById('tokenGeneration').textContent = results.tokenGeneration;
            document.getElementById('modelCompatibility').textContent = results.modelCompatibility;
        }

        function displayServerInfo(info) {
            document.getElementById('modelName').textContent = info.model;
            document.getElementById('contextLength').textContent = info.contextLength;
            document.getElementById('responseTime').textContent = info.responseTime;
            document.getElementById('serverStatus').textContent = info.status;
            document.getElementById('serverInfo').style.display = 'block';
        }

        function hideServerInfo() {
            document.getElementById('serverInfo').style.display = 'none';
        }

        async function saveLLMConfig() {
            const endpoint = document.getElementById('llmEndpoint').value.trim();
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const timeout = parseInt(document.getElementById('timeout').value);
            const retries = parseInt(document.getElementById('retries').value);

            // Validation
            if (!endpoint) {
                showError('Please enter a valid VLLM endpoint URL');
                return;
            }

            if (maxTokens < 1000 || maxTokens > 32000) {
                showError('Max tokens must be between 1000 and 32000');
                return;
            }

            if (temperature < 0 || temperature > 2) {
                showError('Temperature must be between 0.0 and 2.0');
                return;
            }

            // Update config
            llmConfig = {
                endpoint,
                maxTokens,
                temperature,
                timeout,
                retries
            };

            // Save to localStorage
            localStorage.setItem('llmConfig', JSON.stringify(llmConfig));

            // Update backend configuration via API
            try {
                await updateBackendConfig();
                closeConfigModal();
                showSuccess('LLM configuration saved successfully!');
            } catch (error) {
                showError('Failed to update backend configuration');
            }
        }

        async function updateBackendConfig() {
            try {
                const response = await fetch('/api/llm-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(llmConfig)
                });

                if (!response.ok) {
                    throw new Error('Failed to update backend configuration');
                }
            } catch (error) {
                console.error('Error updating backend config:', error);
                throw error;
            }
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to default values?')) {
                llmConfig = {
                    endpoint: 'http://localhost:8100/generate',
                    maxTokens: 6000,
                    temperature: 0.1,
                    timeout: 60,
                    retries: 3
                };
                updateConfigForm();
                localStorage.removeItem('llmConfig');
                
                // Hide status sections
                document.getElementById('connectionStatus').style.display = 'none';
                document.getElementById('serverInfo').style.display = 'none';
                document.getElementById('testResults').style.display = 'none';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('configModal');
            if (event.target === modal) {
                closeConfigModal();
            }
        }

        function showSuccess(message) {
            // Enhanced success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10001;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Session Management
        async function initializeSession() {
            try {
                const savedSessionId = localStorage.getItem('currentSessionId');
                if (savedSessionId) {
                    currentSessionId = savedSessionId;
                    currentConversationId = generateUUID();
                    
                    const response = await fetch(`/api/components/${currentSessionId}`);
                    if (response.ok) {
                        console.log('Using existing session:', currentSessionId);
                        document.getElementById('sessionId').textContent = currentSessionId.slice(0, 8) + '...';
                        document.getElementById('projectName').textContent = 'Existing Project';
                        return;
                    }
                }
                
                const response = await fetch('/api/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_name: `Project_${new Date().toISOString().slice(0,19)}` })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentSessionId = data.session_id;
                    currentConversationId = generateUUID();
                    
                    localStorage.setItem('currentSessionId', currentSessionId);
                    
                    document.getElementById('sessionId').textContent = currentSessionId.slice(0, 8) + '...';
                    document.getElementById('projectName').textContent = data.project_name;
                    
                    console.log('New session initialized:', currentSessionId);
                } else {
                    throw new Error('Failed to create session');
                }
            } catch (error) {
                console.error('Error initializing session:', error);
                showError('Failed to initialize session');
            }
        }

        // Enhanced file upload with progress tracking
        async function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            showLoadingWithProgress(`Processing ${files.length} files...`);
            
            let processedCount = 0;
            let successCount = 0;
            let errorCount = 0;
            const results = [];

            const loadingContent = document.querySelector('.loading-content');
            const statusContainer = document.createElement('div');
            statusContainer.id = 'processingStatus';
            statusContainer.style.marginTop = '2rem';
            loadingContent.appendChild(statusContainer);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileNumber = i + 1;
                
                try {
                    updateLoadingProgress(
                        `Processing ${file.name} (${fileNumber}/${files.length})...`,
                        (i / files.length) * 90,
                        `Analyzing ${file.name}`
                    );
                    
                    updateProcessingStatus(fileNumber, files.length, file.name, 'processing');
                    
                    updateAnalysisStep(1, 'current', `Parsing ${file.name}...`);
                    updateAnalysisStep(2, 'current', 'Extracting components...');
                    updateAnalysisStep(3, 'current', 'Generating AI analysis...');
                    updateAnalysisStep(4, 'current', 'Storing results...');

                    const content = await readFileContent(file);
                    const fileType = getFileType(file.name);
                    
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: currentSessionId,
                            content: content,
                            filename: file.name,
                            file_type: fileType
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            successCount++;
                            results.push({ file: file.name, success: true, data: data });
                            
                            updateAnalysisStep(1, 'completed', `Parsed ${file.name}`);
                            updateAnalysisStep(2, 'completed', `Found ${data.components.length} components`);
                            updateAnalysisStep(3, 'completed', `Generated business summaries`);
                            updateAnalysisStep(4, 'completed', `Stored in database`);
                            
                            updateProcessingStatus(fileNumber, files.length, file.name, 'success', data.components.length);
                            
                            componentsData = componentsData.concat(data.components);
                            
                            console.log(`Successfully processed ${file.name}:`, data.components.length, 'components');
                        } else {
                            errorCount++;
                            results.push({ file: file.name, success: false, error: data.error });
                            updateProcessingStatus(fileNumber, files.length, file.name, 'error', 0, data.error);
                            showErrorInStep(file.name, data.error);
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    errorCount++;
                    results.push({ file: file.name, success: false, error: error.message });
                    console.error(`Error processing ${file.name}:`, error);
                    updateProcessingStatus(fileNumber, files.length, file.name, 'error', 0, error.message);
                    showErrorInStep(file.name, error.message);
                }
                
                processedCount++;
                
                const overallProgress = (processedCount / files.length) * 90;
                updateLoadingProgress(
                    `Processed ${processedCount}/${files.length} files (${successCount} successful, ${errorCount} failed)`,
                    overallProgress,
                    `${processedCount} of ${files.length} complete`
                );
            }

            updateLoadingProgress(
                `Analysis complete! Processed ${processedCount} files`,
                95,
                'Updating interface...'
            );

            const finalSummaryHtml = `
                <div style="background: #d4edda; padding: 1rem; border-radius: 8px; border: 1px solid #c3e6cb; margin-top: 1rem;">
                    <h4 style="color: #155724; margin: 0 0 0.5rem 0;">Processing Complete!</h4>
                    <div style="color: #155724;">
                        <strong>Total Files:</strong> ${files.length}<br>
                        <strong>Successful:</strong> ${successCount}<br>
                        <strong>Failed:</strong> ${errorCount}<br>
                        <strong>Total Components:</strong> ${results.reduce((sum, r) => sum + (r.data?.components?.length || 0), 0)}
                    </div>
                </div>
            `;
            statusContainer.insertAdjacentHTML('beforeend', finalSummaryHtml);

            updateLoadingProgress('All files processed successfully!', 100, 'Ready!');
            
            setTimeout(async () => {
                hideLoading();
                
                await refreshUI();
                await loadDashboardSummaries();
                
                showCompletionNotification(successCount, errorCount, files.length);
                
            }, 2000);
            
            event.target.value = '';
        }



        function updateFieldMappingHTML() {
    return `
    <!-- Field Mapping Analysis Tab -->
    <div id="fieldMapping" class="tab-pane">
        <h2>Field Mapping Analysis</h2>
        
        <!-- Enhanced Controls -->
        <div class="field-mapping-controls">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <input type="text" id="targetFileInput" placeholder="Enter target file name (e.g., CUSTOMER-FILE)" style="flex: 1; min-width: 200px;">
                <select id="recordLayoutSelector" onchange="updateTargetFileFromLayout()" style="min-width: 200px;">
                    <option value="">Or select a record layout</option>
                </select>
                <button class="btn btn-primary" onclick="analyzeFieldMapping()">Analyze Field Mapping</button>
                <button class="btn btn-secondary" onclick="exportFieldMappings()">Export to CSV</button>
            </div>
        </div>

        <!-- Layout Summary Section -->
        <div id="layoutSummarySection" style="display: none; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
            <h4>Layout Summary</h4>
            <div id="layoutSummaryContent"></div>
        </div>

        <!-- Field Mapping Results -->
        <div id="fieldMappingResults">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Field Name</th>
                        <th>Mainframe Type & Length</th>
                        <th>Oracle Type & Length</th>
                        <th>Population Source</th>
                        <th>Business Logic</th>
                        <th>Programs Involved</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="fieldMappingTableBody">
                    <tr>
                        <td colspan="7" class="text-center text-muted">Enter a target file name or select a layout and click Analyze</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Field Details Modal -->
    <div id="fieldDetailsModal" class="modal">
        <div class="modal-content" style="width: 80%; max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="fieldModalTitle">Field Details</h3>
                <button class="close" onclick="closeFieldDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="fieldDetailsContent">
                    <!-- Will be populated with field details -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeFieldDetailsModal()">Close</button>
            </div>
        </div>
    </div>
    `;
}

function updateTargetFileFromLayout() {
    const selector = document.getElementById('recordLayoutSelector');
    const targetInput = document.getElementById('targetFileInput');
    
    if (selector.value) {
        targetInput.value = selector.value;
    }
}
        // Helper function to update processing status
        function updateProcessingStatus(currentFile, totalFiles, fileName, status, componentsFound = 0, error = null) {
            const container = document.getElementById('processingStatus');
            if (!container) return;

            let statusItem = document.getElementById(`status-${currentFile}`);
            if (!statusItem) {
                statusItem = document.createElement('div');
                statusItem.id = `status-${currentFile}`;
                statusItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 0.5rem;
                    margin-bottom: 0.5rem;
                    border-radius: 6px;
                    font-size: 0.9rem;
                `;
                container.appendChild(statusItem);
            }

            let statusIcon, statusColor, statusText, backgroundColor;
            
            switch (status) {
                case 'processing':
                    statusIcon = 'üîÑ';
                    statusColor = '#0c5460';
                    backgroundColor = '#d1ecf1';
                    statusText = `Processing ${fileName}...`;
                    break;
                case 'success':
                    statusIcon = '‚úÖ';
                    statusColor = '#155724';
                    backgroundColor = '#d4edda';
                    statusText = `${fileName} - ${componentsFound} components found`;
                    break;
                case 'error':
                    statusIcon = '‚ùå';
                    statusColor = '#721c24';
                    backgroundColor = '#f8d7da';
                    statusText = `${fileName} - Error: ${error?.substring(0, 50) || 'Unknown error'}`;
                    break;
            }

            statusItem.style.color = statusColor;
            statusItem.style.backgroundColor = backgroundColor;
            statusItem.innerHTML = `
                <span style="margin-right: 0.5rem; font-size: 1rem;">${statusIcon}</span>
                <span><strong>File ${currentFile}/${totalFiles}:</strong> ${statusText}</span>
            `;
        }

        // Enhanced completion notification
        function showCompletionNotification(successCount, errorCount, totalFiles) {
            const notificationHtml = `
                <div id="completionNotification" style="
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    background: ${errorCount > 0 ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)' : 'linear-gradient(135deg, #28a745 0%, #20c997 100%)'};
                    color: white;
                    padding: 1.5rem;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    z-index: 10000;
                    min-width: 300px;
                    animation: slideIn 0.3s ease;
                ">
                    <h4 style="margin: 0 0 0.5rem 0;">${errorCount > 0 ? '‚ö†Ô∏è' : 'üéâ'} Processing Complete!</h4>
                    <div>
                        <strong>Files Processed:</strong> ${successCount}/${totalFiles}<br>
                        ${errorCount > 0 ? `<strong>Errors:</strong> ${errorCount}<br>` : ''}
                        <strong>Total Components:</strong> ${componentsData.length}
                    </div>
                    <button onclick="closeCompletionNotification()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        padding: 0.25rem 0.5rem;
                        border-radius: 4px;
                        margin-top: 0.5rem;
                        cursor: pointer;
                    ">Close</button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', notificationHtml);
            
            setTimeout(() => {
                closeCompletionNotification();
            }, 10000);
        }

        function closeCompletionNotification() {
            const notification = document.getElementById('completionNotification');
            if (notification) {
                notification.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => notification.remove(), 300);
            }
        }

        function normalizeUsageType(usageType) {
    if (!usageType) return 'STATIC';
    
    const normalizedMappings = {
        'MOVE_TARGET': 'INPUT',
        'MOVE_SOURCE': 'OUTPUT', 
        'MOVE': 'INPUT_OUTPUT',
        'COMPUTED': 'DERIVED',
        'DEFINITION': 'STATIC',
        'CONDITION': 'REFERENCE',
        'CONDITIONAL': 'REFERENCE',
        'CICS_INPUT': 'INPUT',
        'CICS_OUTPUT': 'OUTPUT',
        'CICS_REWRITE': 'INPUT_OUTPUT',
        'STRING_MANIPULATION': 'DERIVED',
        'CALCULATED': 'DERIVED',
        'UNUSED': 'UNUSED'
    };
    
    return normalizedMappings[usageType.toUpperCase()] || usageType.toUpperCase();
}

        // Enhanced Dashboard Summaries with Raw Response Handling
        // In index.html, update loadDashboardSummaries function:
async function loadDashboardSummaries() {
    try {
        // Get components with LLM summaries from new table
        const response = await fetch(`/api/llm-summaries/${currentSessionId}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                displayComponentSummariesFromLLMTable(data.summaries);
                updateDashboardMetrics(data.summaries);
            }
        }
    } catch (error) {
        console.error('Error loading LLM summaries:', error);
    }
}

function displayComponentSummariesFromLLMTable(summaries) {
    const container = document.getElementById('componentSummaries');
    container.innerHTML = '';

    if (summaries.length === 0) {
        container.innerHTML = '<p class="text-muted">No component summaries available</p>';
        return;
    }

    summaries.forEach(summary => {
        const card = document.createElement('div');
        card.className = 'component-summary-card';
        
        const businessPurpose = summary.business_purpose || 'No business purpose available';
        const complexityScore = summary.complexity_score || 0.5;
        const keyFeatures = summary.key_features || [];
        
        if (summary.is_raw_response) {
            // Handle raw LLM responses
            card.innerHTML = `
                <div class="component-header">
                    <div>
                        <div class="component-title">${summary.component_name}</div>
                        <div class="text-muted">${summary.friendly_name || ''}</div>
                    </div>
                    <span class="component-type badge badge-warning">RAW AI ANALYSIS</span>
                </div>
                
                <div class="business-purpose raw-analysis">
                    <strong>AI Analysis (Raw Response):</strong><br>
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; max-height: 150px; overflow-y: auto;">
                        ${businessPurpose}
                    </div>
                </div>
                
                <div class="component-metrics">
                    <div class="metric">
                        <span class="metric-value">RAW</span>
                        <span class="metric-label">Analysis</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value">${Math.round(complexityScore * 100)}%</span>
                        <span class="metric-label">Complexity</span>
                    </div>
                </div>
            `;
        } else {
            // Handle structured summaries
            card.innerHTML = `
                <div class="component-header">
                    <div>
                        <div class="component-title">${summary.component_name}</div>
                        <div class="text-muted">${summary.friendly_name || ''}</div>
                    </div>
                    <span class="component-type badge badge-primary">${summary.component_type}</span>
                </div>
                
                <div class="business-purpose">${businessPurpose}</div>
                
                <div class="component-metrics">
                    <div class="metric">
                        <span class="metric-value">${summary.primary_function || 'GENERAL'}</span>
                        <span class="metric-label">Function</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value">${Math.round(complexityScore * 100)}%</span>
                        <span class="metric-label">Complexity</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value">${keyFeatures.length}</span>
                        <span class="metric-label">Features</span>
                    </div>
                </div>
                
                <div class="complexity-bar">
                    <div class="complexity-fill" style="width: ${complexityScore * 100}%"></div>
                </div>
            `;
        }
        
        container.appendChild(card);
    });
}

function escapeForTemplate(str) {
    if (!str) return '';
    return str
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r')
        .replace(/\t/g, '\\t');
}




        function displayComponentSummariesWithDerived(components) {
    const container = document.getElementById('componentSummaries');
    container.innerHTML = '';

    const programs = components.filter(c => c.component_type === 'PROGRAM');
    
    if (programs.length === 0) {
        container.innerHTML = '<p class="text-muted">Upload COBOL files to see AI-generated business summaries</p>';
        return;
    }

    programs.forEach(program => {
        console.log('Processing program:', program.component_name);
        
        let businessPurpose = 'Analysis pending...';
        let complexityScore = 0.5;
        let isRawResponse = false;
        let rawResponse = '';
        let friendlyName = program.component_name;
        
        if (program.friendly_name && program.friendly_name !== program.component_name) {
            friendlyName = program.friendly_name;
        }
        
        // Check for LLM summary with better raw response detection
        if (program.llm_summary) {
            // Check if it's a raw response (JSON parsing failed)
            if (program.llm_summary.is_raw === true || program.llm_summary.raw_response) {
                rawResponse = program.llm_summary.raw_response || program.llm_summary.business_purpose || '';
                businessPurpose = rawResponse.length > 200 ? 
                    rawResponse.substring(0, 197) + '...' : rawResponse;
                isRawResponse = true;
                complexityScore = program.llm_summary.complexity_score || 0.5;
            } 
            // Check if it's a structured response
            else if (program.llm_summary.business_purpose && 
                     program.llm_summary.business_purpose !== 'undefined' &&
                     program.llm_summary.business_purpose.trim() !== '') {
                businessPurpose = program.llm_summary.business_purpose;
                complexityScore = program.llm_summary.complexity_score || 0.5;
                isRawResponse = false;
            }
            // Fallback: check if the whole llm_summary is actually a raw string
            else if (typeof program.llm_summary === 'string') {
                rawResponse = program.llm_summary;
                businessPurpose = rawResponse.length > 200 ? 
                    rawResponse.substring(0, 197) + '...' : rawResponse;
                isRawResponse = true;
            }
        }
        // Fallback to component-level business_purpose
        else if (program.business_purpose && 
                 program.business_purpose !== 'undefined' && 
                 program.business_purpose.trim() !== '') {
            businessPurpose = program.business_purpose;
        }
        
        const derivedCount = program.derived_count || 0;
        const card = document.createElement('div');
        card.className = 'component-summary-card';
        
        if (isRawResponse) {
            card.innerHTML = `
                <div class="component-header">
                    <div>
                        <div class="component-title">${program.component_name}</div>
                        <div class="text-muted" style="font-size: 0.8rem;">${friendlyName}</div>
                    </div>
                    <span class="component-type badge badge-warning">RAW AI ANALYSIS</span>
                </div>
                
                <div class="business-purpose raw-analysis">
                    <strong>AI Analysis (Raw Response):</strong><br>
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; border-left: 4px solid #ffc107; font-size: 0.9rem; line-height: 1.4; max-height: 150px; overflow-y: auto; white-space: pre-wrap;">
                        ${businessPurpose}
                    </div>
                    ${rawResponse.length > 200 ? '<small style="color: #856404;"><em>Click "View Full Analysis" to see complete response</em></small>' : ''}
                </div>
                
                <div class="component-metrics">
                    <div class="metric">
                        <span class="metric-value">${program.total_lines || 0}</span>
                        <span class="metric-label">Lines</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value">RAW</span>
                        <span class="metric-label">Analysis</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value">${derivedCount}</span>
                        <span class="metric-label">Components</span>
                    </div>
                </div>
                
                <div class="derived-components">
                    <button class="derived-toggle" onclick="toggleDerivedComponents('${program.component_name}', this)">
                        View ${derivedCount} Components
                    </button>
                    <div class="derived-list" id="derived-${program.component_name}">
                        <!-- Will be populated when expanded -->
                    </div>
                </div>
                
                ${rawResponse.length > 200 ? 
                    `<button class="btn btn-secondary" style="width: 100%; margin-top: 1rem;" 
                             onclick="showRawAnalysisModal('${program.component_name.replace(/'/g, "\\'")}', '${rawResponse.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')">
                        View Full AI Analysis
                     </button>` : ''}
            `;
        } else {
            // Standard structured display
            card.innerHTML = `
                <div class="component-header">
                    <div>
                        <div class="component-title">${program.component_name}</div>
                        <div class="text-muted" style="font-size: 0.8rem;">${friendlyName}</div>
                    </div>
                    <span class="component-type badge badge-primary">PROGRAM</span>
                </div>
                
                <div class="business-purpose">${businessPurpose}</div>
                
                <div class="component-metrics">
                    <div class="metric">
                        <span class="metric-value">${program.total_lines || 0}</span>
                        <span class="metric-label">Lines</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value">${Math.round(complexityScore * 100)}%</span>
                        <span class="metric-label">Complexity</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value">${derivedCount}</span>
                        <span class="metric-label">Components</span>
                    </div>
                </div>
                
                <div class="complexity-bar">
                    <div class="complexity-fill" style="width: ${complexityScore * 100}%"></div>
                </div>
                
                <div class="derived-components">
                    <button class="derived-toggle" onclick="toggleDerivedComponents('${program.component_name}', this)">
                        View ${derivedCount} Components
                    </button>
                    <div class="derived-list" id="derived-${program.component_name}">
                        <!-- Will be populated when expanded -->
                    </div>
                </div>
            `;
        }
        
        container.appendChild(card);
    });
}
        // Toggle derived components
        async function toggleDerivedComponents(programName, button) {
            const derivedList = document.getElementById(`derived-${programName}`);
            
            if (derivedList.classList.contains('show')) {
                derivedList.classList.remove('show');
                button.textContent = button.textContent.replace('Hide', 'View');
            } else {
                // Load derived components if not already loaded
                if (derivedList.children.length === 0) {
                    try {
                        const response = await fetch(`/api/derived-components/${currentSessionId}?parent_component=${programName}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                displayDerivedComponentsList(derivedList, data.derived_components);
                            }
                        }
                    } catch (error) {
                        console.error('Error loading derived components:', error);
                        derivedList.innerHTML = '<p class="text-muted">Error loading components</p>';
                    }
                }
                
                derivedList.classList.add('show');
                button.textContent = button.textContent.replace('View', 'Hide');
            }
        }

        function displayDerivedComponentsList(container, derivedComponents) {
            container.innerHTML = '';
            
            derivedComponents.forEach(component => {
                const item = document.createElement('div');
                item.className = 'derived-item';
                
                item.innerHTML = `
                    <div>
                        <div class="derived-item-name">${component.component_name}</div>
                        <div class="text-muted" style="font-size: 0.8rem;">${component.friendly_name || ''}</div>
                    </div>
                    <div class="derived-item-type">${component.component_type}</div>
                `;
                
                container.appendChild(item);
            });
        }

        // Show raw analysis modal
        function showRawAnalysisModal(componentName, rawResponse) {
    // Decode escaped characters
    const decodedResponse = rawResponse
        .replace(/\\'/g, "'")
        .replace(/\\n/g, '\n')
        .replace(/\\r/g, '\r')
        .replace(/\\t/g, '\t');
    
    const modalHtml = `
        <div class="modal" style="display: block; z-index: 10001; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);">
            <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 0; border-radius: 12px; width: 70%; max-width: 800px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); animation: modalSlideIn 0.3s ease;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600;">${componentName} - Complete AI Analysis</h3>
                    <button onclick="closeRawAnalysisModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s ease;">&times;</button>
                </div>
                <div style="padding: 2rem;">
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 1px solid #dee2e6; max-height: 500px; overflow-y: auto;">
                        <pre style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.9rem; line-height: 1.4; margin: 0; word-wrap: break-word;">${decodedResponse}</pre>
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 6px; border: 1px solid #ffeaa7;">
                        <strong>Note:</strong> This is the raw response from the AI model. The JSON parsing failed, but the AI provided useful analysis. Consider reviewing the prompt or model configuration if you see this frequently.
                    </div>
                </div>
                <div style="padding: 1.5rem 2rem; border-top: 1px solid #e9ecef; display: flex; gap: 1rem; justify-content: flex-end; background: #f8f9fa; border-radius: 0 0 12px 12px;">
                    <button class="btn btn-secondary" onclick="closeRawAnalysisModal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

        function closeRawAnalysisModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.style.zIndex === '10001') {
                    modal.remove();
                }
            });
        }

        // Enhanced Dependency Flow
        async function loadDependencyFlow() {
            const selectedComponent = document.getElementById('dependencyComponentSelect').value;
            
            try {
                console.log('Loading dependency flow for:', selectedComponent || 'Overall System');
                
                // First, populate the dropdown with available components if it's empty
                await populateDependencyDropdown();
                
                const response = await fetch(`/api/dependencies/${currentSessionId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Dependencies response:', data);
                    
                    if (data.success && data.dependencies && data.dependencies.length > 0) {
                        displayEnhancedDependencyFlow(data.dependencies, selectedComponent);
                    } else {
                        displayEmptyDependencyFlow();
                    }
                } else {
                    console.error('Dependencies API response not ok:', response.status);
                    displayEmptyDependencyFlow();
                }
            } catch (error) {
                console.error('Error loading dependency flow:', error);
                displayEmptyDependencyFlow();
            }
        }

        function displayEmptyDependencyFlow() {
            document.getElementById('dependencyFlowContent').innerHTML = 
                '<p class="text-muted">Upload and analyze COBOL programs to see system architecture flow</p>';
        }

        function displayEnhancedDependencyFlow(dependencies, selectedComponent) {
    console.log('Displaying enhanced dependency flow with', dependencies.length, 'dependencies');
    
    const flowContainer = document.getElementById('dependencyFlowContent');
    flowContainer.innerHTML = '';
    
    // Filter dependencies if a specific component is selected
    let filteredDeps = dependencies;
    if (selectedComponent) {
        filteredDeps = dependencies.filter(dep => 
            dep.source_component === selectedComponent || dep.target_component === selectedComponent
        );
    }
    
    if (filteredDeps.length === 0) {
        flowContainer.innerHTML = `<p class="text-muted">No dependencies found for ${selectedComponent || 'the system'}</p>`;
        return;
    }
    
    const categorizedDeps = categorizeDependenciesForFlow(filteredDeps, selectedComponent);
    console.log('Categorized dependencies:', categorizedDeps);
    
    // Create hierarchical flow
    const flowHtml = createDependencyFlowHTML(categorizedDeps, selectedComponent);
    flowContainer.innerHTML = flowHtml;
}

    function initializeFieldMapping() {
    loadRecordLayoutSelector();
}

function createDependencyFlowHTML(categorized, focusComponent) {
    let html = '<div class="dependency-flow">';
    
    // Input Sources Level
    if (categorized.inputSources.length > 0) {
        html += createFlowLevel('Input Sources', categorized.inputSources, 'input-source');
        html += '<div class="flow-arrow">‚Üì</div>';
    }
    
    // Core Programs Level  
    if (categorized.corePrograms.length > 0) {
        html += createFlowLevel(focusComponent ? `${focusComponent} Dependencies` : 'Core Programs', categorized.corePrograms, 'core-program');
        html += '<div class="flow-arrow">‚Üì</div>';
    }
    
    // CICS Interfaces Level
    if (categorized.cicsInterfaces.length > 0) {
        html += createFlowLevel('CICS Interfaces', categorized.cicsInterfaces, 'cics-interface');
        html += '<div class="flow-arrow">‚Üì</div>';
    }
    
    // Output Files Level
    if (categorized.outputFiles.length > 0) {
        html += createFlowLevel('Output Files', categorized.outputFiles, 'output-file');
    }
    
    // Missing Dependencies Level
    if (categorized.missingDeps.length > 0) {
        html += '<div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px dashed #dc3545;">';
        html += createFlowLevel('Missing Dependencies', categorized.missingDeps, 'missing-dependency');
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

function loadRecordLayoutSelector() {
    const selector = document.getElementById('recordLayoutSelector');
    if (!selector) {
        console.warn('Record layout selector not found');
        return;
    }
    
    if (!currentSessionId) {
        console.warn('No active session for loading layouts');
        return;
    }
    
    try {
        fetch(`/api/record-layouts/${currentSessionId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    selector.innerHTML = '<option value="">Or select a record layout</option>';
                    
                    if (data.layouts && data.layouts.length > 0) {
                        data.layouts.forEach(layout => {
                            const option = document.createElement('option');
                            option.value = layout.layout_name;
                            option.textContent = `${layout.layout_name} (${layout.fields_count || 0} fields) - ${layout.program_name}`;
                            selector.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No record layouts found';
                        option.disabled = true;
                        selector.appendChild(option);
                    }
                } else {
                    console.warn('Failed to load record layouts:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading record layouts:', error);
                selector.innerHTML = '<option value="">Error loading layouts</option>';
            });
    } catch (error) {
        console.error('Error in loadRecordLayoutSelector:', error);
    }
}

function updateTargetFileFromLayout() {
    const selector = document.getElementById('recordLayoutSelector');
    const targetInput = document.getElementById('targetFileInput');
    
    if (selector && selector.value && targetInput) {
        targetInput.value = selector.value;
    }
}


        function categorizeDependenciesForFlow(dependencies, focusComponent = null) {
    const categorized = {
        inputSources: new Map(),      // Use Map instead of Set for deduplication
        cicsInterfaces: new Map(),
        corePrograms: new Map(),
        outputFiles: new Map(),
        missingDeps: new Map()
    };
    
    dependencies.forEach(dep => {
        const source = dep.source_component;
        const target = dep.target_component;
        const type = dep.relationship_type;
        
        // Only add the main program once
        if ((!focusComponent || source === focusComponent) && !categorized.corePrograms.has(source)) {
            categorized.corePrograms.set(source, {
                name: source,
                friendly_name: source.toUpperCase(), // Keep UPPER CASE
                type: 'Program',
                confidence: dep.confidence_score || 0.8
            });
        }
        
        // Categorize targets based on relationship type - using Map for deduplication
        if (type === 'INPUT_FILE') {
            categorized.inputSources.set(target, {
                name: target,
                friendly_name: target.toUpperCase(), // Keep UPPER CASE
                type: 'Input File',
                confidence: dep.confidence_score || 0.8
            });
        } else if (type === 'OUTPUT_FILE') {
            categorized.outputFiles.set(target, {
                name: target,
                friendly_name: target.toUpperCase(), // Keep UPPER CASE
                type: 'Output File',
                confidence: dep.confidence_score || 0.8
            });
        } else if (type === 'CICS_FILE') {
            categorized.cicsInterfaces.set(target, {
                name: target,
                friendly_name: target.toUpperCase(), // Keep UPPER CASE
                type: 'CICS Interface',
                confidence: dep.confidence_score || 0.8
            });
        } else if (type === 'PROGRAM_CALL') {
            categorized.corePrograms.set(target, {
                name: target,
                friendly_name: target.toUpperCase(), // Keep UPPER CASE
                type: 'Called Program',
                confidence: dep.confidence_score || 0.8
            });
        } else {
            categorized.missingDeps.set(target, {
                name: target,
                friendly_name: target.toUpperCase(), // Keep UPPER CASE
                type: type.replace('_', ' '),
                confidence: dep.confidence_score || 0.5,
                reason: 'Unknown relationship type'
            });
        }
    });
    
    // Convert Maps to Arrays
    Object.keys(categorized).forEach(key => {
        categorized[key] = Array.from(categorized[key].values());
    });
    
    return categorized;
}
        function createFlowLevel(title, items, className) {
    let html = `
        <div class="flow-level">
            <div class="flow-level-title">${title}</div>
            <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-left: 160px;">
    `;
    
    items.forEach(item => {
        // Use the name directly (already uppercase from categorization)
        const displayName = item.name || item.friendly_name || 'UNKNOWN';
        const confidenceClass = item.confidence > 0.8 ? 'confidence-high' : 
                               item.confidence > 0.5 ? 'confidence-medium' : 'confidence-low';
        
        html += `
            <div class="flow-component ${className}" onclick="showComponentDetails('${item.name}')">
                <div class="confidence-indicator ${confidenceClass}"></div>
                <div class="component-name">${displayName}</div>
                <div class="component-type-badge">${item.type}</div>
                <div class="component-description">
                    Confidence: ${(item.confidence * 100).toFixed(0)}%
                    ${item.reason ? `<br><small>${item.reason}</small>` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div></div>';
    return html;
}
        function generateFriendlyName(technicalName) {
    if (!technicalName) return 'Unknown';
    
    const name = String(technicalName).toUpperCase().trim();
    
    // Remove common prefixes but keep uppercase
    const prefixes = ['WS-', 'LS-', 'WK-', 'FD-', 'FD_', 'TB-', 'TB_', 'SRV-', 'PRG-', 'TMS', 'TMST'];
    for (const prefix of prefixes) {
        if (name.startsWith(prefix)) {
            return name.substring(prefix.length);
        }
    }
    
    return name; // Return as UPPER CASE
}

// Alternative: Create a specific function for dependency display names
function generateDependencyDisplayName(technicalName) {
    if (!technicalName) return 'UNKNOWN';
    
    let name = String(technicalName).toUpperCase().trim();
    
    // Remove technical prefixes but keep everything uppercase
    const prefixes = ['WS-', 'LS-', 'WK-', 'FD-', 'TB-', 'SRV-', 'PRG-'];
    for (const prefix of prefixes) {
        if (name.startsWith(prefix)) {
            name = name.substring(prefix.length);
            break;
        }
    }
    
    // Replace underscores and hyphens with spaces, but keep UPPER CASE
    return name.replace(/[_-]/g, ' ').replace(/\s+/g, ' ').trim();
}

        async function populateDependencyDropdown() {
    const select = document.getElementById('dependencyComponentSelect');
    if (!select) return;
    
    try {
        // Get the current components data
        const response = await fetch(`/api/components/${currentSessionId}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.components) {
                const programs = data.components.filter(c => c.component_type === 'PROGRAM');
                
                // Clear existing options except the first one
                select.innerHTML = '<option value="">Overall System View</option>';
                
                // Add program options
                programs.forEach(program => {
                    const option = document.createElement('option');
                    option.value = program.component_name;
                    option.textContent = `${program.component_name} (${program.friendly_name || program.component_name})`;
                    select.appendChild(option);
                });
                
                console.log(`Populated dependency dropdown with ${programs.length} programs`);
            }
        }
    } catch (error) {
        console.error('Error populating dependency dropdown:', error);
    }
}

        function refreshDependencyFlow() {
            loadDependencyFlow();
        }

        function exportDependencyDiagram() {
            // Implementation for exporting dependency diagram
            alert('Export functionality coming soon!');
        }

        function showComponentDetails(componentName) {
            // Implementation for showing component details
            alert(`Component Details for: ${componentName}`);
        }

        // Tab Management
        function showTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // Update tab panes
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    document.getElementById(tabName).classList.add('active');

    // Load data if needed
    if (tabName === 'components') {
        loadComponentsLibrary();
    } else if (tabName === 'fieldMatrix') {
        loadFieldMatrixSelectors();
    } else if (tabName === 'dashboard') {
        loadDashboardSummaries();
    } else if (tabName === 'dependencies') {
        loadDependencyFlow();
    } else if (tabName === 'fieldMapping') {
        initializeFieldMapping();
    }
}

        // Enhanced Components Library
        async function loadComponentsLibrary() {
            try {
                const response = await fetch(`/api/components-with-derived/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayComponentsLibrary(data.components);
                    }
                }
            } catch (error) {
                console.error('Error loading components library:', error);
            }
        }

        function displayComponentsLibrary(components) {
            const container = document.getElementById('mainComponentsView');
            container.innerHTML = '';

            const programs = components.filter(c => c.component_type === 'PROGRAM');
            
            if (programs.length === 0) {
                container.innerHTML = '<p class="text-muted">No programs uploaded yet</p>';
                return;
            }

            programs.forEach(program => {
                const card = document.createElement('div');
                card.className = 'component-summary-card';
                
                let businessPurpose = (program.llm_summary && program.llm_summary.business_purpose) || program.business_purpose || 'Analysis pending';
                let derivedCount = program.derived_count || 0;
                
                card.innerHTML = `
                    <div class="component-header">
                        <div>
                            <div class="component-title">${program.component_name}</div>
                            <div class="text-muted" style="font-size: 0.8rem;">${program.friendly_name || ''}</div>
                        </div>
                        <span class="component-type badge badge-primary">COBOL Program</span>
                    </div>
                    
                    <div class="business-purpose">${businessPurpose}</div>
                    
                    <div class="component-metrics">
                        <div class="metric">
                            <span class="metric-value">${program.total_lines || 0}</span>
                            <span class="metric-label">Lines of Code</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${derivedCount}</span>
                            <span class="metric-label">Analyzed Components</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${program.total_fields || 0}</span>
                            <span class="metric-label">Total Fields</span>
                        </div>
                    </div>
                    
                    <div class="derived-components">
                        <button class="derived-toggle" onclick="toggleDerivedComponents('${program.component_name}', this)">
                            View ${derivedCount} Analyzed Components
                        </button>
                        <div class="derived-list" id="derived-${program.component_name}">
                            <!-- Will be populated when expanded -->
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="reAnalyzeComponent('${program.component_name}')">Re-analyze Component</button>
                        <button class="btn btn-secondary" onclick="askAboutThis('${program.component_name}')">Ask AI About This</button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Field Matrix and Mapping functions (keeping existing functionality)
        async function loadFieldMatrixSelectors() {
            try {
                const [componentsResponse, layoutsResponse] = await Promise.all([
                    fetch(`/api/components/${currentSessionId}`),
                    fetch(`/api/record-layouts/${currentSessionId}`)
                ]);
                
                if (componentsResponse.ok) {
                    const componentsData = await componentsResponse.json();
                    if (componentsData.success) {
                        populateProgramSelectors(componentsData.components);
                    }
                }
                
                if (layoutsResponse.ok) {
                    const layoutsData = await layoutsResponse.json();
                    if (layoutsData.success) {
                        populateLayoutSelectors(layoutsData.layouts);
                    }
                }
            } catch (error) {
                console.error('Error loading selectors:', error);
            }
        }

        function populateProgramSelectors(components) {
            const programSelect = document.getElementById('programSelect');
            programSelect.innerHTML = '<option value="">Select Program</option>';

            const programs = components.filter(c => c.component_type === 'PROGRAM');
            
            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.component_name;
                option.textContent = `${program.component_name} (${program.total_lines || 0} lines)`;
                programSelect.appendChild(option);
            });
        }

        function populateLayoutSelectors(layouts) {
            const recordLayoutSelect = document.getElementById('recordLayoutSelect');
            recordLayoutSelect.innerHTML = '<option value="">Select Record Layout</option>';

            layouts.forEach(layout => {
                const option = document.createElement('option');
                option.value = layout.layout_name;
                option.textContent = `${layout.layout_name} (${layout.fields_count || 0} fields) - ${layout.program_name}`;
                recordLayoutSelect.appendChild(option);
            });
        }

        // Chat functionality
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addChatMessage('user', message);
            input.value = '';
            updateChatTokenCounter();

            const typingId = addChatMessage('assistant', 'Thinking...');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message: message,
                        conversation_id: currentConversationId
                    })
                });

               if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById(typingId).remove();
                    
                    if (data.success) {
                        const responseContent = data.response || data.content || data.message || 'No response';
                        addChatMessage('assistant', responseContent);
                        
                        if (data.tokens_used) {
                            updateTokenCounters();
                        }
                    } else {
                        addChatMessage('assistant', data.error || 'Sorry, I encountered an error.');
                    }

                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error sending chat message:', error);
                document.getElementById(typingId).remove();
                addChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            }
        }

        function addChatMessage(type, message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${type}`;
            
            let displayMessage = '';
            if (typeof message === 'string') {
                displayMessage = message;
            } else if (typeof message === 'object') {
                if (message.response) {
                    displayMessage = message.response;
                } else if (message.content) {
                    displayMessage = message.content;
                } else {
                    displayMessage = JSON.stringify(message, null, 2);
                }
            } else {
                displayMessage = String(message);
            }
            
            const formattedMessage = displayMessage
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `<p>${formattedMessage}</p>`;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageId;
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
            updateChatTokenCounter();
        }

        function updateChatTokenCounter() {
            const input = document.getElementById('chatInput');
            const counter = document.getElementById('chatTokenCounter');
            const tokenCount = Math.ceil(input.value.length / 4);
            counter.textContent = `${tokenCount} tokens`;
        }

        // Additional utility functions
        function updateDashboardMetrics(components) {
            const programs = components.filter(c => c.component_type === 'PROGRAM');
            const recordLayouts = components.filter(c => c.component_type === 'RECORD_LAYOUT');
            const cicsFiles = components.filter(c => c.component_type === 'CICS_FILE');
            
            document.getElementById('parsedPrograms').textContent = programs.length;
            document.getElementById('recordLayouts').textContent = recordLayouts.length;
            document.getElementById('cicsFiles').textContent = cicsFiles.length;
        }

        async function refreshUI() {
    await loadMetrics();
    await loadComponentsList();
    await populateDependencyDropdown(); // Add this line
}

        async function loadMetrics() {
            try {
                const response = await fetch(`/api/session-metrics/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateMetricsDisplay(data.metrics);
                    }
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        function updateMetricsDisplay(metrics) {
            document.getElementById('totalComponents').textContent = metrics.total_components || 0;
            document.getElementById('totalPrograms').textContent = metrics.component_counts?.PROGRAM || 0;
            document.getElementById('totalFields').textContent = metrics.total_fields || 0;
            document.getElementById('totalTokens').textContent = 
                (metrics.token_usage?.total_prompt_tokens || 0) + (metrics.token_usage?.total_response_tokens || 0);
        }

        async function loadComponentsList() {
            try {
                const response = await fetch(`/api/components/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateComponentsList(data.components);
                    }
                }
            } catch (error) {
                console.error('Error loading components list:', error);
            }
        }

        function updateComponentsList(components) {
            const container = document.getElementById('componentsList');
            container.innerHTML = '';

            if (!components || components.length === 0) {
                container.innerHTML = '<p class="text-muted">No components uploaded yet</p>';
                return;
            }

            const list = document.createElement('div');
            const typeGroups = {};

            components.forEach(component => {
                const type = component.component_type;
                if (!typeGroups[type]) {
                    typeGroups[type] = [];
                }
                typeGroups[type].push(component);
            });

            Object.keys(typeGroups).forEach(type => {
                const typeHeader = document.createElement('h5');
                typeHeader.textContent = `${type}s (${typeGroups[type].length})`;
                typeHeader.style.color = '#667eea';
                typeHeader.style.marginTop = '1rem';
                typeHeader.style.fontSize = '0.9rem';
                list.appendChild(typeHeader);

                typeGroups[type].forEach(component => {
                    const item = document.createElement('div');
                    item.style.padding = '0.5rem';
                    item.style.borderLeft = '3px solid #667eea';
                    item.style.paddingLeft = '0.5rem';
                    item.style.marginBottom = '0.5rem';
                    item.style.backgroundColor = '#f8f9ff';
                    item.style.borderRadius = '4px';
                    item.style.cursor = 'pointer';
                    
                    let businessPurpose = (component.llm_summary && component.llm_summary.business_purpose) || component.business_purpose || 'Analysis pending';
                    
                    if ((!component.llm_summary || !component.llm_summary.business_purpose) && component.analysis_result_json) {
                        try {
                            const analysis = JSON.parse(component.analysis_result_json);
                            if (analysis.llm_summary && analysis.llm_summary.business_purpose) {
                                businessPurpose = analysis.llm_summary.business_purpose;
                            } else if (analysis.business_purpose) {
                                businessPurpose = analysis.business_purpose;
                            }
                        } catch (e) {
                            console.warn('Could not parse analysis for', component.component_name);
                        }
                    }
                    
                    item.innerHTML = `
                        <div style="font-weight: bold; font-size: 0.8rem;">${component.component_name}</div>
                        <div style="font-size: 0.7rem; color: #666; margin-top: 0.2rem;">
                            ${component.total_lines || 0} lines
                        </div>
                        <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem; 
                                   max-height: 2.4em; overflow: hidden; line-height: 1.2em;">
                            ${businessPurpose}
                        </div>
                    `;
                    
                    item.onclick = () => {
                        alert(`${component.component_name}\n\nLines: ${component.total_lines || 0}\n\nPurpose: ${businessPurpose}`);
                    };
                    
                    list.appendChild(item);
                });
            });

            container.appendChild(list);
        }

        // Utility functions
        function updateTokenCounters() {
            const totalComponents = componentsData.length;
            const estimatedTokens = totalComponents * 1500;
            
            document.getElementById('totalTokens').textContent = estimatedTokens;
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function showLoading(message = 'Processing...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showLoadingWithProgress(title) {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            updateLoadingProgress('Starting analysis...', 0, 'Initializing...');
            resetAnalysisSteps();
        }

        function updateLoadingProgress(message, percentage, progressText) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = progressText;
        }

        function resetAnalysisSteps() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                step.className = 'analysis-step';
            });
        }

        function updateAnalysisStep(stepNumber, status, message) {
            const stepElement = document.getElementById(`step${stepNumber}`);
            stepElement.className = `analysis-step ${status}`;
            
            if (message) {
                stepElement.innerHTML = `<span class="step-icon"></span> ${message}`;
            }
        }

        function showErrorInStep(fileName, error) {
            updateAnalysisStep(1, 'error', `Error parsing ${fileName}`);
            document.getElementById('progressText').textContent = `Error: ${error}`;
            document.getElementById('progressText').style.color = '#dc3545';
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }

        function getFileType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const typeMap = {
                'cbl': 'COBOL',
                'cob': 'COBOL',
                'cpy': 'COPYBOOK',
                'jcl': 'JCL'
            };
            return typeMap[ext] || 'COBOL';
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        // Panel management - Complete collapse/restore
        function togglePanel(side) {
            const panel = document.getElementById(side + 'Panel');
            const isCollapsed = panel.classList.contains('collapsed');
            
            if (isCollapsed) {
                // Restore panel
                panel.classList.remove('collapsed');
                removeRestoreButton(side);
            } else {
                // Completely collapse panel
                panel.classList.add('collapsed');
                addRestoreButton(side);
            }
        }

        function addRestoreButton(side) {
            const existing = document.getElementById(`restore-${side}`);
            if (existing) existing.remove();
            
            const button = document.createElement('button');
            button.id = `restore-${side}`;
            button.className = `panel-restore ${side}`;
            button.innerHTML = side === 'left' ? 'üìÅ<br><small>Dashboard</small>' : 'üí¨<br><small>Chat</small>';
            button.title = `Restore ${side} panel`;
            button.onclick = () => togglePanel(side);
            
            document.body.appendChild(button);
        }

        function removeRestoreButton(side) {
            const button = document.getElementById(`restore-${side}`);
            if (button) button.remove();
        }

        // Field Matrix functionality
        async function loadFieldMatrix() {
            const recordLayout = document.getElementById('recordLayoutSelect').value;
            const program = document.getElementById('programSelect').value;

            if (!recordLayout && !program) {
                return;
            }

            showLoading('Loading field matrix...');

            try {
                const params = new URLSearchParams({
                    session_id: currentSessionId
                });
                
                if (recordLayout) params.append('record_layout', recordLayout);
                if (program) params.append('program_name', program);

                const response = await fetch(`/api/field-matrix?${params}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayFieldMatrix(data.matrix_data);
                    } else {
                        showError(data.error || 'Failed to load field matrix');
                    }
                } else {
                    throw new Error('Network error');
                }
            } catch (error) {
                console.error('Error loading field matrix:', error);
                showError('Failed to load field matrix');
            }

            hideLoading();
        }

        function displayFieldMatrix(matrixData) {
            const tbody = document.getElementById('fieldMatrixTableBody');
            tbody.innerHTML = '';

            if (matrixData.program_layouts) {
                matrixData.program_layouts.forEach((layout, layoutIndex) => {
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'collapsible-row';
                    headerRow.onclick = () => toggleLayoutFields(layoutIndex);
                    
                    headerRow.innerHTML = `
                        <td>
                            <span class="expand-icon" id="expand-${layoutIndex}">‚ñ∂</span>
                            <strong>${layout.layout_name}</strong>
                            <br><small class="text-muted">${layout.friendly_name}</small>
                        </td>
                        <td colspan="5">
                            <span class="badge badge-primary">Level ${layout.level}</span>
                            ${layout.fields.length} fields
                        </td>
                    `;
                    tbody.appendChild(headerRow);

                    const fieldsContainer = document.createElement('tbody');
                    fieldsContainer.id = `fields-${layoutIndex}`;
                    fieldsContainer.className = 'sub-fields';
                    fieldsContainer.style.display = 'none';
                    
                    layout.fields.forEach(field => {
                        const fieldRow = document.createElement('tr');
                        fieldRow.className = 'sub-field-row';
                        
                        const usageClass = `usage-${field.usage_type.toLowerCase()}`;
                        
                        fieldRow.innerHTML = `
                            <td style="padding-left: 2rem;">
                                ${field.field_name}
                                <br><small class="text-muted">${field.friendly_name || ''}</small>
                            </td>
                            <td>
                                <span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type}</span>
                                <br><small>${field.usage_description || ''}</small>
                            </td>
                            <td>${field.source_field || 'N/A'}</td>
                            <td>${field.business_purpose || 'N/A'}</td>
                            <td>${field.program_name || 'N/A'}</td>
                            <td>${field.line_number || 'N/A'}</td>
                        `;
                        fieldRow.className += ` ${usageClass}`;
                        fieldsContainer.appendChild(fieldRow);
                    });
                    
                    tbody.appendChild(fieldsContainer);
                });
            } else if (matrixData.fields) {
                matrixData.fields.forEach(field => {
                    const row = document.createElement('tr');
                    const usageClass = `usage-${field.usage_type.toLowerCase()}`;
                    
                    row.innerHTML = `
                        <td>
                            ${field.field_name}
                            <br><small class="text-muted">${field.friendly_name || ''}</small>
                        </td>
                        <td>
                            <span class="badge ${getBadgeClass(field.usage_type)}">${field.usage_type}</span>
                            <br><small>${field.usage_description || ''}</small>
                        </td>
                        <td>${field.source_field || 'N/A'}</td>
                        <td>${field.business_purpose || 'N/A'}</td>
                        <td>${field.program_name || 'N/A'}</td>
                        <td>${field.line_number || 'N/A'}</td>
                    `;
                    row.className = usageClass;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No field data available</td></tr>';
            }
        }

        function toggleLayoutFields(layoutIndex) {
            const fieldsContainer = document.getElementById(`fields-${layoutIndex}`);
            const expandIcon = document.getElementById(`expand-${layoutIndex}`);
            
            if (fieldsContainer.style.display === 'none') {
                fieldsContainer.style.display = 'table-row-group';
                expandIcon.textContent = '‚ñº';
            } else {
                fieldsContainer.style.display = 'none';
                expandIcon.textContent = '‚ñ∂';
            }
        }

        // Field Mapping functionality
        async function analyzeFieldMapping() {
    const targetFile = document.getElementById('targetFileInput').value.trim();
    if (!targetFile) {
        showError('Please enter a target file name or select a record layout');
        return;
    }

    showLoading('Analyzing field mappings...');

    try {
        const response = await fetch('/api/field-mapping', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: currentSessionId,
                target_file: targetFile
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                displayFieldMappingsWithSummary(data.field_mappings, data.summary);
                await displayLayoutSummary(targetFile);
            } else {
                showError(data.error || 'Failed to analyze field mappings');
            }
        } else {
            throw new Error('Network error');
        }
    } catch (error) {
        console.error('Error analyzing field mapping:', error);
        showError('Failed to analyze field mappings');
    }

    hideLoading();
}
function displayFieldMappingsWithSummary(mappings, summary) {
    const tbody = document.getElementById('fieldMappingTableBody');
    tbody.innerHTML = '';

    if (!mappings || mappings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No field mappings found</td></tr>';
        return;
    }

    mappings.forEach(mapping => {
        const row = document.createElement('tr');
        
        // Normalize usage type for consistency with field matrix
        let normalizedUsageType = normalizeUsageType(mapping.business_logic_type || 'STATIC');
        console.log('mapping:', mapping.usageType, 'normalized to:', normalizedUsageType);
        
         // Function to get badge class based on usage type
        row.innerHTML = `
            <td>
                <div style="min-width: 150px;">
                    <strong>${mapping.field_name || 'N/A'}</strong>
                    ${mapping.friendly_name && mapping.friendly_name !== mapping.field_name ? 
                        `<br><small class="text-muted">${mapping.friendly_name}</small>` : ''}
                </div>
            </td>
            <td>
                <div style="min-width: 120px;">
                    <code style="font-size: 0.8rem;">${mapping.mainframe_data_type || 'UNKNOWN'}</code>
                    <br><small><strong>Length:</strong> ${mapping.mainframe_length || 0}</small>
                </div>
            </td>
            <td>
                <div style="min-width: 120px;">
                    <code style="font-size: 0.8rem;">${mapping.oracle_data_type || 'VARCHAR2(50)'}</code>
                    <br><small><strong>Length:</strong> ${mapping.oracle_length || 50}</small>
                </div>
            </td>
            <td>
                <div style="min-width: 150px;">
                    <strong>${mapping.population_source || 'Program logic'}</strong>
                    ${mapping.source_record_layout ? `<br><small>From: ${mapping.source_record_layout}</small>` : ''}
                </div>
            </td>
            <td>
                <div style="min-width: 120px;">
                    <span class="badge ${getBadgeClass(normalizedUsageType)}">${normalizedUsageType}</span>
                    <br><small style="font-size: 0.75rem;">${mapping.business_logic_description || ''}</small>
                </div>
            </td>
            <td>
                <div style="min-width: 100px;">
                    ${Array.isArray(mapping.programs_involved) ? 
                        mapping.programs_involved.join(', ') : 
                        mapping.programs_involved || 'Unknown'}
                </div>
            </td>
            <td>
                <div style="min-width: 80px;">
                    <button class="btn btn-secondary" onclick="showFieldDetails('${mapping.field_name}')" 
                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap;">
                        View Details
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    // Show summary if available
    if (summary) {
        showMappingSummary(summary);
    }
}

// Add the missing field details modal functions
async function showFieldDetails(fieldName) {
    try {
        const response = await fetch(`/api/field-details/${currentSessionId}/${fieldName}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                displayFieldDetailsModal(data.field_details);
            } else {
                showError(`Could not load details for field ${fieldName}`);
            }
        }
    } catch (error) {
        console.error('Error loading field details:', error);
        showError('Error loading field details');
    }
}

function displayFieldDetailsModal(fieldDetails) {
    const modalTitle = document.getElementById('fieldModalTitle');
    const fieldDetailsContent = document.getElementById('fieldDetailsContent');
    
    if (!modalTitle || !fieldDetailsContent) {
        console.error('Modal elements not found');
        return;
    }
    
    try {
        modalTitle.textContent = `${fieldDetails.field_name} - Field Details`;
        
        // Get normalized usage type for consistency
        const normalizedUsageType = normalizeUsageType(fieldDetails.usage_type || 'STATIC');
        
        // Safe template creation
        const content = createFieldDetailsContent({...fieldDetails, usage_type: normalizedUsageType});
        fieldDetailsContent.innerHTML = content;
        
        const modal = document.getElementById('fieldDetailsModal');
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
    } catch (error) {
        console.error('Error displaying field details modal:', error);
        showError('Error displaying field details');
    }
}

function createFieldDetailsContent(fieldDetails) {
    const operationsSummary = fieldDetails.operations ? 
        fieldDetails.operations.map(op => 
            `${op.program_name}: ${normalizeUsageType(op.usage_type)} (${op.move_source_count + op.move_target_count + op.arithmetic_count + op.conditional_count} operations)`
        ).join('<br>') : 'No operations found';

    const referencesHtml = fieldDetails.references ? 
        fieldDetails.references.map(ref => `
            <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 4px;">
                <strong>Line ${ref.line_number}:</strong> ${normalizeUsageType(ref.operation_type)}<br>
                <code style="font-size: 0.8rem;">${ref.line_content}</code>
            </div>
        `).join('') : 'No references found';

    return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <div>
                <h5>Field Information</h5>
                <table style="width: 100%; font-size: 0.9rem;">
                    <tr><td><strong>Name:</strong></td><td>${fieldDetails.field_name || 'N/A'}</td></tr>
                    <tr><td><strong>Friendly Name:</strong></td><td>${fieldDetails.friendly_name || 'N/A'}</td></tr>
                    <tr><td><strong>Usage Type:</strong></td><td><span class="badge ${getBadgeClass(fieldDetails.usage_type || 'UNKNOWN')}">${fieldDetails.usage_type || 'UNKNOWN'}</span></td></tr>
                    <tr><td><strong>Source Field:</strong></td><td>${fieldDetails.source_field || 'N/A'}</td></tr>
                    <tr><td><strong>Target Field:</strong></td><td>${fieldDetails.target_field || 'N/A'}</td></tr>
                </table>
            </div>
            <div>
                <h5>Data Types & Lengths</h5>
                <table style="width: 100%; font-size: 0.9rem;">
                    <tr><td><strong>Mainframe Type:</strong></td><td><code>${fieldDetails.mainframe_data_type || 'UNKNOWN'}</code></td></tr>
                    <tr><td><strong>Mainframe Length:</strong></td><td>${fieldDetails.mainframe_length || 0}</td></tr>
                    <tr><td><strong>Oracle Type:</strong></td><td><code>${fieldDetails.oracle_data_type || 'VARCHAR2(50)'}</code></td></tr>
                    <tr><td><strong>Oracle Length:</strong></td><td>${fieldDetails.oracle_length || 50}</td></tr>
                    <tr><td><strong>Total References:</strong></td><td>${fieldDetails.total_references || 0}</td></tr>
                </table>
            </div>
        </div>

        <div style="margin-bottom: 2rem;">
            <h5>Business Purpose</h5>
            <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                ${fieldDetails.business_purpose || 'No description available'}
            </div>
        </div>

        <div style="margin-bottom: 2rem;">
            <h5>Field Definition</h5>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.9rem;">
                ${fieldDetails.definition_code || 'Definition not available'}
            </div>
        </div>

        <div style="margin-bottom: 2rem;">
            <h5>Program Operations</h5>
            <div style="font-size: 0.9rem;">
                ${operationsSummary}
            </div>
        </div>

        <div style="margin-bottom: 2rem;">
            <h5>Field References (First 10)</h5>
            <div style="max-height: 300px; overflow-y: auto;">
                ${referencesHtml}
            </div>
        </div>

        <div>
            <h5>Source Code Context</h5>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                <pre style="margin: 0; font-size: 0.8rem; white-space: pre-wrap;">${fieldDetails.source_code_snippet || 'Source code not available'}</pre>
            </div>
        </div>
    `;
}

function closeFieldDetailsModal() {
    document.getElementById('fieldDetailsModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}
function showMappingSummary(summary) {
    const summaryHtml = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem;">
            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${summary.total_fields || 0}</div>
                <div style="font-size: 0.8rem; color: #6c757d;">Total Fields</div>
            </div>
            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">${summary.input_fields || 0}</div>
                <div style="font-size: 0.8rem; color: #6c757d;">Input Fields</div>
            </div>
            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #17a2b8;">${summary.output_fields || 0}</div>
                <div style="font-size: 0.8rem; color: #6c757d;">Output Fields</div>
            </div>
            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #6c757d;">${summary.static_fields || 0}</div>
                <div style="font-size: 0.8rem; color: #6c757d;">Static Fields</div>
            </div>
            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #dc3545;">${summary.unused_fields || 0}</div>
                <div style="font-size: 0.8rem; color: #6c757d;">Unused Fields</div>
            </div>
            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">${summary.calculated_fields || 0}</div>
                <div style="font-size: 0.8rem; color: #6c757d;">Calculated Fields</div>
            </div>
        </div>
    `;
    
    // Show in a notification or summary area
    const summaryDiv = document.createElement('div');
    summaryDiv.innerHTML = `
        <div style="background: #e8f4f8; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #17a2b8;">
            <h5 style="margin: 0 0 0.5rem 0; color: #0c5460;">Field Mapping Summary</h5>
            ${summaryHtml}
        </div>
    `;
    
    const resultsDiv = document.getElementById('fieldMappingResults');
    resultsDiv.insertBefore(summaryDiv, resultsDiv.firstChild);
}

async function displayLayoutSummary(layoutName) {
    try {
        const response = await fetch(`/api/layout-summary/${currentSessionId}/${layoutName}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                const summary = data.summary;
                const summarySection = document.getElementById('layoutSummarySection');
                const summaryContent = document.getElementById('layoutSummaryContent');
                
                if (!summarySection || !summaryContent) {
                    console.warn('Layout summary elements not found in DOM');
                    return;
                }
                
                summaryContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                        <div>
                            <h5>${summary.layout_name}</h5>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #666;">${summary.friendly_name}</p>
                            <p style="font-size: 0.85rem; line-height: 1.4;">${summary.business_purpose}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #667eea;">${summary.total_fields}</div>
                                <div style="font-size: 0.7rem; color: #6c757d;">Total</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">${summary.input_fields}</div>
                                <div style="font-size: 0.7rem; color: #6c757d;">Input</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #17a2b8;">${summary.output_fields}</div>
                                <div style="font-size: 0.7rem; color: #6c757d;">Output</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #6c757d;">${summary.static_fields}</div>
                                <div style="font-size: 0.7rem; color: #6c757d;">Static</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #dc3545;">${summary.unused_fields}</div>
                                <div style="font-size: 0.7rem; color: #6c757d;">Unused</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 6px;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #ffc107;">${summary.derived_fields}</div>
                                <div style="font-size: 0.7rem; color: #6c757d;">Derived</div>
                            </div>
                        </div>
                    </div>
                `;
                
                summarySection.style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Error loading layout summary:', error);
    }
}

async function showFieldDetails(fieldName) {
    try {
        const response = await fetch(`/api/field-details/${currentSessionId}/${fieldName}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                displayFieldDetailsModal(data.field_details);
            } else {
                showError(`Could not load details for field ${fieldName}`);
            }
        }
    } catch (error) {
        console.error('Error loading field details:', error);
        showError('Error loading field details');
    }
}

function displayFieldDetailsModal(fieldDetails) {
    const modalTitle = document.getElementById('fieldModalTitle');
    const fieldDetailsContent = document.getElementById('fieldDetailsContent');
    
    if (!modalTitle || !fieldDetailsContent) {
        console.error('Modal elements not found');
        return;
    }
    
    try {
        modalTitle.textContent = `${fieldDetails.field_name} - Field Details`;
        
        // Safe template creation
        const content = createFieldDetailsContent(fieldDetails);
        fieldDetailsContent.innerHTML = content;
        
        const modal = document.getElementById('fieldDetailsModal');
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
    } catch (error) {
        console.error('Error displaying field details modal:', error);
        showError('Error displaying field details');
    }
}

function createFieldDetailsContent(fieldDetails) {
    const operationsSummary = fieldDetails.operations ? 
        fieldDetails.operations.map(op => 
            `${op.program_name}: ${op.usage_type} (${op.move_source_count + op.move_target_count + op.arithmetic_count + op.conditional_count} operations)`
        ).join('<br>') : 'No operations found';

    const referencesHtml = fieldDetails.references ? 
        fieldDetails.references.map(ref => `
            <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 4px;">
                <strong>Line ${ref.line_number}:</strong> ${ref.operation_type}<br>
                <code style="font-size: 0.8rem;">${ref.line_content}</code>
            </div>
        `).join('') : 'No references found';

    return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <div>
                <h5>Field Information</h5>
                <table style="width: 100%; font-size: 0.9rem;">
                    <tr><td><strong>Name:</strong></td><td>${fieldDetails.field_name || 'N/A'}</td></tr>
                    <tr><td><strong>Friendly Name:</strong></td><td>${fieldDetails.friendly_name || 'N/A'}</td></tr>
                    <tr><td><strong>Usage Type:</strong></td><td><span class="badge ${getBadgeClass(fieldDetails.usage_type || 'UNKNOWN')}">${fieldDetails.usage_type || 'UNKNOWN'}</span></td></tr>
                    <tr><td><strong>Source Field:</strong></td><td>${fieldDetails.source_field || 'N/A'}</td></tr>
                    <tr><td><strong>Target Field:</strong></td><td>${fieldDetails.target_field || 'N/A'}</td></tr>
                </table>
            </div>
            <div>
                <h5>Data Types & Lengths</h5>
                <table style="width: 100%; font-size: 0.9rem;">
                    <tr><td><strong>Mainframe Type:</strong></td><td><code>${fieldDetails.mainframe_data_type || 'UNKNOWN'}</code></td></tr>
                    <tr><td><strong>Mainframe Length:</strong></td><td>${fieldDetails.mainframe_length || 0}</td></tr>
                    <tr><td><strong>Oracle Type:</strong></td><td><code>${fieldDetails.oracle_data_type || 'VARCHAR2(50)'}</code></td></tr>
                    <tr><td><strong>Oracle Length:</strong></td><td>${fieldDetails.oracle_length || 50}</td></tr>
                    <tr><td><strong>Total References:</strong></td><td>${fieldDetails.total_references || 0}</td></tr>
                </table>
            </div>
        </div>

        <div style="margin-bottom: 2rem;">
            <h5>Business Purpose</h5>
            <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                ${fieldDetails.business_purpose || 'No description available'}
            </div>
        </div>

        <div style="margin-bottom: 2rem;">
            <h5>Field Definition</h5>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.9rem;">
                ${fieldDetails.definition_code || 'Definition not available'}
            </div>
        </div>

        <div style="margin-bottom: 2rem;">
            <h5>Program Operations</h5>
            <div style="font-size: 0.9rem;">
                ${operationsSummary}
            </div>
        </div>

        <div style="margin-bottom: 2rem;">
            <h5>Field References (First 10)</h5>
            <div style="max-height: 300px; overflow-y: auto;">
                ${referencesHtml}
            </div>
        </div>

        <div>
            <h5>Source Code Context</h5>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                <pre style="margin: 0; font-size: 0.8rem; white-space: pre-wrap;">${fieldDetails.source_code_snippet || 'Source code not available'}</pre>
            </div>
        </div>
    `;
}

function closeFieldDetailsModal() {
    document.getElementById('fieldDetailsModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

        function displayFieldMappings(mappings) {
            const tbody = document.getElementById('fieldMappingTableBody');
            tbody.innerHTML = '';

            if (!mappings || mappings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No field mappings found</td></tr>';
                return;
            }

            mappings.forEach(mapping => {
                const row = document.createElement('tr');
                
                let populationSource = mapping.population_source || 'N/A';
                if (populationSource === 'N/A' && mapping.business_logic_description) {
                    if (mapping.business_logic_description.includes('from')) {
                        populationSource = mapping.business_logic_description;
                    }
                }

                row.innerHTML = `
                    <td>
                        <strong>${mapping.field_name}</strong><br>
                        <small class="text-muted">${mapping.friendly_name || ''}</small>
                    </td>
                    <td><code>${mapping.mainframe_data_type}</code></td>
                    <td><code>${mapping.oracle_data_type}</code></td>
                    <td>${mapping.mainframe_length}</td>
                    <td>${mapping.oracle_length}</td>
                    <td><strong>${populationSource}</strong></td>
                    <td>
                        <span class="badge ${getBadgeClass(mapping.business_logic_type)}">${mapping.business_logic_type}</span>
                        <br><small>${mapping.business_logic_description || ''}</small>
                    </td>
                    <td>${Array.isArray(mapping.programs_involved) ? mapping.programs_involved.join(', ') : mapping.programs_involved || 'Unknown'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function exportFieldMappings() {
            const table = document.getElementById('fieldMappingTableBody');
            const rows = table.querySelectorAll('tr');
            
            if (rows.length === 0 || rows[0].textContent.includes('No field mappings')) {
                alert('No field mappings to export');
                return;
            }
            
            let csv = 'Field Name,Mainframe Data Type,Oracle Data Type,MF Length,Oracle Length,Population Source,Business Logic,Programs Involved\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                cells.forEach(cell => {
                    const text = cell.textContent.trim().replace(/\n/g, ' ').replace(/,/g, ';');
                    rowData.push(`"${text}"`);
                });
                csv += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `field_mappings_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function getBadgeClass(type) {
            const badgeMap = {
                'INPUT': 'badge-primary',
                'OUTPUT': 'badge-success', 
                'INPUT_OUTPUT': 'badge-warning',
                'DERIVED': 'badge-warning',
                'REFERENCE': 'badge-info',
                'STATIC': 'badge-secondary',
                'UNUSED': 'badge-danger',
                'MOVE': 'badge-primary',
                'CONDITIONAL': 'badge-warning',
                'CALCULATED': 'badge-success',
                'STRING_MANIPULATION': 'badge-info',
                'CICS_INPUT': 'badge-primary',
                'CICS_OUTPUT': 'badge-success',
                'CICS_REWRITE': 'badge-warning'
            };
            return badgeMap[type] || 'badge-secondary';
        }

        // Additional component actions
        function reAnalyzeComponent(componentName) {
            alert(`Re-analysis functionality for ${componentName} coming soon!`);
        }

        function askAboutThis(componentName) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value = `Tell me about the ${componentName} component. What does it do and how does it work?`;
            chatInput.focus();
        }

        function filterComponents() {
            // Implementation for filtering components
            console.log('Filtering components...');
        }

        // Configuration modal functions
        function openConfigModal() {
            updateConfigForm();
            document.getElementById('configModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { opacity: 0; transform: translateX(100%); }
                to { opacity: 1; transform: translateX(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>